{% extends "pc/base_pc.html" %}

{% block title %}æˆ‘çš„è®¾å¤‡è¯¦æƒ… - è®¾å¤‡ç®¡ç†ç³»ç»Ÿ{% endblock %}

{% set active_nav = 'dashboard' %}

{% block content %}
<style>
.notification-item {
    padding: 12px;
    border-bottom: 1px solid #f0f0f0;
}
.notification-item:last-child {
    border-bottom: none;
}
.notification-content {
    font-size: 14px;
    color: var(--text-primary);
    line-height: 1.6;
}
.notification-time {
    font-size: 12px;
    color: var(--text-muted);
    margin-top: 4px;
}
.notification-empty {
    text-align: center;
    padding: 40px 20px;
    color: var(--text-muted);
}
.notification-empty .empty-icon {
    font-size: 48px;
    margin-bottom: 12px;
}
</style>

<!-- é€šçŸ¥é“ƒé“› -->
<div class="notification-bell-wrapper">
    <button class="notification-bell" onclick="toggleNotificationModal()">
        <span class="bell-icon">ğŸ””</span>
        <span class="notification-badge" id="notificationBadge" style="display: none;">0</span>
    </button>
</div>

<!-- é€šçŸ¥å¼¹çª— -->
<div class="notification-modal" id="notificationModal">
    <div class="notification-modal-content">
        <div class="notification-modal-header">
            <h3>ğŸ”” é€šçŸ¥</h3>
            <button class="close-btn" onclick="toggleNotificationModal()">&times;</button>
        </div>
        <div class="notification-modal-body" id="notificationBody">
            <!-- é€šçŸ¥å†…å®¹å°†é€šè¿‡JSåŠ¨æ€æ¸²æŸ“ -->
        </div>
    </div>
</div>

<h1 class="page-title">ğŸ“Š æˆ‘çš„è®¾å¤‡è¯¦æƒ…</h1>

<!-- ä¸»å¸ƒå±€ï¼šå·¦è¾¹å¿«æ·æ“ä½œï¼Œå³è¾¹æˆ‘çš„è®¾å¤‡å’Œå€Ÿç”¨åˆ—è¡¨ -->
<div class="dashboard-main-layout">
    <!-- å·¦ä¾§ï¼šæˆ‘çš„è®¾å¤‡å’Œå¿«æ·æ“ä½œ -->
    <div class="dashboard-left">
        <!-- æˆ‘çš„è®¾å¤‡ -->
        <h2 style="font-size: 16px; color: #666; margin: 0 0 12px 0; font-weight: 500;">ğŸ‘¤ æˆ‘çš„è®¾å¤‡</h2>
        <div class="my-devices-grid">
            <a href="{{ url_for('pc_my_custodian_devices') }}" style="text-decoration: none;">
                <div class="my-device-card">
                    <span class="my-device-icon">ğŸ”</span>
                    <span class="my-device-title">æˆ‘çš„ä¿ç®¡</span>
                    <span class="my-device-count">{{ my_custodian_count }}</span>
                </div>
            </a>
            <a href="{{ url_for('pc_device_list') }}" style="text-decoration: none;">
                <div class="my-device-card">
                    <span class="my-device-icon">ğŸ“‹</span>
                    <span class="my-device-title">æˆ‘çš„å€Ÿç”¨</span>
                    <span class="my-device-count">{{ my_borrowed_count }}</span>
                </div>
            </a>
        </div>

        <!-- å¿«æ·æ“ä½œ -->
        <h2 style="font-size: 16px; color: #666; margin: 24px 0 12px 0; font-weight: 500;">âš¡ å¿«æ·æ“ä½œ</h2>
        <div class="quick-actions-grid">
            <a href="{{ url_for('pc_device_list', type='car') }}" class="quick-action-card car">
                <span class="quick-action-icon">ğŸš—</span>
                <span class="quick-action-title">å€Ÿç”¨è½¦æœº</span>
            </a>
            <a href="{{ url_for('pc_device_list', type='phone') }}" class="quick-action-card phone">
                <span class="quick-action-icon">ğŸ“±</span>
                <span class="quick-action-title">å€Ÿç”¨æ‰‹æœº</span>
            </a>
            <a href="{{ url_for('pc_device_list', type='instrument') }}" class="quick-action-card instrument">
                <span class="quick-action-icon">ğŸ“Š</span>
                <span class="quick-action-title">å€Ÿç”¨ä»ªè¡¨</span>
            </a>
            <a href="{{ url_for('pc_device_list', type='simcard') }}" class="quick-action-card simcard">
                <span class="quick-action-icon">ğŸ“²</span>
                <span class="quick-action-title">å€Ÿç”¨æ‰‹æœºå¡</span>
            </a>
            <a href="{{ url_for('pc_device_list', type='other') }}" class="quick-action-card other">
                <span class="quick-action-icon">ğŸ”§</span>
                <span class="quick-action-title">å€Ÿç”¨å…¶å®ƒ</span>
            </a>
            <a href="{{ url_for('pc_records') }}" class="quick-action-card records">
                <span class="quick-action-icon">ğŸ“‹</span>
                <span class="quick-action-title">æŸ¥çœ‹è®°å½•</span>
            </a>
        </div>
    </div>

    <!-- å³ä¾§ï¼šæˆ‘çš„å€Ÿç”¨è®¾å¤‡ -->
    <div class="dashboard-right">
        <!-- è®¾å¤‡æœç´¢ -->
        <div class="card" style="margin-bottom: 16px;">
            <div class="card-header">
                <span class="card-title">ğŸ” è®¾å¤‡æœç´¢</span>
            </div>
            <div class="card-body">
                <div style="display: flex; gap: 10px; align-items: flex-start;">
                    <div style="flex: 1; position: relative;">
                        <input type="text" id="deviceSearchInput" class="search-input" placeholder="è¾“å…¥è®¾å¤‡å·æˆ–å‹å·è¿›è¡Œæœç´¢..." 
                               style="width: 100%; padding: 10px 12px; border: 1px solid #d9d9d9; border-radius: 6px; font-size: 14px;"
                               oninput="handleDeviceSearchInput(this.value)" onkeydown="handleDeviceSearchKeydown(event)">
                        <div id="searchSuggestions" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: #fff; border: 1px solid #d9d9d9; border-radius: 6px; margin-top: 4px; max-height: 200px; overflow-y: auto; z-index: 100; box-shadow: 0 4px 12px rgba(0,0,0,0.1);"></div>
                    </div>
                    <button onclick="searchDevice()" class="btn btn-primary" style="padding: 10px 24px; white-space: nowrap;">æœç´¢</button>
                </div>
            </div>
        </div>

        <!-- æˆ‘çš„å€Ÿç”¨è®¾å¤‡ -->
<div class="card">
    <div class="card-header">
        <span class="card-title">
            ğŸ“± æˆ‘çš„å€Ÿç”¨è®¾å¤‡
            {% if my_borrowed_count > 0 %}
            <span style="font-size: 14px; color: #666; font-weight: normal;">
                ï¼ˆå…±{{ my_borrowed_count }}å°
                {%- for type, count in my_borrowed_type_counts.items() -%}
                    {{ 'ã€' if loop.first else '' }}{{ type }}{{ count }}å°{{ 'ã€' if not loop.last else '' }}
                {%- endfor -%}
                ï¼‰
            </span>
            {% endif %}
        </span>
        <a href="{{ url_for('pc_device_list') }}" class="btn btn-default btn-sm">æŸ¥çœ‹å…¨éƒ¨</a>
    </div>
    <div class="card-body">
        {% if my_borrowed_devices %}
        <table class="data-table">
            <thead>
                <tr>
                    <th>è®¾å¤‡åç§°</th>
                    <th>ç±»å‹</th>
                    <th>å€Ÿç”¨æ—¶é—´</th>
                    <th>é¢„è®¡å½’è¿˜</th>
                    <th>å‰©ä½™æ—¶é—´</th>
                    <th>çŠ¶æ€</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody>
                {% for device in my_borrowed_devices %}
                <tr {% if device.is_overdue and device.status.value not in ['ä¸¢å¤±', 'å·²æŸå'] %}style="background: #fff1f0;"{% endif %}>
                    <td>
                        <span class="device-icon">{% if device.device_type.value == 'è½¦æœº' %}ğŸš—{% elif device.device_type.value == 'æ‰‹æœº' %}ğŸ“±{% elif device.device_type.value == 'ä»ªè¡¨' %}ğŸ“Š{% elif device.device_type.value == 'æ‰‹æœºå¡' %}ğŸ“²{% elif device.device_type.value == 'å…¶å®ƒè®¾å¤‡' %}ğŸ”§{% else %}ğŸ“¦{% endif %}</span>
                        <a href="{{ url_for('pc_device_detail', device_id=device.id, device_type=device.device_type.value) }}" class="device-name" style="color: #1890ff; font-weight: 500; text-decoration: none;">{{ device.name }}</a>
                    </td>
                    <td class="device-type">{{ device.device_type.value }}</td>
                    <td>{{ device.borrow_time }}</td>
                    <td>
                        {% if device.status.value == 'ä¸¢å¤±' or device.status.value == 'å·²æŸå' %}
                            -
                        {% elif device.expected_return_date %}
                            {{ device.expected_return_date.strftime('%Y-%m-%d %H:%M') }}
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td {% if device.is_overdue and device.status.value not in ['ä¸¢å¤±', 'å·²æŸå'] %}style="color: #ff4d4f; font-weight: 500;"{% endif %}>
                        {% if device.status.value == 'ä¸¢å¤±' %}
                            -
                        {% elif device.status.value == 'å·²æŸå' %}
                            -
                        {% elif device.is_overdue %}
                        âš ï¸ é€¾æœŸ {% if device.overdue_hours < 24 %}{{ device.overdue_hours }} å°æ—¶{% else %}{{ device.overdue_days }} å¤©{% endif %}
                        {% else %}
                        {% if device.remaining_days > 0 %}â° {{ device.remaining_days }} å¤©{% else %}â° {{ device.remaining_hours }} å°æ—¶{% endif %}
                        {% endif %}
                    </td>
                    <td>
                        {% if device.status.value == 'ä¸¢å¤±' %}
                        <span class="status-tag status-lost">ä¸¢å¤±</span>
                        {% elif device.status.value == 'å·²æŸå' %}
                        <span class="status-tag status-damaged">å·²æŸå</span>
                        {% elif device.is_overdue %}
                        <span class="status-tag status-lost">å·²é€¾æœŸ</span>
                        {% else %}
                        <span class="status-tag status-borrowed">å€Ÿç”¨ä¸­</span>
                        {% endif %}
                    </td>
                    <td>
                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                            {% if device.status.value not in ['ä¸¢å¤±', 'å·²æŸå'] %}
                            <button onclick="openReturnModal('{{ device.id }}')" class="btn btn-success btn-sm">å½’è¿˜</button>
                            <button onclick="openTransferModal('{{ device.id }}')" class="btn btn-info btn-sm">è½¬å€Ÿ</button>
                            {% if device.can_renew %}
                            <button onclick="openRenewModal('{{ device.id }}')" class="btn btn-info btn-sm">ç»­å€Ÿ</button>
                            {% else %}
                            <button onclick="showToast('{{ device.renew_disabled_reason }}')" class="btn btn-sm" style="background: #d9d9d9; border-color: #d9d9d9; color: #8c8c8c; cursor: not-allowed;" title="{{ device.renew_disabled_reason }}">ç»­å€Ÿ</button>
                            {% endif %}
                            {% endif %}
                            <a href="{{ url_for('pc_device_detail', device_id=device.id) }}" class="btn btn-primary btn-sm">æŸ¥çœ‹è¯¦æƒ…</a>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="empty-state">
            <div class="empty-icon">ğŸ“­</div>
            <p class="empty-title">æ‚¨å½“å‰æ²¡æœ‰å€Ÿç”¨è®¾å¤‡</p>
            <a href="{{ url_for('pc_device_list') }}" class="btn btn-primary">å»å€Ÿè®¾å¤‡</a>
        </div>
        {% endif %}
    </div>
</div>
</div>
<!-- å³ä¾§ç»“æŸ -->

<!-- å¼¹çª—ï¼šå½’è¿˜ -->
<div class="modal-overlay" id="returnModal">
    <div class="modal">
        <div class="modal-header">
            <span class="modal-title">ğŸ“¤ å½’è¿˜ç¡®è®¤</span>
            <button class="modal-close" onclick="closeModal('returnModal')">Ã—</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label">å½’è¿˜åŸå› </label>
                <div class="radio-group">
                    <label class="radio-item"><input type="radio" name="returnReason" value="æ­£å¸¸å½’è¿˜" checked><span>æ­£å¸¸å½’è¿˜</span></label>
                    <label class="radio-item"><input type="radio" name="returnReason" value="è®¾å¤‡æ”¶å›"><span>è®¾å¤‡æ”¶å›</span></label>
                    <label class="radio-item"><input type="radio" name="returnReason" value="è½¬å€Ÿä»–äºº"><span>è½¬å€Ÿä»–äºº</span></label>
                    <label class="radio-item"><input type="radio" name="returnReason" value="å…¶ä»–"><span>å…¶ä»–</span></label>
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">å½’è¿˜å¤‡æ³¨</label>
                <textarea id="returnRemark" class="form-textarea" rows="2">è®¾å¤‡å®Œå¥½ï¼Œæ— å¼‚å¸¸</textarea>
            </div>
            <div style="background: #f6ffed; padding: 16px; border-radius: 8px; margin-top: 16px;">
                <p style="font-weight: 500; margin-bottom: 12px;">âœ“ å½’è¿˜å‰è¯·ç¡®è®¤ï¼š</p>
                <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                    <input type="checkbox" id="check1" checked> è®¾å¤‡å¤–è§‚å®Œå¥½ï¼Œæ— æ˜æ˜¾æŸå
                </label>
                <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                    <input type="checkbox" id="check2" checked> é…ä»¶é½å…¨ï¼ˆå……ç”µå™¨ã€æ•°æ®çº¿ç­‰ï¼‰
                </label>
                <label style="display: flex; align-items: center; gap: 8px;">
                    <input type="checkbox" id="check3" checked> å·²æ¸…é™¤è®¾å¤‡ä¸­çš„ä¸ªäººæ•°æ®
                </label>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-default" onclick="closeModal('returnModal')">å–æ¶ˆ</button>
            <button class="btn btn-warning" onclick="submitReturn()">ç¡®è®¤å½’è¿˜</button>
        </div>
    </div>
</div>

<!-- å¼¹çª—ï¼šè½¬å€Ÿ -->
<div class="modal-overlay" id="transferModal">
    <div class="modal">
        <div class="modal-header">
            <span class="modal-title">ğŸ”„ è½¬å€Ÿè®¾å¤‡</span>
            <button class="modal-close" onclick="closeModal('transferModal')">Ã—</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label">è½¬å€Ÿç»™ <span style="color: #ff4d4f;">*</span></label>
                <input type="text" id="transferTo" class="form-input" placeholder="è¾“å…¥å§“åæœç´¢..." autocomplete="off">
                <div id="userSuggestions" style="background: #fff; border: 1px solid #d9d9d9; border-radius: 4px; max-height: 200px; overflow-y: auto; display: none; margin-top: 4px;"></div>
            </div>
            <div class="form-group">
                <label class="form-label">å¤‡æ³¨</label>
                <textarea id="transferRemark" class="form-textarea" rows="2" placeholder="å¯é€‰ï¼šæ·»åŠ è½¬å€Ÿå¤‡æ³¨"></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-default" onclick="closeModal('transferModal')">å–æ¶ˆ</button>
            <button class="btn btn-primary" onclick="submitTransfer()">ç¡®è®¤è½¬å€Ÿ</button>
        </div>
    </div>
</div>

<!-- å¼¹çª—ï¼šç»­å€Ÿ -->
<div class="modal-overlay" id="renewModal">
    <div class="modal">
        <div class="modal-header">
            <span class="modal-title">ğŸ“… å€Ÿç”¨ç»­æœŸ</span>
            <button class="modal-close" onclick="closeModal('renewModal')">Ã—</button>
        </div>
        <div class="modal-body">
            <p style="color: #8c8c8c; margin-bottom: 16px;">è¯·é€‰æ‹©æ–°çš„é¢„è®¡å½’è¿˜æ—¥æœŸï¼ˆåªèƒ½å¾€åé€‰æ‹©ï¼‰ï¼š</p>
            <div class="form-group">
                <label class="form-label">æ–°é¢„è®¡å½’è¿˜æ—¥æœŸ</label>
                <input type="date" id="renewDate" class="form-input">
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-default" onclick="closeModal('renewModal')">å–æ¶ˆ</button>
            <button class="btn btn-success" onclick="submitRenew()">ç¡®è®¤ç»­æœŸ</button>
        </div>
    </div>
</div>

<script>
let currentDeviceId = '';
let allUsers = [];

// åŠ è½½ç”¨æˆ·åˆ—è¡¨
function loadUsers() {
    fetch('/api/users').then(r => r.json()).then(data => {
        if (data.success && data.users) {
            allUsers = data.users;
        }
    }).catch(() => {});
}

// æ‰“å¼€å½’è¿˜å¼¹çª—
function openReturnModal(deviceId) {
    currentDeviceId = deviceId;
    openModal('returnModal');
}

// æ‰“å¼€è½¬å€Ÿå¼¹çª—
function openTransferModal(deviceId) {
    currentDeviceId = deviceId;
    loadUserSuggestions();
    openModal('transferModal');
}

// æ‰“å¼€ç»­å€Ÿå¼¹çª—
function openRenewModal(deviceId) {
    currentDeviceId = deviceId;
    const renewDateEl = document.getElementById('renewDate');
    if (renewDateEl) {
        const today = new Date();
        const tomorrow = new Date(today);
        tomorrow.setDate(today.getDate() + 1);
        const tomorrowStr = tomorrow.toISOString().split('T')[0];
        const todayStr = today.toISOString().split('T')[0];
        renewDateEl.min = todayStr;
        renewDateEl.value = tomorrowStr;
    }
    openModal('renewModal');
}

// ç”¨æˆ·æœç´¢å»ºè®®
function loadUserSuggestions() {
    const input = document.getElementById('transferTo');
    const suggestions = document.getElementById('userSuggestions');
    if (!input || !suggestions) return;

    // æ¸…ç©ºè¾“å…¥æ¡†
    input.value = '';

    input.addEventListener('input', function() {
        const keyword = this.value.trim().toLowerCase();
        if (!keyword) { suggestions.style.display = 'none'; return; }

        const matched = allUsers.filter(u => u.name.toLowerCase().includes(keyword));
        if (matched.length > 0) {
            suggestions.innerHTML = matched.map(u => {
                const name = u.name.replace(/\\/g, '\\\\').replace(/'/g, "\\'");
                return '<div style="padding: 10px 12px; cursor: pointer;" onclick="selectUser(\'' + name + '\')">' + u.name + '</div>';
            }).join('');
            suggestions.style.display = 'block';
        } else {
            suggestions.innerHTML = '<div style="padding: 10px 12px; color: #999;">æ— åŒ¹é…ç”¨æˆ·</div>';
            suggestions.style.display = 'block';
        }
    });

    document.addEventListener('click', e => {
        if (!e.target.closest('#transferTo') && !e.target.closest('#userSuggestions')) {
            suggestions.style.display = 'none';
        }
    });
}

function selectUser(name) {
    const transferToEl = document.getElementById('transferTo');
    const suggestionsEl = document.getElementById('userSuggestions');
    if (transferToEl) transferToEl.value = name;
    if (suggestionsEl) suggestionsEl.style.display = 'none';
}

// æäº¤å½’è¿˜
function submitReturn() {
    const reasonEl = document.querySelector('input[name="returnReason"]:checked');
    const remarkEl = document.getElementById('returnRemark');

    if (!reasonEl) { showToast('è¯·é€‰æ‹©å½’è¿˜åŸå› '); return; }

    const reason = reasonEl.value;
    const remark = remarkEl ? remarkEl.value.trim() : '';
    const fullRemark = reason + (remark ? ' - ' + remark : '');

    const check1 = document.getElementById('check1');
    const check2 = document.getElementById('check2');
    const check3 = document.getElementById('check3');
    if ((!check1 || !check1.checked) || (!check2 || !check2.checked) || (!check3 || !check3.checked)) {
        showToast('è¯·ç¡®è®¤æ‰€æœ‰æ£€æŸ¥é¡¹'); return;
    }

    fetch('/api/return', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({device_id: currentDeviceId, reason: fullRemark})
    }).then(r => r.json()).then(data => {
        if (data.success) { showToast('å½’è¿˜æˆåŠŸï¼'); setTimeout(() => window.location.href = '/pc', 1000); }
        else { showToast(data.message || 'å½’è¿˜å¤±è´¥'); }
    }).catch(() => showToast('æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•'));
}

// æäº¤è½¬å€Ÿ
function submitTransfer() {
    const toEl = document.getElementById('transferTo');
    const remarkEl = document.getElementById('transferRemark');
    if (!toEl) { showToast('é¡µé¢å…ƒç´ é”™è¯¯'); return; }

    const to = toEl.value.trim();
    const remark = remarkEl ? remarkEl.value.trim() : '';
    if (!to) { showToast('è¯·é€‰æ‹©è½¬å€Ÿäºº'); return; }

    if (!allUsers.some(u => u.name === to)) { showToast('è¯¥ç”¨æˆ·ä¸å­˜åœ¨ï¼Œè¯·ä»åˆ—è¡¨ä¸­é€‰æ‹©'); return; }

    fetch('/api/transfer', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({device_id: currentDeviceId, transfer_to: to, remark: remark})
    }).then(r => r.json()).then(data => {
        if (data.success) { showToast('è½¬å€ŸæˆåŠŸ'); setTimeout(() => window.location.href = '/pc', 1000); }
        else { showToast(data.message || 'è½¬å€Ÿå¤±è´¥'); }
    }).catch(() => showToast('æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•'));
    closeModal('transferModal');
}

// æäº¤ç»­å€Ÿ
function submitRenew() {
    const dateEl = document.getElementById('renewDate');
    if (!dateEl || !dateEl.value) { showToast('è¯·é€‰æ‹©ç»­æœŸæ—¥æœŸ'); return; }
    const date = dateEl.value;
    const today = new Date().toISOString().split('T')[0];
    if (date < today) { showToast('ç»­æœŸæ—¥æœŸä¸èƒ½æ—©äºä»Šå¤©'); return; }

    fetch('/api/renew', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({device_id: currentDeviceId, new_return_date: date})
    }).then(r => r.json()).then(data => {
        if (data.success) { showToast('ç»­æœŸæˆåŠŸ'); setTimeout(() => location.reload(), 1000); }
        else { showToast(data.message || 'ç»­æœŸå¤±è´¥'); }
    }).catch(() => showToast('æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•'));
    closeModal('renewModal');
}

// å¼¹çª—æ§åˆ¶
function openModal(id) { document.getElementById(id).classList.add('active'); }
function closeModal(id) { document.getElementById(id).classList.remove('active'); }

// è·å–å½“å‰é¡µé¢çš„æ‰€æœ‰é€šçŸ¥æ•°æ®
const allNotifications = [
    {% if notifications is defined and notifications %}
        {% for item in notifications %}
        {
            id: '{{ item.device_name }}_{{ item.borrower }}_{{ item.time.timestamp()|string }}',
            device_type: '{{ item.device_type }}',
            device_name: '{{ item.device_name }}',
            borrower: '{{ item.borrower }}',
            type: '{{ item.type }}',
            time: '{{ item.time.strftime("%Y-%m-%d %H:%M:%S") }}',
            reason: '{{ item.reason if item.reason is defined else "" }}'
        }{{ "," if not loop.last }}
        {% endfor %}
    {% endif %}
];

// ä»LocalStorageè·å–å·²è¯»é€šçŸ¥ID
function getReadNotificationIds() {
    const readIds = localStorage.getItem('read_notification_ids');
    return readIds ? JSON.parse(readIds) : [];
}

// ä¿å­˜å·²è¯»é€šçŸ¥IDåˆ°LocalStorage
function saveReadNotificationId(id) {
    const readIds = getReadNotificationIds();
    if (!readIds.includes(id)) {
        readIds.push(id);
        localStorage.setItem('read_notification_ids', JSON.stringify(readIds));
    }
}

// æ ‡è®°æ‰€æœ‰å½“å‰é€šçŸ¥ä¸ºå·²è¯»
function markAllAsRead() {
    allNotifications.forEach(notification => {
        saveReadNotificationId(notification.id);
    });
    updateNotificationBadge();
}

// æ›´æ–°è§’æ ‡æ˜¾ç¤º
function updateNotificationBadge() {
    const readIds = getReadNotificationIds();
    const unreadCount = allNotifications.filter(n => !readIds.includes(n.id)).length;
    const badge = document.getElementById('notificationBadge');
    if (unreadCount > 0) {
        badge.textContent = unreadCount;
        badge.style.display = 'block';
    } else {
        badge.style.display = 'none';
    }
}

// æ¸²æŸ“é€šçŸ¥åˆ—è¡¨
function renderNotifications() {
    const body = document.getElementById('notificationBody');
    if (allNotifications.length === 0) {
        body.innerHTML = `
            <div class="notification-empty">
                <div class="empty-icon">ğŸ“­</div>
                <p>æš‚æ— é€šçŸ¥</p>
            </div>
        `;
        return;
    }

    let html = '';
    allNotifications.forEach(notification => {
        let content = '';
        if (notification.type === 'ä¿ç®¡-è¢«åŠ¨') {
            content = `æˆ‘ä¿ç®¡çš„${notification.device_type}ï¼Œ<strong>${notification.device_name}</strong>è¢«<strong>${notification.borrower}</strong>å€Ÿèµ°`;
        } else if (notification.type === 'å€Ÿç”¨-è¢«åŠ¨') {
            content = `æˆ‘æ­£åœ¨å€Ÿç”¨çš„${notification.device_type}ï¼Œ<strong>${notification.device_name}</strong>è¢«<strong>${notification.borrower}</strong>è½¬èµ°`;
        } else if (notification.type === 'å€Ÿç”¨-ä¸»åŠ¨') {
            content = `æˆ‘è½¬å€Ÿç»™äº†<strong>${notification.borrower}</strong>${notification.device_type}ï¼Œ<strong>${notification.device_name}</strong>`;
        } else if (notification.type === 'è®¾å¤‡æŠ¥åºŸ') {
            content = `æˆ‘å€Ÿç”¨çš„${notification.device_type}ï¼Œ<strong>${notification.device_name}</strong>å·²è¢«ç®¡ç†å‘˜<span style="color: #ff4d4f;">æŠ¥åºŸ</span>ï¼Œå·²è‡ªåŠ¨å½’è¿˜`;
        } else if (notification.type === 'çŠ¶æ€å˜æ›´') {
            content = `ç®¡ç†å‘˜å°†æˆ‘${notification.device_type}ï¼Œ<strong>${notification.device_name}</strong>çš„çŠ¶æ€æ›´æ”¹ä¸º${notification.reason || ''}`;
        } else if (notification.type === 'ä¿ç®¡äººå˜æ›´') {
            content = `ç®¡ç†å‘˜å°†${notification.device_type}ï¼Œ<strong>${notification.device_name}</strong>çš„ä¿ç®¡äººå˜æ›´ï¼š${notification.reason || ''}`;
        }

        html += `
            <div class="notification-item">
                <div class="notification-content">${content}</div>
                <div class="notification-time">${notification.time}</div>
            </div>
        `;
    });
    body.innerHTML = html;
}

function toggleNotificationModal() {
    const modal = document.getElementById('notificationModal');
    modal.classList.toggle('active');
    // æ‰“å¼€å¼¹çª—æ—¶æ ‡è®°ä¸ºå·²è¯»
    if (modal.classList.contains('active')) {
        markAllAsRead();
    }
}

// ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
document.addEventListener('click', function(event) {
    const modal = document.getElementById('notificationModal');
    const bell = document.querySelector('.notification-bell');
    if (modal && modal.classList.contains('active') && !modal.contains(event.target) && !bell.contains(event.target)) {
        modal.classList.remove('active');
    }
});

// é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    loadUsers();
    renderNotifications();
    updateNotificationBadge();
});

// ==================== è®¾å¤‡æœç´¢åŠŸèƒ½ ====================
let searchTimeout = null;
let allDevices = [];

// åŠ è½½æ‰€æœ‰è®¾å¤‡æ•°æ®
function loadAllDevices() {
    fetch('/api/search?keyword=')
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                allDevices = data.devices || [];
            }
        })
        .catch(() => {});
}

// å¤„ç†æœç´¢è¾“å…¥ï¼ˆæ¨¡ç³Šæœç´¢æ˜¾ç¤ºå»ºè®®ï¼‰
function handleDeviceSearchInput(keyword) {
    const suggestionsBox = document.getElementById('searchSuggestions');
    
    if (!keyword.trim()) {
        suggestionsBox.style.display = 'none';
        return;
    }
    
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
        const keywordLower = keyword.toLowerCase().replace(/\s+/g, '');
        const matched = allDevices.filter(d => {
            const deviceName = (d.name || '').toLowerCase().replace(/\s+/g, '');
            const deviceModel = (d.model || '').toLowerCase().replace(/\s+/g, '');
            return deviceName.includes(keywordLower) || deviceModel.includes(keywordLower);
        }).slice(0, 10); // æœ€å¤šæ˜¾ç¤º10æ¡
        
        if (matched.length > 0) {
            suggestionsBox.innerHTML = matched.map(d => {
                const icon = d.device_type === 'è½¦æœº' ? 'ğŸš—' : 
                            d.device_type === 'æ‰‹æœº' ? 'ğŸ“±' : 
                            d.device_type === 'ä»ªè¡¨' ? 'ğŸ“Š' : 
                            d.device_type === 'æ‰‹æœºå¡' ? 'ğŸ“²' : 'ğŸ”§';
                const safeName = d.name.replace(/'/g, "\\'").replace(/"/g, '\\"');
                return `<div class="suggestion-item" data-id="${d.id}" data-type="${d.device_type}" data-name="${safeName}" 
                            style="padding: 10px 12px; cursor: pointer; display: flex; align-items: center; gap: 8px; border-bottom: 1px solid #f0f0f0; hover: background-color: #f5f5f5;">
                            <span>${icon}</span>
                            <div style="flex: 1;">
                                <div style="font-weight: 500;">${escapeHtml(d.name)}</div>
                                <div style="font-size: 12px; color: #8c8c8c;">${d.model || ''} ${d.device_type}</div>
                            </div>
                        </div>`;
            }).join('');
            
            // ç»‘å®šç‚¹å‡»äº‹ä»¶
            suggestionsBox.querySelectorAll('.suggestion-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const id = this.getAttribute('data-id');
                    const type = this.getAttribute('data-type');
                    const name = this.getAttribute('data-name');
                    document.getElementById('deviceSearchInput').value = name;
                    document.getElementById('searchSuggestions').style.display = 'none';
                    window.location.href = `/pc/device/${id}?device_type=${encodeURIComponent(type)}`;
                });
            });
            
            suggestionsBox.style.display = 'block';
        } else {
            suggestionsBox.innerHTML = '<div style="padding: 10px 12px; color: #999;">æ— åŒ¹é…è®¾å¤‡</div>';
            suggestionsBox.style.display = 'block';
        }
    }, 200);
}

// å¤„ç†é”®ç›˜äº‹ä»¶
function handleDeviceSearchKeydown(event) {
    if (event.key === 'Enter') {
        searchDevice();
    }
}

// é€‰æ‹©è®¾å¤‡ï¼ˆç‚¹å‡»å»ºè®®ï¼‰
function selectDevice(deviceId, deviceType, deviceName) {
    const input = document.getElementById('deviceSearchInput');
    input.value = deviceName;
    document.getElementById('searchSuggestions').style.display = 'none';
    // è·³è½¬åˆ°è®¾å¤‡è¯¦æƒ…
    window.location.href = `/pc/device/${deviceId}?device_type=${encodeURIComponent(deviceType)}`;
}

// ç‚¹å‡»å»ºè®®é¡¹ï¼ˆé˜²æ­¢äº‹ä»¶å†’æ³¡ï¼‰
function onSuggestionClick(event, deviceId, deviceType, deviceName) {
    event.stopPropagation();
    event.preventDefault();
    selectDevice(deviceId, deviceType, deviceName);
    return false;
}

// æœç´¢æŒ‰é’®ç‚¹å‡»
function searchDevice() {
    const keyword = document.getElementById('deviceSearchInput').value.trim();
    if (!keyword) {
        showToast('è¯·è¾“å…¥è®¾å¤‡å·æˆ–å‹å·');
        return;
    }
    
    // æ£€æŸ¥è®¾å¤‡æ•°æ®æ˜¯å¦å·²åŠ è½½
    if (allDevices.length === 0) {
        showToast('è®¾å¤‡æ•°æ®åŠ è½½ä¸­ï¼Œè¯·ç¨åå†è¯•');
        // é‡æ–°åŠ è½½è®¾å¤‡æ•°æ®
        loadAllDevices();
        return;
    }
    
    // æ¨¡ç³ŠåŒ¹é…ï¼ˆåŒ…å«ç²¾ç¡®åŒ¹é…ï¼‰
    // ç§»é™¤æœç´¢å…³é”®è¯ä¸­çš„ç©ºæ ¼ï¼Œæé«˜åŒ¹é…æˆåŠŸç‡
    const keywordLower = keyword.toLowerCase().replace(/\s+/g, '');
    const matched = allDevices.filter(d => {
        const deviceName = (d.name || '').toLowerCase().replace(/\s+/g, '');
        const deviceModel = (d.model || '').toLowerCase().replace(/\s+/g, '');
        const nameMatch = deviceName.includes(keywordLower);
        const modelMatch = deviceModel.includes(keywordLower);
        return nameMatch || modelMatch;
    });
    
    if (matched.length === 0) {
        showToast('æ— æ­¤è®¾å¤‡');
    } else if (matched.length === 1) {
        // åªæœ‰ä¸€ä¸ªåŒ¹é…ï¼Œç›´æ¥è·³è½¬
        window.location.href = `/pc/device/${matched[0].id}?device_type=${encodeURIComponent(matched[0].device_type)}`;
    } else {
        // æ£€æŸ¥æ˜¯å¦æœ‰ç²¾ç¡®åŒ¹é…ï¼ˆå¿½ç•¥ç©ºæ ¼ï¼‰
        const exactMatch = matched.find(d => {
            const deviceName = (d.name || '').toLowerCase().replace(/\s+/g, '');
            return deviceName === keywordLower;
        });
        if (exactMatch) {
            window.location.href = `/pc/device/${exactMatch.id}?device_type=${encodeURIComponent(exactMatch.device_type)}`;
            return;
        }
        // å¤šä¸ªåŒ¹é…ï¼Œæ˜¾ç¤ºå»ºè®®åˆ—è¡¨
        const suggestionsBox = document.getElementById('searchSuggestions');
        suggestionsBox.innerHTML = matched.map(d => {
            const icon = d.device_type === 'è½¦æœº' ? 'ğŸš—' : 
                        d.device_type === 'æ‰‹æœº' ? 'ğŸ“±' : 
                        d.device_type === 'ä»ªè¡¨' ? 'ğŸ“Š' : 
                        d.device_type === 'æ‰‹æœºå¡' ? 'ğŸ“²' : 'ğŸ”§';
            const safeName = d.name.replace(/'/g, "\\'").replace(/"/g, '\\"');
            return `<div class="suggestion-item" data-id="${d.id}" data-type="${d.device_type}" data-name="${safeName}" 
                        style="padding: 10px 12px; cursor: pointer; display: flex; align-items: center; gap: 8px; border-bottom: 1px solid #f0f0f0;">
                        <span>${icon}</span>
                        <div style="flex: 1;">
                            <div style="font-weight: 500;">${escapeHtml(d.name)}</div>
                            <div style="font-size: 12px; color: #8c8c8c;">${d.model || ''} ${d.device_type}</div>
                        </div>
                    </div>`;
        }).join('');
        
        // ç»‘å®šç‚¹å‡»äº‹ä»¶
        suggestionsBox.querySelectorAll('.suggestion-item').forEach(item => {
            item.addEventListener('click', function(e) {
                e.stopPropagation();
                const id = this.getAttribute('data-id');
                const type = this.getAttribute('data-type');
                const name = this.getAttribute('data-name');
                document.getElementById('deviceSearchInput').value = name;
                document.getElementById('searchSuggestions').style.display = 'none';
                window.location.href = `/pc/device/${id}?device_type=${encodeURIComponent(type)}`;
            });
        });
        
        suggestionsBox.style.display = 'block';
        showToast('æ‰¾åˆ°å¤šä¸ªåŒ¹é…è®¾å¤‡ï¼Œè¯·é€‰æ‹©');
    }
}

// ç‚¹å‡»å¤–éƒ¨å…³é—­å»ºè®®
 document.addEventListener('click', function(event) {
    const searchBox = document.getElementById('deviceSearchInput');
    const suggestionsBox = document.getElementById('searchSuggestions');
    if (searchBox && suggestionsBox && !searchBox.contains(event.target) && !suggestionsBox.contains(event.target)) {
        suggestionsBox.style.display = 'none';
    }
});

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// é¡µé¢åŠ è½½æ—¶è·å–è®¾å¤‡æ•°æ®
loadAllDevices();
</script>
{% endblock %}
