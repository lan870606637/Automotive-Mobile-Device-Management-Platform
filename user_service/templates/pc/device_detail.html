{% extends "pc/base_pc.html" %}

{% block title %}{{ device.name }} - è®¾å¤‡è¯¦æƒ…{% endblock %}

{% set active_nav = 'devices' %}

{% block content %}
<!-- é¡µé¢å¤´éƒ¨ -->
<div class="detail-header">
    <div class="detail-icon">
        {% if device_type == 'è½¦æœº' %}ğŸš—
        {% elif device_type == 'æ‰‹æœº' %}ğŸ“±
        {% elif device_type == 'ä»ªè¡¨' %}ğŸ“Š
        {% elif device_type == 'æ‰‹æœºå¡' %}ğŸ“²
        {% else %}ğŸ”§{% endif %}
    </div>
    <div class="detail-title">
        <h2>{{ device.name }}</h2>
        <div class="detail-meta">
            <span class="status-tag
                {% if device.status.value == 'åœ¨åº“' %}status-available
                {% elif device.status.value == 'ä¿ç®¡ä¸­' %}status-custody
                {% elif device.status.value == 'å€Ÿå‡º' %}status-borrowed
                {% elif device.status.value == 'å·²å¯„å‡º' %}status-shipped
                {% elif device.status.value == 'å·²æŸå' %}status-damaged
                {% elif device.status.value == 'ä¸¢å¤±' %}status-lost
                {% elif device.status.value == 'æŠ¥åºŸ' %}status-scrapped
                {% endif %}">
                {{ device.status.value }}
            </span>
            <span>{{ device_type }}</span>
        </div>
    </div>
</div>

<!-- è®¾å¤‡è¯¦æƒ…å’Œæ“ä½œ -->
<div class="detail-grid">
    <!-- å·¦ä¾§ï¼šè®¾å¤‡ä¿¡æ¯ + æ“ä½œæŒ‰é’® + ç”¨æˆ·å¤‡æ³¨ -->
    <div class="detail-main">
        <!-- è®¾å¤‡ä¿¡æ¯ -->
        <div class="card">
            <div class="card-header">
                <span class="card-title">ğŸ“‹ è®¾å¤‡ä¿¡æ¯</span>
            </div>
            <div class="card-body">
                <div class="info-row">
                    <span class="info-label">è®¾å¤‡ç±»å‹</span>
                    <span class="info-value">{{ device_type }}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">å‹å·</span>
                    <span class="info-value">{{ device.model or '-' }}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">å¤‡æ³¨</span>
                    <span class="info-value">{{ device.remark or '-' }}</span>
                </div>
                {% if device.jira_address %}
                <div class="info-row">
                    <span class="info-label">JIRAåœ°å€</span>
                    <span class="info-value">
                        <a href="http://jira.carbit.lo/browse/{{ device.jira_address }}" target="_blank" style="color: #1890ff; text-decoration: none;">{{ device.jira_address }}</a>
                    </span>
                </div>
                {% endif %}
                {% if device.project_attribute %}
                <div class="info-row">
                    <span class="info-label">é¡¹ç›®å±æ€§</span>
                    <span class="info-value">{{ device.project_attribute }}</span>
                </div>
                {% endif %}
                {% if device.connection_method %}
                <div class="info-row">
                    <span class="info-label">è¿æ¥æ–¹å¼</span>
                    <span class="info-value">{{ device.connection_method }}</span>
                </div>
                {% endif %}
                {% if device.os_version %}
                <div class="info-row">
                    <span class="info-label">ç³»ç»Ÿç‰ˆæœ¬</span>
                    <span class="info-value">{{ device.os_version }}</span>
                </div>
                {% endif %}
                {% if device.os_platform %}
                <div class="info-row">
                    <span class="info-label">ç³»ç»Ÿå¹³å°</span>
                    <span class="info-value">{{ device.os_platform }}</span>
                </div>
                {% endif %}
                {% if device.product_name %}
                <div class="info-row">
                    <span class="info-label">äº§å“åç§°</span>
                    <span class="info-value">{{ device.product_name }}</span>
                </div>
                {% endif %}
                {% if device.screen_orientation %}
                <div class="info-row">
                    <span class="info-label">å±å¹•æ–¹å‘</span>
                    <span class="info-value">{{ device.screen_orientation }}</span>
                </div>
                {% endif %}
                {% if device.screen_resolution %}
                <div class="info-row">
                    <span class="info-label">åˆ†è¾¨ç‡</span>
                    <span class="info-value">{{ device.screen_resolution }}</span>
                </div>
                {% endif %}
                {% if device.status.value == 'ä¸¢å¤±' %}
                <div class="info-row" style="color: #ff4d4f;">
                    <span class="info-label">ä¸¢å¤±æ—¶é—´</span>
                    <span class="info-value">{{ device.lost_time.strftime('%Y-%m-%d %H:%M') }}</span>
                </div>
                {% endif %}
                {% if device.status.value == 'å·²æŸå' %}
                <div class="info-row" style="color: #ff4d4f;">
                    <span class="info-label">æŸååŸå› </span>
                    <span class="info-value">{{ device.damage_reason }}</span>
                </div>
                <div class="info-row" style="color: #ff4d4f;">
                    <span class="info-label">æŸåæ—¶é—´</span>
                    <span class="info-value">{{ device.damage_time.strftime('%Y-%m-%d %H:%M') }}</span>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- æ“ä½œåŒº -->
        {% if device.status.value in ['åœ¨åº“', 'ä¿ç®¡ä¸­'] and is_custodian %}
        <div class="card">
            <div class="card-header">
                <span class="card-title">âš¡ ä¿ç®¡äººæ“ä½œ</span>
            </div>
            <div class="card-body">
                <div class="action-btns">
                    <button class="btn btn-primary btn-lg btn-block" onclick="openTransferModal()">è½¬å€Ÿä»–äºº</button>
                    <button class="btn btn-error btn-block" onclick="openReportLostModal()">âš ï¸ ä¸¢å¤±æŠ¥å¤‡</button>
                    <button class="btn btn-warning btn-block" onclick="openReportDamageModal()">ğŸ”§ æŸåæŠ¥å¤‡</button>
                </div>
            </div>
        </div>

        {% elif device.status.value in ['åœ¨åº“', 'ä¿ç®¡ä¸­'] %}
        <div class="card">
            <div class="card-header">
                <span class="card-title">âš¡ æ“ä½œ</span>
            </div>
            <div class="card-body" style="display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px 20px;">
                <button class="btn btn-primary" onclick="openBorrowModal()" style="font-size: 24px; padding: 20px 60px; border-radius: 12px; min-width: 200px;">æˆ‘è¦å€Ÿç”¨</button>
                <p style="font-size: 14px; color: #8c8c8c; margin-top: 20px; text-align: center;">å€Ÿç”¨åå¯æŸ¥çœ‹æŸœå·ä¿¡æ¯</p>
            </div>
        </div>

        {% elif device.status.value == 'å€Ÿå‡º' and is_borrower %}
        <div class="card">
            <div class="card-header">
                <span class="card-title">âš¡ å½’è¿˜/è½¬å€Ÿ</span>
            </div>
            <div class="card-body">
                <div class="action-btns">
                    <button class="btn btn-warning btn-lg btn-block" onclick="openReturnModal()">ç«‹å³å½’è¿˜</button>
                    <button class="btn btn-primary btn-block" onclick="openTransferModal()">è½¬å€Ÿä»–äºº</button>
                    {% if can_renew %}
                    <button class="btn btn-success btn-block" onclick="openRenewModal()">å€Ÿç”¨ç»­æœŸ</button>
                    {% else %}
                    <button class="btn btn-block" onclick="showToast('{{ renew_disabled_reason }}')" style="background: #d9d9d9; border-color: #d9d9d9; color: #8c8c8c; cursor: not-allowed;" title="{{ renew_disabled_reason }}">å€Ÿç”¨ç»­æœŸ</button>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="card">
            <div class="card-header">
                <span class="card-title">âš ï¸ å¼‚å¸¸æŠ¥å¤‡</span>
            </div>
            <div class="card-body">
                <div class="action-btns">
                    <button class="btn btn-error btn-block" onclick="openReportLostModal()">âš ï¸ ä¸¢å¤±æŠ¥å¤‡</button>
                    <button class="btn btn-warning btn-block" onclick="openReportDamageModal()">ğŸ”§ æŸåæŠ¥å¤‡</button>
                    {% if device_type == 'è½¦æœº' %}
                    <button class="btn btn-primary btn-block" onclick="openShipModal()">ğŸ“¦ å¯„å‡º</button>
                    {% endif %}
                    {% if device.previous_borrower %}
                    <button class="btn btn-error btn-block" onclick="confirmNotFound()">â” æœªæ‰¾åˆ°</button>
                    {% else %}
                    <button class="btn btn-error btn-block" onclick="confirmNotFoundDirect()">æœªæ‰¾åˆ°</button>
                    {% endif %}
                </div>
            </div>
        </div>

        {% elif device.status.value == 'å€Ÿå‡º' and is_custodian %}
        <div class="card">
            <div class="card-header">
                <span class="card-title">âš¡ ä¿ç®¡äººæ“ä½œ</span>
            </div>
            <div class="card-body">
                <div class="action-btns">
                    <button class="btn btn-warning btn-lg btn-block" onclick="confirmReturnByCustodian()">å¼ºåˆ¶å½’è¿˜</button>
                    <button class="btn btn-primary btn-block" onclick="openTransferModal()">è½¬å€Ÿä»–äºº</button>
                    <button class="btn btn-error btn-block" onclick="openReportLostModal()">âš ï¸ ä¸¢å¤±æŠ¥å¤‡</button>
                    <button class="btn btn-warning btn-block" onclick="openReportDamageModal()">ğŸ”§ æŸåæŠ¥å¤‡</button>
                </div>
            </div>
        </div>

        {% elif device.status.value == 'å€Ÿå‡º' and not is_borrower %}
        <div class="card">
            <div class="card-header">
                <span class="card-title">âš¡ æ“ä½œ</span>
            </div>
            <div class="card-body">
                <div class="action-btns">
                    <button class="btn btn-default btn-lg btn-block" disabled>è®¾å¤‡å·²å€Ÿå‡º</button>
                    <button class="btn btn-primary btn-block" onclick="confirmTransferToMe()">è½¬ç»™è‡ªå·±</button>
                </div>
            </div>
        </div>

        {% elif device.status.value == 'ä¸¢å¤±' %}
        <div class="card">
            <div class="card-header">
                <span class="card-title">âš¡ æ“ä½œ</span>
            </div>
            <div class="card-body">
                <div class="action-btns">
                    <button class="btn btn-default btn-lg btn-block" disabled>è®¾å¤‡å·²ä¸¢å¤±</button>
                    <button class="btn btn-success btn-block" onclick="openFoundModal()">æˆ‘å·²æ‰¾åˆ°</button>
                </div>
            </div>
        </div>

        {% elif device.status.value == 'å·²æŸå' %}
        <div class="card">
            <div class="card-header">
                <span class="card-title">âš¡ æ“ä½œ</span>
            </div>
            <div class="card-body">
                <div class="action-btns">
                    <button class="btn btn-default btn-lg btn-block" disabled>è®¾å¤‡å·²æŸå</button>
                    <button class="btn btn-warning btn-block" onclick="openRepairedModal()">æˆ‘å·²ä¿®å¥½</button>
                </div>
            </div>
        </div>

        {% elif device.status.value == 'å·²å¯„å‡º' %}
        <div class="card">
            <div class="card-header">
                <span class="card-title">ğŸ“¦ è®¾å¤‡çŠ¶æ€</span>
            </div>
            <div class="card-body">
                <button class="btn btn-default btn-lg btn-block" disabled>è®¾å¤‡å·²å¯„å‡º</button>
                <button class="btn btn-warning btn-block" onclick="confirmUnship()">ğŸ“¦ æœªå¯„å‡ºï¼ˆè¿˜åŸï¼‰</button>
            </div>
        </div>

        {% elif device.status.value == 'æŠ¥åºŸ' %}
        <div class="card">
            <div class="card-header">
                <span class="card-title">ğŸš« è®¾å¤‡çŠ¶æ€</span>
            </div>
            <div class="card-body">
                <button class="btn btn-default btn-lg btn-block" disabled>è®¾å¤‡å·²æŠ¥åºŸ</button>
            </div>
        </div>
        {% endif %}

        <!-- ç”¨æˆ·å¤‡æ³¨ -->
        <div class="card">
            <div class="card-header">
                <span class="card-title">ğŸ“ ç”¨æˆ·å¤‡æ³¨</span>
                <button class="btn btn-primary btn-sm" onclick="openAddRemarkModal()">+ æ·»åŠ å¤‡æ³¨</button>
            </div>
            <div class="card-body">
                {% if remarks %}
                <div class="remarks-list">
                    {% for remark in remarks %}
                    <div class="remark-item" data-remark-id="{{ remark.id }}">
                        <div class="remark-content">{{ remark.content | e }}</div>
                        <div class="remark-meta">
                            <span class="remark-author">{{ remark.creator }}</span>
                            <span>{{ remark.create_time }}</span>
                            {% if remark.is_creator %}
                            <div class="remark-actions">
                                <a href="javascript:void(0)" onclick="openEditRemarkModalFromElement(this)">ç¼–è¾‘</a>
                                <a href="javascript:void(0)" class="delete" onclick="deleteRemarkFromElement(this)">åˆ é™¤</a>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="empty-state" style="padding: 40px;">
                    <p class="empty-title">æš‚æ— å¤‡æ³¨</p>
                    <button class="btn btn-primary" onclick="openAddRemarkModal()">æ·»åŠ ç¬¬ä¸€æ¡å¤‡æ³¨</button>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- æŸ¥çœ‹è®°å½• -->
        <div class="card">
            <div class="card-header">
                <span class="card-title">ğŸ‘ï¸ æŸ¥çœ‹è®°å½•</span>
                <span style="font-size: 12px; color: #8c8c8c;">æœ€è¿‘20æ¡</span>
            </div>
            <div class="card-body">
                {% if view_records %}
                <div class="timeline">
                    {% for vr in view_records %}
                    <div class="timeline-item">
                        <div class="timeline-dot"></div>
                        <div class="timeline-content">
                            <div class="timeline-header">
                                <span class="timeline-device">{{ vr.viewer }}{% if is_admin_user(vr.viewer) %}<span class="status-tag status-lost" style="margin-left: 4px; font-size: 10px; padding: 1px 4px;">ç®¡</span>{% endif %}</span>
                                <span class="timeline-time">{{ vr.view_time[:19] }}</span>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="empty-state" style="padding: 40px;">
                    <p class="empty-title">æš‚æ— æŸ¥çœ‹è®°å½•</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- å³ä¾§ï¼šç™»è®°åæŸ¥çœ‹/å€Ÿç”¨ä¿¡æ¯ + å€Ÿç”¨è®°å½• -->
    <div class="detail-sidebar">
        {% if device.status.value == 'åœ¨åº“' and not is_custodian %}
        <!-- åœ¨åº“çŠ¶æ€ï¼šé”å®šä¿¡æ¯ -->
        <div class="card">
            <div class="card-header">
                <span class="card-title">ğŸ”’ ç™»è®°åæŸ¥çœ‹</span>
            </div>
            <div class="card-body" style="color: #8c8c8c; background: #fafafa; border-radius: 8px;">
                <p>â€¢ {% if device_type == 'è½¦æœº' or device_type == 'ä»ªè¡¨' %}æŸœå·{% else %}ä¿ç®¡äºº{% endif %}ï¼š***</p>
                <p>â€¢ å€Ÿç”¨è®°å½•ï¼š***</p>
                <p style="color: #1890ff; margin-top: 12px;">å€Ÿç”¨æˆåŠŸåå¯æŸ¥çœ‹å®Œæ•´ä¿¡æ¯</p>
            </div>
        </div>
        {% endif %}

        {% if device.status.value == 'åœ¨åº“' and is_custodian %}
        <!-- ä¿ç®¡äººæŸ¥çœ‹åœ¨åº“è®¾å¤‡ï¼šæ˜¾ç¤ºå®Œæ•´ä¿¡æ¯ -->
        <div class="card">
            <div class="card-header">
                <span class="card-title">ğŸ“‹ è®¾å¤‡ä¿¡æ¯</span>
            </div>
            <div class="card-body">
                <div class="info-row">
                    <span class="info-label">{% if device_type == 'è½¦æœº' or device_type == 'ä»ªè¡¨' %}æŸœå·{% else %}ä¿ç®¡äºº{% endif %}</span>
                    <span class="info-value" style="color: #1890ff; font-size: 16px; font-weight: 600;">{{ device.cabinet_number }}</span>
                </div>
            </div>
        </div>
        {% endif %}

        {% if device.status.value == 'å·²å¯„å‡º' %}
        <!-- å·²å¯„å‡ºçŠ¶æ€ï¼šå¯„å‡ºä¿¡æ¯ -->
        <div class="card">
            <div class="card-header">
                <span class="card-title">ğŸ“¦ å¯„å‡ºä¿¡æ¯</span>
            </div>
            <div class="card-body">
                <div class="info-row">
                    <span class="info-label">çŠ¶æ€</span>
                    <span class="info-value"><span class="status-tag status-shipped">å·²å¯„å‡º</span></span>
                </div>
                <div class="info-row">
                    <span class="info-label">å€Ÿç”¨äºº</span>
                    <span class="info-value">{{ device.pre_ship_borrower or '-' }}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">å¯„å‡ºäºº</span>
                    <span class="info-value">{{ device.ship_by or '-' }}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">å¯„å‡ºæ—¶é—´</span>
                    <span class="info-value">{{ device.ship_time.strftime('%Y-%m-%d %H:%M') if device.ship_time else '-' }}</span>
                </div>
                {% if device.ship_remark %}
                <div class="info-row">
                    <span class="info-label">å¤‡æ³¨</span>
                    <span class="info-value">{{ device.ship_remark }}</span>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}

        {% if device.status.value == 'å€Ÿå‡º' %}
        <!-- å€Ÿå‡ºçŠ¶æ€ï¼šå€Ÿç”¨ä¿¡æ¯ -->
        <div class="card">
            <div class="card-header">
                <span class="card-title">
                    {% if is_borrower %}âœ… æ‚¨æ­£åœ¨å€Ÿç”¨æ­¤è®¾å¤‡{% else %}ğŸ“¤ å½“å‰å€Ÿç”¨ä¿¡æ¯{% endif %}
                </span>
            </div>
            <div class="card-body">
                {% if is_borrower or is_custodian %}
                <div class="info-row" style="background: #e6f7ff; padding: 12px; border-radius: 8px; margin-bottom: 12px;">
                    <span class="info-label">ğŸ“ {% if device_type == 'è½¦æœº' or device_type == 'ä»ªè¡¨' %}æŸœå·{% else %}ä¿ç®¡äºº{% endif %}</span>
                    <span class="info-value" style="color: #1890ff; font-size: 18px; font-weight: 600;">{{ device.cabinet_number }}</span>
                </div>
                {% if is_borrower %}
                <div style="margin-bottom: 16px;">
                    <button class="btn btn-primary" onclick="openCabinetMapModal()">ğŸ—ºï¸ æŸ¥çœ‹æŸœå­ä½ç½®å›¾</button>
                </div>
                {% endif %}
                {% endif %}
                <div class="info-row">
                    <span class="info-label">å€Ÿç”¨äºº</span>
                    <span class="info-value">{{ device.borrower }}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">å€Ÿç”¨æ—¶é—´</span>
                    <span class="info-value">{{ device.borrow_time.strftime('%Y-%m-%d %H:%M') }}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">å€Ÿç”¨åŸå› </span>
                    <span class="info-value">{{ device.reason or '-' }}</span>
                </div>
                {% if device.expected_return_date %}
                <div class="info-row">
                    <span class="info-label">é¢„è®¡å½’è¿˜</span>
                    <span class="info-value" {% if is_overdue %}style="color: #ff4d4f; font-weight: 500;"{% endif %}>
                        {{ device.expected_return_date.strftime('%Y-%m-%d %H:%M') }}
                        {% if is_overdue %}
                        <span style="margin-left: 8px;">âš ï¸ å·²é€¾æœŸ {% if overdue_hours < 24 %}{{ overdue_hours }} å°æ—¶{% else %}{{ overdue_days }} å¤©{% endif %}</span>
                        {% else %}
                        <span style="margin-left: 8px; color: #52c41a;">â° è¿˜å‰©{% if remaining_days > 0 %}{{ remaining_days }} å¤©{% else %}{{ remaining_hours }} å°æ—¶{% endif %}</span>
                        {% endif %}
                    </span>
                </div>
                {% endif %}
                {% if device.previous_borrower %}
                <div class="info-row" style="background: #fff7e6; padding: 12px; border-radius: 8px; margin-top: 12px;">
                    <span class="info-label">ä¸Šä¸€ä¸ªå€Ÿç”¨äºº</span>
                    <span class="info-value">{{ device.previous_borrower }}</span>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- å€Ÿç”¨è®°å½• -->
        <div class="card">
            <div class="card-header">
                <span class="card-title">ğŸ“‹ å€Ÿç”¨è®°å½•</span>
            </div>
            <div class="card-body">
                {% if records %}
                <div class="timeline">
                    {% for record in records %}
                    <div class="timeline-item">
                        <div class="timeline-dot
                            {% if 'å€Ÿå‡º' in record.operation_type %}borrow
                            {% elif 'å½’è¿˜' in record.operation_type %}return
                            {% else %}lost{% endif %}"></div>
                        <div class="timeline-content">
                            <div class="timeline-header">
                                <span class="timeline-device">
                                    <span class="status-tag
                                        {% if 'å€Ÿå‡º' in record.operation_type %}status-borrowed
                                        {% elif 'å½’è¿˜' in record.operation_type %}status-available
                                        {% elif 'ä¸¢å¤±' in record.operation_type or 'æŸå' in record.operation_type %}status-lost
                                        {% elif 'ç»­æœŸ' in record.operation_type %}status-available
                                        {% else %}status-borrowed{% endif %}">
                                        {{ record.operation_type }}
                                    </span>
                                </span>
                                <span class="timeline-time">{{ record.operation_time[:19] }}</span>
                            </div>
                            <div style="margin-top: 4px; font-size: 13px; color: #595959;">
                                {{ record.borrower }}
                                {% if record.entry_source == 'ç®¡ç†å‘˜å½•å…¥' %}
                                <span class="status-tag status-no-cabinet" style="margin-left: 4px; font-size: 10px; padding: 1px 4px;">ç®¡</span>
                                {% endif %}
                            </div>
                            {% if record.reason and record.reason != 'nan' %}
                            <div style="margin-top: 4px; font-size: 13px; color: #595959;">
                                åŸå› ï¼š{{ record.reason }}
                            </div>
                            {% endif %}
                            {% if record.remark and record.remark != 'nan' %}
                            <div style="margin-top: 4px; font-size: 13px; color: #595959;">
                                å¤‡æ³¨ï¼š{{ record.remark }}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="empty-state" style="padding: 40px;">
                    <p class="empty-title">æš‚æ— è®°å½•</p>
                </div>
                {% endif %}
            </div>
        </div>

    </div>
</div>

<!-- å¼¹çª—ï¼šå€Ÿç”¨ -->
<div class="modal-overlay" id="borrowModal">
    <div class="modal">
        <div class="modal-header">
            <span class="modal-title">ğŸ“¥ å€Ÿç”¨ç™»è®°</span>
            <button class="modal-close" onclick="closeModal('borrowModal')">Ã—</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label">å€Ÿç”¨äºº</label>
                <input type="text" class="form-input" value="{{ user.borrower_name }}" readonly>
            </div>
            <div class="form-group">
                <label class="form-label">å€Ÿç”¨åŸå› </label>
                <div class="radio-group">
                    <label class="radio-item"><input type="radio" name="borrowReason" value="æµ‹è¯•" checked><span>æµ‹è¯•</span></label>
                    <label class="radio-item"><input type="radio" name="borrowReason" value="å¼€å‘"><span>å¼€å‘</span></label>
                    <label class="radio-item"><input type="radio" name="borrowReason" value="æ¼”ç¤º"><span>æ¼”ç¤º</span></label>
                    <label class="radio-item"><input type="radio" name="borrowReason" value="å‡ºå·®"><span>å‡ºå·®</span></label>
                    <label class="radio-item"><input type="radio" name="borrowReason" value="å…¶ä»–"><span>å…¶ä»–</span></label>
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">è¯¦ç»†è¯´æ˜</label>
                <textarea id="borrowDetail" class="form-textarea" rows="2">ç”¨äºåŠŸèƒ½æµ‹è¯•</textarea>
            </div>
            <div class="form-group">
                <label class="form-label">é¢„è®¡å½’è¿˜æ—¥æœŸ</label>
                <input type="date" id="returnDate" class="form-input">
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-default" onclick="closeModal('borrowModal')">å–æ¶ˆ</button>
            <button class="btn btn-primary" onclick="submitBorrow()">ç¡®è®¤å€Ÿç”¨</button>
        </div>
    </div>
</div>

<!-- å¼¹çª—ï¼šå½’è¿˜ -->
<div class="modal-overlay" id="returnModal">
    <div class="modal">
        <div class="modal-header">
            <span class="modal-title">ğŸ“¤ å½’è¿˜ç¡®è®¤</span>
            <button class="modal-close" onclick="closeModal('returnModal')">Ã—</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label">å½’è¿˜åŸå› </label>
                <div class="radio-group">
                    <label class="radio-item"><input type="radio" name="returnReason" value="æ­£å¸¸å½’è¿˜" checked><span>æ­£å¸¸å½’è¿˜</span></label>
                    <label class="radio-item"><input type="radio" name="returnReason" value="è®¾å¤‡æ”¶å›"><span>è®¾å¤‡æ”¶å›</span></label>
                    <label class="radio-item"><input type="radio" name="returnReason" value="è½¬å€Ÿä»–äºº"><span>è½¬å€Ÿä»–äºº</span></label>
                    <label class="radio-item"><input type="radio" name="returnReason" value="å…¶ä»–"><span>å…¶ä»–</span></label>
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">å½’è¿˜å¤‡æ³¨</label>
                <textarea id="returnRemark" class="form-textarea" rows="2">è®¾å¤‡å®Œå¥½ï¼Œæ— å¼‚å¸¸</textarea>
            </div>
            <div style="background: #f6ffed; padding: 16px; border-radius: 8px; margin-top: 16px;">
                <p style="font-weight: 500; margin-bottom: 12px;">âœ“ å½’è¿˜å‰è¯·ç¡®è®¤ï¼š</p>
                <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                    <input type="checkbox" id="check1" checked> è®¾å¤‡å¤–è§‚å®Œå¥½ï¼Œæ— æ˜æ˜¾æŸå
                </label>
                <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                    <input type="checkbox" id="check2" checked> é…ä»¶é½å…¨ï¼ˆå……ç”µå™¨ã€æ•°æ®çº¿ç­‰ï¼‰
                </label>
                <label style="display: flex; align-items: center; gap: 8px;">
                    <input type="checkbox" id="check3" checked> å·²æ¸…é™¤è®¾å¤‡ä¸­çš„ä¸ªäººæ•°æ®
                </label>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-default" onclick="closeModal('returnModal')">å–æ¶ˆ</button>
            <button class="btn btn-warning" onclick="submitReturn()">ç¡®è®¤å½’è¿˜</button>
        </div>
    </div>
</div>

<!-- å¼¹çª—ï¼šè½¬å€Ÿ -->
<div class="modal-overlay" id="transferModal">
    <div class="modal">
        <div class="modal-header">
            <span class="modal-title">ğŸ”„ è½¬å€Ÿè®¾å¤‡</span>
            <button class="modal-close" onclick="closeModal('transferModal')">Ã—</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label">è½¬å€Ÿç»™ <span style="color: #ff4d4f;">*</span></label>
                <input type="text" id="transferTo" class="form-input" placeholder="è¾“å…¥å§“åæœç´¢..." autocomplete="off">
                <div id="userSuggestions" style="background: #fff; border: 1px solid #d9d9d9; border-radius: 4px; max-height: 200px; overflow-y: auto; display: none; margin-top: 4px;"></div>
            </div>
            <div class="form-group">
                <label class="form-label">å¤‡æ³¨</label>
                <textarea id="transferRemark" class="form-textarea" rows="2" placeholder="å¯é€‰ï¼šæ·»åŠ è½¬å€Ÿå¤‡æ³¨"></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-default" onclick="closeModal('transferModal')">å–æ¶ˆ</button>
            <button class="btn btn-primary" onclick="submitTransfer()">ç¡®è®¤è½¬å€Ÿ</button>
        </div>
    </div>
</div>

<!-- å¼¹çª—ï¼šç»­æœŸ -->
<div class="modal-overlay" id="renewModal">
    <div class="modal">
        <div class="modal-header">
            <span class="modal-title">ğŸ“… å€Ÿç”¨ç»­æœŸ</span>
            <button class="modal-close" onclick="closeModal('renewModal')">Ã—</button>
        </div>
        <div class="modal-body">
            <p style="color: #8c8c8c; margin-bottom: 16px;">è®¾ç½®æ–°çš„é¢„è®¡å½’è¿˜æ—¶é—´ï¼ˆé»˜è®¤å¢åŠ 1å¤©ï¼‰ï¼š</p>
            <div class="form-group">
                <label class="form-label">æ–°é¢„è®¡å½’è¿˜æ—¥æœŸ</label>
                <input type="date" id="renewDate" class="form-input">
            </div>
            <div class="form-group" style="background: #f6ffed; padding: 12px 16px; border-radius: 8px; border: 1px solid #b7eb8f; margin-top: 12px;">
                <div style="display: flex; align-items: center; gap: 8px;">
                    <span style="color: #52c41a; font-size: 20px;">â°</span>
                    <span style="color: #389e0d; font-size: 14px;">å½“å‰é¢„è®¡å½’è¿˜æ—¶é—´ + <strong id="renewDays">1</strong> å¤©</span>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-default" onclick="closeModal('renewModal')">å–æ¶ˆ</button>
            <button class="btn btn-success" onclick="submitRenew()">ç¡®è®¤ç»­æœŸ</button>
        </div>
    </div>
</div>

<!-- å¼¹çª—ï¼šä¸¢å¤±æŠ¥å¤‡ -->
<div class="modal-overlay" id="reportLostModal">
    <div class="modal">
        <div class="modal-header">
            <span class="modal-title">âš ï¸ ä¸¢å¤±æŠ¥å¤‡</span>
            <button class="modal-close" onclick="closeModal('reportLostModal')">Ã—</button>
        </div>
        <div class="modal-body">
            <p>ç¡®å®šè¦æŠ¥å¤‡æ­¤è®¾å¤‡ä¸¢å¤±å—ï¼Ÿ</p>
            <p style="color: #8c8c8c; font-size: 13px; margin-top: 8px;">ä¸¢å¤±æ—¶é—´ï¼š{{ now }}</p>
        </div>
        <div class="modal-footer">
            <button class="btn btn-default" onclick="closeModal('reportLostModal')">å–æ¶ˆ</button>
            <button class="btn btn-error" onclick="submitReportLost()">ç¡®è®¤æŠ¥å¤‡</button>
        </div>
    </div>
</div>

<!-- å¼¹çª—ï¼šæŸåæŠ¥å¤‡ -->
<div class="modal-overlay" id="reportDamageModal">
    <div class="modal">
        <div class="modal-header">
            <span class="modal-title">ğŸ”§ æŸåæŠ¥å¤‡</span>
            <button class="modal-close" onclick="closeModal('reportDamageModal')">Ã—</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label">æŸååŸå› </label>
                <textarea id="damageReason" class="form-textarea" rows="3" placeholder="è¯·å¡«å†™æŸååŸå› "></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-default" onclick="closeModal('reportDamageModal')">å–æ¶ˆ</button>
            <button class="btn btn-warning" onclick="submitReportDamage()">ç¡®è®¤æŠ¥å¤‡</button>
        </div>
    </div>
</div>

<!-- å¼¹çª—ï¼šå¯„å‡º -->
<div class="modal-overlay" id="shipModal">
    <div class="modal">
        <div class="modal-header">
            <span class="modal-title">ğŸ“¦ è®¾å¤‡å¯„å‡º</span>
            <button class="modal-close" onclick="closeModal('shipModal')">Ã—</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label">å¯„å‡ºæ—¶é—´</label>
                <input type="datetime-local" id="shipTime" class="form-input">
            </div>
            <div class="form-group">
                <label class="form-label">å¤‡æ³¨</label>
                <textarea id="shipRemark" class="form-textarea" rows="3" placeholder="å¡«å†™å¯„å‡ºå¤‡æ³¨"></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-default" onclick="closeModal('shipModal')">å–æ¶ˆ</button>
            <button class="btn btn-primary" onclick="submitShip()">ç¡®è®¤å¯„å‡º</button>
        </div>
    </div>
</div>

<!-- å¼¹çª—ï¼šæˆ‘å·²æ‰¾åˆ° -->
<div class="modal-overlay" id="foundModal">
    <div class="modal">
        <div class="modal-header">
            <span class="modal-title">âœ… è®¾å¤‡å·²æ‰¾åˆ°</span>
            <button class="modal-close" onclick="closeModal('foundModal')">Ã—</button>
        </div>
        <div class="modal-body">
            <p style="margin-bottom: 16px;">è¯·é€‰æ‹©åç»­æ“ä½œï¼š</p>
            <div style="display: flex; flex-direction: column; gap: 10px;">
                <button class="btn btn-primary btn-lg" onclick="submitFound('keep')">è½¬ç»™è‡ªå·±</button>
                <button class="btn btn-warning btn-lg" onclick="submitFound('return')">{% if device_type == 'è½¦æœº' or device_type == 'ä»ªè¡¨' %}å½’è¿˜å…¥åº“{% else %}è½¬ç»™ä¿ç®¡äºº{% endif %}</button>
                <button class="btn btn-default btn-lg" onclick="closeModal('foundModal'); openTransferSelectModal('found')">è½¬ç»™åˆ«äºº</button>
            </div>
        </div>
    </div>
</div>

<!-- å¼¹çª—ï¼šæˆ‘å·²ä¿®å¥½ -->
<div class="modal-overlay" id="repairedModal">
    <div class="modal">
        <div class="modal-header">
            <span class="modal-title">ğŸ”§ è®¾å¤‡å·²ä¿®å¥½</span>
            <button class="modal-close" onclick="closeModal('repairedModal')">Ã—</button>
        </div>
        <div class="modal-body">
            <p style="margin-bottom: 16px;">è¯·é€‰æ‹©åç»­æ“ä½œï¼š</p>
            <div style="display: flex; flex-direction: column; gap: 10px;">
                <button class="btn btn-primary btn-lg" onclick="submitRepaired('keep')">è½¬ç»™è‡ªå·±</button>
                <button class="btn btn-warning btn-lg" onclick="submitRepaired('return')">{% if device_type == 'è½¦æœº' or device_type == 'ä»ªè¡¨' %}å½’è¿˜å…¥åº“{% else %}è½¬ç»™ä¿ç®¡äºº{% endif %}</button>
                <button class="btn btn-default btn-lg" onclick="closeModal('repairedModal'); openTransferSelectModal('repaired')">è½¬ç»™åˆ«äºº</button>
            </div>
        </div>
    </div>
</div>

<!-- å¼¹çª—ï¼šé€‰æ‹©è½¬å€Ÿäºº -->
<div class="modal-overlay" id="transferSelectModal">
    <div class="modal">
        <div class="modal-header">
            <span class="modal-title">ğŸ‘¤ é€‰æ‹©è½¬å€Ÿäºº</span>
            <button class="modal-close" onclick="closeModal('transferSelectModal')">Ã—</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <select id="transferToUser" class="form-select">
                    <option value="">è¯·é€‰æ‹©</option>
                </select>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-default" onclick="closeModal('transferSelectModal')">å–æ¶ˆ</button>
            <button class="btn btn-primary" onclick="submitTransferToUser()">ç¡®è®¤</button>
        </div>
    </div>
</div>

<!-- å¼¹çª—ï¼šè½¬è®©ä¿ç®¡äºº -->
<div class="modal-overlay" id="transferCustodianModal">
    <div class="modal">
        <div class="modal-header">
            <span class="modal-title">ğŸ”‘ è½¬è®©ä¿ç®¡äºº</span>
            <button class="modal-close" onclick="closeModal('transferCustodianModal')">Ã—</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label">æ–°ä¿ç®¡äºº</label>
                <select id="newCustodian" class="form-select">
                    <option value="">è¯·é€‰æ‹©æ–°ä¿ç®¡äºº</option>
                </select>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-default" onclick="closeModal('transferCustodianModal')">å–æ¶ˆ</button>
            <button class="btn btn-primary" onclick="submitTransferCustodian()">ç¡®è®¤è½¬è®©</button>
        </div>
    </div>
</div>

<!-- å¼¹çª—ï¼šæ·»åŠ å¤‡æ³¨ -->
<div class="modal-overlay" id="addRemarkModal">
    <div class="modal">
        <div class="modal-header">
            <span class="modal-title">ğŸ“ æ·»åŠ å¤‡æ³¨</span>
            <button class="modal-close" onclick="closeModal('addRemarkModal')">Ã—</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label">å¤‡æ³¨å†…å®¹</label>
                <textarea id="remarkContent" class="form-textarea" rows="4" placeholder="è¯·è¾“å…¥å¤‡æ³¨å†…å®¹..."></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-default" onclick="closeModal('addRemarkModal')">å–æ¶ˆ</button>
            <button class="btn btn-primary" onclick="submitAddRemark()">ç¡®è®¤æ·»åŠ </button>
        </div>
    </div>
</div>

<!-- å¼¹çª—ï¼šç¼–è¾‘å¤‡æ³¨ -->
<div class="modal-overlay" id="editRemarkModal">
    <div class="modal">
        <div class="modal-header">
            <span class="modal-title">âœï¸ ç¼–è¾‘å¤‡æ³¨</span>
            <button class="modal-close" onclick="closeModal('editRemarkModal')">Ã—</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label">å¤‡æ³¨å†…å®¹</label>
                <textarea id="editRemarkContent" class="form-textarea" rows="4"></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-default" onclick="closeModal('editRemarkModal')">å–æ¶ˆ</button>
            <button class="btn btn-primary" onclick="submitEditRemark()">ç¡®è®¤ä¿®æ”¹</button>
        </div>
    </div>
</div>

<!-- å¼¹çª—ï¼šæŸœå­ä½ç½®å›¾ -->
<div class="modal-overlay" id="cabinetMapModal" style="align-items: flex-start; padding-top: 40px;">
    <div class="modal" style="max-width: 90vw; width: auto;">
        <div class="modal-header">
            <span class="modal-title">ğŸ—ºï¸ æŸœå­ä½ç½®åˆ†å¸ƒå›¾</span>
            <button class="modal-close" onclick="closeModal('cabinetMapModal')">Ã—</button>
        </div>
        <div class="modal-body" style="padding: 0;">
            <img src="{{ url_for('static', filename='images/cabinet_map.png') }}" alt="æŸœå­ä½ç½®å›¾" style="max-width: 100%; height: auto; display: block;">
        </div>
        <div class="modal-footer">
            <button class="btn btn-default" onclick="closeModal('cabinetMapModal')">å…³é—­</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const deviceId = '{{ device.id }}';
const deviceType = '{{ device_type }}';
let currentAction = '';
let currentRemarkId = '';
let allUsers = [];

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    // åŠ è½½ç”¨æˆ·åˆ—è¡¨
    fetch('/api/users').then(r => r.json()).then(data => {
        if (data.success && data.users) {
            allUsers = data.users;
        }
    }).catch(() => {});

    // è®¾ç½®é»˜è®¤å½’è¿˜æ—¥æœŸä¸º1å¤©å
    const returnDateEl = document.getElementById('returnDate');
    if (returnDateEl) {
        returnDateEl.value = new Date(Date.now() + 1 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
    }

    // å€Ÿç”¨åŸå› è”åŠ¨
    const reasonInputs = document.querySelectorAll('input[name="borrowReason"]');
    const detailReason = document.getElementById('borrowDetail');
    if (detailReason && reasonInputs.length > 0) {
        const reasonDetails = {'æµ‹è¯•': 'ç”¨äºåŠŸèƒ½æµ‹è¯•', 'å¼€å‘': 'ç”¨äºå¼€å‘è°ƒè¯•', 'æ¼”ç¤º': 'ç”¨äºäº§å“æ¼”ç¤º', 'å‡ºå·®': 'ç”¨äºå‡ºå·®ä½¿ç”¨', 'å…¶ä»–': ''};
        reasonInputs.forEach(input => input.addEventListener('change', () => detailReason.value = reasonDetails[input.value]));
    }
});

// å¼¹çª—æ§åˆ¶
function openModal(id) { document.getElementById(id).classList.add('active'); }
function closeModal(id) { document.getElementById(id).classList.remove('active'); }

function openBorrowModal() { openModal('borrowModal'); }
function openReturnModal() { openModal('returnModal'); }
function openTransferModal() { openModal('transferModal'); loadUserSuggestions(); }
function openRenewModal() {
    const renewDateEl = document.getElementById('renewDate');
    if (renewDateEl) {
        // é»˜è®¤å€¼ä¸ºå½“å‰é¢„è®¡å½’è¿˜æ—¥æœŸ + 1å¤©ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä»Šå¤©+1å¤©
        const currentExpectedDate = '{{ device.expected_return_date.strftime("%Y-%m-%d") if device.expected_return_date else "" }}';
        let defaultDate;
        if (currentExpectedDate) {
            const d = new Date(currentExpectedDate);
            d.setDate(d.getDate() + 1);
            defaultDate = d.toISOString().split('T')[0];
        } else {
            const d = new Date();
            d.setDate(d.getDate() + 1);
            defaultDate = d.toISOString().split('T')[0];
        }
        renewDateEl.value = defaultDate;
        renewDateEl.min = new Date().toISOString().split('T')[0]; // ä¸èƒ½é€‰æ‹©è¿‡å»çš„æ—¥æœŸ
    }
    openModal('renewModal');
}
function openReportLostModal() { openModal('reportLostModal'); }
function openReportDamageModal() { openModal('reportDamageModal'); }
function openShipModal() {
    const shipTimeEl = document.getElementById('shipTime');
    if (shipTimeEl) {
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        shipTimeEl.value = now.toISOString().slice(0, 16);
    }
    openModal('shipModal');
}
function openFoundModal() { openModal('foundModal'); }
function openRepairedModal() { openModal('repairedModal'); }
function openAddRemarkModal() { openModal('addRemarkModal'); }

function openTransferSelectModal(action) {
    currentAction = action;
    const select = document.getElementById('transferToUser');
    select.innerHTML = '<option value="">åŠ è½½ä¸­...</option>';
    openModal('transferSelectModal');
    loadUsersToSelect(select);
}

function openTransferCustodianModal() {
    const select = document.getElementById('newCustodian');
    select.innerHTML = '<option value="">åŠ è½½ä¸­...</option>';
    openModal('transferCustodianModal');
    loadUsersToSelect(select);
}

function openEditRemarkModal(id, content) {
    currentRemarkId = id;
    document.getElementById('editRemarkContent').value = content;
    openModal('editRemarkModal');
}

function openEditRemarkModalFromElement(element) {
    const item = element.closest('.remark-item');
    if (!item) return;
    const id = item.dataset.remarkId;
    const contentEl = item.querySelector('.remark-content');
    const content = contentEl ? contentEl.textContent : '';
    if (id) {
        openEditRemarkModal(id, content);
    }
}

function loadUsersToSelect(select) {
    // å½“å‰è®¾å¤‡å€Ÿç”¨äººï¼Œè½¬å€Ÿæ—¶åº”è¯¥æ’é™¤
    const currentBorrower = '{{ device.borrower }}';
    fetch('/api/users').then(r => r.json()).then(data => {
        if (data.success) {
            select.innerHTML = '<option value="">è¯·é€‰æ‹©</option>';
            data.users.forEach(u => {
                // æ’é™¤å½“å‰å€Ÿç”¨äºº
                if (u.borrower_name !== currentBorrower) {
                    const option = document.createElement('option');
                    option.value = u.borrower_name;
                    option.textContent = u.borrower_name;
                    select.appendChild(option);
                }
            });
        }
    }).catch(() => select.innerHTML = '<option value="">åŠ è½½å¤±è´¥</option>');
}

function loadUserSuggestions() {
    const input = document.getElementById('transferTo');
    const suggestions = document.getElementById('userSuggestions');
    if (!input || !suggestions) return;

    // å½“å‰è®¾å¤‡å€Ÿç”¨äººï¼Œè½¬å€Ÿæ—¶åº”è¯¥æ’é™¤
    const currentBorrower = '{{ device.borrower }}';

    input.addEventListener('input', function() {
        const keyword = this.value.trim().toLowerCase();
        if (!keyword) { suggestions.style.display = 'none'; return; }
        // æ’é™¤å½“å‰å€Ÿç”¨äºº
        const matched = allUsers.filter(u => u.name.toLowerCase().includes(keyword) && u.name !== currentBorrower);
        if (matched.length > 0) {
            suggestions.innerHTML = matched.map(u => {
                const name = u.name.replace(/\\/g, '\\\\').replace(/'/g, "\\'");
                return '<div style="padding: 10px 12px; cursor: pointer;" onclick="selectUser(\'' + name + '\')">' + u.name + '</div>';
            }).join('');
            suggestions.style.display = 'block';
        } else {
            suggestions.innerHTML = '<div style="padding: 10px 12px; color: #999;">æ— åŒ¹é…ç”¨æˆ·</div>';
            suggestions.style.display = 'block';
        }
    });

    document.addEventListener('click', e => {
        if (!e.target.closest('#transferTo') && !e.target.closest('#userSuggestions')) {
            suggestions.style.display = 'none';
        }
    });
}

function selectUser(name) {
    const transferToEl = document.getElementById('transferTo');
    const suggestionsEl = document.getElementById('userSuggestions');
    if (transferToEl) transferToEl.value = name;
    if (suggestionsEl) suggestionsEl.style.display = 'none';
}

// APIæäº¤
function submitBorrow() {
    const reasonEl = document.querySelector('input[name="borrowReason"]:checked');
    const detailEl = document.getElementById('borrowDetail');
    const dateEl = document.getElementById('returnDate');
    
    if (!reasonEl) { showToast('è¯·é€‰æ‹©å€Ÿç”¨åŸå› '); return; }
    if (!dateEl || !dateEl.value) { showToast('è¯·é€‰æ‹©é¢„è®¡å½’è¿˜æ—¥æœŸ'); return; }
    
    const reason = reasonEl.value;
    const detail = detailEl ? detailEl.value.trim() : '';
    const date = dateEl.value;
    const fullReason = reason + (detail ? ' - ' + detail : '');

    fetch('/api/borrow', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({device_id: deviceId, reason: fullReason, expected_return_date: date})
    }).then(r => r.json()).then(data => {
        if (data.success) { showToast('å€Ÿç”¨æˆåŠŸï¼'); setTimeout(() => location.reload(), 1000); }
        else { showToast(data.message || 'å€Ÿç”¨å¤±è´¥'); }
    }).catch(() => showToast('æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•'));
}

function submitReturn() {
    const reasonEl = document.querySelector('input[name="returnReason"]:checked');
    const remarkEl = document.getElementById('returnRemark');
    
    if (!reasonEl) { showToast('è¯·é€‰æ‹©å½’è¿˜åŸå› '); return; }
    
    const reason = reasonEl.value;
    const remark = remarkEl ? remarkEl.value.trim() : '';
    const fullRemark = reason + (remark ? ' - ' + remark : '');

    const check1 = document.getElementById('check1');
    const check2 = document.getElementById('check2');
    const check3 = document.getElementById('check3');
    if ((!check1 || !check1.checked) || (!check2 || !check2.checked) || (!check3 || !check3.checked)) {
        showToast('è¯·ç¡®è®¤æ‰€æœ‰æ£€æŸ¥é¡¹'); return;
    }

    fetch('/api/return', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({device_id: deviceId, reason: fullRemark})
    }).then(r => r.json()).then(data => {
        if (data.success) { showToast('å½’è¿˜æˆåŠŸï¼'); setTimeout(() => window.location.href = '/pc', 1000); }
        else { showToast(data.message || 'å½’è¿˜å¤±è´¥'); }
    }).catch(() => showToast('æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•'));
}

function submitTransfer() {
    const toEl = document.getElementById('transferTo');
    const remarkEl = document.getElementById('transferRemark');
    if (!toEl) { showToast('é¡µé¢å…ƒç´ é”™è¯¯'); return; }
    
    const to = toEl.value.trim();
    const remark = remarkEl ? remarkEl.value.trim() : '';
    if (!to) { showToast('è¯·é€‰æ‹©è½¬å€Ÿäºº'); return; }
    
    // æ£€æŸ¥ä¸èƒ½è½¬å€Ÿç»™è‡ªå·±
    const currentUserName = '{{ user.borrower_name }}';
    if (to === currentUserName) { showToast('ä¸èƒ½è½¬å€Ÿç»™è‡ªå·±'); return; }
    
    if (!allUsers.some(u => u.name === to)) { showToast('è¯¥ç”¨æˆ·ä¸å­˜åœ¨ï¼Œè¯·ä»åˆ—è¡¨ä¸­é€‰æ‹©'); return; }

    fetch('/api/transfer', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({device_id: deviceId, transfer_to: to, remark: remark})
    }).then(r => r.json()).then(data => {
        if (data.success) { showToast('è½¬å€ŸæˆåŠŸ'); setTimeout(() => window.location.href = '/pc', 1000); }
        else { showToast(data.message || 'è½¬å€Ÿå¤±è´¥'); }
    }).catch(() => showToast('æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•'));
    closeModal('transferModal');
}

function submitRenew() {
    const dateEl = document.getElementById('renewDate');
    if (!dateEl || !dateEl.value) { showToast('è¯·é€‰æ‹©ç»­æœŸæ—¥æœŸ'); return; }
    const newReturnDate = dateEl.value;
    const today = new Date().toISOString().split('T')[0];
    if (newReturnDate < today) { showToast('ç»­æœŸæ—¥æœŸä¸èƒ½æ—©äºä»Šå¤©'); return; }

    fetch('/api/renew', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({device_id: deviceId, new_return_date: newReturnDate})
    }).then(r => r.json()).then(data => {
        if (data.success) { showToast('ç»­æœŸæˆåŠŸ'); setTimeout(() => location.reload(), 1000); }
        else { showToast(data.message || 'ç»­æœŸå¤±è´¥'); }
    }).catch(() => showToast('æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•'));
    closeModal('renewModal');
}

function submitReportLost() {
    fetch('/api/report-lost', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({device_id: deviceId})
    }).then(r => r.json()).then(data => {
        if (data.success) { showToast('ä¸¢å¤±æŠ¥å¤‡æˆåŠŸ'); setTimeout(() => location.reload(), 1000); }
        else { showToast(data.message || 'æŠ¥å¤‡å¤±è´¥'); }
    }).catch(() => showToast('æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•'));
    closeModal('reportLostModal');
}

function submitReportDamage() {
    const reasonEl = document.getElementById('damageReason');
    if (!reasonEl) { showToast('é¡µé¢å…ƒç´ é”™è¯¯'); return; }
    const reason = reasonEl.value.trim();
    if (!reason) { showToast('è¯·å¡«å†™æŸååŸå› '); return; }

    fetch('/api/report-damage', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({device_id: deviceId, damage_reason: reason})
    }).then(r => r.json()).then(data => {
        if (data.success) { showToast('æŸåæŠ¥å¤‡æˆåŠŸ'); setTimeout(() => location.reload(), 1000); }
        else { showToast(data.message || 'æŠ¥å¤‡å¤±è´¥'); }
    }).catch(() => showToast('æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•'));
    closeModal('reportDamageModal');
}

function submitShip() {
    const timeEl = document.getElementById('shipTime');
    const remarkEl = document.getElementById('shipRemark');
    if (!timeEl || !timeEl.value) { showToast('è¯·é€‰æ‹©å¯„å‡ºæ—¶é—´'); return; }
    const shipTime = timeEl.value;
    const remark = remarkEl ? remarkEl.value.trim() : '';

    fetch('/api/ship-device', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({device_id: deviceId, ship_time: shipTime, remark: remark})
    }).then(r => r.json()).then(data => {
        if (data.success) { showToast('å¯„å‡ºç™»è®°æˆåŠŸ'); setTimeout(() => location.reload(), 1000); }
        else { showToast(data.message || 'å¯„å‡ºå¤±è´¥'); }
    }).catch(() => showToast('æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•'));
    closeModal('shipModal');
}

function submitFound(action) {
    const data = {device_id: deviceId, action: action};
    if (action === 'transfer') {
        const transferToEl = document.getElementById('transferToUser');
        if (!transferToEl) { showToast('é¡µé¢å…ƒç´ é”™è¯¯'); return; }
        const transferTo = transferToEl.value;
        if (!transferTo) { showToast('è¯·é€‰æ‹©è½¬å€Ÿäºº'); return; }
        data.transfer_to = transferTo;
    }
    fetch('/api/found-device', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    }).then(r => r.json()).then(data => {
        if (data.success) { showToast('æ“ä½œæˆåŠŸ'); setTimeout(() => location.reload(), 1000); }
        else { showToast(data.message || 'æ“ä½œå¤±è´¥'); }
    }).catch(() => showToast('æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•'));
    closeModal('foundModal');
    closeModal('transferSelectModal');
}

function submitRepaired(action) {
    const data = {device_id: deviceId, action: action};
    if (action === 'transfer') {
        const transferToEl = document.getElementById('transferToUser');
        if (!transferToEl) { showToast('é¡µé¢å…ƒç´ é”™è¯¯'); return; }
        const transferTo = transferToEl.value;
        if (!transferTo) { showToast('è¯·é€‰æ‹©è½¬å€Ÿäºº'); return; }
        data.transfer_to = transferTo;
    }
    fetch('/api/repair-device', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    }).then(r => r.json()).then(data => {
        if (data.success) { showToast('æ“ä½œæˆåŠŸ'); setTimeout(() => location.reload(), 1000); }
        else { showToast(data.message || 'æ“ä½œå¤±è´¥'); }
    }).catch(() => showToast('æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•'));
    closeModal('repairedModal');
    closeModal('transferSelectModal');
}

function submitTransferToUser() {
    if (currentAction === 'found') submitFound('transfer');
    else submitRepaired('transfer');
}

function confirmTransferToMe() {
    const deviceName = document.querySelector('.detail-title h2')?.textContent || 'æ­¤è®¾å¤‡';
    const borrower = document.querySelector('.info-value')?.textContent || 'å½“å‰å€Ÿç”¨äºº';
    if (!confirm('ç¡®å®šè¦å°† ' + deviceName + ' ä» ' + borrower + ' è½¬å€Ÿåˆ°è‡ªå·±åä¸‹å—ï¼Ÿ')) return;
    fetch('/api/transfer-to-me', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({device_id: deviceId})
    }).then(r => r.json()).then(data => {
        if (data.success) { showToast('è½¬å€ŸæˆåŠŸ'); setTimeout(() => location.reload(), 1000); }
        else { showToast(data.message || 'è½¬å€Ÿå¤±è´¥'); }
    }).catch(() => showToast('æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•'));
}

function confirmReturnByCustodian() {
    const deviceName = document.querySelector('.detail-title h2')?.textContent || 'æ­¤è®¾å¤‡';
    if (!confirm('ç¡®å®šè¦æ”¶å› ' + deviceName + ' å—ï¼Ÿ')) return;
    fetch('/api/return-by-custodian', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({device_id: deviceId})
    }).then(r => r.json()).then(data => {
        if (data.success) { showToast('æ”¶å›æˆåŠŸ'); setTimeout(() => location.reload(), 1000); }
        else { showToast(data.message || 'æ”¶å›å¤±è´¥'); }
    }).catch(() => showToast('æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•'));
}

function confirmUnship() {
    const deviceName = document.querySelector('.detail-title h2')?.textContent || 'æ­¤è®¾å¤‡';
    if (!confirm('ç¡®å®šå°† ' + deviceName + ' è¿˜åŸä¸ºå€Ÿç”¨çŠ¶æ€å—ï¼Ÿ')) return;
    fetch('/api/unship-device', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({device_id: deviceId})
    }).then(r => r.json()).then(data => {
        if (data.success) { showToast('è¿˜åŸæˆåŠŸ'); setTimeout(() => location.reload(), 1000); }
        else { showToast(data.message || 'è¿˜åŸå¤±è´¥'); }
    }).catch(() => showToast('æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•'));
}

function confirmNotFound() {
    if (!confirm('ç¡®å®šè¦é€€å›æ­¤è®¾å¤‡å—ï¼Ÿå°†è½¬å›ç»™ä¸Šä¸€ä¸ªå€Ÿç”¨äººã€‚')) return;
    fetch('/api/not-found', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({device_id: deviceId})
    }).then(r => r.json()).then(data => {
        if (data.success) { showToast('æ“ä½œæˆåŠŸ'); setTimeout(() => location.reload(), 1000); }
        else { showToast(data.message || 'æ“ä½œå¤±è´¥'); }
    }).catch(() => showToast('æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•'));
}

function confirmNotFoundDirect() {
    if (!confirm('ç¡®å®šè®¾å¤‡æœªæ‰¾åˆ°å—ï¼Ÿå°†è®°å½•å€Ÿç”¨äººæœªæ‰¾åˆ°ï¼Œè®¾å¤‡è½¬ä¸ºä¸¢å¤±çŠ¶æ€ã€‚')) return;
    fetch('/api/not-found-direct', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({device_id: deviceId})
    }).then(r => r.json()).then(data => {
        if (data.success) { showToast('å·²è®°å½•ï¼šå€Ÿç”¨äººæœªæ‰¾åˆ°ï¼Œè®¾å¤‡å·²è½¬ä¸ºä¸¢å¤±'); setTimeout(() => location.reload(), 1000); }
        else { showToast(data.message || 'æ“ä½œå¤±è´¥'); }
    }).catch(() => showToast('æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•'));
}

function submitTransferCustodian() {
    const newCustodianEl = document.getElementById('newCustodian');
    if (!newCustodianEl) { showToast('é¡µé¢å…ƒç´ é”™è¯¯'); return; }
    const newCustodian = newCustodianEl.value;
    if (!newCustodian) { showToast('è¯·é€‰æ‹©æ–°ä¿ç®¡äºº'); return; }
    fetch('/api/transfer-custodian', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({device_id: deviceId, new_custodian: newCustodian})
    }).then(r => r.json()).then(data => {
        if (data.success) { showToast('ä¿ç®¡äººè½¬è®©æˆåŠŸ'); setTimeout(() => location.reload(), 1000); }
        else { showToast(data.message || 'è½¬è®©å¤±è´¥'); }
    }).catch(() => showToast('æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•'));
    closeModal('transferCustodianModal');
}

function submitAddRemark() {
    const contentEl = document.getElementById('remarkContent');
    if (!contentEl) { showToast('é¡µé¢å…ƒç´ é”™è¯¯'); return; }
    const content = contentEl.value.trim();
    if (!content) { showToast('å¤‡æ³¨å†…å®¹ä¸èƒ½ä¸ºç©º'); return; }
    fetch('/api/remark/add', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({device_id: deviceId, content: content})
    }).then(r => r.json()).then(data => {
        if (data.success) { showToast('å¤‡æ³¨å·²æ·»åŠ '); closeModal('addRemarkModal'); location.reload(); }
        else { showToast(data.message || 'æ·»åŠ å¤±è´¥'); }
    }).catch(() => showToast('æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•'));
}

function submitEditRemark() {
    const contentEl = document.getElementById('editRemarkContent');
    if (!contentEl) { showToast('é¡µé¢å…ƒç´ é”™è¯¯'); return; }
    const content = contentEl.value.trim();
    if (!content) { showToast('å¤‡æ³¨å†…å®¹ä¸èƒ½ä¸ºç©º'); return; }
    fetch('/api/remark/edit', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({remark_id: currentRemarkId, content: content})
    }).then(r => r.json()).then(data => {
        if (data.success) { showToast('å¤‡æ³¨å·²æ›´æ–°'); closeModal('editRemarkModal'); location.reload(); }
        else { showToast(data.message || 'æ›´æ–°å¤±è´¥'); }
    }).catch(() => showToast('æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•'));
}

function openCabinetMapModal() {
    openModal('cabinetMapModal');
}

function deleteRemark(id) {
    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡å¤‡æ³¨å—ï¼Ÿ')) return;
    fetch('/api/remark/delete', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({remark_id: id})
    }).then(r => r.json()).then(data => {
        if (data.success) { showToast('åˆ é™¤æˆåŠŸ'); location.reload(); }
        else { showToast(data.message || 'åˆ é™¤å¤±è´¥'); }
    }).catch(() => showToast('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•'));
}

function deleteRemarkFromElement(element) {
    const item = element.closest('.remark-item');
    if (!item) return;
    const id = item.dataset.remarkId;
    if (id) {
        deleteRemark(id);
    }
}

// å°†å‡½æ•°å¯¼å‡ºåˆ°å…¨å±€ä½œç”¨åŸŸï¼Œç¡®ä¿ onclick å¯ä»¥è°ƒç”¨
window.openBorrowModal = openBorrowModal;
window.openReturnModal = openReturnModal;
window.openTransferModal = openTransferModal;
window.openRenewModal = openRenewModal;
window.openReportLostModal = openReportLostModal;
window.openReportDamageModal = openReportDamageModal;
window.openShipModal = openShipModal;
window.openFoundModal = openFoundModal;
window.openRepairedModal = openRepairedModal;
window.openAddRemarkModal = openAddRemarkModal;
window.openTransferSelectModal = openTransferSelectModal;
window.openTransferCustodianModal = openTransferCustodianModal;
window.openEditRemarkModalFromElement = openEditRemarkModalFromElement;
window.submitBorrow = submitBorrow;
window.submitReturn = submitReturn;
window.submitTransfer = submitTransfer;
window.submitRenew = submitRenew;
window.submitReportLost = submitReportLost;
window.submitReportDamage = submitReportDamage;
window.submitShip = submitShip;
window.submitFound = submitFound;
window.submitRepaired = submitRepaired;
window.submitTransferToUser = submitTransferToUser;
window.confirmTransferToMe = confirmTransferToMe;
window.confirmReturnByCustodian = confirmReturnByCustodian;
window.confirmUnship = confirmUnship;
window.confirmNotFound = confirmNotFound;
window.confirmNotFoundDirect = confirmNotFoundDirect;
window.submitTransferCustodian = submitTransferCustodian;
window.submitAddRemark = submitAddRemark;
window.submitEditRemark = submitEditRemark;
window.deleteRemark = deleteRemark;
window.openCabinetMapModal = openCabinetMapModal;
window.deleteRemarkFromElement = deleteRemarkFromElement;
window.selectUser = selectUser;
window.openModal = openModal;
window.closeModal = closeModal;

</script>
{% endblock %}
