{% extends "pc/base_pc.html" %}

{% block title %}å€Ÿç”¨è®¾å¤‡åˆ—è¡¨ - è®¾å¤‡ç®¡ç†ç³»ç»Ÿ{% endblock %}

{% set active_nav = 'devices' %}

{% block content %}
<h1 class="page-title">
    {% if no_cabinet %}
    ğŸ“¦ æ— æŸœå·è®¾å¤‡
    {% elif device_type == 'car' %}
    ğŸš— è½¦æœºè®¾å¤‡
    {% elif device_type == 'phone' %}
    ğŸ“± æ‰‹æœºè®¾å¤‡
    {% elif device_type == 'instrument' %}
    ğŸ“Š ä»ªè¡¨è®¾å¤‡
    {% elif device_type == 'simcard' %}
    ğŸ“² æ‰‹æœºå¡è®¾å¤‡
    {% elif device_type == 'other' %}
    ğŸ”§ å…¶å®ƒè®¾å¤‡
    {% else %}
    ğŸ“¦ å…¨éƒ¨è®¾å¤‡
    {% endif %}
</h1>

<!-- æœç´¢å’Œç­›é€‰ -->
<div class="search-bar">
    <div class="search-input-wrap">
        <span class="search-icon">ğŸ”</span>
        <input type="text" id="searchInput" class="search-input" placeholder="æœç´¢ï¼šåç§°ã€å‹å·ã€JIRAã€é¡¹ç›®å±æ€§ã€ç³»ç»Ÿç‰ˆæœ¬ã€å€Ÿç”¨äºº..." onkeyup="handleSearch(event)">
        <button class="clear-btn" id="clearSearchBtn" onclick="clearSearch()" style="display:none; position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; color: #999;">âœ•</button>
    </div>
</div>

{% if device_type == 'car' or device_type == 'instrument' %}
<!-- ç»„åˆç­›é€‰ï¼ˆä»…è½¦æœºå’Œä»ªè¡¨ï¼‰ -->
<div class="card" style="margin-bottom: 20px;">
    <div class="card-header">
        <span class="card-title">ğŸ” ç»„åˆç­›é€‰</span>
        <button onclick="resetFilters()" class="btn btn-default btn-sm">é‡ç½®ç­›é€‰</button>
    </div>
    <div class="card-body">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
            <div>
                <label style="display: block; font-size: 13px; color: #666; margin-bottom: 6px;">é¡¹ç›®å±æ€§</label>
                <select id="filterProject" onchange="applyFilters()" style="width: 100%; padding: 8px 12px; border: 1px solid #d9d9d9; border-radius: 6px; font-size: 14px;">
                    <option value="">å…¨éƒ¨</option>
                </select>
            </div>
            <div>
                <label style="display: block; font-size: 13px; color: #666; margin-bottom: 6px;">è¿æ¥æ–¹å¼</label>
                <select id="filterConnection" onchange="applyFilters()" style="width: 100%; padding: 8px 12px; border: 1px solid #d9d9d9; border-radius: 6px; font-size: 14px;">
                    <option value="">å…¨éƒ¨</option>
                </select>
            </div>
            <div>
                <label style="display: block; font-size: 13px; color: #666; margin-bottom: 6px;">ç³»ç»Ÿç‰ˆæœ¬</label>
                <select id="filterOsVersion" onchange="applyFilters()" style="width: 100%; padding: 8px 12px; border: 1px solid #d9d9d9; border-radius: 6px; font-size: 14px;">
                    <option value="">å…¨éƒ¨</option>
                </select>
            </div>
            <div>
                <label style="display: block; font-size: 13px; color: #666; margin-bottom: 6px;">ç³»ç»Ÿå¹³å°</label>
                <select id="filterOsPlatform" onchange="applyFilters()" style="width: 100%; padding: 8px 12px; border: 1px solid #d9d9d9; border-radius: 6px; font-size: 14px;">
                    <option value="">å…¨éƒ¨</option>
                </select>
            </div>
            <div>
                <label style="display: block; font-size: 13px; color: #666; margin-bottom: 6px;">äº§å“åç§°</label>
                <select id="filterProduct" onchange="applyFilters()" style="width: 100%; padding: 8px 12px; border: 1px solid #d9d9d9; border-radius: 6px; font-size: 14px;">
                    <option value="">å…¨éƒ¨</option>
                </select>
            </div>
            <div>
                <label style="display: block; font-size: 13px; color: #666; margin-bottom: 6px;">å±å¹•æ–¹å‘</label>
                <select id="filterOrientation" onchange="applyFilters()" style="width: 100%; padding: 8px 12px; border: 1px solid #d9d9d9; border-radius: 6px; font-size: 14px;">
                    <option value="">å…¨éƒ¨</option>
                </select>
            </div>
            <div>
                <label style="display: block; font-size: 13px; color: #666; margin-bottom: 6px;">åˆ†è¾¨ç‡</label>
                <select id="filterResolution" onchange="applyFilters()" style="width: 100%; padding: 8px 12px; border: 1px solid #d9d9d9; border-radius: 6px; font-size: 14px;">
                    <option value="">å…¨éƒ¨</option>
                </select>
            </div>
        </div>
    </div>
</div>
{% endif %}

<div class="filter-tabs">
    <a href="{{ url_for('pc_device_list') }}" class="filter-tab {% if (not device_type or device_type == 'all') and not no_cabinet %}active{% endif %}">å…¨éƒ¨</a>
    <a href="{{ url_for('pc_device_list', type='car') }}" class="filter-tab {% if device_type == 'car' %}active{% endif %}">è½¦æœº</a>
    <a href="{{ url_for('pc_device_list', type='phone') }}" class="filter-tab {% if device_type == 'phone' %}active{% endif %}">æ‰‹æœº</a>
    <a href="{{ url_for('pc_device_list', type='instrument') }}" class="filter-tab {% if device_type == 'instrument' %}active{% endif %}">ä»ªè¡¨</a>
    <a href="{{ url_for('pc_device_list', type='simcard') }}" class="filter-tab {% if device_type == 'simcard' %}active{% endif %}">æ‰‹æœºå¡</a>
    <a href="{{ url_for('pc_device_list', type='other') }}" class="filter-tab {% if device_type == 'other' %}active{% endif %}">å…¶å®ƒ</a>
    <a href="{{ url_for('pc_device_list', no_cabinet='1') }}" class="filter-tab {% if no_cabinet %}active{% endif %}">æ— æŸœå·</a>
</div>

<!-- è®¾å¤‡åˆ—è¡¨ -->
<div class="card">
    <div class="card-body">
        {% if devices %}
        <table class="data-table device-list-table" id="deviceTable">
            <thead>
                <tr>
                    <th style="width: 50px;">åºå·</th>
                    <th>å‹å·</th>
                    <th>è®¾å¤‡åç§°</th>
                    <th>JIRAåœ°å€</th>
                    {% if device_type == 'car' or device_type == 'instrument' %}
                    <th>é¡¹ç›®å±æ€§</th>
                    <th>è¿æ¥æ–¹å¼</th>
                    <th>ç³»ç»Ÿç‰ˆæœ¬</th>
                    <th>ç³»ç»Ÿå¹³å°</th>
                    <th>äº§å“åç§°</th>
                    <th>å±å¹•æ–¹å‘</th>
                    <th>åˆ†è¾¨ç‡</th>
                    {% elif device_type == 'phone' %}
                    <th>ç³»ç»Ÿç‰ˆæœ¬</th>
                    <th>IMEI</th>
                    <th>SNç </th>
                    <th>è¿è¥å•†</th>
                    {% elif device_type == 'simcard' %}
                    <th>å·ç </th>
                    <th>è¿è¥å•†</th>
                    {% else %}
                    <th>ç±»å‹</th>
                    <th>å¤‡æ³¨</th>
                    {% endif %}
                    <th>çŠ¶æ€</th>
                    <th style="width: 90px;">æ“ä½œ</th>
                </tr>
            </thead>
            <tbody>
                {% for device in devices %}
                <tr {% if device.status.value == 'æŠ¥åºŸ' %}class="disabled"{% endif %}>
                    <td>{{ loop.index }}</td>
                    <td>{{ device.model or '-' }}</td>
                    <td>
                        <span class="device-icon">
                            {% if device.device_type.value == 'è½¦æœº' %}ğŸš—
                            {% elif device.device_type.value == 'æ‰‹æœº' %}ğŸ“±
                            {% elif device.device_type.value == 'ä»ªè¡¨' %}ğŸ“Š
                            {% elif device.device_type.value == 'æ‰‹æœºå¡' %}ğŸ“²
                            {% else %}ğŸ”§{% endif %}
                        </span>
                        {% if device.status.value == 'æŠ¥åºŸ' %}
                        <span class="device-name">{{ device.name }}</span>
                        {% else %}
                        <a href="{% if device.no_cabinet or device.is_circulating or device.is_sealed %}{{ url_for('pc_device_detail_simple', device_id=device.id, device_type=device.device_type.value) }}{% else %}{{ url_for('pc_device_detail', device_id=device.id, device_type=device.device_type.value) }}{% endif %}" class="device-name" style="color: #1890ff; font-weight: 500;">{{ device.name }}</a>
                        {% endif %}
                    </td>
                    <td>
                        {% if device.jira_address %}
                        <a href="http://jira.carbit.lo/browse/{{ device.jira_address }}" target="_blank" style="color: #1890ff; text-decoration: none;">{{ device.jira_address }}</a>
                        {% else %}
                        -
                        {% endif %}
                    </td>
                    {% if device_type == 'car' or device_type == 'instrument' %}
                    <td>{{ device.project_attribute or '-' }}</td>
                    <td style="max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="{{ device.connection_method or '' }}">{{ device.connection_method or '-' }}</td>
                    <td>{{ device.os_version or '-' }}</td>
                    <td>{{ device.os_platform or '-' }}</td>
                    <td>{{ device.product_name or '-' }}</td>
                    <td>{{ device.screen_orientation or '-' }}</td>
                    <td>{{ device.screen_resolution or '-' }}</td>
                    {% elif device_type == 'phone' %}
                    <td>{{ device.system_version or '-' }}</td>
                    <td style="font-size: 12px;" title="{{ device.imei or '' }}">{{ device.imei[:15] + '...' if device.imei and device.imei|length > 15 else device.imei or '-' }}</td>
                    <td style="font-size: 12px;" title="{{ device.sn or '' }}">{{ device.sn[:15] + '...' if device.sn and device.sn|length > 15 else device.sn or '-' }}</td>
                    <td>{{ device.carrier or '-' }}</td>
                    {% elif device_type == 'simcard' %}
                    <td>{{ device.model or '-' }}</td>
                    <td>{{ device.carrier or '-' }}</td>
                    {% else %}
                    <td class="device-type">{{ device.device_type.value }}</td>
                    <td style="color: #8c8c8c; font-size: 13px; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="{{ device.remark or '' }}">{{ device.remark or '-' }}</td>
                    {% endif %}
                    <td>
                        {% if device.no_cabinet %}
                        <span class="status-tag status-no-cabinet">æ— æŸœå·</span>
                        {% elif device.is_circulating %}
                        <span class="status-tag status-circulating">æµé€š</span>
                        {% elif device.is_sealed %}
                        <span class="status-tag status-sealed">å°å­˜</span>
                        {% else %}
                        <span class="status-tag
                            {% if device.status.value == 'åœ¨åº“' %}status-available
                            {% elif device.status.value == 'ä¿ç®¡ä¸­' %}status-custody
                            {% elif device.status.value == 'å€Ÿå‡º' %}status-borrowed
                            {% elif device.status.value == 'å·²å¯„å‡º' %}status-shipped
                            {% elif device.status.value == 'å·²æŸå' %}status-damaged
                            {% elif device.status.value == 'ä¸¢å¤±' %}status-lost
                            {% elif device.status.value == 'æŠ¥åºŸ' %}status-scrapped
                            {% endif %}">
                            {{ device.status.value }}
                        </span>
                        {% endif %}
                    </td>
                    <td>
                        {% if device.status.value == 'æŠ¥åºŸ' %}
                        <button class="btn btn-default btn-sm" disabled>å·²æŠ¥åºŸ</button>
                        {% else %}
                        <a href="{% if device.no_cabinet or device.is_circulating or device.is_sealed %}{{ url_for('pc_device_detail_simple', device_id=device.id, device_type=device.device_type.value) }}{% else %}{{ url_for('pc_device_detail', device_id=device.id, device_type=device.device_type.value) }}{% endif %}" class="btn btn-primary btn-sm">æŸ¥çœ‹è¯¦æƒ…</a>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <!-- åˆ†é¡µ -->
        {% if total_pages > 1 %}
        <div class="pagination">
            <a href="{{ url_for('pc_device_list', type=device_type, no_cabinet='1' if no_cabinet else '', page=page-1) }}" class="page-btn" {% if page <= 1 %}style="pointer-events: none; opacity: 0.5;"{% endif %}>â€¹ ä¸Šä¸€é¡µ</a>
            <span class="page-info">{{ page }} / {{ total_pages }} é¡µ (å…±{{ total }}å°)</span>
            <a href="{{ url_for('pc_device_list', type=device_type, no_cabinet='1' if no_cabinet else '', page=page+1) }}" class="page-btn" {% if page >= total_pages %}style="pointer-events: none; opacity: 0.5;"{% endif %}>ä¸‹ä¸€é¡µ â€º</a>
        </div>
        {% endif %}
        {% else %}
        <div class="empty-state">
            <div class="empty-icon">ğŸ”</div>
            <p class="empty-title">æš‚æ— è®¾å¤‡</p>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let searchTimeout;
let allDevices = []; // ç¼“å­˜æœç´¢ç»“æœ
let isSearching = false;

function handleSearch(event) {
    clearTimeout(searchTimeout);
    const keyword = event.target.value.trim();
    
    // å¦‚æœæœç´¢æ¡†ä¸ºç©ºï¼Œæ¢å¤åŸå§‹åˆ—è¡¨
    if (!keyword) {
        restoreOriginalList();
        return;
    }
    
    searchTimeout = setTimeout(() => {
        doSearch(keyword);
    }, 300);
}

function doSearch(keyword) {
    if (isSearching) return;
    isSearching = true;
    
    fetch(`/api/search?keyword=${encodeURIComponent(keyword)}`)
        .then(res => res.json())
        .then(data => {
            isSearching = false;
            if (data.success) {
                allDevices = data.devices;
                renderSearchResults(allDevices);
                // æœç´¢å®Œæˆåé‡æ–°åˆå§‹åŒ–ç­›é€‰å™¨
                initFilters();
            } else {
                showToast('æœç´¢å¤±è´¥');
            }
        })
        .catch(err => {
            isSearching = false;
            showToast('æœç´¢å¤±è´¥ï¼Œè¯·é‡è¯•');
        });
}

// è·å–å½“å‰é¡µé¢è®¾å¤‡ç±»å‹
const currentDeviceType = '{{ device_type }}';

function renderSearchResults(devices) {
    const tbody = document.querySelector('#deviceTable tbody');
    const pagination = document.querySelector('.pagination');
    
    // éšè—åˆ†é¡µ
    if (pagination) {
        pagination.style.display = 'none';
    }
    
    if (devices.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="12" class="empty-state" style="padding: 40px;">
                    <div class="empty-icon">ğŸ”</div>
                    <p class="empty-title">æœªæ‰¾åˆ°åŒ¹é…çš„è®¾å¤‡</p>
                </td>
            </tr>
        `;
        return;
    }
    
    const getDeviceIcon = (type) => {
        const iconMap = {
            'è½¦æœº': 'ğŸš—',
            'æ‰‹æœº': 'ğŸ“±',
            'ä»ªè¡¨': 'ğŸ“Š',
            'æ‰‹æœºå¡': 'ğŸ“²',
            'å…¶å®ƒè®¾å¤‡': 'ğŸ”§'
        };
        return iconMap[type] || 'ğŸ”§';
    };
    
    // æ ¹æ®å½“å‰è®¾å¤‡ç±»å‹ç¡®å®šæ¸²æŸ“çš„åˆ—æ•°
    const isCarOrInstrument = currentDeviceType === 'car' || currentDeviceType === 'instrument';
    const isPhone = currentDeviceType === 'phone';
    const isSimcard = currentDeviceType === 'simcard';
    
    tbody.innerHTML = devices.map((device, index) => {
        const detailUrl = device.no_cabinet || device.is_circulating || device.is_sealed 
            ? '/pc/device/' + device.id + '/simple?device_type=' + encodeURIComponent(device.device_type)
            : '/pc/device/' + device.id + '?device_type=' + encodeURIComponent(device.device_type);
        
        let extraCols = '';
        
        if (isCarOrInstrument) {
            // è½¦æœºå’Œä»ªè¡¨æ˜¾ç¤ºé¢å¤–å­—æ®µ
            extraCols = `
                <td>${device.project_attribute || '-'}</td>
                <td style="max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${device.connection_method || ''}">${device.connection_method || '-'}</td>
                <td>${device.os_version || '-'}</td>
                <td>${device.os_platform || '-'}</td>
                <td>${device.product_name || '-'}</td>
                <td>${device.screen_orientation || '-'}</td>
                <td>${device.screen_resolution || '-'}</td>
            `;
        } else if (isPhone) {
            // æ‰‹æœºæ˜¾ç¤ºé¢å¤–å­—æ®µ
            const imei = device.imei || '';
            const sn = device.sn || '';
            extraCols = `
                <td>${device.system_version || '-'}</td>
                <td style="font-size: 12px;" title="${imei}">${imei.length > 15 ? imei.substring(0, 15) + '...' : imei || '-'}</td>
                <td style="font-size: 12px;" title="${sn}">${sn.length > 15 ? sn.substring(0, 15) + '...' : sn || '-'}</td>
                <td>${device.carrier || '-'}</td>
            `;
        } else if (isSimcard) {
            // æ‰‹æœºå¡æ˜¾ç¤ºé¢å¤–å­—æ®µ
            extraCols = `
                <td>${device.model || '-'}</td>
                <td>${device.carrier || '-'}</td>
            `;
        } else {
            // é»˜è®¤æ˜¾ç¤ºç±»å‹å’Œå¤‡æ³¨
            extraCols = `
                <td class="device-type">${device.device_type}</td>
                <td style="color: #8c8c8c; font-size: 13px; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${device.remark || ''}">${device.remark || '-'}</td>
            `;
        }
        
        return `<tr ${device.status === 'æŠ¥åºŸ' ? 'class="disabled"' : ''}>
            <td>${index + 1}</td>
            <td>${device.model || '-'}</td>
            <td>
                <span class="device-icon">${getDeviceIcon(device.device_type)}</span>
                ${device.status === 'æŠ¥åºŸ'
                    ? `<span class="device-name">${escapeHtml(device.name)}</span>`
                    : `<a href="${detailUrl}" class="device-name" style="color: #1890ff; font-weight: 500;">${escapeHtml(device.name)}</a>`
                }
            </td>
            <td>
                ${device.jira_address 
                    ? `<a href="http://jira.carbit.lo/browse/${escapeHtml(device.jira_address)}" target="_blank" style="color: #1890ff; text-decoration: none;">${escapeHtml(device.jira_address)}</a>`
                    : '-'
                }
            </td>
            ${extraCols}
            <td>
                ${device.no_cabinet
                    ? '<span class="status-tag status-no-cabinet">æ— æŸœå·</span>'
                    : device.is_circulating
                        ? '<span class="status-tag status-circulating">æµé€š</span>'
                        : device.is_sealed
                            ? '<span class="status-tag status-sealed">å°å­˜</span>'
                            : `<span class="status-tag ${getStatusClass(device.status)}">${device.status}</span>`
                }
            </td>
            <td>
                ${device.status === 'æŠ¥åºŸ'
                    ? '<button class="btn btn-default btn-sm" disabled>å·²æŠ¥åºŸ</button>'
                    : `<a href="${detailUrl}" class="btn btn-primary btn-sm">æŸ¥çœ‹è¯¦æƒ…</a>`
                }
            </td>
        </tr>`;
    }).join('');
}

function restoreOriginalList() {
    location.reload();
}

function getStatusClass(status) {
    const classMap = {
        'åœ¨åº“': 'status-available',
        'ä¿ç®¡ä¸­': 'status-custody',
        'å€Ÿå‡º': 'status-borrowed',
        'å·²å¯„å‡º': 'status-shipped',
        'å·²æŸå': 'status-damaged',
        'ä¸¢å¤±': 'status-lost',
        'æŠ¥åºŸ': 'status-scrapped',
        'å°å­˜': 'status-sealed'
    };
    return classMap[status] || '';
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// ==================== ç»„åˆç­›é€‰åŠŸèƒ½ ====================
let originalDevices = []; // ä¿å­˜åŸå§‹è®¾å¤‡æ•°æ®

// ä»é¡µé¢è¡¨æ ¼ä¸­è¯»å–è®¾å¤‡æ•°æ®
function loadDevicesFromTable() {
    const devices = [];
    const rows = document.querySelectorAll('#deviceTable tbody tr');
    
    rows.forEach(row => {
        if (row.classList.contains('empty-state') || row.querySelector('.empty-state')) return;
        
        const cells = row.querySelectorAll('td');
        if (cells.length < 5) return;
        
        // æ ¹æ®åˆ—æ•°åˆ¤æ–­è®¾å¤‡ç±»å‹å¹¶æå–æ•°æ®
        const device = {
            id: row.querySelector('a[href*="/pc/device/"]')?.href?.match(/\/pc\/device\/([^?]+)/)?.[1] || '',
            name: cells[2]?.textContent?.trim() || '',
            device_type: cells[3]?.textContent?.trim() || '',
            model: cells[1]?.textContent?.trim() || '',
            jira_address: cells[3]?.querySelector('a')?.textContent?.trim() || '',
            project_attribute: cells[4]?.textContent?.trim() || '',
            connection_method: cells[5]?.textContent?.trim() || '',
            os_version: cells[6]?.textContent?.trim() || '',
            os_platform: cells[7]?.textContent?.trim() || '',
            product_name: cells[8]?.textContent?.trim() || '',
            screen_orientation: cells[9]?.textContent?.trim() || '',
            screen_resolution: cells[10]?.textContent?.trim() || ''
        };
        
        devices.push(device);
    });
    
    return devices;
}

// ä»APIè·å–æ‰€æœ‰è®¾å¤‡æ•°æ®ç”¨äºç­›é€‰é€‰é¡¹
function loadAllDevicesForFilterOptions() {
    fetch('/api/search?keyword=')
        .then(r => r.json())
        .then(data => {
            if (data.success && data.devices) {
                initFilterOptions(data.devices);
            }
        })
        .catch(() => {
            // å¦‚æœAPIå¤±è´¥ï¼Œä½¿ç”¨å½“å‰é¡µé¢æ•°æ®
            initFilterOptions(originalDevices);
        });
}

// åˆå§‹åŒ–ç­›é€‰å™¨é€‰é¡¹
function initFilters() {
    const isCarOrInstrument = currentDeviceType === 'car' || currentDeviceType === 'instrument';
    if (!isCarOrInstrument) return;
    
    // ä»APIè·å–æ‰€æœ‰è®¾å¤‡æ•°æ®æ¥ç”Ÿæˆç­›é€‰é€‰é¡¹
    loadAllDevicesForFilterOptions();
}

// æ ¹æ®è®¾å¤‡æ•°æ®å¡«å……ç­›é€‰é€‰é¡¹
function initFilterOptions(deviceList) {
    if (!deviceList || deviceList.length === 0) {
        console.log('æ²¡æœ‰è®¾å¤‡æ•°æ®ï¼Œæ— æ³•åˆå§‹åŒ–ç­›é€‰å™¨');
        return;
    }
    
    // æ”¶é›†æ‰€æœ‰å”¯ä¸€çš„å€¼
    const projectSet = new Set();
    const connectionSet = new Set();
    const osVersionSet = new Set();
    const osPlatformSet = new Set();
    const productSet = new Set();
    const orientationSet = new Set();
    const resolutionSet = new Set();
    
    deviceList.forEach(d => {
        if (d.project_attribute && d.project_attribute !== '-') projectSet.add(d.project_attribute);
        if (d.connection_method && d.connection_method !== '-') connectionSet.add(d.connection_method);
        if (d.os_version && d.os_version !== '-') osVersionSet.add(d.os_version);
        if (d.os_platform && d.os_platform !== '-') osPlatformSet.add(d.os_platform);
        if (d.product_name && d.product_name !== '-') productSet.add(d.product_name);
        if (d.screen_orientation && d.screen_orientation !== '-') orientationSet.add(d.screen_orientation);
        if (d.screen_resolution && d.screen_resolution !== '-') resolutionSet.add(d.screen_resolution);
    });
    
    // æ¸…ç©ºå¹¶å¡«å……ä¸‹æ‹‰æ¡†
    clearAndFillSelect('filterProject', projectSet);
    clearAndFillSelect('filterConnection', connectionSet);
    clearAndFillSelect('filterOsVersion', osVersionSet);
    clearAndFillSelect('filterOsPlatform', osPlatformSet);
    clearAndFillSelect('filterProduct', productSet);
    clearAndFillSelect('filterOrientation', orientationSet);
    clearAndFillSelect('filterResolution', resolutionSet);
}

function clearAndFillSelect(selectId, valueSet) {
    const select = document.getElementById(selectId);
    if (!select) return;
    
    // ä¿ç•™ç¬¬ä¸€ä¸ª"å…¨éƒ¨"é€‰é¡¹
    const firstOption = select.options[0];
    select.innerHTML = '';
    select.appendChild(firstOption);
    
    const values = Array.from(valueSet).sort();
    values.forEach(value => {
        if (value && value.trim()) {
            const option = document.createElement('option');
            option.value = value;
            option.textContent = value;
            select.appendChild(option);
        }
    });
}



// åº”ç”¨ç­›é€‰
function applyFilters() {
    const project = document.getElementById('filterProject')?.value || '';
    const connection = document.getElementById('filterConnection')?.value || '';
    const osVersion = document.getElementById('filterOsVersion')?.value || '';
    const osPlatform = document.getElementById('filterOsPlatform')?.value || '';
    const product = document.getElementById('filterProduct')?.value || '';
    const orientation = document.getElementById('filterOrientation')?.value || '';
    const resolution = document.getElementById('filterResolution')?.value || '';
    
    // ä»åŸå§‹æ•°æ®ä¸­ç­›é€‰
    let filtered = allDevices.filter(d => {
        if (project && d.project_attribute !== project) return false;
        if (connection && d.connection_method !== connection) return false;
        if (osVersion && d.os_version !== osVersion) return false;
        if (osPlatform && d.os_platform !== osPlatform) return false;
        if (product && d.product_name !== product) return false;
        if (orientation && d.screen_orientation !== orientation) return false;
        if (resolution && d.screen_resolution !== resolution) return false;
        return true;
    });
    
    renderSearchResults(filtered);
    
    // æ˜¾ç¤ºç­›é€‰ç»“æœæ•°é‡
    const pagination = document.querySelector('.pagination');
    if (pagination) pagination.style.display = 'none';
}

// é‡ç½®ç­›é€‰
function resetFilters() {
    document.getElementById('filterProject').value = '';
    document.getElementById('filterConnection').value = '';
    document.getElementById('filterOsVersion').value = '';
    document.getElementById('filterOsPlatform').value = '';
    document.getElementById('filterProduct').value = '';
    document.getElementById('filterOrientation').value = '';
    document.getElementById('filterResolution').value = '';
    
    // æ¢å¤åŸå§‹åˆ—è¡¨
    if (document.getElementById('searchInput').value.trim()) {
        // å¦‚æœæœ‰æœç´¢å…³é”®è¯ï¼Œé‡æ–°æœç´¢
        doSearch(document.getElementById('searchInput').value.trim());
    } else {
        // å¦åˆ™æ¢å¤åŸå§‹åˆ—è¡¨
        restoreOriginalList();
    }
}

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–ç­›é€‰å™¨
document.addEventListener('DOMContentLoaded', function() {
    // ç­‰å¾…é¡µé¢å®Œå…¨åŠ è½½ååˆå§‹åŒ–ç­›é€‰å™¨
    setTimeout(() => {
        // ä»é¡µé¢è¡¨æ ¼åŠ è½½è®¾å¤‡æ•°æ®
        originalDevices = loadDevicesFromTable();
        allDevices = originalDevices;
        initFilters();
    }, 300);
});
</script>
{% endblock %}
