{% extends "pc/base_pc.html" %}

{% block title %}å€Ÿç”¨è®¾å¤‡åˆ—è¡¨ - è®¾å¤‡ç®¡ç†ç³»ç»Ÿ{% endblock %}

{% set active_nav = 'devices' %}

{% block content %}
<h1 class="page-title">
    {% if no_cabinet %}
    ğŸ“¦ æ— æŸœå·è®¾å¤‡
    {% elif device_type == 'car' %}
    ğŸš— è½¦æœºè®¾å¤‡
    {% elif device_type == 'phone' %}
    ğŸ“± æ‰‹æœºè®¾å¤‡
    {% elif device_type == 'instrument' %}
    ğŸ“Š ä»ªè¡¨è®¾å¤‡
    {% elif device_type == 'simcard' %}
    ğŸ“² æ‰‹æœºå¡è®¾å¤‡
    {% elif device_type == 'other' %}
    ğŸ”§ å…¶å®ƒè®¾å¤‡
    {% else %}
    ğŸ“¦ å…¨éƒ¨è®¾å¤‡
    {% endif %}
</h1>

<!-- æœç´¢å’Œç­›é€‰ -->
<div class="search-bar">
    <div class="search-input-wrap">
        <span class="search-icon">ğŸ”</span>
        <input type="text" id="searchInput" class="search-input" placeholder="æœç´¢ï¼šåç§°ã€å‹å·ã€JIRAã€é¡¹ç›®å±æ€§ã€ç³»ç»Ÿç‰ˆæœ¬ã€å€Ÿç”¨äºº..." onkeyup="handleSearch(event)">
        <button class="clear-btn" id="clearSearchBtn" onclick="clearSearch()" style="display:none; position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; color: #999;">âœ•</button>
    </div>
</div>

<div class="filter-tabs">
    <a href="{{ url_for('pc_device_list') }}" class="filter-tab {% if (not device_type or device_type == 'all') and not no_cabinet %}active{% endif %}">å…¨éƒ¨</a>
    <a href="{{ url_for('pc_device_list', type='car') }}" class="filter-tab {% if device_type == 'car' %}active{% endif %}">è½¦æœº</a>
    <a href="{{ url_for('pc_device_list', type='phone') }}" class="filter-tab {% if device_type == 'phone' %}active{% endif %}">æ‰‹æœº</a>
    <a href="{{ url_for('pc_device_list', type='instrument') }}" class="filter-tab {% if device_type == 'instrument' %}active{% endif %}">ä»ªè¡¨</a>
    <a href="{{ url_for('pc_device_list', type='simcard') }}" class="filter-tab {% if device_type == 'simcard' %}active{% endif %}">æ‰‹æœºå¡</a>
    <a href="{{ url_for('pc_device_list', type='other') }}" class="filter-tab {% if device_type == 'other' %}active{% endif %}">å…¶å®ƒ</a>
    <a href="{{ url_for('pc_device_list', no_cabinet='1') }}" class="filter-tab {% if no_cabinet %}active{% endif %}">æ— æŸœå·</a>
</div>

<!-- è®¾å¤‡åˆ—è¡¨ -->
<div class="card">
    <div class="card-body">
        {% if devices %}
        <table class="data-table device-list-table" id="deviceTable">
            <thead>
                <tr>
                    <th style="width: 50px;">åºå·</th>
                    <th>å‹å·</th>
                    <th>è®¾å¤‡åç§°</th>
                    <th>JIRAåœ°å€</th>
                    {% if device_type == 'car' or device_type == 'instrument' %}
                    <th>é¡¹ç›®å±æ€§</th>
                    <th>è¿æ¥æ–¹å¼</th>
                    <th>ç³»ç»Ÿç‰ˆæœ¬</th>
                    <th>ç³»ç»Ÿå¹³å°</th>
                    <th>äº§å“åç§°</th>
                    <th>å±å¹•æ–¹å‘</th>
                    <th>åˆ†è¾¨ç‡</th>
                    {% elif device_type == 'phone' %}
                    <th>ç³»ç»Ÿç‰ˆæœ¬</th>
                    <th>IMEI</th>
                    <th>SNç </th>
                    <th>è¿è¥å•†</th>
                    {% elif device_type == 'simcard' %}
                    <th>å·ç </th>
                    <th>è¿è¥å•†</th>
                    {% else %}
                    <th>ç±»å‹</th>
                    <th>å¤‡æ³¨</th>
                    {% endif %}
                    <th>çŠ¶æ€</th>
                    <th style="width: 90px;">æ“ä½œ</th>
                </tr>
            </thead>
            <tbody>
                {% for device in devices %}
                <tr {% if device.status.value == 'æŠ¥åºŸ' %}class="disabled"{% endif %}>
                    <td>{{ loop.index }}</td>
                    <td>{{ device.model or '-' }}</td>
                    <td>
                        <span class="device-icon">
                            {% if device.device_type.value == 'è½¦æœº' %}ğŸš—
                            {% elif device.device_type.value == 'æ‰‹æœº' %}ğŸ“±
                            {% elif device.device_type.value == 'ä»ªè¡¨' %}ğŸ“Š
                            {% elif device.device_type.value == 'æ‰‹æœºå¡' %}ğŸ“²
                            {% else %}ğŸ”§{% endif %}
                        </span>
                        {% if device.status.value == 'æŠ¥åºŸ' %}
                        <span class="device-name">{{ device.name }}</span>
                        {% else %}
                        <a href="{% if device.no_cabinet or device.is_circulating or device.is_sealed %}{{ url_for('pc_device_detail_simple', device_id=device.id, device_type=device.device_type.value) }}{% else %}{{ url_for('pc_device_detail', device_id=device.id, device_type=device.device_type.value) }}{% endif %}" class="device-name" style="color: #1890ff; font-weight: 500;">{{ device.name }}</a>
                        {% endif %}
                    </td>
                    <td>
                        {% if device.jira_address %}
                        <a href="http://jira.carbit.lo/browse/{{ device.jira_address }}" target="_blank" style="color: #1890ff; text-decoration: none;">{{ device.jira_address }}</a>
                        {% else %}
                        -
                        {% endif %}
                    </td>
                    {% if device_type == 'car' or device_type == 'instrument' %}
                    <td>{{ device.project_attribute or '-' }}</td>
                    <td style="max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="{{ device.connection_method or '' }}">{{ device.connection_method or '-' }}</td>
                    <td>{{ device.os_version or '-' }}</td>
                    <td>{{ device.os_platform or '-' }}</td>
                    <td>{{ device.product_name or '-' }}</td>
                    <td>{{ device.screen_orientation or '-' }}</td>
                    <td>{{ device.screen_resolution or '-' }}</td>
                    {% elif device_type == 'phone' %}
                    <td>{{ device.system_version or '-' }}</td>
                    <td style="font-size: 12px;" title="{{ device.imei or '' }}">{{ device.imei[:15] + '...' if device.imei and device.imei|length > 15 else device.imei or '-' }}</td>
                    <td style="font-size: 12px;" title="{{ device.sn or '' }}">{{ device.sn[:15] + '...' if device.sn and device.sn|length > 15 else device.sn or '-' }}</td>
                    <td>{{ device.carrier or '-' }}</td>
                    {% elif device_type == 'simcard' %}
                    <td>{{ device.model or '-' }}</td>
                    <td>{{ device.carrier or '-' }}</td>
                    {% else %}
                    <td class="device-type">{{ device.device_type.value }}</td>
                    <td style="color: #8c8c8c; font-size: 13px; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="{{ device.remark or '' }}">{{ device.remark or '-' }}</td>
                    {% endif %}
                    <td>
                        {% if device.no_cabinet %}
                        <span class="status-tag status-no-cabinet">æ— æŸœå·</span>
                        {% elif device.is_circulating %}
                        <span class="status-tag status-circulating">æµé€š</span>
                        {% elif device.is_sealed %}
                        <span class="status-tag status-sealed">å°å­˜</span>
                        {% else %}
                        <span class="status-tag
                            {% if device.status.value == 'åœ¨åº“' %}status-available
                            {% elif device.status.value == 'ä¿ç®¡ä¸­' %}status-custody
                            {% elif device.status.value == 'å€Ÿå‡º' %}status-borrowed
                            {% elif device.status.value == 'å·²å¯„å‡º' %}status-shipped
                            {% elif device.status.value == 'å·²æŸå' %}status-damaged
                            {% elif device.status.value == 'ä¸¢å¤±' %}status-lost
                            {% elif device.status.value == 'æŠ¥åºŸ' %}status-scrapped
                            {% endif %}">
                            {{ device.status.value }}
                        </span>
                        {% endif %}
                    </td>
                    <td>
                        {% if device.status.value == 'æŠ¥åºŸ' %}
                        <button class="btn btn-default btn-sm" disabled>å·²æŠ¥åºŸ</button>
                        {% else %}
                        <a href="{% if device.no_cabinet or device.is_circulating or device.is_sealed %}{{ url_for('pc_device_detail_simple', device_id=device.id, device_type=device.device_type.value) }}{% else %}{{ url_for('pc_device_detail', device_id=device.id, device_type=device.device_type.value) }}{% endif %}" class="btn btn-primary btn-sm">æŸ¥çœ‹è¯¦æƒ…</a>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <!-- åˆ†é¡µ -->
        {% if total_pages > 1 %}
        <div class="pagination">
            <a href="{{ url_for('pc_device_list', type=device_type, no_cabinet='1' if no_cabinet else '', page=page-1) }}" class="page-btn" {% if page <= 1 %}style="pointer-events: none; opacity: 0.5;"{% endif %}>â€¹ ä¸Šä¸€é¡µ</a>
            <span class="page-info">{{ page }} / {{ total_pages }} é¡µ (å…±{{ total }}å°)</span>
            <a href="{{ url_for('pc_device_list', type=device_type, no_cabinet='1' if no_cabinet else '', page=page+1) }}" class="page-btn" {% if page >= total_pages %}style="pointer-events: none; opacity: 0.5;"{% endif %}>ä¸‹ä¸€é¡µ â€º</a>
        </div>
        {% endif %}
        {% else %}
        <div class="empty-state">
            <div class="empty-icon">ğŸ”</div>
            <p class="empty-title">æš‚æ— è®¾å¤‡</p>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let searchTimeout;
let allDevices = []; // ç¼“å­˜æœç´¢ç»“æœ
let isSearching = false;

function handleSearch(event) {
    clearTimeout(searchTimeout);
    const keyword = event.target.value.trim();
    
    // å¦‚æœæœç´¢æ¡†ä¸ºç©ºï¼Œæ¢å¤åŸå§‹åˆ—è¡¨
    if (!keyword) {
        restoreOriginalList();
        return;
    }
    
    searchTimeout = setTimeout(() => {
        doSearch(keyword);
    }, 300);
}

function doSearch(keyword) {
    if (isSearching) return;
    isSearching = true;
    
    fetch(`/api/search?keyword=${encodeURIComponent(keyword)}`)
        .then(res => res.json())
        .then(data => {
            isSearching = false;
            if (data.success) {
                allDevices = data.devices;
                renderSearchResults(allDevices);
            } else {
                showToast('æœç´¢å¤±è´¥');
            }
        })
        .catch(err => {
            isSearching = false;
            showToast('æœç´¢å¤±è´¥ï¼Œè¯·é‡è¯•');
        });
}

function renderSearchResults(devices) {
    const tbody = document.querySelector('#deviceTable tbody');
    const pagination = document.querySelector('.pagination');
    
    // éšè—åˆ†é¡µ
    if (pagination) {
        pagination.style.display = 'none';
    }
    
    if (devices.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="5" class="empty-state" style="padding: 40px;">
                    <div class="empty-icon">ğŸ”</div>
                    <p class="empty-title">æœªæ‰¾åˆ°åŒ¹é…çš„è®¾å¤‡</p>
                </td>
            </tr>
        `;
        return;
    }
    
    const getDeviceIcon = (type) => {
        const iconMap = {
            'è½¦æœº': 'ğŸš—',
            'æ‰‹æœº': 'ğŸ“±',
            'ä»ªè¡¨': 'ğŸ“Š',
            'æ‰‹æœºå¡': 'ğŸ“²',
            'å…¶å®ƒè®¾å¤‡': 'ğŸ”§'
        };
        return iconMap[type] || 'ğŸ”§';
    };
    
    tbody.innerHTML = devices.map(device => `
        <tr ${device.status === 'æŠ¥åºŸ' ? 'class="disabled"' : ''}>
            <td>
                <span class="device-icon">${getDeviceIcon(device.device_type)}</span>
                ${device.status === 'æŠ¥åºŸ'
                    ? `<span class="device-name">${escapeHtml(device.name)}</span>`
                    : `<a href="${device.no_cabinet || device.is_circulating || device.is_sealed ? '/pc/device/' + device.id + '/simple?device_type=' + encodeURIComponent(device.device_type) : '/pc/device/' + device.id + '?device_type=' + encodeURIComponent(device.device_type)}" class="device-name" style="color: #1890ff; font-weight: 500;">${escapeHtml(device.name)}</a>`
                }
            </td>
            <td class="device-type">${device.device_type}</td>
            <td>
                ${device.no_cabinet
                    ? '<span class="status-tag status-no-cabinet">æ— æŸœå·</span>'
                    : device.is_circulating
                        ? '<span class="status-tag status-circulating">æµé€š</span>'
                        : device.is_sealed
                            ? '<span class="status-tag status-sealed">å°å­˜</span>'
                            : `<span class="status-tag ${getStatusClass(device.status)}">${device.status}</span>`
                }
            </td>
            <td style="color: #8c8c8c; font-size: 13px; max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${device.remark ? escapeHtml(device.remark) : '-'}</td>
            <td>
                ${device.status === 'æŠ¥åºŸ'
                    ? '<button class="btn btn-default btn-sm" disabled>å·²æŠ¥åºŸ</button>'
                    : `<a href="${device.no_cabinet || device.is_circulating || device.is_sealed ? '/pc/device/' + device.id + '/simple?device_type=' + encodeURIComponent(device.device_type) : '/pc/device/' + device.id + '?device_type=' + encodeURIComponent(device.device_type)}" class="btn btn-primary btn-sm">æŸ¥çœ‹è¯¦æƒ…</a>`
                }
            </td>
        </tr>
    `).join('');
}

function restoreOriginalList() {
    location.reload();
}

function getStatusClass(status) {
    const classMap = {
        'åœ¨åº“': 'status-available',
        'ä¿ç®¡ä¸­': 'status-custody',
        'å€Ÿå‡º': 'status-borrowed',
        'å·²å¯„å‡º': 'status-shipped',
        'å·²æŸå': 'status-damaged',
        'ä¸¢å¤±': 'status-lost',
        'æŠ¥åºŸ': 'status-scrapped',
        'å°å­˜': 'status-sealed'
    };
    return classMap[status] || '';
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>
{% endblock %}
