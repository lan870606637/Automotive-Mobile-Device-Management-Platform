{% extends "pc/base_pc.html" %}

{% block title %}æˆ‘çš„ä¿ç®¡è®¾å¤‡ - è®¾å¤‡ç®¡ç†ç³»ç»Ÿ{% endblock %}

{% set active_nav = 'my_custodian' %}

{% block content %}
<h1 class="page-title">ğŸ›¡ï¸ æˆ‘çš„ä¿ç®¡è®¾å¤‡</h1>

<!-- ç»Ÿè®¡å¡ç‰‡ -->
<div class="stats-grid" style="grid-template-columns: repeat(2, 1fr);">
    <div class="stat-card">
        <div class="stat-header">
            <span class="stat-icon blue">ğŸ“±</span>
            <span class="stat-label">ä¿ç®¡è®¾å¤‡æ€»æ•°</span>
        </div>
        <div class="stat-value">{{ total_count }}</div>
    </div>
    <div class="stat-card">
        <div class="stat-header">
            <span class="stat-icon orange">ğŸ“¤</span>
            <span class="stat-label">å½“å‰å€Ÿå‡º</span>
        </div>
        <div class="stat-value">{{ devices|selectattr('status', 'equalto', 'å€Ÿå‡º')|list|length }}</div>
    </div>
</div>

<!-- è®¾å¤‡åˆ—è¡¨ -->
<div class="card">
    <div class="card-header">
        <span class="card-title">ğŸ“‹ ä¿ç®¡è®¾å¤‡æ˜ç»†</span>
    </div>
    <div class="card-body">
        {% if devices %}
        <table class="data-table">
            <thead>
                <tr>
                    <th>è®¾å¤‡åç§°</th>
                    <th>ç±»å‹</th>
                    <th>å½“å‰å€Ÿç”¨äºº</th>
                    <th>å€Ÿç”¨æ—¶é—´</th>
                    <th>é¢„è®¡å½’è¿˜</th>
                    <th>çŠ¶æ€</th>
                    <th>æ—¶é—´</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody>
                {% for device in devices %}
                <tr>
                    <td>
                        <span style="font-size: 16px; margin-right: 4px;">{% if device.type == 'è½¦æœº' %}ğŸš—{% elif device.type == 'æ‰‹æœº' %}ğŸ“±{% elif device.type == 'ä»ªè¡¨' %}ğŸ“Š{% elif device.type == 'æ‰‹æœºå¡' %}ğŸ“²{% elif device.type == 'å…¶å®ƒè®¾å¤‡' %}ğŸ”§{% else %}ğŸ“¦{% endif %}</span>
                        <a href="{{ url_for('pc_device_detail', device_id=device.id) }}" style="font-weight: 500; color: #1890ff; text-decoration: none;">{{ device.name }}</a>
                    </td>
                    <td>{{ device.type }}</td>
                    <td>
                        {% if device.status in ['ä¸¢å¤±', 'å·²æŸå'] %}
                        <span style="color: #8c8c8c;">-</span>
                        {% elif device.borrower == 'æœªå€Ÿç”¨' %}
                        <span style="color: #8c8c8c;">æœªå€Ÿç”¨</span>
                        {% elif device.borrower == user.borrower_name %}
                        <span style="color: #8c8c8c;">-</span>
                        {% else %}
                        {{ device.borrower }}
                        {% endif %}
                    </td>
                    <td style="font-size: 13px; color: #595959;">
                        {% if device.status in ['ä¸¢å¤±', 'å·²æŸå'] %}-
                        {% else %}{{ device.borrow_time or '-' }}
                        {% endif %}
                    </td>
                    <td style="font-size: 13px; color: #595959;">
                        {% if device.status in ['ä¸¢å¤±', 'å·²æŸå'] %}-
                        {% else %}{{ device.expected_return_date or '-' }}
                        {% endif %}
                    </td>
                    <td>
                        {% if device.status == 'ä¸¢å¤±' %}
                        <span class="status-tag status-lost">ä¸¢å¤±</span>
                        {% elif device.status == 'å·²æŸå' %}
                        <span class="status-tag status-damaged">å·²æŸå</span>
                        {% elif device.status == 'æŠ¥åºŸ' %}
                        <span class="status-tag status-scrapped">æŠ¥åºŸ</span>
                        {% elif device.status == 'å·²å¯„å‡º' %}
                        <span class="status-tag status-shipped">å·²å¯„å‡º</span>
                        {% elif device.status == 'å€Ÿå‡º' or device.borrower != 'æœªå€Ÿç”¨' %}
                        <span class="status-tag status-borrowed">å€Ÿå‡º</span>
                        {% elif device.type == 'æ‰‹æœº' %}
                        <span class="status-tag status-available">ä¿ç®¡ä¸­</span>
                        {% else %}
                        <span class="status-tag status-available">åœ¨åº“</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if device.status in ['ä¸¢å¤±', 'å·²æŸå', 'æŠ¥åºŸ', 'å·²å¯„å‡º'] %}
                        <span style="color: #8c8c8c;">-</span>
                        {% elif device.status == 'å€Ÿå‡º' or device.borrower != 'æœªå€Ÿç”¨' %}
                            {% if device.time_remaining %}
                                {% if device.is_overdue %}
                                <span class="status-tag status-lost">{{ device.time_remaining }}</span>
                                {% else %}
                                <span class="status-tag status-available">{{ device.time_remaining }}</span>
                                {% endif %}
                            {% else %}
                            <span style="color: #8c8c8c;">-</span>
                            {% endif %}
                        {% else %}
                        <span style="color: #8c8c8c;">-</span>
                        {% endif %}
                    </td>
                    <td>
                        <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                            {% if device.status == 'ä¸¢å¤±' %}
                            <button class="btn btn-success btn-sm" onclick="foundDevice('{{ device.id }}', '{{ device.name }}')">æˆ‘å·²æ‰¾åˆ°</button>
                            <button class="btn btn-primary btn-sm" onclick="transferCustodian('{{ device.id }}', '{{ device.name }}')">è½¬è®©ä¿ç®¡äºº</button>
                            {% elif device.status == 'å·²æŸå' %}
                            <button class="btn btn-success btn-sm" onclick="repairDevice('{{ device.id }}', '{{ device.name }}')">æˆ‘å·²ä¿®å¥½</button>
                            <button class="btn btn-primary btn-sm" onclick="transferCustodian('{{ device.id }}', '{{ device.name }}')">è½¬è®©ä¿ç®¡äºº</button>
                            {% elif device.status == 'æŠ¥åºŸ' %}
                            <span style="color: #8c8c8c; font-size: 13px;">ä¸å¯æ“ä½œ</span>
                            {% elif device.status == 'å·²å¯„å‡º' %}
                            <button class="btn btn-primary btn-sm" onclick="transferCustodian('{{ device.id }}', '{{ device.name }}')">è½¬è®©ä¿ç®¡äºº</button>
                            <a href="{{ url_for('pc_device_detail', device_id=device.id) }}" class="btn btn-primary btn-sm">è¯¦æƒ…</a>
                            {% elif device.status == 'å€Ÿå‡º' or device.borrower != 'æœªå€Ÿç”¨' %}
                            <button class="btn btn-error btn-sm" onclick="forceReturn('{{ device.id }}', '{{ device.name }}')">å¼ºåˆ¶å½’è¿˜</button>
                            <button class="btn btn-warning btn-sm" onclick="transferDevice('{{ device.id }}', '{{ device.name }}', '{{ device.borrower }}')">è½¬å€Ÿ</button>
                            <button class="btn btn-primary btn-sm" onclick="transferCustodian('{{ device.id }}', '{{ device.name }}')">è½¬è®©ä¿ç®¡äºº</button>
                            <a href="{{ url_for('pc_device_detail', device_id=device.id) }}" class="btn btn-primary btn-sm">è¯¦æƒ…</a>
                            {% else %}
                            <button class="btn btn-primary btn-sm" onclick="transferCustodian('{{ device.id }}', '{{ device.name }}')">è½¬è®©ä¿ç®¡äºº</button>
                            <a href="{{ url_for('pc_device_detail', device_id=device.id) }}" class="btn btn-primary btn-sm">è¯¦æƒ…</a>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="empty-state">
            <div class="empty-icon">ğŸ“­</div>
            <p class="empty-title">æš‚æ— ä¿ç®¡è®¾å¤‡</p>
            <p style="color: #8c8c8c; font-size: 14px;">æ‚¨å½“å‰æ²¡æœ‰ä¿ç®¡ä»»ä½•è®¾å¤‡</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- å¼ºåˆ¶å½’è¿˜ç¡®è®¤å¼¹çª— -->
<div id="returnModal" class="modal-overlay">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title">å¼ºåˆ¶å½’è¿˜ç¡®è®¤</h3>
            <button class="modal-close" onclick="closeReturnModal()">&times;</button>
        </div>
        <div class="modal-body">
            <p>ç¡®å®šè¦å¼ºåˆ¶æ”¶å›è®¾å¤‡ <strong id="returnDeviceName"></strong> å—ï¼Ÿ</p>
            <p style="color: #999; font-size: 13px; margin-top: 8px;">æ­¤æ“ä½œå°†ç›´æ¥ä»å½“å‰å€Ÿç”¨äººå¤„æ”¶å›è®¾å¤‡ã€‚</p>
        </div>
        <div class="modal-footer">
            <button class="btn btn-default" onclick="closeReturnModal()">å–æ¶ˆ</button>
            <button class="btn btn-error" onclick="confirmReturn()">ç¡®è®¤æ”¶å›</button>
        </div>
    </div>
</div>

<!-- è½¬å€Ÿå¼¹çª— -->
<div id="transferModal" class="modal-overlay">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title">è½¬å€Ÿè®¾å¤‡</h3>
            <button class="modal-close" onclick="closeTransferModal()">&times;</button>
        </div>
        <div class="modal-body">
            <p style="margin-bottom: 16px;">è®¾å¤‡ï¼š<strong id="transferDeviceName"></strong></p>
            <div class="form-group">
                <label class="form-label">é€‰æ‹©è½¬å€Ÿäºº</label>
                <select id="transferTo" class="form-select">
                    <option value="">è¯·é€‰æ‹©</option>
                </select>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-default" onclick="closeTransferModal()">å–æ¶ˆ</button>
            <button class="btn btn-primary" onclick="confirmTransfer()">ç¡®è®¤è½¬å€Ÿ</button>
        </div>
    </div>
</div>

<!-- æˆ‘å·²æ‰¾åˆ°å¼¹çª— -->
<div id="foundModal" class="modal-overlay">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title">è®¾å¤‡å·²æ‰¾åˆ°</h3>
            <button class="modal-close" onclick="closeFoundModal()">&times;</button>
        </div>
        <div class="modal-body">
            <p style="margin-bottom: 16px;">è®¾å¤‡ï¼š<strong id="foundDeviceName"></strong></p>
            <div class="form-group">
                <label class="form-label">é€‰æ‹©å¤„ç†æ–¹å¼</label>
                <div class="radio-group">
                    <label class="radio-item">
                        <input type="radio" name="foundAction" value="return" checked>
                        <span>ä¿ç®¡äººè‡ªç”¨</span>
                    </label>
                    <label class="radio-item">
                        <input type="radio" name="foundAction" value="transfer">
                        <span>è½¬å€Ÿä»–äºº</span>
                    </label>
                </div>
            </div>
            <div class="form-group" id="foundTransferSelect" style="display: none;">
                <label class="form-label">é€‰æ‹©è½¬å€Ÿäºº</label>
                <select id="foundTransferTo" class="form-select">
                    <option value="">è¯·é€‰æ‹©</option>
                </select>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-default" onclick="closeFoundModal()">å–æ¶ˆ</button>
            <button class="btn btn-success" onclick="confirmFound()">ç¡®è®¤</button>
        </div>
    </div>
</div>

<!-- æˆ‘å·²ä¿®å¥½å¼¹çª— -->
<div id="repairModal" class="modal-overlay">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title">è®¾å¤‡å·²ä¿®å¥½</h3>
            <button class="modal-close" onclick="closeRepairModal()">&times;</button>
        </div>
        <div class="modal-body">
            <p style="margin-bottom: 16px;">è®¾å¤‡ï¼š<strong id="repairDeviceName"></strong></p>
            <div class="form-group">
                <label class="form-label">é€‰æ‹©å¤„ç†æ–¹å¼</label>
                <div class="radio-group">
                    <label class="radio-item">
                        <input type="radio" name="repairAction" value="return" checked>
                        <span>ä¿ç®¡äººè‡ªç”¨</span>
                    </label>
                    <label class="radio-item">
                        <input type="radio" name="repairAction" value="transfer">
                        <span>è½¬å€Ÿä»–äºº</span>
                    </label>
                </div>
            </div>
            <div class="form-group" id="repairTransferSelect" style="display: none;">
                <label class="form-label">é€‰æ‹©è½¬å€Ÿäºº</label>
                <select id="repairTransferTo" class="form-select">
                    <option value="">è¯·é€‰æ‹©</option>
                </select>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-default" onclick="closeRepairModal()">å–æ¶ˆ</button>
            <button class="btn btn-success" onclick="confirmRepair()">ç¡®è®¤</button>
        </div>
    </div>
</div>

<!-- è½¬è®©ä¿ç®¡äººå¼¹çª— -->
<div id="transferCustodianModal" class="modal-overlay">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title">è½¬è®©ä¿ç®¡äºº</h3>
            <button class="modal-close" onclick="closeTransferCustodianModal()">&times;</button>
        </div>
        <div class="modal-body">
            <p style="margin-bottom: 16px;">è®¾å¤‡ï¼š<strong id="transferCustodianDeviceName"></strong></p>
            <div class="form-group">
                <label class="form-label">é€‰æ‹©æ–°ä¿ç®¡äºº</label>
                <select id="newCustodian" class="form-select">
                    <option value="">è¯·é€‰æ‹©</option>
                </select>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-default" onclick="closeTransferCustodianModal()">å–æ¶ˆ</button>
            <button class="btn btn-primary" onclick="confirmTransferCustodian()">ç¡®è®¤è½¬è®©</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentDeviceId = '';

// å¼ºåˆ¶å½’è¿˜
function forceReturn(deviceId, deviceName) {
    currentDeviceId = deviceId;
    document.getElementById('returnDeviceName').textContent = deviceName;
    document.getElementById('returnModal').classList.add('active');
}

function closeReturnModal() {
    document.getElementById('returnModal').classList.remove('active');
}

function confirmReturn() {
    fetch('/api/return-by-custodian', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ device_id: currentDeviceId })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            showToast('æ”¶å›æˆåŠŸ');
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast(data.message || 'æ”¶å›å¤±è´¥');
        }
    })
    .catch(err => {
        showToast('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•');
    });
    closeReturnModal();
}

// è½¬å€Ÿ
function transferDevice(deviceId, deviceName, currentBorrower) {
    currentDeviceId = deviceId;
    document.getElementById('transferDeviceName').textContent = deviceName;

    // åŠ è½½ç”¨æˆ·åˆ—è¡¨ï¼ˆæ’é™¤å½“å‰å€Ÿç”¨äººï¼‰
    fetch('/api/users')
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            const select = document.getElementById('transferTo');
            select.innerHTML = '<option value="">è¯·é€‰æ‹©</option>';
            data.users.forEach(u => {
                // æ’é™¤å½“å‰å€Ÿç”¨äººï¼ˆå½“ä¸æ˜¯"æœªå€Ÿç”¨"æ—¶ï¼‰
                if (currentBorrower && currentBorrower !== 'æœªå€Ÿç”¨' && u.name === currentBorrower) {
                    return;
                }
                select.innerHTML += `<option value="${u.name}">${u.name}</option>`;
            });
        }
    });

    document.getElementById('transferModal').classList.add('active');
}

function closeTransferModal() {
    document.getElementById('transferModal').classList.remove('active');
}

function confirmTransfer() {
    const transferTo = document.getElementById('transferTo').value;
    if (!transferTo) {
        showToast('è¯·é€‰æ‹©è½¬å€Ÿäºº');
        return;
    }
    
    fetch('/api/transfer', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            device_id: currentDeviceId,
            transfer_to: transferTo
        })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            showToast('è½¬å€ŸæˆåŠŸ');
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast(data.message || 'è½¬å€Ÿå¤±è´¥');
        }
    })
    .catch(err => {
        showToast('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•');
    });
    closeTransferModal();
}

// Toastæç¤º
function showToast(message) {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.classList.add('show');
    setTimeout(() => toast.classList.remove('show'), 2000);
}

// æˆ‘å·²æ‰¾åˆ°
function foundDevice(deviceId, deviceName) {
    currentDeviceId = deviceId;
    document.getElementById('foundDeviceName').textContent = deviceName;
    
    // åŠ è½½ç”¨æˆ·åˆ—è¡¨ï¼ˆæ’é™¤è‡ªå·±ï¼‰
    fetch('/api/users')
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            const select = document.getElementById('foundTransferTo');
            select.innerHTML = '<option value="">è¯·é€‰æ‹©</option>';
            const currentUser = '{{ user.borrower_name }}';
            data.users.forEach(u => {
                if (u.name !== currentUser) {
                    select.innerHTML += `<option value="${u.name}">${u.name}</option>`;
                }
            });
        }
    });
    
    document.getElementById('foundModal').classList.add('active');
}

function closeFoundModal() {
    document.getElementById('foundModal').classList.remove('active');
}

function confirmFound() {
    const action = document.querySelector('input[name="foundAction"]:checked').value;
    const transferTo = document.getElementById('foundTransferTo').value;
    
    if (action === 'transfer' && !transferTo) {
        showToast('è¯·é€‰æ‹©è½¬å€Ÿäºº');
        return;
    }
    
    fetch('/api/found-device', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            device_id: currentDeviceId,
            action: action,
            transfer_to: transferTo
        })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            showToast('æ“ä½œæˆåŠŸ');
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast(data.message || 'æ“ä½œå¤±è´¥');
        }
    })
    .catch(err => {
        showToast('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•');
    });
    closeFoundModal();
}

// æˆ‘å·²ä¿®å¥½
function repairDevice(deviceId, deviceName) {
    currentDeviceId = deviceId;
    document.getElementById('repairDeviceName').textContent = deviceName;
    
    // åŠ è½½ç”¨æˆ·åˆ—è¡¨ï¼ˆæ’é™¤è‡ªå·±ï¼‰
    fetch('/api/users')
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            const select = document.getElementById('repairTransferTo');
            select.innerHTML = '<option value="">è¯·é€‰æ‹©</option>';
            const currentUser = '{{ user.borrower_name }}';
            data.users.forEach(u => {
                if (u.name !== currentUser) {
                    select.innerHTML += `<option value="${u.name}">${u.name}</option>`;
                }
            });
        }
    });
    
    document.getElementById('repairModal').classList.add('active');
}

function closeRepairModal() {
    document.getElementById('repairModal').classList.remove('active');
}

function confirmRepair() {
    const action = document.querySelector('input[name="repairAction"]:checked').value;
    const transferTo = document.getElementById('repairTransferTo').value;
    
    if (action === 'transfer' && !transferTo) {
        showToast('è¯·é€‰æ‹©è½¬å€Ÿäºº');
        return;
    }
    
    fetch('/api/repair-device', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            device_id: currentDeviceId,
            action: action,
            transfer_to: transferTo
        })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            showToast('æ“ä½œæˆåŠŸ');
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast(data.message || 'æ“ä½œå¤±è´¥');
        }
    })
    .catch(err => {
        showToast('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•');
    });
    closeRepairModal();
}

// ç›‘å¬å•é€‰æŒ‰é’®å˜åŒ–
if (document.querySelectorAll('input[name="foundAction"]').length > 0) {
    document.querySelectorAll('input[name="foundAction"]').forEach(radio => {
        radio.addEventListener('change', function() {
            document.getElementById('foundTransferSelect').style.display = 
                this.value === 'transfer' ? 'block' : 'none';
        });
    });
}

if (document.querySelectorAll('input[name="repairAction"]').length > 0) {
    document.querySelectorAll('input[name="repairAction"]').forEach(radio => {
        radio.addEventListener('change', function() {
            document.getElementById('repairTransferSelect').style.display = 
                this.value === 'transfer' ? 'block' : 'none';
        });
    });
}

// ç‚¹å‡»é®ç½©å…³é—­å¼¹çª—
document.getElementById('returnModal').addEventListener('click', function(e) {
    if (e.target === this) closeReturnModal();
});
document.getElementById('transferModal').addEventListener('click', function(e) {
    if (e.target === this) closeTransferModal();
});
document.getElementById('foundModal').addEventListener('click', function(e) {
    if (e.target === this) closeFoundModal();
});
document.getElementById('repairModal').addEventListener('click', function(e) {
    if (e.target === this) closeRepairModal();
});

// è½¬è®©ä¿ç®¡äºº
function transferCustodian(deviceId, deviceName) {
    currentDeviceId = deviceId;
    document.getElementById('transferCustodianDeviceName').textContent = deviceName;
    
    // åŠ è½½ç”¨æˆ·åˆ—è¡¨ï¼ˆæ’é™¤è‡ªå·±ï¼‰
    fetch('/api/users')
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            const select = document.getElementById('newCustodian');
            select.innerHTML = '<option value="">è¯·é€‰æ‹©</option>';
            const currentUser = '{{ user.borrower_name }}';
            data.users.forEach(u => {
                if (u.name !== currentUser) {
                    select.innerHTML += `<option value="${u.name}">${u.name}</option>`;
                }
            });
        }
    });
    
    document.getElementById('transferCustodianModal').classList.add('active');
}

function closeTransferCustodianModal() {
    document.getElementById('transferCustodianModal').classList.remove('active');
}

function confirmTransferCustodian() {
    const newCustodian = document.getElementById('newCustodian').value;
    if (!newCustodian) {
        showToast('è¯·é€‰æ‹©æ–°ä¿ç®¡äºº');
        return;
    }
    
    fetch('/api/transfer-custodian', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            device_id: currentDeviceId,
            new_custodian: newCustodian
        })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            showToast('è½¬è®©æˆåŠŸ');
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast(data.message || 'è½¬è®©å¤±è´¥');
        }
    })
    .catch(err => {
        showToast('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•');
    });
    closeTransferCustodianModal();
}

document.getElementById('transferCustodianModal').addEventListener('click', function(e) {
    if (e.target === this) closeTransferCustodianModal();
});
</script>
{% endblock %}
