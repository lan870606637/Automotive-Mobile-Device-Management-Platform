{% extends "base.html" %}

{% block title %}å€Ÿç”¨ç™»è®° - {{ device.name }}{% endblock %}

{% set show_nav = false %}

{% block content %}
<div class="form-page">
    <!-- é¡µé¢å¤´éƒ¨ -->
    <div class="page-header">
        <a href="javascript:history.back()" class="back-btn">â€¹</a>
        <h1>å€Ÿç”¨ç™»è®°</h1>
    </div>
    
    <!-- è®¾å¤‡ä¿¡æ¯ -->
    <div class="info-card">
        <div class="device-mini">
            <span class="mini-icon">{% if device_type == 'è½¦æœº' %}ğŸš—{% elif device_type == 'æ‰‹æœº' %}ğŸ“±{% elif device_type == 'ä»ªè¡¨' %}ğŸ“Š{% elif device_type == 'æ‰‹æœºå¡' %}ğŸ“²{% elif device_type == 'å…¶å®ƒè®¾å¤‡' %}ğŸ”§{% else %}ğŸ“¦{% endif %}</span>
            <div class="mini-info">
                <span class="mini-name">{{ device.name }}</span>
                <span class="mini-type">{{ device_type }}</span>
            </div>
        </div>
    </div>
    
    <!-- å€Ÿç”¨è¡¨å• -->
    <div class="form-card">
        <h3 class="form-title">å¡«å†™å€Ÿç”¨ä¿¡æ¯</h3>
        
        <div class="form-group">
            <label class="form-label">å€Ÿç”¨äºº</label>
            <input type="text" class="form-input" value="{{ user.borrower_name }}" readonly>
        </div>
        
        <div class="form-group">
            <label class="form-label">æ‰‹æœºå·</label>
            <input type="text" class="form-input" value="{{ phone_mask }}" readonly>
            <span class="form-hint">å¦‚éœ€ä¿®æ”¹è¯·è”ç³»ç®¡ç†å‘˜</span>
        </div>
        
        <div class="form-group">
            <label class="form-label">å€Ÿç”¨åŸå› </label>
            <div class="radio-group">
                <label class="radio-item">
                    <input type="radio" name="reason" value="æµ‹è¯•" checked>
                    <span class="radio-text">æµ‹è¯•</span>
                </label>
                <label class="radio-item">
                    <input type="radio" name="reason" value="å¼€å‘">
                    <span class="radio-text">å¼€å‘</span>
                </label>
                <label class="radio-item">
                    <input type="radio" name="reason" value="æ¼”ç¤º">
                    <span class="radio-text">æ¼”ç¤º</span>
                </label>
                <label class="radio-item">
                    <input type="radio" name="reason" value="å‡ºå·®">
                    <span class="radio-text">å‡ºå·®</span>
                </label>
                <label class="radio-item">
                    <input type="radio" name="reason" value="å…¶ä»–">
                    <span class="radio-text">å…¶ä»–</span>
                </label>
            </div>
        </div>
        
        <div class="form-group">
            <label class="form-label">è¯¦ç»†è¯´æ˜</label>
            <textarea id="detailReason" class="form-textarea" rows="2" placeholder="è¯·è¯¦ç»†è¯´æ˜å€Ÿç”¨ç”¨é€”..."></textarea>
        </div>
        
        <div class="form-group">
            <label class="form-label">é¢„è®¡å½’è¿˜æ—¥æœŸ</label>
            <input type="date" id="returnDate" class="form-input">
        </div>
    </div>
    
    <!-- æç¤ºä¿¡æ¯ -->
    <div class="tips-card">
        <h4>ğŸ“‹ å€Ÿç”¨é¡»çŸ¥</h4>
        <ul>
            <li>è¯·çˆ±æŠ¤è®¾å¤‡ï¼Œå¦¥å–„ä¿ç®¡</li>
            <li>æŒ‰æ—¶å½’è¿˜ï¼Œé€¾æœŸè¯·è”ç³»ç®¡ç†å‘˜</li>
            <li>å¦‚æœ‰æŸåè¯·åŠæ—¶æŠ¥å¤‡</li>
        </ul>
    </div>
    
    <!-- æäº¤æŒ‰é’® -->
    <div class="form-actions">
        <button type="button" class="btn btn-default btn-large" onclick="history.back()">å–æ¶ˆ</button>
        <button type="button" class="btn btn-primary btn-large" onclick="submitBorrow()">ç¡®è®¤å€Ÿç”¨</button>
    </div>
</div>

<script>
// è®¾ç½®é»˜è®¤å½’è¿˜æ—¥æœŸä¸º1å¤©å
document.getElementById('returnDate').value = new Date(Date.now() + 1 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];

// å€Ÿç”¨åŸå› é€‰æ‹©è”åŠ¨
const reasonInputs = document.querySelectorAll('input[name="reason"]');
const detailReason = document.getElementById('detailReason');
const reasonDetails = {
    'æµ‹è¯•': 'ç”¨äºåŠŸèƒ½æµ‹è¯•',
    'å¼€å‘': 'ç”¨äºå¼€å‘è°ƒè¯•',
    'æ¼”ç¤º': 'ç”¨äºäº§å“æ¼”ç¤º',
    'å‡ºå·®': 'ç”¨äºå‡ºå·®ä½¿ç”¨',
    'å…¶ä»–': ''
};

reasonInputs.forEach(input => {
    input.addEventListener('change', () => {
        detailReason.value = reasonDetails[input.value] || '';
    });
});
detailReason.value = reasonDetails['æµ‹è¯•'];

function submitBorrow() {
    const reasonRadio = document.querySelector('input[name="reason"]:checked');
    const detailReason = document.getElementById('detailReason').value.trim();
    const returnDate = document.getElementById('returnDate').value;
    
    const fullReason = reasonRadio.value + (detailReason ? ' - ' + detailReason : '');
    
    const btn = document.querySelector('.btn-primary');
    btn.disabled = true;
    btn.textContent = 'æäº¤ä¸­...';
    
    fetch('/api/borrow', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            device_id: '{{ device.id }}',
            reason: fullReason,
            expected_return_date: returnDate
        })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            showToast('å€Ÿç”¨æˆåŠŸï¼');
            setTimeout(() => {
                window.location.href = '/device/{{ device.id }}';
            }, 1500);
        } else {
            showToast(data.message || 'å€Ÿç”¨å¤±è´¥');
            btn.disabled = false;
            btn.textContent = 'ç¡®è®¤å€Ÿç”¨';
        }
    })
    .catch(() => {
        showToast('æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•');
        btn.disabled = false;
        btn.textContent = 'ç¡®è®¤å€Ÿç”¨';
    });
}
</script>
{% endblock %}
