{% extends "base.html" %}

{% block title %}{{ device.name }} - è®¾å¤‡è¯¦æƒ…{% endblock %}

{% set active_nav = 'devices' %}

{% block content %}
<div class="device-detail-page">
    <!-- é¡µé¢å¤´éƒ¨ -->
    <div class="page-header">
        <a href="javascript:history.back()" class="back-btn">â€¹</a>
        <h1>è®¾å¤‡è¯¦æƒ…</h1>
    </div>
    

    
    <!-- è®¾å¤‡åŸºæœ¬ä¿¡æ¯ -->
    <div class="detail-card">
        <div class="device-header">
            <span class="device-icon-large">
                {% if device_type == 'è½¦æœº' %}ğŸš—{% else %}ğŸ“±{% endif %}
            </span>
            <div class="device-title">
                <h2>{{ device.name }}</h2>
                <span class="status-badge 
                    {% if device.status.value == 'åœ¨åº“' %}status-available
                    {% elif device.status.value == 'å€Ÿå‡º' %}status-borrowed
                    {% elif device.status.value == 'å·²å¯„å‡º' %}status-shipped
                    {% elif device.status.value == 'å·²æŸå' %}status-damaged
                    {% elif device.status.value == 'ä¸¢å¤±' %}status-lost
                    {% elif device.status.value == 'æŠ¥åºŸ' %}status-scrapped
                    {% endif %}">
                    {{ device.status.value }}
                </span>
            </div>
        </div>
        
        <div class="info-list">
            <div class="info-item">
                <span class="info-label">è®¾å¤‡ç±»å‹</span>
                <span class="info-value">{{ device_type }}</span>
            </div>
            <div class="info-item">
                <span class="info-label">å‹å·</span>
                <span class="info-value">{{ device.model or '-' }}</span>
            </div>
            <div class="info-item">
                <span class="info-label">å¤‡æ³¨</span>
                <span class="info-value">{{ device.remark or '-' }}</span>
            </div>
            {% if device.status.value == 'ä¸¢å¤±' %}
            <div class="info-item" style="color: #f5222d;">
                <span class="info-label">ä¸¢å¤±æ—¶é—´</span>
                <span class="info-value">{{ device.lost_time.strftime('%Y-%m-%d %H:%M') }}</span>
            </div>
            {% endif %}
            {% if device.status.value == 'å·²æŸå' %}
            <div class="info-item" style="color: #f5222d;">
                <span class="info-label">æŸååŸå› </span>
                <span class="info-value">{{ device.damage_reason }}</span>
            </div>
            <div class="info-item" style="color: #f5222d;">
                <span class="info-label">æŸåæ—¶é—´</span>
                <span class="info-value">{{ device.damage_time.strftime('%Y-%m-%d %H:%M') }}</span>
            </div>
            {% endif %}
        </div>
    </div>
    
    {% if device.status.value == 'å·²å¯„å‡º' or device.status.value == 'å·²æŸå' or device.status.value == 'æŠ¥åºŸ' %}
    <!-- è®¾å¤‡å·²å¯„å‡ºã€å·²æŸåæˆ–æŠ¥åºŸ -->
    <div class="action-section">
        {% if device.status.value == 'æŠ¥åºŸ' %}
        <button class="btn btn-primary btn-large btn-block" disabled>è®¾å¤‡å·²æŠ¥åºŸ</button>
        {% else %}
        <button class="btn btn-primary btn-large btn-block" disabled>
            {% if device.status.value == 'å·²å¯„å‡º' %}è®¾å¤‡å·²å¯„å‡º{% else %}è®¾å¤‡å·²æŸå{% endif %}
        </button>
        {% endif %}
        {% if device.status.value == 'å·²æŸå' %}
        <div style="margin-top: 15px;">
            <button onclick="showDamageOptions('{{ device.id }}')" class="btn btn-warning btn-large btn-block">æˆ‘å·²ä¿®å¥½</button>
        </div>
        {% endif %}
    </div>

    <div class="info-list" style="margin-top: 20px;">
        <div class="info-item">
            <span class="info-label">ğŸ“ {% if device_type == 'æ‰‹æœº' %}ä¿ç®¡äºº{% else %}æŸœå·{% endif %}</span>
            <span class="info-value">{{ device.cabinet_number }}</span>
        </div>
    </div>

    <!-- å€Ÿç”¨è®°å½• -->
    <div class="records-section">
        <h3 class="section-title">å€Ÿç”¨è®°å½•</h3>
        {% if records %}
        <div class="record-list">
            {% for record in records %}
            <div class="record-item">
                <div class="record-main">
                    <span class="record-type
                        {% if 'å€Ÿå‡º' in record.operation_type.value %}type-borrow
                        {% elif 'å½’è¿˜' in record.operation_type.value %}type-return
                        {% elif 'ä¸¢å¤±' in record.operation_type.value or 'æŸå' in record.operation_type.value or 'æœªæ‰¾åˆ°' in record.operation_type.value %}type-lost
                        {% elif 'ç»­æœŸ' in record.operation_type.value %}type-renew
                        {% else %}type-transfer{% endif %}">
                        {{ record.operation_type.value }}
                    </span>
                    <span class="record-user">
                        {{ record.borrower }}
                        {% if record.entry_source == 'ç®¡ç†å‘˜å½•å…¥' %}
                        <span class="admin-badge">ç®¡</span>
                        {% endif %}
                        {% if record.reason and record.reason != 'nan' %}
                        <button class="reason-btn" onclick="showReason(this, '{{ record.reason|replace("'", "\\'") }}', event)" title="æŸ¥çœ‹è¯¦æƒ…">?</button>
                        {% endif %}
                    </span>
                </div>
                <div class="record-time">{{ record.operation_time }}</div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p class="no-data">æš‚æ— è®°å½•</p>
        {% endif %}
    </div>

    {% elif device.status.value == 'ä¸¢å¤±' %}
    <!-- è®¾å¤‡ä¸¢å¤±çŠ¶æ€ -->
    <div class="action-section">
        <button class="btn btn-primary btn-large btn-block" disabled>è®¾å¤‡å·²ä¸¢å¤±</button>
        <div style="margin-top: 15px;">
            <button onclick="showLostOptions('{{ device.id }}')" class="btn btn-success btn-large btn-block">æˆ‘å·²æ‰¾åˆ°</button>
        </div>
    </div>

    <!-- å€Ÿç”¨è®°å½• -->
    <div class="records-section">
        <h3 class="section-title">å€Ÿç”¨è®°å½•</h3>
        {% if records %}
        <div class="record-list">
            {% for record in records %}
            <div class="record-item">
                <div class="record-main">
                    <span class="record-type
                        {% if 'å€Ÿå‡º' in record.operation_type.value %}type-borrow
                        {% elif 'å½’è¿˜' in record.operation_type.value %}type-return
                        {% elif 'ä¸¢å¤±' in record.operation_type.value or 'æŸå' in record.operation_type.value or 'æœªæ‰¾åˆ°' in record.operation_type.value %}type-lost
                        {% elif 'ç»­æœŸ' in record.operation_type.value %}type-renew
                        {% else %}type-transfer{% endif %}">
                        {{ record.operation_type.value }}
                    </span>
                    <span class="record-user">
                        {{ record.borrower }}
                        {% if record.entry_source == 'ç®¡ç†å‘˜å½•å…¥' %}
                        <span class="admin-badge">ç®¡</span>
                        {% endif %}
                        {% if record.reason and record.reason != 'nan' %}
                        <button class="reason-btn" onclick="showReason(this, '{{ record.reason|replace("'", "\\'") }}', event)" title="æŸ¥çœ‹è¯¦æƒ…">?</button>
                        {% endif %}
                    </span>
                </div>
                <div class="record-time">{{ record.operation_time }}</div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p class="no-data">æš‚æ— è®°å½•</p>
        {% endif %}
    </div>

    {% elif device.status.value == 'åœ¨åº“' %}
    <!-- æƒ…å†µAï¼šè®¾å¤‡åœ¨åº“ -->
    {% if is_custodian %}
    <div class="action-section">
        <a href="{{ url_for('transfer_device', device_id=device.id) }}" class="btn btn-info btn-large btn-block">
            è½¬å€Ÿä»–äºº
        </a>
    </div>
    {% else %}
    <div class="action-section">
        <a href="{{ url_for('borrow_device', device_id=device.id) }}" class="btn btn-primary btn-large btn-block">
            æˆ‘è¦å€Ÿç”¨
        </a>
    </div>
    {% endif %}
    
    <!-- ç™»è®°åæŸ¥çœ‹åŒºåŸŸ -->
    <div class="hidden-info-section">
        <div class="section-header">
            <span class="lock-icon">ğŸ”’</span>
            <span>ç™»è®°åæŸ¥çœ‹</span>
        </div>
        <div class="hidden-content">
            <p>â€¢ {% if device_type == 'æ‰‹æœº' %}ä¿ç®¡äºº{% else %}æŸœå·{% endif %}ï¼š***</p>
            <p>â€¢ å€Ÿç”¨è®°å½•ï¼š***</p>
            <p class="tip">å€Ÿç”¨æˆåŠŸåå¯æŸ¥çœ‹å®Œæ•´ä¿¡æ¯</p>
        </div>
    </div>
    
    {% else %}
    <!-- è®¾å¤‡å€Ÿå‡ºä¸­ -->
    <div class="borrow-info-card">
        <h3 class="card-title">
            {% if is_borrower %}
            <span class="you-badge">æ‚¨æ­£åœ¨å€Ÿç”¨æ­¤è®¾å¤‡</span>
            {% else %}
            å½“å‰å€Ÿç”¨ä¿¡æ¯
            {% endif %}
        </h3>
        
        <div class="info-list">
            {% if is_borrower %}
            <div class="info-item highlight">
                <span class="info-label">ğŸ“ {% if device_type == 'æ‰‹æœº' %}ä¿ç®¡äºº{% else %}æŸœå·{% endif %}</span>
                <span class="info-value">{{ device.cabinet_number }}</span>
            </div>
            {% endif %}
            
            <div class="info-item">
                <span class="info-label">å€Ÿç”¨äºº</span>
                <span class="info-value">{{ device.borrower }}</span>
            </div>
            <div class="info-item">
                <span class="info-label">å€Ÿç”¨æ—¶é—´</span>
                <span class="info-value">{{ device.borrow_time.strftime('%Y-%m-%d %H:%M') }}</span>
            </div>
            <div class="info-item">
                <span class="info-label">å€Ÿç”¨åŸå› </span>
                <span class="info-value">{{ device.reason or '-' }}</span>
            </div>
            <div class="info-item">
                <span class="info-label">å½•å…¥è€…</span>
                <span class="info-value">{{ device.entry_source }}</span>
            </div>
            {% if device.expected_return_date %}
            <div class="info-item">
                <span class="info-label">é¢„è®¡å½’è¿˜</span>
                <span class="info-value">{{ device.expected_return_date.strftime('%Y-%m-%d') }}</span>
            </div>
            {% endif %}
            
            {% if is_overdue %}
            <div class="info-item overdue-warning">
                <span class="info-label">âš ï¸ è¶…æ—¶æé†’</span>
                <span class="info-value" style="color: #f5222d; font-weight: bold;">å·²è¶…æ—¶ {% if overdue_hours < 24 %}{{ overdue_hours }} å°æ—¶{% else %}{{ overdue_days }} å¤©{% endif %}</span>
            </div>
            {% endif %}
        </div>
        
        {% if is_borrower %}
        <div class="action-section">
            <a href="{{ url_for('return_device', device_id=device.id) }}" class="btn btn-warning btn-large btn-block">
                ç«‹å³å½’è¿˜
            </a>
            <div style="display: flex; gap: 10px; margin-top: 10px;">
                <a href="{{ url_for('transfer_device', device_id=device.id) }}" class="btn btn-info btn-large" style="flex: 1;">
                    è½¬å€Ÿä»–äºº
                </a>
                <button onclick="showRenewModal('{{ device.id }}', '{{ device.expected_return_date.strftime('%Y-%m-%d') if device.expected_return_date else '' }}')" class="btn btn-primary btn-large" style="flex: 1; background: #52c41a; border-color: #52c41a;">
                    å€Ÿç”¨ç»­æœŸ
                </button>
            </div>
            <div style="display: flex; justify-content: space-between; margin-top: 10px; gap: 10px;">
                <button onclick="showReportLost('{{ device.id }}')" class="btn" style="flex: 1; padding: 6px 0; font-size: 12px; background: #8c8c8c; color: white;">
                    ä¸¢å¤±æŠ¥å¤‡
                </button>
                <button onclick="showReportDamage('{{ device.id }}')" class="btn" style="flex: 1; padding: 6px 0; font-size: 12px; background: #fa8c16; color: white;">
                    æŸåæŠ¥å¤‡
                </button>
            </div>
            {% if device.previous_borrower %}
            <div style="margin-top: 10px; padding: 10px; background: #fff7e6; border-radius: 4px; font-size: 12px; color: #666;">
                ä¸Šä¸€ä¸ªå€Ÿç”¨äººï¼š{{ device.previous_borrower }}
            </div>
            <button onclick="confirmNotFound('{{ device.id }}')" class="btn btn-large btn-block" style="margin-top: 10px; background: #ff4d4f; color: white; border: none;">
                æœªæ‰¾åˆ°
            </button>
            {% else %}
            <button onclick="confirmNotFoundDirect('{{ device.id }}')" class="btn btn-large btn-block" style="margin-top: 10px; background: #ff4d4f; color: white; border: none;">
                æœªæ‰¾åˆ°
            </button>
            {% endif %}
        </div>
        {% elif is_custodian %}
        <div class="action-section">
            <button onclick="confirmReturnByCustodian('{{ device.id }}', '{{ device.borrower }}', '{{ device.name }}')" class="btn btn-warning btn-large btn-block">
                æ”¶å›å€Ÿç”¨
            </button>
            {% if device_type == 'æ‰‹æœº' %}
            <button onclick="showTransferCustodian('{{ device.id }}')" class="btn btn-info btn-large btn-block" style="margin-top: 10px;">
                è½¬è®©ä¿ç®¡äºº
            </button>
            {% endif %}
        </div>
        {% elif device.status.value == 'å€Ÿå‡º' and not is_borrower %}
        <div class="action-section">
            <button class="btn btn-primary btn-large btn-block" disabled>è®¾å¤‡å·²å€Ÿå‡º</button>
            <button onclick="confirmTransferToMe('{{ device.id }}', '{{ device.borrower }}', '{{ device.name }}')" class="btn btn-info btn-large btn-block" style="margin-top: 10px;">
                è½¬ç»™è‡ªå·±
            </button>
        </div>
        {% endif %}
    </div>
    
    <!-- å€Ÿç”¨è®°å½• -->
    <div class="records-section">
        <h3 class="section-title">å€Ÿç”¨è®°å½•</h3>
        {% if records %}
        <div class="record-list">
            {% for record in records %}
            <div class="record-item">
                <div class="record-main">
                    <span class="record-type 
                        {% if record.operation_type.value == 'å€Ÿå‡º' or record.operation_type.value == 'å¼ºåˆ¶å€Ÿå‡º' %}type-borrow
                        {% elif record.operation_type.value == 'å½’è¿˜' or record.operation_type.value == 'å¼ºåˆ¶å½’è¿˜' %}type-return
                        {% elif record.operation_type.value == 'ä¸¢å¤±æŠ¥å¤‡' or record.operation_type.value == 'æŸåæŠ¥å¤‡' or record.operation_type.value == 'å€Ÿç”¨äººæœªæ‰¾åˆ°' %}type-lost
                        {% elif record.operation_type.value == 'å€Ÿç”¨ç»­æœŸ' %}type-renew
                        {% else %}type-transfer{% endif %}">
                        {{ record.operation_type.value }}
                    </span>
                    <span class="record-user">
                        {{ record.borrower }}
                        {% if record.entry_source == 'ç®¡ç†å‘˜å½•å…¥' %}
                        <span class="admin-badge">ç®¡</span>
                        {% endif %}
                        {% if record.reason and record.reason != 'nan' %}
                        <button class="reason-btn" onclick="showReason(this, '{{ record.reason|replace("'", "\\'") }}', event)" title="æŸ¥çœ‹è¯¦æƒ…">?</button>
                        {% endif %}
                    </span>
                </div>
                <div class="record-time">{{ record.operation_time }}</div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p class="no-data">æš‚æ— è®°å½•</p>
        {% endif %}
    </div>
    {% endif %}
    
    <!-- æŸ¥çœ‹è®°å½• -->
    <div class="records-section">
        <h3 class="section-title">æŸ¥çœ‹è®°å½•</h3>
        {% if view_records %}
        <div class="record-list">
            {% for vr in view_records %}
            <div class="record-item">
                <div class="record-main">
                    <span class="record-type type-view">æŸ¥çœ‹</span>
                    <span class="record-user">{{ vr.viewer }}{% if is_admin_user(vr.viewer) %}<span style="color: #ff4d4f; font-weight: bold; margin-left: 2px;">ç®¡</span>{% endif %}</span>
                </div>
                <div class="record-time">{{ vr.view_time }}</div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p class="no-data">æš‚æ— æŸ¥çœ‹è®°å½•</p>
        {% endif %}
    </div>
    
    <!-- ç”¨æˆ·å¤‡æ³¨ -->
    <div class="remarks-section">
        <h3 class="section-title">
            ç”¨æˆ·å¤‡æ³¨
            <a href="{{ url_for('add_remark', device_id=device.id) }}" class="add-btn">+ æ·»åŠ </a>
        </h3>
        
        {% if remarks %}
        <div class="remark-list">
            {% for remark in remarks %}
            <div class="remark-item">
                <div class="remark-content">{{ remark.content }}</div>
                <div class="remark-meta">
                    <span class="remark-creator">{{ remark.creator }}</span>
                    <span class="remark-time">{{ remark.create_time }}</span>
                    {% if remark.is_creator %}
                    <div class="remark-actions">
                        <a href="{{ url_for('edit_remark_page', remark_id=remark.id) }}" class="action-link">ç¼–è¾‘</a>
                        <a href="javascript:void(0)" onclick="deleteRemark('{{ remark.id }}')" class="action-link delete">åˆ é™¤</a>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-remarks">
            <p>æš‚æ— å¤‡æ³¨</p>
            <a href="{{ url_for('add_remark', device_id=device.id) }}" class="link">æ·»åŠ ç¬¬ä¸€æ¡å¤‡æ³¨</a>
        </div>
        {% endif %}
    </div>
</div>

<!-- ä¸¢å¤±æŠ¥å¤‡å¼¹çª— -->
<div id="reportLostModal" class="modal" style="display: none;">
    <div class="modal-content">
        <h3>ä¸¢å¤±æŠ¥å¤‡</h3>
        <p>ç¡®å®šè¦æŠ¥å¤‡æ­¤è®¾å¤‡ä¸¢å¤±å—ï¼Ÿ</p>
        <p style="color: #999; font-size: 14px;">ä¸¢å¤±æ—¶é—´ï¼š{{ now if now else 'å½“å‰æ—¶é—´' }}</p>
        <div class="modal-actions">
            <button onclick="closeModal('reportLostModal')" class="btn btn-default">å–æ¶ˆ</button>
            <button onclick="submitReportLost()" class="btn btn-danger">ç¡®è®¤æŠ¥å¤‡</button>
        </div>
    </div>
</div>

<!-- æŸåæŠ¥å¤‡å¼¹çª— -->
<div id="reportDamageModal" class="modal" style="display: none;">
    <div class="modal-content">
        <h3>æŸåæŠ¥å¤‡</h3>
        <textarea id="damageReason" placeholder="è¯·å¡«å†™æŸååŸå› " rows="3" style="width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 4px;"></textarea>
        <div class="modal-actions">
            <button onclick="closeModal('reportDamageModal')" class="btn btn-default">å–æ¶ˆ</button>
            <button onclick="submitReportDamage()" class="btn btn-danger" style="background: #fa8c16;">ç¡®è®¤æŠ¥å¤‡</button>
        </div>
    </div>
</div>

<!-- æˆ‘å·²æ‰¾åˆ°å¼¹çª— -->
<div id="foundModal" class="modal" style="display: none;">
    <div class="modal-content">
        <h3>è®¾å¤‡å·²æ‰¾åˆ°</h3>
        <p>è¯·é€‰æ‹©åç»­æ“ä½œï¼š</p>
        <div class="modal-actions" style="flex-direction: column; gap: 10px;">
            <button onclick="submitFound('keep')" class="btn btn-primary btn-block">è½¬ç»™è‡ªå·±</button>
            <button onclick="submitFound('return')" class="btn btn-warning btn-block" id="foundReturnBtn">å½’è¿˜å…¥åº“</button>
            <button onclick="showTransferSelect('found')" class="btn btn-info btn-block">è½¬ç»™åˆ«äºº</button>
            <button onclick="closeModal('foundModal')" class="btn btn-default btn-block">å–æ¶ˆ</button>
        </div>
    </div>
</div>

<!-- æˆ‘å·²ä¿®å¥½å¼¹çª— -->
<div id="repairedModal" class="modal" style="display: none;">
    <div class="modal-content">
        <h3>è®¾å¤‡å·²ä¿®å¥½</h3>
        <p>è¯·é€‰æ‹©åç»­æ“ä½œï¼š</p>
        <div class="modal-actions" style="flex-direction: column; gap: 10px;">
            <button onclick="submitRepaired('keep')" class="btn btn-primary btn-block">è½¬ç»™è‡ªå·±</button>
            <button onclick="submitRepaired('return')" class="btn btn-warning btn-block" id="repairedReturnBtn">å½’è¿˜å…¥åº“</button>
            <button onclick="showTransferSelect('repaired')" class="btn btn-info btn-block">è½¬ç»™åˆ«äºº</button>
            <button onclick="closeModal('repairedModal')" class="btn btn-default btn-block">å–æ¶ˆ</button>
        </div>
    </div>
</div>

<!-- è½¬ç»™åˆ«äººé€‰æ‹©å¼¹çª— -->
<div id="transferSelectModal" class="modal" style="display: none;">
    <div class="modal-content">
        <h3>é€‰æ‹©è½¬å€Ÿäºº</h3>
        <select id="transferToUser" style="width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 4px;">
            <option value="">è¯·é€‰æ‹©</option>
        </select>
        <div class="modal-actions">
            <button onclick="closeModal('transferSelectModal')" class="btn btn-default">å–æ¶ˆ</button>
            <button onclick="submitTransfer()" class="btn btn-primary">ç¡®è®¤</button>
        </div>
    </div>
</div>

<!-- è½¬è®©ä¿ç®¡äººå¼¹çª— -->
<div id="transferCustodianModal" class="modal" style="display: none;">
    <div class="modal-content">
        <h3>è½¬è®©ä¿ç®¡äºº</h3>
        <select id="newCustodian" style="width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 4px;">
            <option value="">è¯·é€‰æ‹©æ–°ä¿ç®¡äºº</option>
        </select>
        <div class="modal-actions">
            <button onclick="closeModal('transferCustodianModal')" class="btn btn-default">å–æ¶ˆ</button>
            <button onclick="submitTransferCustodian()" class="btn btn-primary">ç¡®è®¤è½¬è®©</button>
        </div>
    </div>
</div>

<!-- æ°”æ³¡æç¤º -->
<div id="reasonTooltip" class="reason-tooltip" style="display: none;">
    <div class="reason-tooltip-content"></div>
    <div class="reason-tooltip-arrow"></div>
</div>

<!-- å€Ÿç”¨ç»­æœŸå¼¹çª— -->
<div id="renewModal" class="modal" style="display: none;">
    <div class="modal-content">
        <h3>å€Ÿç”¨ç»­æœŸ</h3>
        <p style="color: #666; font-size: 14px; margin-bottom: 10px;">è¯·é€‰æ‹©æ–°çš„é¢„è®¡å½’è¿˜æ—¥æœŸï¼ˆåªèƒ½å¾€åé€‰æ‹©ï¼‰ï¼š</p>
        <input type="date" id="renewDate" style="width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 4px; font-size: 16px;">
        <div class="modal-actions">
            <button onclick="closeModal('renewModal')" class="btn btn-default">å–æ¶ˆ</button>
            <button onclick="submitRenew()" class="btn btn-success">ç¡®è®¤ç»­æœŸ</button>
        </div>
    </div>
</div>

<script>
let currentDeviceId = '';
let currentAction = '';
let currentDeviceType = '{{ device_type }}';

function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
}

// éšè—æ°”æ³¡æç¤º
function hideReasonTooltip() {
    const tooltip = document.getElementById('reasonTooltip');
    if (tooltip) {
        tooltip.style.display = 'none';
    }
}

// æ˜¾ç¤ºæ°”æ³¡æç¤º
function showReason(btn, reason, event) {
    // å…ˆå…³é—­å…¶ä»–å¯èƒ½æ‰“å¼€çš„æ°”æ³¡
    hideReasonTooltip();
    
    const tooltip = document.getElementById('reasonTooltip');
    const content = tooltip.querySelector('.reason-tooltip-content');
    const arrow = tooltip.querySelector('.reason-tooltip-arrow');
    
    content.textContent = reason;
    tooltip.style.display = 'block';
    
    // å…ˆé‡ç½®ç®­å¤´æ ·å¼
    arrow.style.borderTop = '6px solid #333';
    arrow.style.borderBottom = 'none';
    arrow.style.top = 'auto';
    arrow.style.bottom = '-6px';
    
    // è®¡ç®—ä½ç½®
    const btnRect = btn.getBoundingClientRect();
    const tooltipRect = tooltip.getBoundingClientRect();
    
    // æ°´å¹³å±…ä¸­
    let left = btnRect.left + btnRect.width / 2 - tooltipRect.width / 2;
    // åœ¨æŒ‰é’®ä¸Šæ–¹
    let top = btnRect.top - tooltipRect.height - 8;
    
    // è¾¹ç•Œæ£€æŸ¥
    if (left < 10) left = 10;
    if (left + tooltipRect.width > window.innerWidth - 10) {
        left = window.innerWidth - tooltipRect.width - 10;
    }
    
    // å¦‚æœä¸Šæ–¹ç©ºé—´ä¸å¤Ÿï¼Œæ˜¾ç¤ºåœ¨ä¸‹æ–¹
    if (top < 10) {
        top = btnRect.bottom + 8;
        arrow.style.borderTop = 'none';
        arrow.style.borderBottom = '6px solid #333';
        arrow.style.top = '-6px';
        arrow.style.bottom = 'auto';
    }
    
    tooltip.style.left = left + 'px';
    tooltip.style.top = top + pageYOffset + 'px';
    
    // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé˜²æ­¢ç«‹å³å…³é—­
    if (event) {
        event.stopPropagation();
    }
    
    // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­
    const closeTooltip = function(e) {
        if (!tooltip.contains(e.target) && e.target !== btn) {
            hideReasonTooltip();
            document.removeEventListener('click', closeTooltip);
        }
    };
    
    // å»¶è¿Ÿæ·»åŠ ç›‘å¬å™¨ï¼Œé¿å…å½“å‰ç‚¹å‡»äº‹ä»¶è§¦å‘å…³é—­
    setTimeout(() => {
        document.addEventListener('click', closeTooltip);
    }, 10);
}

function showReportLost(deviceId) {
    currentDeviceId = deviceId;
    document.getElementById('reportLostModal').style.display = 'flex';
}

function submitReportLost() {
    fetch('/api/report-lost', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ device_id: currentDeviceId })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            showToast('ä¸¢å¤±æŠ¥å¤‡æˆåŠŸ');
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast(data.message || 'æŠ¥å¤‡å¤±è´¥');
        }
    })
    .catch(() => showToast('æŠ¥å¤‡å¤±è´¥ï¼Œè¯·é‡è¯•'));
    closeModal('reportLostModal');
}

function showReportDamage(deviceId) {
    currentDeviceId = deviceId;
    document.getElementById('reportDamageModal').style.display = 'flex';
}

function submitReportDamage() {
    const reason = document.getElementById('damageReason').value.trim();
    if (!reason) {
        showToast('è¯·å¡«å†™æŸååŸå› ');
        return;
    }
    fetch('/api/report-damage', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ device_id: currentDeviceId, damage_reason: reason })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            showToast('æŸåæŠ¥å¤‡æˆåŠŸ');
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast(data.message || 'æŠ¥å¤‡å¤±è´¥');
        }
    })
    .catch(() => showToast('æŠ¥å¤‡å¤±è´¥ï¼Œè¯·é‡è¯•'));
    closeModal('reportDamageModal');
}

function showLostOptions(deviceId) {
    currentDeviceId = deviceId;
    currentAction = 'found';
    // æ ¹æ®è®¾å¤‡ç±»å‹è®¾ç½®æŒ‰é’®æ–‡å­—
    const returnBtn = document.getElementById('foundReturnBtn');
    if (returnBtn) {
        returnBtn.textContent = currentDeviceType === 'æ‰‹æœº' ? 'è½¬ç»™ä¿ç®¡äºº' : 'å½’è¿˜å…¥åº“';
    }
    document.getElementById('foundModal').style.display = 'flex';
}

function showDamageOptions(deviceId) {
    currentDeviceId = deviceId;
    currentAction = 'repaired';
    // æ ¹æ®è®¾å¤‡ç±»å‹è®¾ç½®æŒ‰é’®æ–‡å­—
    const returnBtn = document.getElementById('repairedReturnBtn');
    if (returnBtn) {
        returnBtn.textContent = currentDeviceType === 'æ‰‹æœº' ? 'è½¬ç»™ä¿ç®¡äºº' : 'å½’è¿˜å…¥åº“';
    }
    document.getElementById('repairedModal').style.display = 'flex';
}

function showTransferSelect(action) {
    currentAction = action;
    closeModal(action === 'found' ? 'foundModal' : 'repairedModal');
    // åŠ è½½ç”¨æˆ·åˆ—è¡¨
    const select = document.getElementById('transferToUser');
    select.innerHTML = '<option value="">åŠ è½½ä¸­...</option>';
    document.getElementById('transferSelectModal').style.display = 'flex';
    
    fetch('/api/users')
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                select.innerHTML = '<option value="">è¯·é€‰æ‹©</option>';
                data.users.forEach(u => {
                    const option = document.createElement('option');
                    option.value = u.borrower_name;
                    option.textContent = u.borrower_name + ' (' + u.phone.substring(0, 3) + '****' + u.phone.substring(7) + ')';
                    select.appendChild(option);
                });
            }
        })
        .catch(() => {
            select.innerHTML = '<option value="">åŠ è½½å¤±è´¥</option>';
        });
}

function submitFound(action) {
    const data = { device_id: currentDeviceId, action: action };
    if (action === 'transfer') {
        const transferTo = document.getElementById('transferToUser').value;
        if (!transferTo) { showToast('è¯·é€‰æ‹©è½¬å€Ÿäºº'); return; }
        data.transfer_to = transferTo;
    }
    fetch('/api/found-device', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            showToast('æ“ä½œæˆåŠŸ');
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast(data.message || 'æ“ä½œå¤±è´¥');
        }
    })
    .catch(() => showToast('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•'));
    closeModal('foundModal');
    closeModal('transferSelectModal');
}

function submitRepaired(action) {
    const data = { device_id: currentDeviceId, action: action };
    if (action === 'transfer') {
        const transferTo = document.getElementById('transferToUser').value;
        if (!transferTo) { showToast('è¯·é€‰æ‹©è½¬å€Ÿäºº'); return; }
        data.transfer_to = transferTo;
    }
    fetch('/api/repair-device', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            showToast('æ“ä½œæˆåŠŸ');
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast(data.message || 'æ“ä½œå¤±è´¥');
        }
    })
    .catch(() => showToast('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•'));
    closeModal('repairedModal');
    closeModal('transferSelectModal');
}

function submitTransfer() {
    if (currentAction === 'found') {
        submitFound('transfer');
    } else {
        submitRepaired('transfer');
    }
}

function confirmNotFound(deviceId) {
    if (!confirm('ç¡®å®šè¦é€€å›æ­¤è®¾å¤‡å—ï¼Ÿå°†è½¬å›ç»™ä¸Šä¸€ä¸ªå€Ÿç”¨äººã€‚')) {
        return;
    }
    fetch('/api/not-found', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ device_id: deviceId })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            showToast('æ“ä½œæˆåŠŸ');
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast(data.message || 'æ“ä½œå¤±è´¥');
        }
    })
    .catch(() => showToast('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•'));
}

function confirmNotFoundDirect(deviceId) {
    if (!confirm('ç¡®å®šè®¾å¤‡æœªæ‰¾åˆ°å—ï¼Ÿå°†è®°å½•å€Ÿç”¨äººæœªæ‰¾åˆ°ï¼Œè®¾å¤‡è½¬ä¸ºä¸¢å¤±çŠ¶æ€ã€‚')) {
        return;
    }
    fetch('/api/not-found-direct', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ device_id: deviceId })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            showToast('å·²è®°å½•ï¼šå€Ÿç”¨äººæœªæ‰¾åˆ°ï¼Œè®¾å¤‡å·²è½¬ä¸ºä¸¢å¤±');
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast(data.message || 'æ“ä½œå¤±è´¥');
        }
    })
    .catch(() => showToast('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•'));
}

function showTransferCustodian(deviceId) {
    currentDeviceId = deviceId;
    const select = document.getElementById('newCustodian');
    select.innerHTML = '<option value="">åŠ è½½ä¸­...</option>';
    document.getElementById('transferCustodianModal').style.display = 'flex';
    
    fetch('/api/users')
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                select.innerHTML = '<option value="">è¯·é€‰æ‹©æ–°ä¿ç®¡äºº</option>';
                data.users.forEach(u => {
                    const option = document.createElement('option');
                    option.value = u.borrower_name;
                    option.textContent = u.borrower_name;
                    select.appendChild(option);
                });
            }
        })
        .catch(() => {
            select.innerHTML = '<option value="">åŠ è½½å¤±è´¥</option>';
        });
}

function submitTransferCustodian() {
    const newCustodian = document.getElementById('newCustodian').value;
    if (!newCustodian) {
        showToast('è¯·é€‰æ‹©æ–°ä¿ç®¡äºº');
        return;
    }
    fetch('/api/transfer-custodian', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ device_id: currentDeviceId, new_custodian: newCustodian })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            showToast('ä¿ç®¡äººè½¬è®©æˆåŠŸ');
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast(data.message || 'è½¬è®©å¤±è´¥');
        }
    })
    .catch(() => showToast('è½¬è®©å¤±è´¥ï¼Œè¯·é‡è¯•'));
    closeModal('transferCustodianModal');
}

function deleteRemark(remarkId) {
    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡å¤‡æ³¨å—ï¼Ÿ')) {
        return;
    }
    fetch('/api/remark/delete', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ remark_id: remarkId })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            showToast('åˆ é™¤æˆåŠŸ');
            location.reload();
        } else {
            showToast(data.message || 'åˆ é™¤å¤±è´¥');
        }
    })
    .catch(() => showToast('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•'));
}

function confirmTransferToMe(deviceId, currentBorrower, deviceName) {
    if (!confirm(`ç¡®å®šè¦å°† ${deviceName} ä» ${currentBorrower} è½¬å€Ÿåˆ°è‡ªå·±åä¸‹å—ï¼Ÿ`)) {
        return;
    }
    showToast('æ­£åœ¨å¤„ç†...');
    fetch('/api/transfer-to-me', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ device_id: deviceId })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            showToast('è½¬å€ŸæˆåŠŸ');
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast(data.message || 'è½¬å€Ÿå¤±è´¥');
        }
    })
    .catch(() => showToast('è½¬å€Ÿå¤±è´¥ï¼Œè¯·é‡è¯•'));
}

let currentExpectedReturnDate = '';

function showRenewModal(deviceId, expectedDate) {
    currentDeviceId = deviceId;
    currentExpectedReturnDate = expectedDate;
    const dateInput = document.getElementById('renewDate');
    
    // è®¾ç½®æœ€å°æ—¥æœŸä¸ºå½“å‰æ—¥æœŸï¼ˆåªèƒ½å¾€åé€‰æ‹©ï¼‰
    const today = new Date().toISOString().split('T')[0];
    dateInput.min = today;
    
    // å¦‚æœæœ‰å½“å‰é¢„è®¡å½’è¿˜æ—¥æœŸï¼Œé»˜è®¤è®¾ç½®ä¸ºè¯¥æ—¥æœŸ
    if (expectedDate) {
        dateInput.value = expectedDate;
    } else {
        dateInput.value = today;
    }
    
    document.getElementById('renewModal').style.display = 'flex';
}

function submitRenew() {
    const newDate = document.getElementById('renewDate').value;
    if (!newDate) {
        showToast('è¯·é€‰æ‹©ç»­æœŸæ—¥æœŸ');
        return;
    }
    
    // éªŒè¯æ—¥æœŸæ˜¯å¦å¤§äºç­‰äºä»Šå¤©
    const today = new Date().toISOString().split('T')[0];
    if (newDate < today) {
        showToast('ç»­æœŸæ—¥æœŸä¸èƒ½æ—©äºä»Šå¤©');
        return;
    }
    
    fetch('/api/renew', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
            device_id: currentDeviceId,
            new_return_date: newDate
        })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            showToast('ç»­æœŸæˆåŠŸ');
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast(data.message || 'ç»­æœŸå¤±è´¥');
        }
    })
    .catch(() => showToast('ç»­æœŸå¤±è´¥ï¼Œè¯·é‡è¯•'));
    closeModal('renewModal');
}

function confirmReturnByCustodian(deviceId, currentBorrower, deviceName) {
    if (!confirm(`ç¡®å®šè¦æ”¶å› ${deviceName} å—ï¼Ÿå½“å‰å€Ÿç”¨äººä¸º ${currentBorrower}`)) {
        return;
    }
    showToast('æ­£åœ¨å¤„ç†...');
    fetch('/api/return-by-custodian', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ device_id: deviceId })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            showToast('æ”¶å›æˆåŠŸ');
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast(data.message || 'æ”¶å›å¤±è´¥');
        }
    })
    .catch(() => showToast('æ”¶å›å¤±è´¥ï¼Œè¯·é‡è¯•'));
}
</script>

<style>
.status-lost { background: #fff1f0 !important; color: #f5222d !important; border: 1px solid #ffccc7 !important; }
.status-scrapped { background: #f5f5f5 !important; color: #999 !important; border: 1px solid #d9d9d9 !important; }
.type-lost { background: #fff1f0; color: #f5222d; }
.type-view { background: #e6f7ff; color: #1890ff; }
.type-renew { background: #f6ffed; color: #52c41a; border: 1px solid #b7eb8f; }

/* æŸ¥çœ‹æ‰¹æ³¨æŒ‰é’® - é—®å·å¸®åŠ©æŒ‰é’® */
.reason-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 18px;
    height: 18px;
    border-radius: 50%;
    background: #1890ff;
    color: white;
    font-size: 12px;
    font-weight: bold;
    cursor: pointer;
    margin-left: 6px;
    border: none;
    padding: 0;
    line-height: 1;
    vertical-align: middle;
}
.reason-btn:hover {
    background: #40a9ff;
}

/* æ°”æ³¡æç¤º */
.reason-tooltip {
    position: absolute;
    z-index: 1000;
    max-width: 280px;
}
.reason-tooltip-content {
    background: #333;
    color: #fff;
    padding: 10px 14px;
    border-radius: 8px;
    font-size: 13px;
    line-height: 1.5;
    word-break: break-all;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}
.reason-tooltip-arrow {
    position: absolute;
    bottom: -6px;
    left: 50%;
    transform: translateX(-50%);
    width: 0;
    height: 0;
    border-left: 6px solid transparent;
    border-right: 6px solid transparent;
    border-top: 6px solid #333;
}
.modal {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center;
    z-index: 1000;
}
.modal-content {
    background: white; padding: 20px; border-radius: 8px; width: 90%; max-width: 350px;
}
.modal-content h3 { margin: 0 0 15px 0; }
.modal-actions {
    display: flex; justify-content: flex-end; gap: 10px; margin-top: 15px;
}
.modal-actions button { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; }
.btn-block { width: 100%; padding: 12px; font-size: 16px; }
</style>
{% endblock %}
