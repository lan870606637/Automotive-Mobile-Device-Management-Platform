{% extends "base.html" %}

{% block title %}è½¬å€Ÿè®¾å¤‡ - è®¾å¤‡ç®¡ç†ç³»ç»Ÿ{% endblock %}

{% set active_nav = 'devices' %}

{% block content %}
<div class="borrow-page">
    <!-- é¡µé¢å¤´éƒ¨ -->
    <div class="page-header">
        <a href="javascript:history.back()" class="back-btn">â€¹</a>
        <h1>è½¬å€Ÿè®¾å¤‡</h1>
    </div>
    
    <!-- è®¾å¤‡ä¿¡æ¯ -->
    <div class="device-info-card">
        <div class="device-header">
            <span class="device-icon-large">
                {% if device_type == 'è½¦æœº' %}ğŸš—{% else %}ğŸ“±{% endif %}
            </span>
            <div class="device-title">
                <h2>{{ device.name }}</h2>
                <span class="status-badge status-borrowed">å€Ÿå‡ºä¸­</span>
            </div>
        </div>
    </div>
    
    <!-- è½¬å€Ÿè¡¨å• -->
    <div class="form-card">
        <h3 class="form-title">é€‰æ‹©è½¬å€Ÿäºº</h3>
        
        <form id="transferForm" onsubmit="return handleTransfer(event)">
            <input type="hidden" id="device_id" value="{{ device.id }}">
            
            <div class="form-group">
                <label for="transfer_to">è½¬å€Ÿç»™ <span class="required">*</span></label>
                <div class="autocomplete-wrapper">
                    <input type="text" id="transfer_to" name="transfer_to" class="form-control" 
                           placeholder="è¾“å…¥å§“åæœç´¢..." autocomplete="off" required>
                    <div id="user-suggestions" class="suggestions-list"></div>
                </div>
                <small class="form-text">è¾“å…¥å§“åæœç´¢ç³»ç»Ÿå†…çš„ç”¨æˆ·</small>
            </div>
            
            <div class="form-group">
                <label for="transfer_time">è½¬å€Ÿæ—¶é—´</label>
                <input type="text" id="transfer_time" class="form-control" readonly>
            </div>
            
            <div class="form-group">
                <label for="remark">å¤‡æ³¨</label>
                <textarea id="remark" name="remark" class="form-control" rows="3" 
                          placeholder="å¯é€‰ï¼šæ·»åŠ è½¬å€Ÿå¤‡æ³¨"></textarea>
            </div>
            
            <div class="form-actions">
                <button type="submit" class="btn btn-primary btn-large btn-block">
                    ç¡®è®¤è½¬å€Ÿ
                </button>
                <a href="javascript:history.back()" class="btn btn-default btn-block" style="margin-top: 10px;">
                    å–æ¶ˆ
                </a>
            </div>
        </form>
    </div>
</div>

<style>
.autocomplete-wrapper {
    position: relative;
}

.suggestions-list {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid #ddd;
    border-top: none;
    border-radius: 0 0 8px 8px;
    max-height: 200px;
    overflow-y: auto;
    z-index: 1000;
    display: none;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.suggestions-list.active {
    display: block;
}

.suggestion-item {
    padding: 12px 16px;
    cursor: pointer;
    border-bottom: 1px solid #f0f0f0;
    transition: background 0.2s;
}

.suggestion-item:last-child {
    border-bottom: none;
}

.suggestion-item:hover,
.suggestion-item.selected {
    background: #f5f7fa;
}

.suggestion-name {
    font-weight: 500;
    color: #333;
}

.suggestion-phone {
    font-size: 12px;
    color: #999;
    margin-left: 8px;
}

.no-suggestions {
    padding: 12px 16px;
    color: #999;
    text-align: center;
}
</style>

<script>
// ç”¨æˆ·æ•°æ®
const users = [
    {% for user in all_users %}
    { name: {{ user.borrower_name | tojson }}, phone: {{ user.phone | tojson }} }{% if not loop.last %},{% endif %}
    {% endfor %}
];

// è®¾ç½®å½“å‰æ—¶é—´
function setCurrentTime() {
    const now = new Date();
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const day = String(now.getDate()).padStart(2, '0');
    const hours = String(now.getHours()).padStart(2, '0');
    const minutes = String(now.getMinutes()).padStart(2, '0');
    
    const timeStr = `${year}å¹´${month}æœˆ${day}æ—¥ ${hours}:${minutes}`;
    document.getElementById('transfer_time').value = timeStr;
}

// æœç´¢è”æƒ³åŠŸèƒ½
const transferInput = document.getElementById('transfer_to');
const suggestionsList = document.getElementById('user-suggestions');
let selectedIndex = -1;

transferInput.addEventListener('input', function() {
    const keyword = this.value.trim().toLowerCase();
    selectedIndex = -1;
    
    if (keyword.length === 0) {
        suggestionsList.classList.remove('active');
        return;
    }
    
    // è¿‡æ»¤åŒ¹é…çš„ç”¨æˆ·
    const matched = users.filter(u => 
        u.name.toLowerCase().includes(keyword) || 
        u.phone.includes(keyword)
    );
    
    // æ¸²æŸ“å»ºè®®åˆ—è¡¨
    if (matched.length > 0) {
        suggestionsList.innerHTML = matched.map((u, index) => `
            <div class="suggestion-item" data-index="${index}" data-name="${u.name}">
                <span class="suggestion-name">${u.name}</span>
                <span class="suggestion-phone">${u.phone}</span>
            </div>
        `).join('');
        
        // æ·»åŠ ç‚¹å‡»äº‹ä»¶
        suggestionsList.querySelectorAll('.suggestion-item').forEach(item => {
            item.addEventListener('click', function() {
                transferInput.value = this.dataset.name;
                suggestionsList.classList.remove('active');
            });
        });
        
        suggestionsList.classList.add('active');
    } else {
        suggestionsList.innerHTML = '<div class="no-suggestions">æ— åŒ¹é…ç”¨æˆ·</div>';
        suggestionsList.classList.add('active');
    }
});

// é”®ç›˜å¯¼èˆª
transferInput.addEventListener('keydown', function(e) {
    const items = suggestionsList.querySelectorAll('.suggestion-item');
    
    if (e.key === 'ArrowDown') {
        e.preventDefault();
        selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
        updateSelection(items);
    } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        selectedIndex = Math.max(selectedIndex - 1, -1);
        updateSelection(items);
    } else if (e.key === 'Enter') {
        e.preventDefault();
        if (selectedIndex >= 0 && items[selectedIndex]) {
            transferInput.value = items[selectedIndex].dataset.name;
            suggestionsList.classList.remove('active');
        }
    } else if (e.key === 'Escape') {
        suggestionsList.classList.remove('active');
    }
});

function updateSelection(items) {
    items.forEach((item, index) => {
        if (index === selectedIndex) {
            item.classList.add('selected');
            item.scrollIntoView({ block: 'nearest' });
        } else {
            item.classList.remove('selected');
        }
    });
}

// ç‚¹å‡»å¤–éƒ¨å…³é—­å»ºè®®åˆ—è¡¨
document.addEventListener('click', function(e) {
    if (!e.target.closest('.autocomplete-wrapper')) {
        suggestionsList.classList.remove('active');
    }
});

// é¡µé¢åŠ è½½æ—¶è®¾ç½®æ—¶é—´
setCurrentTime();

function handleTransfer(event) {
    event.preventDefault();
    
    const deviceId = document.getElementById('device_id').value;
    const transferTo = document.getElementById('transfer_to').value.trim();
    const remark = document.getElementById('remark').value.trim();
    
    if (!transferTo) {
        showToast('è¯·è¾“å…¥è½¬å€Ÿäºº');
        return false;
    }
    
    // éªŒè¯ç”¨æˆ·æ˜¯å¦å­˜åœ¨
    const userExists = users.some(u => u.name === transferTo);
    if (!userExists) {
        showToast('è¯¥ç”¨æˆ·ä¸å­˜åœ¨ï¼Œè¯·ä»åˆ—è¡¨ä¸­é€‰æ‹©');
        return false;
    }
    
    showToast('æ­£åœ¨å¤„ç†...');
    
    fetch('/api/transfer', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            device_id: deviceId,
            transfer_to: transferTo,
            remark: remark
        })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            showToast('è½¬å€ŸæˆåŠŸ');
            setTimeout(() => {
                window.location.href = '/home';
            }, 1000);
        } else {
            showToast(data.message || 'è½¬å€Ÿå¤±è´¥');
        }
    })
    .catch(() => showToast('è½¬å€Ÿå¤±è´¥ï¼Œè¯·é‡è¯•'));
    
    return false;
}
</script>
{% endblock %}
