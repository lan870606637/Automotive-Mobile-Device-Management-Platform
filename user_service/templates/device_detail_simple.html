{% extends "base.html" %}

{% block title %}{{ device.name }} - è®¾å¤‡è¯¦æƒ…{% endblock %}

{% set active_nav = 'devices' %}

{% block content %}
<div class="device-detail-page">
    <!-- é¡µé¢å¤´éƒ¨ -->
    <div class="page-header">
        <a href="javascript:history.back()" class="back-btn">â€¹</a>
        <h1>è®¾å¤‡è¯¦æƒ…</h1>
    </div>
    
    <!-- è®¾å¤‡åŸºæœ¬ä¿¡æ¯ -->
    <div class="detail-card">
        <div class="device-header">
            <span class="device-icon-large">
                {% if device_type == 'è½¦æœº' %}ğŸš—{% else %}ğŸ“±{% endif %}
            </span>
            <div class="device-title">
                <h2>{{ device.name }}</h2>
                {% if is_circulating %}
                <span class="status-badge" style="background: #f6ffed; color: #52c41a; border: 1px solid #b7eb8f;">
                    æµé€šè®¾å¤‡
                </span>
                {% else %}
                <span class="status-badge status-available">
                    æ— æŸœå·è®¾å¤‡
                </span>
                {% endif %}
            </div>
        </div>
        
        <div class="info-list">
            <div class="info-item">
                <span class="info-label">è®¾å¤‡ç±»å‹</span>
                <span class="info-value">{{ device_type }}</span>
            </div>
            <div class="info-item">
                <span class="info-label">å‹å·</span>
                <span class="info-value">{{ device.model or '-' }}</span>
            </div>
            <div class="info-item">
                <span class="info-label">æŸœå·</span>
                <span class="info-value cabinet-status {% if is_circulating %}status-circulating{% else %}status-empty{% endif %}">
                    {{ 'æµé€š' if is_circulating else 'æ— ' }}
                </span>
            </div>
            <div class="info-item">
                <span class="info-label">å¤‡æ³¨</span>
                <span class="info-value">{{ device.remark or '-' }}</span>
            </div>
        </div>
    </div>
    
    <!-- æç¤ºä¿¡æ¯ -->
    <div class="action-section">
        <div class="info-box device-status-box {{ 'status-circulating-box' if is_circulating else 'status-empty-box' }}">
            <p class="status-title">{{ 'ğŸ”„ æ­¤è®¾å¤‡ä¸ºæµé€šè®¾å¤‡' if is_circulating else 'âš ï¸ æ­¤è®¾å¤‡æš‚æ— æŸœå·ä¿¡æ¯' }}</p>
            <p class="status-hint">æš‚ä¸æ”¯æŒå€Ÿç”¨æ“ä½œ</p>
        </div>
    </div>
    
    <!-- æŸ¥çœ‹è®°å½• -->
    <div class="records-section">
        <h3 class="section-title">æŸ¥çœ‹è®°å½•</h3>
        {% if view_records %}
        <div class="record-list">
            {% for vr in view_records %}
            <div class="record-item">
                <div class="record-main">
                    <span class="record-type type-view">æŸ¥çœ‹</span>
                    <span class="record-user">{{ vr.viewer }}</span>
                </div>
                <div class="record-time">{{ vr.view_time }}</div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p class="no-data">æš‚æ— æŸ¥çœ‹è®°å½•</p>
        {% endif %}
    </div>
    
    <!-- ç”¨æˆ·å¤‡æ³¨ -->
    <div class="remarks-section">
        <h3 class="section-title">
            ç”¨æˆ·å¤‡æ³¨
            <a href="{{ url_for('add_remark', device_id=device.id) }}" class="add-btn">+ æ·»åŠ </a>
        </h3>
        
        {% if remarks %}
        <div class="remark-list">
            {% for remark in remarks %}
            <div class="remark-item">
                <div class="remark-content">{{ remark.content }}</div>
                <div class="remark-meta">
                    <span class="remark-creator">{{ remark.creator }}</span>
                    <span class="remark-time">{{ remark.create_time }}</span>
                    {% if remark.is_creator %}
                    <div class="remark-actions">
                        <a href="{{ url_for('edit_remark_page', remark_id=remark.id) }}" class="action-link">ç¼–è¾‘</a>
                        <a href="javascript:void(0)" onclick="deleteRemark('{{ remark.id }}')" class="action-link delete">åˆ é™¤</a>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-remarks">
            <p>æš‚æ— å¤‡æ³¨</p>
            <a href="{{ url_for('add_remark', device_id=device.id) }}" class="link">æ·»åŠ ç¬¬ä¸€æ¡å¤‡æ³¨</a>
        </div>
        {% endif %}
    </div>
</div>

<script>
function deleteRemark(remarkId) {
    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡å¤‡æ³¨å—ï¼Ÿ')) {
        return;
    }
    fetch('/api/remark/delete', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ remark_id: remarkId })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            showToast('åˆ é™¤æˆåŠŸ');
            location.reload();
        } else {
            showToast(data.message || 'åˆ é™¤å¤±è´¥');
        }
    })
    .catch(() => showToast('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•'));
}
</script>

<style>
/* æŸœå·çŠ¶æ€æ ·å¼ */
.cabinet-status.status-circulating {
    color: #52c41a;
    font-weight: 500;
}
.cabinet-status.status-empty {
    color: #999;
}

/* è®¾å¤‡çŠ¶æ€æç¤ºæ¡†æ ·å¼ */
.device-status-box {
    padding: 15px;
    border-radius: 8px;
    text-align: center;
}
.device-status-box .status-title {
    margin: 0;
}
.device-status-box .status-hint {
    font-size: 12px;
    margin: 5px 0 0;
}

/* æµé€šè®¾å¤‡æç¤ºæ¡† */
.status-circulating-box {
    background: #f6ffed;
    border: 1px solid #b7eb8f;
}
.status-circulating-box .status-title {
    color: #52c41a;
}
.status-circulating-box .status-hint {
    color: #666;
}

/* æ— æŸœå·è®¾å¤‡æç¤ºæ¡† */
.status-empty-box {
    background: #f5f5f5;
}
.status-empty-box .status-title {
    color: #666;
}
.status-empty-box .status-hint {
    color: #999;
}
</style>
{% endblock %}
