{% extends "base.html" %}

{% block title %}{% if no_cabinet %}æ— æŸœå·è®¾å¤‡{% elif device_type == 'car' %}è½¦æœº{% elif device_type == 'phone' %}æ‰‹æœº{% else %}å…¨éƒ¨è®¾å¤‡{% endif %}åˆ—è¡¨ - è®¾å¤‡ç®¡ç†ç³»ç»Ÿ{% endblock %}

{% set active_nav = 'devices' %}

{% block content %}
<div class="device-list-page">
    <!-- é¡µé¢å¤´éƒ¨ -->
    <div class="page-header">
        <a href="{{ url_for('home') }}" class="back-btn">â€¹</a>
        <h1>
            {% if no_cabinet %}
            ğŸ“¦ æ— æŸœå·è®¾å¤‡
            {% elif device_type == 'car' %}
            ğŸš— è½¦æœºè®¾å¤‡
            {% elif device_type == 'phone' %}
            ğŸ“± æ‰‹æœºè®¾å¤‡
            {% else %}
            ğŸ“¦ å…¨éƒ¨è®¾å¤‡
            {% endif %}
        </h1>
    </div>
    
    <!-- æœç´¢æ  -->
    <div class="search-bar">
        <div class="search-input-wrap">
            <span class="search-icon">ğŸ”</span>
            <input type="text" id="searchInput" class="search-input" placeholder="æœç´¢è®¾å¤‡åã€å‹å·..." onkeyup="handleSearch(event)">
            <button class="clear-btn" onclick="clearSearch()" style="display:none;">âœ•</button>
        </div>
        <button class="btn-search" onclick="doSearch()">æœç´¢</button>
    </div>
    
    <!-- ç­›é€‰æ ‡ç­¾ -->
    <div class="filter-tabs">
        <a href="{{ url_for('device_list') }}" class="tab {% if not device_type and not no_cabinet %}active{% endif %}">å…¨éƒ¨</a>
        <a href="{{ url_for('device_list', type='car') }}" class="tab {% if device_type == 'car' %}active{% endif %}">è½¦æœº</a>
        <a href="{{ url_for('device_list', type='phone') }}" class="tab {% if device_type == 'phone' %}active{% endif %}">æ‰‹æœº</a>
        <a href="{{ url_for('device_list', no_cabinet='1') }}" class="tab {% if no_cabinet %}active{% endif %}">æ— æŸœå·</a>
    </div>
    
    <!-- è®¾å¤‡åˆ—è¡¨ -->
    <div class="device-list-content" id="deviceList">
        {% if devices %}
        <div class="device-grid">
            {% for device in devices %}
            <a href="{% if device.no_cabinet or device.is_circulating %}{{ url_for('device_detail_simple', device_id=device.id) }}{% else %}{{ url_for('device_detail', device_id=device.id) }}{% endif %}" class="device-card {% if device.status.value == 'æŠ¥åºŸ' %}scrapped{% endif %}">
                <div class="card-header">
                    <span class="device-icon-large">
                        {% if device.device_type.value == 'è½¦æœº' %}ğŸš—{% else %}ğŸ“±{% endif %}
                    </span>
                    {% if device.no_cabinet %}
                    <span class="status-badge status-no-cabinet">æ— æŸœå·</span>
                    {% elif device.is_circulating %}
                    <span class="status-badge status-circulating">æµé€š</span>
                    {% else %}
                    <span class="status-badge 
                        {% if device.status.value == 'åœ¨åº“' %}status-available
                        {% elif device.status.value == 'å€Ÿå‡º' %}status-borrowed
                        {% elif device.status.value == 'å·²å¯„å‡º' %}status-shipped
                        {% elif device.status.value == 'å·²æŸå' %}status-damaged
                        {% elif device.status.value == 'ä¸¢å¤±' %}status-lost
                        {% elif device.status.value == 'æŠ¥åºŸ' %}status-scrapped
                        {% endif %}">
                        {{ device.status.value }}
                    </span>
                    {% endif %}
                </div>
                <div class="card-body">
                    <h4 class="device-name">{{ device.name }}</h4>
                    <p class="device-remark">{{ device.remark }}</p>
                </div>
                <div class="card-footer">
                    <span class="device-type">{{ device.device_type.value }}</span>
                    <span class="arrow">{% if device.status.value == 'æŠ¥åºŸ' %}å·²æŠ¥åºŸ{% else %}æŸ¥çœ‹è¯¦æƒ… â€º{% endif %}</span>
                </div>
            </a>
            {% endfor %}
        </div>
        
        <!-- åˆ†é¡µæ§ä»¶ -->
        {% if total_pages > 1 %}
        <div class="pagination">
            {% if page > 1 %}
            <a href="{{ url_for('device_list', type=device_type, no_cabinet='1' if no_cabinet else '', page=page-1) }}" class="page-btn">â€¹ ä¸Šä¸€é¡µ</a>
            {% else %}
            <span class="page-btn disabled">â€¹ ä¸Šä¸€é¡µ</span>
            {% endif %}
            
            <span class="page-info">{{ page }} / {{ total_pages }} é¡µ (å…±{{ total }}å°)</span>
            
            {% if page < total_pages %}
            <a href="{{ url_for('device_list', type=device_type, no_cabinet='1' if no_cabinet else '', page=page+1) }}" class="page-btn">ä¸‹ä¸€é¡µ â€º</a>
            {% else %}
            <span class="page-btn disabled">ä¸‹ä¸€é¡µ â€º</span>
            {% endif %}
        </div>
        {% endif %}
        {% else %}
        <div class="empty-state">
            <div class="empty-icon">ğŸ”</div>
            <p>æš‚æ— è®¾å¤‡</p>
        </div>
        {% endif %}
    </div>
</div>

<script>
let searchTimeout;
let searchResults = [];
let searchPage = 1;
const searchPerPage = 12;

function handleSearch(event) {
    const input = document.getElementById('searchInput');
    const clearBtn = document.querySelector('.clear-btn');
    
    clearBtn.style.display = input.value ? 'block' : 'none';
    
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
        if (input.value.length >= 1) {
            doSearch();
        }
    }, 500);
}

function clearSearch() {
    const input = document.getElementById('searchInput');
    input.value = '';
    document.querySelector('.clear-btn').style.display = 'none';
    location.reload();
}

function doSearch() {
    const keyword = document.getElementById('searchInput').value.trim();
    if (!keyword) return;
    
    fetch(`/api/search?keyword=${encodeURIComponent(keyword)}`)
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                searchResults = data.devices;
                searchPage = 1;
                renderDevicesWithPagination(searchResults, searchPage);
            }
        })
        .catch(err => {
            showToast('æœç´¢å¤±è´¥ï¼Œè¯·é‡è¯•');
        });
}

function renderDevicesWithPagination(devices, page) {
    const container = document.getElementById('deviceList');
    
    if (devices.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-icon">ğŸ”</div>
                <p>æœªæ‰¾åˆ°åŒ¹é…çš„è®¾å¤‡</p>
            </div>
        `;
        return;
    }
    
    // åˆ†é¡µè®¡ç®—
    const total = devices.length;
    const totalPages = Math.ceil(total / searchPerPage);
    page = Math.max(1, Math.min(page, totalPages));
    const start = (page - 1) * searchPerPage;
    const end = start + searchPerPage;
    const paginatedDevices = devices.slice(start, end);
    
    let html = '<div class="device-grid">';
    paginatedDevices.forEach(device => {
        const icon = device.type === 'è½¦æœº' ? 'ğŸš—' : 'ğŸ“±';
        let statusClass = 'status-borrowed';
        let statusText = device.status;
        if (device.no_cabinet) {
            statusClass = 'status-no-cabinet';
            statusText = 'æ— æŸœå·';
        } else if (device.is_circulating) {
            statusClass = 'status-circulating';
            statusText = 'æµé€š';
        } else if (device.status === 'åœ¨åº“') {
            statusClass = 'status-available';
        } else if (device.status === 'å·²æŸå') {
            statusClass = 'status-damaged';
        } else if (device.status === 'ä¸¢å¤±') {
            statusClass = 'status-lost';
        } else if (device.status === 'æŠ¥åºŸ') {
            statusClass = 'status-scrapped';
        }
        
        const scrappedClass = device.is_scrapped ? 'scrapped' : '';
        const arrowText = device.is_scrapped ? 'å·²æŠ¥åºŸ' : 'æŸ¥çœ‹è¯¦æƒ… â€º';
        
        // æ— æŸœå·æˆ–æµé€šè®¾å¤‡è·³è½¬åˆ°ç®€å•è¯¦æƒ…é¡µ
        const isSimpleDetail = device.no_cabinet || device.is_circulating;
        const href = device.is_scrapped 
            ? 'javascript:showToast(\'è®¾å¤‡å·²æŠ¥åºŸï¼Œè¯·è”ç³»ç®¡ç†å‘˜\')' 
            : (isSimpleDetail 
                ? `/device/${device.id}/simple` 
                : `/device/${device.id}`);
        
        html += `
            <a href="${href}" class="device-card ${scrappedClass}">
                <div class="card-header">
                    <span class="device-icon-large">${icon}</span>
                    <span class="status-badge ${statusClass}">${statusText}</span>
                </div>
                <div class="card-body">
                    <h4 class="device-name">${device.name}</h4>
                    <p class="device-remark">${device.remark}</p>
                </div>
                <div class="card-footer">
                    <span class="device-type">${device.type}</span>
                    <span class="arrow">${arrowText}</span>
                </div>
            </a>
        `;
    });
    html += '</div>';
    
    // æ·»åŠ æœç´¢åˆ†é¡µæ§ä»¶
    if (totalPages > 1) {
        html += `
            <div class="pagination">
                <button onclick="goToSearchPage(${page - 1})" class="page-btn" ${page <= 1 ? 'disabled' : ''}>â€¹ ä¸Šä¸€é¡µ</button>
                <span class="page-info">${page} / ${totalPages} é¡µ (å…±${total}å°)</span>
                <button onclick="goToSearchPage(${page + 1})" class="page-btn" ${page >= totalPages ? 'disabled' : ''}>ä¸‹ä¸€é¡µ â€º</button>
            </div>
        `;
    }
    
    container.innerHTML = html;
}

function goToSearchPage(page) {
    renderDevicesWithPagination(searchResults, page);
}
</script>

<style>
.status-lost { background: #fff1f0 !important; color: #f5222d !important; border: 1px solid #ffccc7 !important; }
.status-scrapped { background: #f5f5f5 !important; color: #999 !important; border: 1px solid #d9d9d9 !important; }
.status-no-cabinet { background: #e6f7ff !important; color: #1890ff !important; border: 1px solid #91d5ff !important; }
.status-circulating { background: #f6ffed !important; color: #52c41a !important; border: 1px solid #b7eb8f !important; }
.device-card.scrapped { opacity: 0.6; }
.device-card.scrapped .device-name { text-decoration: line-through; }

/* åˆ†é¡µæ ·å¼ */
.pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 15px;
    margin-top: 30px;
    padding: 15px;
}
.page-btn {
    padding: 8px 16px;
    background: #1890ff;
    color: white;
    border-radius: 4px;
    text-decoration: none;
    font-size: 14px;
    transition: background 0.3s;
}
.page-btn:hover {
    background: #40a9ff;
}
.page-btn.disabled {
    background: #d9d9d9;
    color: #999;
    cursor: not-allowed;
}
.page-info {
    font-size: 14px;
    color: #666;
}
</style>
{% endblock %}
