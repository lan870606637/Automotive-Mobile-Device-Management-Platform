{% extends "base.html" %}

{% block title %}å½’è¿˜ç¡®è®¤ - {{ device.name }}{% endblock %}

{% set show_nav = false %}

{% block content %}
<div class="form-page">
    <!-- é¡µé¢å¤´éƒ¨ -->
    <div class="page-header">
        <a href="javascript:history.back()" class="back-btn">â€¹</a>
        <h1>å½’è¿˜ç¡®è®¤</h1>
    </div>
    
    <!-- è®¾å¤‡ä¿¡æ¯ -->
    <div class="info-card">
        <div class="device-mini">
            <span class="mini-icon">{% if device_type == 'è½¦æœº' %}ğŸš—{% else %}ğŸ“±{% endif %}</span>
            <div class="mini-info">
                <span class="mini-name">{{ device.name }}</span>
                <span class="mini-type">{{ device_type }}</span>
            </div>
        </div>
        {% if is_borrower %}
        <div class="you-tag">æ‚¨å€Ÿç”¨çš„è®¾å¤‡</div>
        {% endif %}
    </div>
    
    <!-- å€Ÿç”¨ä¸å½’è¿˜ä¿¡æ¯ -->
    <div class="info-card">
        <h3 class="card-title-small">å€Ÿç”¨ä¿¡æ¯</h3>
        <div class="info-list-simple">
            <div class="info-row">
                <span class="label">å€Ÿç”¨äºº</span>
                <span class="value">{{ device.borrower }}</span>
            </div>
            <div class="info-row">
                <span class="label">å€Ÿç”¨æ—¶é—´</span>
                <span class="value">{{ device.borrow_time.strftime('%Y-%m-%d') }}</span>
            </div>
            <div class="info-row">
                <span class="label">å€Ÿç”¨åŸå› </span>
                <span class="value">{{ device.reason or '-' }}</span>
            </div>
            <div class="info-row">
                <span class="label">å€Ÿç”¨å¤‡æ³¨</span>
                <span class="value">{{ device.remark or '-' }}</span>
            </div>
        </div>
    </div>
    
    <!-- å½’è¿˜ä¿¡æ¯å¡«å†™ -->
    <div class="form-card">
        <h3 class="form-title">å½’è¿˜ä¿¡æ¯</h3>
        
        <div class="form-group">
            <label class="form-label">å½’è¿˜äºº</label>
            <input type="text" id="returnPerson" class="form-input" value="{{ device.borrower }}" readonly>
        </div>
        
        <div class="form-group">
            <label class="form-label">å½’è¿˜åŸå› </label>
            <div class="radio-group">
                <label class="radio-item">
                    <input type="radio" name="returnReason" value="æ­£å¸¸å½’è¿˜" checked>
                    <span class="radio-text">æ­£å¸¸å½’è¿˜</span>
                </label>
                <label class="radio-item">
                    <input type="radio" name="returnReason" value="è®¾å¤‡æ”¶å›">
                    <span class="radio-text">è®¾å¤‡æ”¶å›</span>
                </label>
                <label class="radio-item">
                    <input type="radio" name="returnReason" value="è½¬å€Ÿä»–äºº">
                    <span class="radio-text">è½¬å€Ÿä»–äºº</span>
                </label>
                <label class="radio-item">
                    <input type="radio" name="returnReason" value="å…¶ä»–">
                    <span class="radio-text">å…¶ä»–</span>
                </label>
            </div>
        </div>
        
        <div class="form-group">
            <label class="form-label">å½’è¿˜å¤‡æ³¨</label>
            <textarea id="returnRemark" class="form-textarea" rows="2">è®¾å¤‡å®Œå¥½ï¼Œæ— å¼‚å¸¸</textarea>
        </div>
    </div>
    
    <!-- è®¾å¤‡æ£€æŸ¥æ¸…å• -->
    <div class="checklist-card">
        <div class="checklist-header">
            <h4>âœ“ å½’è¿˜å‰è¯·ç¡®è®¤</h4>
            <button type="button" class="btn-check-all" onclick="checkAll()">ä¸€é”®å…¨é€‰</button>
        </div>
        <label class="check-item">
            <input type="checkbox" id="check1">
            <span>è®¾å¤‡å¤–è§‚å®Œå¥½ï¼Œæ— æ˜æ˜¾æŸå</span>
        </label>
        <label class="check-item">
            <input type="checkbox" id="check2">
            <span>é…ä»¶é½å…¨ï¼ˆå……ç”µå™¨ã€æ•°æ®çº¿ç­‰ï¼‰</span>
        </label>
        <label class="check-item">
            <input type="checkbox" id="check3">
            <span>å·²æ¸…é™¤è®¾å¤‡ä¸­çš„ä¸ªäººæ•°æ®</span>
        </label>
    </div>
    
    <!-- æäº¤æŒ‰é’® -->
    <div class="form-actions">
        <button type="button" class="btn btn-default btn-large" onclick="history.back()">å–æ¶ˆ</button>
        <button type="button" class="btn btn-warning btn-large" onclick="submitReturn()">ç¡®è®¤å½’è¿˜</button>
    </div>
</div>

<script>
function checkAll() {
    document.getElementById('check1').checked = true;
    document.getElementById('check2').checked = true;
    document.getElementById('check3').checked = true;
}

function submitReturn() {
    const returnPerson = document.getElementById('returnPerson').value.trim();
    const returnReason = document.querySelector('input[name="returnReason"]:checked').value;
    const returnRemark = document.getElementById('returnRemark').value.trim();
    
    // æ£€æŸ¥ç¡®è®¤é¡¹
    if (!document.getElementById('check1').checked ||
        !document.getElementById('check2').checked ||
        !document.getElementById('check3').checked) {
        showToast('è¯·ç¡®è®¤æ‰€æœ‰æ£€æŸ¥é¡¹');
        return;
    }
    
    const fullRemark = returnReason + (returnRemark ? ' - ' + returnRemark : '');
    
    const btn = document.querySelector('.btn-warning');
    btn.disabled = true;
    btn.textContent = 'æäº¤ä¸­...';
    
    fetch('/api/return', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            device_id: '{{ device.id }}',
            person: returnPerson,
            reason: fullRemark
        })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            showToast('å½’è¿˜æˆåŠŸï¼');
            setTimeout(() => {
                window.location.href = '/home';
            }, 1500);
        } else {
            showToast(data.message || 'å½’è¿˜å¤±è´¥');
            btn.disabled = false;
            btn.textContent = 'ç¡®è®¤å½’è¿˜';
        }
    })
    .catch(() => {
        showToast('æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•');
        btn.disabled = false;
        btn.textContent = 'ç¡®è®¤å½’è¿˜';
    });
}
</script>
{% endblock %}
