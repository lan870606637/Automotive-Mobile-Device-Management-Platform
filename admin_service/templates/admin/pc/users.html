<!-- 
  ç”µè„‘ç«¯åå°ç®¡ç† - ç”¨æˆ·ç®¡ç†é¡µé¢
-->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”¨æˆ·ç®¡ç† - è½¦è½½æµ‹è¯•è®¾å¤‡ç®¡ç†ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="/static/admin/admin_pc.css">
</head>
<body class="pc-admin-body">
    <div class="pc-admin-wrapper">
        <!-- ä¾§è¾¹æ  -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <span class="logo">ğŸ”§</span>
                <span class="logo-text">åå°ç®¡ç†</span>
            </div>
            <nav class="sidebar-nav">
                <a href="/admin/pc/dashboard" class="nav-item">
                    <span class="nav-icon">ğŸ“Š</span>
                    <span>ä»ªè¡¨ç›˜</span>
                </a>
                <a href="/admin/pc/devices" class="nav-item">
                    <span class="nav-icon">ğŸ“±</span>
                    <span>è®¾å¤‡ç®¡ç†</span>
                </a>
                <a href="/admin/pc/users" class="nav-item active">
                    <span class="nav-icon">ğŸ‘¥</span>
                    <span>ç”¨æˆ·ç®¡ç†</span>
                </a>
                <a href="/admin/pc/records" class="nav-item">
                    <span class="nav-icon">ğŸ“‹</span>
                    <span>è®°å½•æŸ¥è¯¢</span>
                </a>
                <a href="/admin/pc/logs" class="nav-item">
                    <span class="nav-icon">ğŸ“œ</span>
                    <span>æ“ä½œæ—¥å¿—</span>
                </a>
                <a href="/admin/pc/overdue" class="nav-item">
                    <span class="nav-icon">âš ï¸</span>
                    <span>è¿‡æœŸæœªè¿˜</span>
                    {% if overdue_count > 0 %}
                    <span class="nav-badge">{{ overdue_count }}</span>
                    {% endif %}
                </a>
                <a href="/admin/pc/announcements" class="nav-item">
                    <span class="nav-icon">ğŸ“¢</span>
                    <span>å…¬å‘Šç®¡ç†</span>
                </a>
            </nav>
            <div class="sidebar-footer">
                <span>ğŸ‘¤ {{ admin_name }}</span>
                <a href="/admin/logout" class="logout-btn">é€€å‡º</a>
            </div>
        </aside>

        <!-- ä¸»å†…å®¹åŒº -->
        <main class="main-content">
            <header class="content-header">
                <h1>ç”¨æˆ·ç®¡ç†</h1>
                <div class="header-actions">
                    <button class="btn btn-primary" onclick="showAddUserModal()">â• æ–°å¢ç”¨æˆ·</button>
                </div>
            </header>

            <!-- ç­›é€‰æ  -->
            <div class="filter-bar">
                <div class="filter-group">
                    <input type="text" id="searchInput" class="search-input" placeholder="æœç´¢å§“å / å¾®ä¿¡å / æ‰‹æœºå·" autocomplete="off">
                </div>
                <div class="filter-group">
                    <label>çŠ¶æ€</label>
                    <select id="filterStatus">
                        <option value="">å…¨éƒ¨</option>
                        <option value="æ­£å¸¸">æ­£å¸¸</option>
                        <option value="å·²å†»ç»“">å·²å†»ç»“</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>è§’è‰²</label>
                    <select id="filterRole">
                        <option value="">å…¨éƒ¨</option>
                        <option value="ç®¡ç†å‘˜">ç®¡ç†å‘˜</option>
                        <option value="æ™®é€šç”¨æˆ·">æ™®é€šç”¨æˆ·</option>
                    </select>
                </div>
                <button class="btn btn-secondary" onclick="resetFilters()">é‡ç½®</button>
            </div>

            <!-- ç”¨æˆ·åˆ—è¡¨ -->
            <div class="data-table">
                <table>
                    <thead>
                        <tr>
                            <th>å€Ÿç”¨äºº</th>
                            <th>å¾®ä¿¡å</th>
                            <th>æ‰‹æœºå·</th>
                            <th>å€Ÿç”¨æ¬¡æ•°</th>
                            <th>è§’è‰²</th>
                            <th>çŠ¶æ€</th>
                            <th>æ³¨å†Œæ—¶é—´</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="userTableBody">
                        {% for user in users %}
                        <tr>
                            <td>
                                <div style="display:flex;align-items:center;gap:12px;">
                                    <div class="user-avatar-small">{{ user.name[0] if user.name else '?' }}</div>
                                    <strong>{{ user.name }}</strong>
                                </div>
                            </td>
                            <td>{{ user.weixin_name or '-' }}</td>
                            <td>{{ user.phone or '-' }}</td>
                            <td>{{ user.borrow_count }}</td>
                            <td>
                                {% if user.is_admin %}
                                <span class="role-badge admin">ç®¡ç†å‘˜</span>
                                {% else %}
                                <span class="role-badge user">æ™®é€šç”¨æˆ·</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if user.is_frozen %}
                                <span class="role-badge frozen">å·²å†»ç»“</span>
                                {% else %}
                                <span style="color: #52c41a;">æ­£å¸¸</span>
                                {% endif %}
                            </td>
                            <td>{{ user.register_time }}</td>
                            <td>
                                <div class="table-actions">
                                    <button class="btn btn-sm btn-secondary" onclick="editUser('{{ user.id }}')">ç¼–è¾‘</button>
                                    {% if user.is_frozen %}
                                    <button class="btn btn-sm btn-success" onclick="unfreezeUser('{{ user.id }}')">è§£å†»</button>
                                    {% else %}
                                    <button class="btn btn-sm btn-warning" onclick="freezeUser('{{ user.id }}')">å†»ç»“</button>
                                    {% endif %}
                                    {% if user.is_admin %}
                                    <button class="btn btn-sm btn-danger" onclick="removeAdmin('{{ user.id }}')">å–æ¶ˆç®¡ç†</button>
                                    {% else %}
                                    <button class="btn btn-sm btn-primary" onclick="setAdmin('{{ user.id }}')">è®¾ç®¡ç†</button>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </main>
    </div>

    <!-- æ–°å¢/ç¼–è¾‘ç”¨æˆ·å¼¹çª— -->
    <div id="userModal" class="modal">
        <div class="modal-dialog" style="max-width: 500px;">
            <div class="modal-header">
                <h3 id="modalTitle">æ–°å¢ç”¨æˆ·</h3>
                <button class="modal-close" onclick="closeModal('userModal')">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="userId">
                <div class="form-field">
                    <label>å€Ÿç”¨äººå§“å <span class="required">*</span></label>
                    <input type="text" id="userName" placeholder="è¯·è¾“å…¥å€Ÿç”¨äººå§“å" required>
                </div>
                <div class="form-field">
                    <label>å¾®ä¿¡å</label>
                    <input type="text" id="userWeixin" placeholder="è¯·è¾“å…¥å¾®ä¿¡å">
                </div>
                <div class="form-field">
                    <label>æ‰‹æœºå·</label>
                    <input type="text" id="userPhone" placeholder="è¯·è¾“å…¥æ‰‹æœºå·">
                </div>
                <div class="form-field">
                    <label>å¯†ç  {{ '<span class="required">*</span>' if not user else '' }}</label>
                    <input type="password" id="userPassword" placeholder="{{ 'ç•™ç©ºåˆ™ä¸ä¿®æ”¹' if user else 'è¯·è¾“å…¥å¯†ç ' }}">
                </div>
                <div class="form-row" style="margin-top: 16px;">
                    <div class="form-field">
                        <label>
                            <input type="checkbox" id="userIsAdmin"> è®¾ä¸ºç®¡ç†å‘˜
                        </label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('userModal')">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="saveUser()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- Toastæç¤º -->
    <div id="toast" class="toast"></div>

    <script>
        let users = [];

        // åŠ è½½ç”¨æˆ·åˆ—è¡¨
        async function loadUsers() {
            try {
                const response = await fetch('/api/admin/users');
                users = await response.json();
                renderUsers(users);
            } catch (error) {
                showToast('åŠ è½½ç”¨æˆ·åˆ—è¡¨å¤±è´¥', 'error');
            }
        }

        // æ¸²æŸ“ç”¨æˆ·åˆ—è¡¨
        function renderUsers(userList) {
            const tbody = document.getElementById('userTableBody');
            
            if (userList.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="empty-cell">æš‚æ— ç”¨æˆ·</td></tr>';
                return;
            }

            tbody.innerHTML = userList.map(user => `
                <tr>
                    <td>
                        <div style="display:flex;align-items:center;gap:12px;">
                            <div class="user-avatar-small">${user.name ? user.name[0] : '?'}</div>
                            <strong>${user.name}</strong>
                        </div>
                    </td>
                    <td>${user.weixin_name || '-'}</td>
                    <td>${user.phone || '-'}</td>
                    <td>${user.borrow_count}</td>
                    <td>${user.is_admin ? '<span class="role-badge admin">ç®¡ç†å‘˜</span>' : '<span class="role-badge user">æ™®é€šç”¨æˆ·</span>'}</td>
                    <td>${user.is_frozen ? '<span class="role-badge frozen">å·²å†»ç»“</span>' : '<span style="color: #52c41a;">æ­£å¸¸</span>'}</td>
                    <td>${user.register_time}</td>
                    <td>
                        <div class="table-actions">
                            <button class="btn btn-sm btn-secondary" onclick="editUser('${user.id}')">ç¼–è¾‘</button>
                            ${user.is_frozen 
                                ? `<button class="btn btn-sm btn-success" onclick="unfreezeUser('${user.id}')">è§£å†»</button>`
                                : `<button class="btn btn-sm btn-warning" onclick="freezeUser('${user.id}')">å†»ç»“</button>`
                            }
                            ${user.is_admin
                                ? `<button class="btn btn-sm btn-danger" onclick="removeAdmin('${user.id}')">å–æ¶ˆç®¡ç†</button>`
                                : `<button class="btn btn-sm btn-primary" onclick="setAdmin('${user.id}')">è®¾ç®¡ç†</button>`
                            }
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // æ˜¾ç¤ºæ–°å¢ç”¨æˆ·å¼¹çª—
        function showAddUserModal() {
            document.getElementById('modalTitle').textContent = 'æ–°å¢ç”¨æˆ·';
            document.getElementById('userId').value = '';
            document.getElementById('userName').value = '';
            document.getElementById('userWeixin').value = '';
            document.getElementById('userPhone').value = '';
            document.getElementById('userPassword').value = '';
            document.getElementById('userIsAdmin').checked = false;
            document.getElementById('userModal').classList.add('show');
        }

        // ç¼–è¾‘ç”¨æˆ·
        function editUser(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;

            document.getElementById('modalTitle').textContent = 'ç¼–è¾‘ç”¨æˆ·';
            document.getElementById('userId').value = user.id;
            document.getElementById('userName').value = user.name;
            document.getElementById('userWeixin').value = user.weixin_name || '';
            document.getElementById('userPhone').value = user.phone || '';
            document.getElementById('userPassword').value = '';
            document.getElementById('userIsAdmin').checked = user.is_admin;
            document.getElementById('userModal').classList.add('show');
        }

        // ä¿å­˜ç”¨æˆ·
        async function saveUser() {
            const userId = document.getElementById('userId').value;
            const userData = {
                name: document.getElementById('userName').value.trim(),
                weixin_name: document.getElementById('userWeixin').value.trim(),
                phone: document.getElementById('userPhone').value.trim(),
                password: document.getElementById('userPassword').value,
                is_admin: document.getElementById('userIsAdmin').checked
            };

            if (!userData.name) {
                showToast('è¯·è¾“å…¥å€Ÿç”¨äººå§“å', 'warning');
                return;
            }

            if (!userId && !userData.password) {
                showToast('è¯·è¾“å…¥å¯†ç ', 'warning');
                return;
            }

            const url = userId ? `/api/admin/users/${userId}` : '/api/admin/users';
            const method = userId ? 'PUT' : 'POST';

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(userData)
                });

                const result = await response.json();
                if (result.success) {
                    showToast(userId ? 'ç”¨æˆ·æ›´æ–°æˆåŠŸ' : 'ç”¨æˆ·åˆ›å»ºæˆåŠŸ', 'success');
                    closeModal('userModal');
                    loadUsers();
                } else {
                    showToast(result.message || 'æ“ä½œå¤±è´¥', 'error');
                }
            } catch (error) {
                showToast('ç½‘ç»œé”™è¯¯', 'error');
            }
        }

        // å†»ç»“ç”¨æˆ·
        async function freezeUser(userId) {
            if (!confirm('ç¡®å®šè¦å†»ç»“è¯¥ç”¨æˆ·å—ï¼Ÿå†»ç»“åå°†æ— æ³•å€Ÿè¿˜è®¾å¤‡ã€‚')) return;
            
            try {
                const response = await fetch(`/api/users/${userId}/freeze`, { method: 'POST' });
                const result = await response.json();
                if (result.success) {
                    showToast('ç”¨æˆ·å·²å†»ç»“', 'success');
                    loadUsers();
                } else {
                    showToast(result.message || 'æ“ä½œå¤±è´¥', 'error');
                }
            } catch (error) {
                showToast('ç½‘ç»œé”™è¯¯', 'error');
            }
        }

        // è§£å†»ç”¨æˆ·
        async function unfreezeUser(userId) {
            try {
                const response = await fetch(`/api/users/${userId}/unfreeze`, { method: 'POST' });
                const result = await response.json();
                if (result.success) {
                    showToast('ç”¨æˆ·å·²è§£å†»', 'success');
                    loadUsers();
                } else {
                    showToast(result.message || 'æ“ä½œå¤±è´¥', 'error');
                }
            } catch (error) {
                showToast('ç½‘ç»œé”™è¯¯', 'error');
            }
        }

        // è®¾ä¸ºç®¡ç†å‘˜
        async function setAdmin(userId) {
            if (!confirm('ç¡®å®šè¦è®¾ä¸ºç®¡ç†å‘˜å—ï¼Ÿ')) return;
            
            try {
                const response = await fetch(`/api/users/${userId}/set_admin`, { method: 'POST' });
                const result = await response.json();
                if (result.success) {
                    showToast('å·²è®¾ä¸ºç®¡ç†å‘˜', 'success');
                    loadUsers();
                } else {
                    showToast(result.message || 'æ“ä½œå¤±è´¥', 'error');
                }
            } catch (error) {
                showToast('ç½‘ç»œé”™è¯¯', 'error');
            }
        }

        // å–æ¶ˆç®¡ç†å‘˜
        async function removeAdmin(userId) {
            if (!confirm('ç¡®å®šè¦å–æ¶ˆç®¡ç†å‘˜æƒé™å—ï¼Ÿ')) return;
            
            try {
                const response = await fetch(`/api/users/${userId}/remove_admin`, { method: 'POST' });
                const result = await response.json();
                if (result.success) {
                    showToast('å·²å–æ¶ˆç®¡ç†å‘˜æƒé™', 'success');
                    loadUsers();
                } else {
                    showToast(result.message || 'æ“ä½œå¤±è´¥', 'error');
                }
            } catch (error) {
                showToast('ç½‘ç»œé”™è¯¯', 'error');
            }
        }

        // ç­›é€‰åŠŸèƒ½
        document.getElementById('searchInput')?.addEventListener('input', filterUsers);
        document.getElementById('filterStatus')?.addEventListener('change', filterUsers);
        document.getElementById('filterRole')?.addEventListener('change', filterUsers);

        function filterUsers() {
            const keyword = document.getElementById('searchInput')?.value?.toLowerCase() || '';
            const status = document.getElementById('filterStatus')?.value || '';
            const role = document.getElementById('filterRole')?.value || '';

            let filtered = users;

            if (keyword) {
                filtered = filtered.filter(u => 
                    (u.name && u.name.toLowerCase().includes(keyword)) ||
                    (u.weixin_name && u.weixin_name.toLowerCase().includes(keyword)) ||
                    (u.phone && u.phone.includes(keyword))
                );
            }
            if (status === 'æ­£å¸¸') filtered = filtered.filter(u => !u.is_frozen);
            if (status === 'å·²å†»ç»“') filtered = filtered.filter(u => u.is_frozen);
            if (role === 'ç®¡ç†å‘˜') filtered = filtered.filter(u => u.is_admin);
            if (role === 'æ™®é€šç”¨æˆ·') filtered = filtered.filter(u => !u.is_admin);

            renderUsers(filtered);
        }

        function resetFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('filterStatus').value = '';
            document.getElementById('filterRole').value = '';
            renderUsers(users);
        }

        // å…³é—­å¼¹çª—
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        // æ˜¾ç¤ºToast
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', loadUsers);
    </script>
</body>
</html>
