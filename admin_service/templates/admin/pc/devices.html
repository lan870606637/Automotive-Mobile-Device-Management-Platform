<!-- 
  ç”µè„‘ç«¯åå°ç®¡ç† - è®¾å¤‡ç®¡ç†é¡µé¢
  åŠŸèƒ½ï¼šåˆ—è¡¨å±•ç¤ºã€ç­›é€‰ã€æ–°å¢ã€ç¼–è¾‘ã€åˆ é™¤ã€å€Ÿè¿˜æ“ä½œ
-->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è®¾å¤‡ç®¡ç† - è½¦è½½æµ‹è¯•è®¾å¤‡ç®¡ç†ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="/static/admin/admin_pc.css">
    <style>
        /* å¯è°ƒæ•´åˆ—å®½çš„è¡¨æ ¼æ ·å¼ */
        .data-table table {
            table-layout: fixed;
            width: 100%;
        }
        .data-table th {
            position: relative;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }
        .data-table th .resizer {
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 5px;
            cursor: col-resize;
            background: transparent;
            z-index: 10;
        }
        .data-table th .resizer:hover {
            background: #1890ff;
        }
        .data-table th.resizing {
            background: #e6f7ff;
        }
        .data-table td {
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }
        /* æ“ä½œåˆ—å›ºå®šå®½åº¦ */
        .data-table th:last-child,
        .data-table td:last-child {
            width: 180px !important;
            min-width: 180px !important;
        }
        /* æŸœå·å‰ç¼€é€‰æ‹©æ¡†æ ·å¼ */
        #cabinetPrefixGroup select {
            min-width: 100px;
            padding: 6px 10px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            background-color: #fff;
            font-size: 14px;
            cursor: pointer;
        }
        #cabinetPrefixGroup select:hover {
            border-color: #40a9ff;
        }
        #cabinetPrefixGroup select:focus {
            border-color: #1890ff;
            outline: none;
        }
        /* æ“ä½œæŒ‰é’®æ ·å¼ */
        .table-actions {
            display: flex;
            gap: 4px;
            flex-wrap: nowrap;
        }
        .table-actions .btn {
            padding: 2px 8px;
            font-size: 12px;
            white-space: nowrap;
        }
    </style>
</head>
<body class="pc-admin-body">
    <div class="pc-admin-wrapper">
        <!-- ä¾§è¾¹æ  -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <span class="logo">ğŸ”§</span>
                <span class="logo-text">åå°ç®¡ç†</span>
            </div>
            <nav class="sidebar-nav">
                <a href="/admin/pc/dashboard" class="nav-item">
                    <span class="nav-icon">ğŸ“Š</span>
                    <span>ä»ªè¡¨ç›˜</span>
                </a>
                <a href="/admin/pc/devices" class="nav-item active">
                    <span class="nav-icon">ğŸ“±</span>
                    <span>è®¾å¤‡ç®¡ç†</span>
                </a>
                <a href="/admin/pc/users" class="nav-item">
                    <span class="nav-icon">ğŸ‘¥</span>
                    <span>ç”¨æˆ·ç®¡ç†</span>
                </a>
                <a href="/admin/pc/records" class="nav-item">
                    <span class="nav-icon">ğŸ“‹</span>
                    <span>è®°å½•æŸ¥è¯¢</span>
                </a>
                <a href="/admin/pc/logs" class="nav-item">
                    <span class="nav-icon">ğŸ“œ</span>
                    <span>æ“ä½œæ—¥å¿—</span>
                </a>
                <a href="/admin/pc/overdue" class="nav-item">
                    <span class="nav-icon">âš ï¸</span>
                    <span>è¿‡æœŸæœªè¿˜</span>
                    {% if overdue_count > 0 %}
                    <span class="nav-badge">{{ overdue_count }}</span>
                    {% endif %}
                </a>
            </nav>
            <div class="sidebar-footer">
                <span>ğŸ‘¤ {{ admin_name }}</span>
                <a href="/admin/logout" class="logout-btn">é€€å‡º</a>
            </div>
        </aside>

        <!-- ä¸»å†…å®¹åŒº -->
        <main class="main-content">
            <header class="content-header">
                <h1>è®¾å¤‡ç®¡ç†</h1>
                <div class="header-actions">
                    <button class="btn btn-secondary" onclick="showImportModal()">ğŸ“¥ æ‰¹é‡å¯¼å…¥</button>
                    <a href="/admin/pc/device/add" class="btn btn-primary">â• æ–°å¢è®¾å¤‡</a>
                </div>
            </header>

            <!-- è®¾å¤‡ç±»å‹æ ‡ç­¾æ  -->
            <div class="device-type-tabs">
                <div class="type-tab active" data-type="" onclick="switchTypeTab(this)">
                    <span class="tab-icon">ğŸ“¦</span>
                    <span class="tab-text">å…¨éƒ¨</span>
                    <span class="tab-count" id="count-all">0</span>
                </div>
                <div class="type-tab" data-type="è½¦æœº" onclick="switchTypeTab(this)">
                    <span class="tab-icon">ğŸš—</span>
                    <span class="tab-text">è½¦æœº</span>
                    <span class="tab-count" id="count-car">0</span>
                </div>
                <div class="type-tab" data-type="æ‰‹æœº" onclick="switchTypeTab(this)">
                    <span class="tab-icon">ğŸ“±</span>
                    <span class="tab-text">æ‰‹æœº</span>
                    <span class="tab-count" id="count-phone">0</span>
                </div>
                <div class="type-tab" data-type="ä»ªè¡¨" onclick="switchTypeTab(this)">
                    <span class="tab-icon">ğŸ“Š</span>
                    <span class="tab-text">ä»ªè¡¨</span>
                    <span class="tab-count" id="count-dashboard">0</span>
                </div>
                <div class="type-tab" data-type="æ‰‹æœºå¡" onclick="switchTypeTab(this)">
                    <span class="tab-icon">ğŸ“²</span>
                    <span class="tab-text">æ‰‹æœºå¡</span>
                    <span class="tab-count" id="count-sim">0</span>
                </div>
                <div class="type-tab" data-type="å…¶å®ƒè®¾å¤‡" onclick="switchTypeTab(this)">
                    <span class="tab-icon">ğŸ”§</span>
                    <span class="tab-text">å…¶å®ƒè®¾å¤‡</span>
                    <span class="tab-count" id="count-other">0</span>
                </div>
            </div>

            <!-- ç­›é€‰æ  -->
            <div class="filter-bar">
                <div class="filter-group">
                    <input type="text" id="searchInput" class="search-input" placeholder="æœç´¢è®¾å¤‡å / å‹å· / å€Ÿç”¨äºº / æŸœå· / JIRA / IMEI / ç³»ç»Ÿç‰ˆæœ¬ / é¡¹ç›®å±æ€§ / äº§å“åç§°..." style="min-width: 400px;">
                </div>
                <div class="filter-group">
                    <label>çŠ¶æ€</label>
                    <select id="filterStatus">
                        <option value="">å…¨éƒ¨</option>
                        <option value="åœ¨åº“">åœ¨åº“</option>
                        <option value="ä¿ç®¡ä¸­">ä¿ç®¡ä¸­</option>
                        <option value="å€Ÿå‡º">å€Ÿå‡º</option>
                        <option value="å·²å¯„å‡º">å·²å¯„å‡º</option>
                        <option value="ç»´ä¿®ä¸­">ç»´ä¿®ä¸­</option>
                        <option value="å·²æŸå">å·²æŸå</option>
                        <option value="æŠ¥åºŸ">æŠ¥åºŸ</option>
                        <option value="æµé€š">æµé€š</option>
                        <option value="å°å­˜">å°å­˜</option>
                        <option value="æ— æŸœå·">æ— æŸœå·</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label id="cabinetSearchLabel">æŸœå·/ä¿ç®¡äºº</label>
                    <input type="text" id="filterCabinet" class="search-input" placeholder="æœç´¢æŸœå·æˆ–ä¿ç®¡äºº...">
                </div>
                <div class="filter-group" id="cabinetPrefixGroup" style="display: none;">
                    <label>æŸœå·å‰ç¼€</label>
                    <select id="filterCabinetPrefix">
                        <option value="">å…¨éƒ¨</option>
                    </select>
                </div>
                <button class="btn btn-secondary" onclick="resetFilters()">é‡ç½®</button>
            </div>

            <!-- è®¾å¤‡åˆ—è¡¨ -->
            <div class="data-table">
                <table id="deviceTable">
                    <thead>
                        <tr>
                            <th style="width: 5%;">åºå·<span class="resizer"></span></th>
                            <th id="typeHeader" style="width: 8%;">ç±»å‹<span class="resizer"></span></th>
                            <th style="width: 10%;">å‹å·<span class="resizer"></span></th>
                            <th style="width: 12%;">è®¾å¤‡åç§°<span class="resizer"></span></th>
                            <th style="width: 10%;">JIRAåœ°å€<span class="resizer"></span></th>
                            <th id="carAttrHeader" style="width: 8%; display: none;">é¡¹ç›®å±æ€§<span class="resizer"></span></th>
                            <th id="connMethodHeader" style="width: 8%; display: none;">è¿æ¥æ–¹å¼<span class="resizer"></span></th>
                            <th id="osVerHeader" style="width: 8%; display: none;">ç³»ç»Ÿç‰ˆæœ¬<span class="resizer"></span></th>
                            <th id="osPlatformHeader" style="width: 8%; display: none;">ç³»ç»Ÿå¹³å°<span class="resizer"></span></th>
                            <th id="prodNameHeader" style="width: 10%; display: none;">äº§å“åç§°<span class="resizer"></span></th>
                            <th id="screenOrientationHeader" style="width: 8%; display: none;">å±å¹•æ–¹å‘<span class="resizer"></span></th>
                            <th id="screenResolutionHeader" style="width: 10%; display: none;">è½¦æœºåˆ†è¾¨ç‡<span class="resizer"></span></th>
                            <th id="systemVersionHeader" style="width: 8%; display: none;">ç³»ç»Ÿç‰ˆæœ¬<span class="resizer"></span></th>
                            <th id="imeiHeader" style="width: 10%; display: none;">IMEI<span class="resizer"></span></th>
                            <th style="width: 7%;">çŠ¶æ€<span class="resizer"></span></th>
                            <th style="width: 7%;">å€Ÿç”¨äºº<span class="resizer"></span></th>
                            <th id="locationHeader" style="width: 7%;">æŸœå·/ä¿ç®¡äºº<span class="resizer"></span></th>
                            <th style="width: 8%;">é¢„è®¡å½’è¿˜<span class="resizer"></span></th>
                            <th style="width: 180px;">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="deviceTableBody">
                        <!-- åˆå§‹ç”±åç«¯æ¸²æŸ“ï¼Œå…¨éƒ¨è§†å›¾ä¸‹åªæ˜¾ç¤ºå…¬å…±å­—æ®µ -->
                        {% for device in devices %}
                        <tr data-device-id="{{ device.id }}">
                            <td>{{ loop.index }}</td>
                            <td class="type-field">
                                {% if device.device_type.value == 'æ‰‹æœº' %}ğŸ“±{% elif device.device_type.value == 'è½¦æœº' %}ğŸš—{% elif device.device_type.value == 'ä»ªè¡¨' %}ğŸ“Š{% elif device.device_type.value == 'æ‰‹æœºå¡' %}ğŸ“²{% elif device.device_type.value == 'å…¶å®ƒè®¾å¤‡' %}ğŸ”§{% else %}ğŸ“¦{% endif %}
                                {{ device.device_type.value }}
                            </td>
                            <td>{{ device.model or '-' }}</td>
                            <td>
                                <strong>{{ device.name }}</strong>
                                {% if device.is_overdue %}
                                <span style="color: #ff4d4f; font-size: 12px;">(é€¾æœŸ)</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if device.jira_address %}
                                <a href="http://jira.carbit.lo/browse/{{ device.jira_address }}" target="_blank" style="color: #1890ff; text-decoration: none;">{{ device.jira_address }}</a>
                                {% else %}
                                -
                                {% endif %}
                            </td>
                            <!-- è½¦æœº/ä»ªè¡¨ç‰¹æœ‰å­—æ®µï¼ˆåœ¨"å…¨éƒ¨"è§†å›¾ä¸‹éšè—ï¼‰ -->
                            <td class="car-field" style="display: none;">{{ device.project_attribute or '-' }}</td>
                            <td class="car-field" style="display: none;">{{ device.connection_method or '-' }}</td>
                            <td class="car-field" style="display: none;">{{ device.os_version or '-' }}</td>
                            <td class="car-field" style="display: none;">{{ device.os_platform or '-' }}</td>
                            <td class="car-field" style="display: none;">{{ device.product_name or '-' }}</td>
                            <td class="car-field" style="display: none;">{{ device.screen_orientation or '-' }}</td>
                            <td class="car-field" style="display: none;">{{ device.screen_resolution or '-' }}</td>
                            <!-- æ‰‹æœºç‰¹æœ‰å­—æ®µï¼ˆåœ¨"å…¨éƒ¨"è§†å›¾ä¸‹éšè—ï¼‰ -->
                            <td class="phone-field" style="display: none;">{{ device.system_version or '-' }}</td>
                            <td class="phone-field" style="display: none; font-size: 12px; font-family: monospace;">{{ device.imei or '-' }}</td>
                            <td><span class="status-tag status-{{ device.status }}">{{ device.status }}</span></td>
                            <td>{{ device.borrower or '-' }}</td>
                            <td class="location-cell">{{ device.cabinet or device.custodian or '-' }}</td>
                            <td style="color: {{ '#ff4d4f' if device.is_overdue else '#666' }}">{{ device.expect_return_time or '-' }}</td>
                            <td>
                                <div class="table-actions">
                                    <a href="/admin/pc/device/{{ device.id }}" class="btn btn-sm btn-secondary">ç¼–è¾‘</a>
                                    {% if device.status == 'åœ¨åº“' %}
                                    <button class="btn btn-sm btn-primary" onclick="showBorrowModal('{{ device.id }}')">å€Ÿå‡º</button>
                                    {% elif device.status == 'å€Ÿå‡º' %}
                                    <button class="btn btn-sm btn-success" onclick="showReturnModal('{{ device.id }}')">å½’è¿˜</button>
                                    <button class="btn btn-sm btn-warning" onclick="showTransferModal('{{ device.id }}')">è½¬å€Ÿ</button>
                                    {% endif %}
                                    <button class="btn btn-sm btn-danger" onclick="deleteDevice('{{ device.id }}')">åˆ é™¤</button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- åˆ†é¡µ -->
            <div class="pagination" id="pagination">
                <!-- åŠ¨æ€ç”Ÿæˆåˆ†é¡µ -->
            </div>
        </main>
    </div>

    <!-- å€Ÿå‡ºè®¾å¤‡å¼¹çª— -->
    <div id="borrowModal" class="modal">
        <div class="modal-dialog">
            <div class="modal-header">
                <h3>ğŸ“¤ å½•å…¥ç™»è®°ï¼ˆå€Ÿå‡ºè®¾å¤‡ï¼‰</h3>
                <button class="modal-close" onclick="closeModal('borrowModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-field">
                    <label>é€‰æ‹©å€Ÿç”¨äºº <span class="required">*</span></label>
                    <input type="text" id="borrowUser" list="borrowUserList" placeholder="æœç´¢æˆ–è¾“å…¥å€Ÿç”¨äººå§“å..." autocomplete="off">
                    <datalist id="borrowUserList">
                        {% for user in users %}
                        <option value="{{ user.borrower_name }}">{{ user.borrower_name }} {{ '(' + user.weixin_name + ')' if user.weixin_name else '' }}</option>
                        {% endfor %}
                    </datalist>
                </div>
                <div class="form-field">
                    <label>å€Ÿå‡ºå¤©æ•° <span class="required">*</span></label>
                    <input type="number" id="borrowDays" value="1" min="1" max="365">
                </div>
                <div class="form-field">
                    <label>å€Ÿå‡ºå¤‡æ³¨</label>
                    <textarea id="borrowRemarks" placeholder="å¯é€‰ï¼šå¡«å†™å€Ÿå‡ºå¤‡æ³¨..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('borrowModal')">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="confirmBorrow()">ç¡®è®¤å€Ÿå‡º</button>
            </div>
        </div>
    </div>

    <!-- å½’è¿˜è®¾å¤‡å¼¹çª— -->
    <div id="returnModal" class="modal">
        <div class="modal-dialog" style="max-width: 400px;">
            <div class="modal-header">
                <h3>ğŸ“¥ å¼ºåˆ¶å½’è¿˜è®¾å¤‡</h3>
                <button class="modal-close" onclick="closeModal('returnModal')">&times;</button>
            </div>
            <div class="modal-body">
                <p>ç¡®è®¤å¼ºåˆ¶å½’è¿˜è¯¥è®¾å¤‡å—ï¼Ÿ</p>
                <p style="color: #666; font-size: 14px; margin-top: 12px;">è®¾å¤‡å°†å›åˆ°åœ¨åº“çŠ¶æ€ï¼Œå¹¶è®°å½•æ“ä½œæ—¥å¿—ã€‚</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('returnModal')">å–æ¶ˆ</button>
                <button class="btn btn-success" onclick="confirmReturn()">ç¡®è®¤å½’è¿˜</button>
            </div>
        </div>
    </div>

    <!-- è½¬å€Ÿè®¾å¤‡å¼¹çª— -->
    <div id="transferModal" class="modal">
        <div class="modal-dialog">
            <div class="modal-header">
                <h3>ğŸ”„ è½¬å€Ÿè®¾å¤‡</h3>
                <button class="modal-close" onclick="closeModal('transferModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-field">
                    <label>æ–°å€Ÿç”¨äºº <span class="required">*</span></label>
                    <input type="text" id="transferUser" list="transferUserList" placeholder="æœç´¢æˆ–è¾“å…¥å€Ÿç”¨äººå§“å..." autocomplete="off">
                    <datalist id="transferUserList">
                        {% for user in users %}
                        <option value="{{ user.borrower_name }}">{{ user.borrower_name }} {{ '(' + user.weixin_name + ')' if user.weixin_name else '' }}</option>
                        {% endfor %}
                    </datalist>
                </div>
                <div class="form-field">
                    <label>è½¬å€Ÿå¤‡æ³¨</label>
                    <textarea id="transferRemarks" placeholder="å¯é€‰ï¼šå¡«å†™è½¬å€Ÿå¤‡æ³¨..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('transferModal')">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="confirmTransfer()">ç¡®è®¤è½¬å€Ÿ</button>
            </div>
        </div>
    </div>

    <!-- Toastæç¤º -->
    <div id="toast" class="toast"></div>

    <script>
        let currentDeviceId = null;
        let devices = [];
        let filteredDevices = [];
        let currentPage = 1;
        const pageSize = 50;

        // è·å–è®¾å¤‡å›¾æ ‡
        function getDeviceIcon(deviceType) {
            const iconMap = {
                'æ‰‹æœº': 'ğŸ“±',
                'è½¦æœº': 'ğŸš—',
                'ä»ªè¡¨': 'ğŸ“Š',
                'æ‰‹æœºå¡': 'ğŸ“²',
                'å…¶å®ƒè®¾å¤‡': 'ğŸ”§'
            };
            return iconMap[deviceType] || 'ğŸ“¦';
        }

        // åŠ è½½è®¾å¤‡åˆ—è¡¨
        async function loadDevices() {
            try {
                const response = await fetch('/api/devices');
                devices = await response.json();
                updateTypeCounts();
                updateStatusOptions();
                updateLocationHeader();
                updateCabinetPrefixOptions();
                // åˆå§‹åŒ–ç­›é€‰æ•°æ®å¹¶åˆ†é¡µæ˜¾ç¤º
                filteredDevices = devices;
                currentPage = 1;
                renderCurrentPage();
            } catch (error) {
                showToast('åŠ è½½è®¾å¤‡åˆ—è¡¨å¤±è´¥', 'error');
            }
        }

        // è·å–è®¾å¤‡ä½ç½®ä¿¡æ¯ï¼ˆæŸœå·æˆ–ä¿ç®¡äººï¼‰
        // å¯¹äºæ‰‹æœºã€æ‰‹æœºå¡ã€å…¶å®ƒè®¾å¤‡ï¼šcabinetå­—æ®µå­˜å‚¨çš„æ˜¯ä¿ç®¡äºº
        // å¯¹äºè½¦æœºã€ä»ªè¡¨ï¼šcabinetå­—æ®µå­˜å‚¨çš„æ˜¯æŸœå·
        function getDeviceLocation(device) {
            return device.cabinet || '-';
        }

        // æ›´æ–°è¡¨å¤´æ˜¾ç¤º
        function updateLocationHeader() {
            const header = document.getElementById('locationHeader');
            if (!header) return;

            const custodianTypes = ['æ‰‹æœº', 'æ‰‹æœºå¡', 'å…¶å®ƒè®¾å¤‡'];
            if (currentTypeFilter === '') {
                header.textContent = 'æŸœå·/ä¿ç®¡äºº';
            } else if (custodianTypes.includes(currentTypeFilter)) {
                header.textContent = 'ä¿ç®¡äºº';
            } else {
                header.textContent = 'æŸœå·';
            }

            // æ§åˆ¶æ‰‹æœºç‰¹æœ‰åˆ—çš„æ˜¾ç¤º/éšè—
            updatePhoneSpecificColumns();
        }

        // æ§åˆ¶ç‰¹æœ‰åˆ—ï¼ˆè½¦æœº/ä»ªè¡¨/æ‰‹æœºï¼‰çš„æ˜¾ç¤º/éšè—
        function updatePhoneSpecificColumns() {
            const systemVersionHeader = document.getElementById('systemVersionHeader');
            const imeiHeader = document.getElementById('imeiHeader');
            const carAttrHeader = document.getElementById('carAttrHeader');
            const connMethodHeader = document.getElementById('connMethodHeader');
            const osVerHeader = document.getElementById('osVerHeader');
            const osPlatformHeader = document.getElementById('osPlatformHeader');
            const prodNameHeader = document.getElementById('prodNameHeader');
            
            if (!systemVersionHeader || !imeiHeader) return;

            // è·å–æ‰€æœ‰è¡¨å¤´
            const headers = systemVersionHeader.parentElement.children;
            
            // åˆ¤æ–­å½“å‰ç­›é€‰ç±»å‹
            const isCarOrInstrument = currentTypeFilter === 'è½¦æœº' || currentTypeFilter === 'ä»ªè¡¨';
            const isPhone = currentTypeFilter === 'æ‰‹æœº';
            const isAll = currentTypeFilter === '';
            
            // æ§åˆ¶è½¦æœº/ä»ªè¡¨ç‰¹æœ‰åˆ—è¡¨å¤´æ˜¾ç¤º
            if (carAttrHeader) carAttrHeader.style.display = isCarOrInstrument ? '' : 'none';
            if (connMethodHeader) connMethodHeader.style.display = isCarOrInstrument ? '' : 'none';
            if (osVerHeader) osVerHeader.style.display = isCarOrInstrument ? '' : 'none';
            if (osPlatformHeader) osPlatformHeader.style.display = isCarOrInstrument ? '' : 'none';
            if (prodNameHeader) prodNameHeader.style.display = isCarOrInstrument ? '' : 'none';
            const screenOrientationHeader = document.getElementById('screenOrientationHeader');
            const screenResolutionHeader = document.getElementById('screenResolutionHeader');
            if (screenOrientationHeader) screenOrientationHeader.style.display = isCarOrInstrument ? '' : 'none';
            if (screenResolutionHeader) screenResolutionHeader.style.display = isCarOrInstrument ? '' : 'none';
            
            // æ§åˆ¶æ‰‹æœºç‰¹æœ‰åˆ—è¡¨å¤´æ˜¾ç¤º
            systemVersionHeader.style.display = isPhone ? '' : 'none';
            imeiHeader.style.display = isPhone ? '' : 'none';

            // æ§åˆ¶ç±»å‹åˆ—æ˜¾ç¤ºï¼ˆå…¨éƒ¨è§†å›¾æ˜¾ç¤ºï¼Œå…¶ä»–éšè—ï¼‰
            const typeHeader = document.getElementById('typeHeader');
            if (typeHeader) typeHeader.style.display = isAll ? '' : 'none';

            // æ›´æ–°è¡¨æ ¼æ•°æ®è¡Œçš„å•å…ƒæ ¼æ˜¾ç¤º
            const rows = document.querySelectorAll('#deviceTableBody tr');
            rows.forEach(row => {
                const carFields = row.querySelectorAll('.car-field');
                const phoneFields = row.querySelectorAll('.phone-field');
                const typeFields = row.querySelectorAll('.type-field');

                carFields.forEach(cell => {
                    cell.style.display = isCarOrInstrument ? '' : 'none';
                });

                phoneFields.forEach(cell => {
                    cell.style.display = isPhone ? '' : 'none';
                });

                typeFields.forEach(cell => {
                    cell.style.display = isAll ? '' : 'none';
                });
            });

            // åˆ—å®½åˆ†é…
            if (isPhone) {
                // æ‰‹æœºç±»å‹ï¼šæ˜¾ç¤ºæ‰‹æœºç‰¹æœ‰åˆ—ï¼Œéšè—è½¦æœºç‰¹æœ‰åˆ—ï¼ˆ14åˆ—æ˜¾ç¤ºï¼‰
                headers[0].style.width = '5%';   // åºå·
                headers[1].style.width = '7%';   // ç±»å‹
                headers[2].style.width = '9%';   // å‹å·
                headers[3].style.width = '11%';  // è®¾å¤‡åç§°
                headers[4].style.width = '9%';   // JIRAåœ°å€
                // éšè—çš„7ä¸ªè½¦æœºå­—æ®µï¼ˆ5-11ï¼‰
                headers[12].style.width = '8%';  // ç³»ç»Ÿç‰ˆæœ¬(æ‰‹æœº)
                headers[13].style.width = '12%'; // IMEI
                headers[14].style.width = '7%';  // çŠ¶æ€
                headers[15].style.width = '7%';  // å€Ÿç”¨äºº
                headers[16].style.width = '8%';  // æŸœå·/ä¿ç®¡äºº
                headers[17].style.width = '9%';  // é¢„è®¡å½’è¿˜
                headers[18].style.width = '180px'; // æ“ä½œ
            } else if (isCarOrInstrument) {
                // è½¦æœº/ä»ªè¡¨ç±»å‹ï¼šæ˜¾ç¤ºè½¦æœºç‰¹æœ‰åˆ—ï¼Œéšè—æ‰‹æœºç‰¹æœ‰åˆ—ï¼ˆ17åˆ—æ˜¾ç¤ºï¼‰
                headers[0].style.width = '4%';   // åºå·
                headers[1].style.width = '6%';   // ç±»å‹
                headers[2].style.width = '8%';   // å‹å·
                headers[3].style.width = '10%';  // è®¾å¤‡åç§°
                headers[4].style.width = '8%';   // JIRAåœ°å€
                headers[5].style.width = '7%';   // é¡¹ç›®å±æ€§
                headers[6].style.width = '7%';   // è¿æ¥æ–¹å¼
                headers[7].style.width = '7%';   // ç³»ç»Ÿç‰ˆæœ¬
                headers[8].style.width = '7%';   // ç³»ç»Ÿå¹³å°
                headers[9].style.width = '8%';   // äº§å“åç§°
                headers[10].style.width = '7%';  // å±å¹•æ–¹å‘
                headers[11].style.width = '8%';  // è½¦æœºåˆ†è¾¨ç‡
                // éšè—çš„2ä¸ªæ‰‹æœºå­—æ®µï¼ˆ12-13ï¼‰
                headers[14].style.width = '6%';  // çŠ¶æ€
                headers[15].style.width = '6%';  // å€Ÿç”¨äºº
                headers[16].style.width = '7%';  // æŸœå·/ä¿ç®¡äºº
                headers[17].style.width = '7%';  // é¢„è®¡å½’è¿˜
                headers[18].style.width = '180px'; // æ“ä½œ
            } else {
                // å…¨éƒ¨è§†å›¾ï¼šåªæ˜¾ç¤º10åˆ—å…¬å…±å­—æ®µï¼ˆåºå·ã€ç±»å‹ã€å‹å·ã€è®¾å¤‡åã€JIRAã€çŠ¶æ€ã€å€Ÿç”¨äººã€æŸœå·/ä¿ç®¡äººã€é¢„è®¡å½’è¿˜ã€æ“ä½œï¼‰
                headers[0].style.width = '6%';   // åºå·
                headers[1].style.width = '10%';  // ç±»å‹
                headers[2].style.width = '12%';  // å‹å·
                headers[3].style.width = '18%';  // è®¾å¤‡åç§°
                headers[4].style.width = '14%';  // JIRAåœ°å€
                // éšè—çš„7ä¸ªè½¦æœºå­—æ®µï¼ˆ5-11ï¼‰å’Œ2ä¸ªæ‰‹æœºå­—æ®µï¼ˆ12-13ï¼‰
                headers[14].style.width = '8%';  // çŠ¶æ€
                headers[15].style.width = '8%';  // å€Ÿç”¨äºº
                headers[16].style.width = '10%'; // æŸœå·/ä¿ç®¡äºº
                headers[17].style.width = '10%'; // é¢„è®¡å½’è¿˜
                headers[18].style.width = '180px'; // æ“ä½œ
            }
        }

        // åˆ¤æ–­å½“å‰ç±»å‹æ˜¯å¦ä½¿ç”¨æŸœå·ï¼ˆè½¦æœºå’Œä»ªè¡¨ä½¿ç”¨æŸœå·ï¼‰
        function isCabinetType() {
            if (!currentTypeFilter) return true; // å…¨éƒ¨æ—¶æ˜¾ç¤º
            return currentTypeFilter === 'è½¦æœº' || currentTypeFilter === 'ä»ªè¡¨';
        }

        // æ›´æ–°æŸœå·å‰ç¼€é€‰æ‹©æ¡†
        function updateCabinetPrefixOptions() {
            const prefixSelect = document.getElementById('filterCabinetPrefix');
            const prefixGroup = document.getElementById('cabinetPrefixGroup');
            if (!prefixSelect || !prefixGroup) {
                console.log('DEBUG: æŸœå·å‰ç¼€DOMå…ƒç´ æœªæ‰¾åˆ°');
                return;
            }

            console.log('DEBUG: å½“å‰ç±»å‹=', currentTypeFilter, 'æ˜¯å¦æŸœå·ç±»å‹=', isCabinetType());

            // å¦‚æœä¸æ˜¯æŸœå·ç±»å‹ï¼ˆæ‰‹æœºã€æ‰‹æœºå¡ã€å…¶å®ƒè®¾å¤‡ï¼‰ï¼Œéšè—å‰ç¼€ç­›é€‰
            if (!isCabinetType()) {
                console.log('DEBUG: éæŸœå·ç±»å‹ï¼Œéšè—é€‰æ‹©æ¡†');
                prefixGroup.style.display = 'none';
                return;
            }

            // è·å–å½“å‰ç±»å‹çš„è®¾å¤‡
            let relevantDevices = devices;
            if (currentTypeFilter) {
                relevantDevices = devices.filter(d => d.device_type === currentTypeFilter);
            } else {
                // å…¨éƒ¨æ—¶åªæ˜¾ç¤ºè½¦æœºå’Œä»ªè¡¨çš„æŸœå·ï¼ˆå®ƒä»¬ä½¿ç”¨xx-xxæ ¼å¼ï¼‰
                relevantDevices = devices.filter(d => d.device_type === 'è½¦æœº' || d.device_type === 'ä»ªè¡¨');
            }

            console.log('DEBUG: ç›¸å…³è®¾å¤‡æ•°é‡=', relevantDevices.length);
            console.log('DEBUG: è®¾å¤‡åˆ—è¡¨=', relevantDevices.map(d => ({name: d.device_name, type: d.device_type, cabinet: d.cabinet})));

            // æå–æŸœå·å‰ç¼€ï¼ˆåŒ¹é…xx-xxæˆ–xx - xxæ ¼å¼ï¼Œæ”¯æŒç©ºæ ¼ï¼Œæ”¯æŒå­—æ¯æˆ–æ•°å­—å¼€å¤´ï¼‰
            const prefixSet = new Set();
            relevantDevices.forEach(d => {
                if (d.cabinet && /^[A-Za-z0-9]+\s*-\s*/.test(d.cabinet)) {
                    const match = d.cabinet.match(/^([A-Za-z0-9]+)\s*-/);
                    if (match) {
                        prefixSet.add(match[1]);
                    }
                }
            });

            console.log('DEBUG: æå–çš„å‰ç¼€=', Array.from(prefixSet));

            // è½¦æœºå’Œä»ªè¡¨ç±»å‹å§‹ç»ˆæ˜¾ç¤ºæŸœå·å‰ç¼€ç­›é€‰ï¼ˆå³ä½¿æ²¡æœ‰ç¬¦åˆæ ¼å¼çš„æŸœå·ï¼‰
            prefixGroup.style.display = 'block';

            // ä¿æŒå½“å‰é€‰ä¸­å€¼
            const currentValue = prefixSelect.value;

            // é‡ç½®é€‰é¡¹
            let optionsHtml = '<option value="">å…¨éƒ¨</option>';
            
            // æŒ‰æ•°å­—æ’åº
            const sortedPrefixes = Array.from(prefixSet).sort((a, b) => parseInt(a) - parseInt(b));
            
            sortedPrefixes.forEach(prefix => {
                optionsHtml += `<option value="${prefix}">${prefix}å·æŸœ</option>`;
            });

            prefixSelect.innerHTML = optionsHtml;

            // æ¢å¤ä¹‹å‰çš„é€‰ä¸­å€¼ï¼ˆå¦‚æœè¿˜å­˜åœ¨ï¼‰
            if (currentValue && prefixSet.has(currentValue)) {
                prefixSelect.value = currentValue;
            }
        }

        // æ›´æ–°æœç´¢æ¡†æ ‡ç­¾å’Œplaceholder
        function updateSearchPlaceholder() {
            const label = document.getElementById('cabinetSearchLabel');
            const input = document.getElementById('filterCabinet');
            if (!label || !input) return;

            const custodianTypes = ['æ‰‹æœº', 'æ‰‹æœºå¡', 'å…¶å®ƒè®¾å¤‡'];
            if (currentTypeFilter === '') {
                label.textContent = 'æŸœå·/ä¿ç®¡äºº';
                input.placeholder = 'æœç´¢æŸœå·æˆ–ä¿ç®¡äºº...';
            } else if (custodianTypes.includes(currentTypeFilter)) {
                label.textContent = 'ä¿ç®¡äºº';
                input.placeholder = 'æœç´¢ä¿ç®¡äºº...';
            } else {
                label.textContent = 'æŸœå·';
                input.placeholder = 'æœç´¢æŸœå·...';
            }
        }

        // æ¸²æŸ“è®¾å¤‡åˆ—è¡¨
        function renderDevices(deviceList) {
            const tbody = document.getElementById('deviceTableBody');

            if (deviceList.length === 0) {
                tbody.innerHTML = '<tr><td colspan="19" class="empty-cell">' + (filteredDevices.length === 0 ? 'æš‚æ— è®¾å¤‡' : 'å½“å‰é¡µæ— æ•°æ®') + '</td></tr>';
                return;
            }

            tbody.innerHTML = deviceList.map((device, index) => {
                // æ ¹æ®å½“å‰ç­›é€‰ç±»å‹å†³å®šæ˜¯å¦æ˜¾ç¤ºç‰¹æœ‰å­—æ®µ
                const showCarFields = currentTypeFilter === 'è½¦æœº' || currentTypeFilter === 'ä»ªè¡¨';
                const showPhoneFields = currentTypeFilter === 'æ‰‹æœº';
                const isAllView = currentTypeFilter === '';

                // åˆ¤æ–­æ˜¯å¦æ˜¾ç¤ºè½¦æœº/ä»ªè¡¨ç‰¹æœ‰æ•°æ®ï¼ˆå½“å‰æ˜¯è½¦æœº/ä»ªè¡¨è§†å›¾ï¼Œä¸”è®¾å¤‡ç±»å‹åŒ¹é…ï¼‰
                const showCarData = showCarFields && (device.device_type === 'è½¦æœº' || device.device_type === 'ä»ªè¡¨');
                // åˆ¤æ–­æ˜¯å¦æ˜¾ç¤ºæ‰‹æœºç‰¹æœ‰æ•°æ®ï¼ˆå½“å‰æ˜¯æ‰‹æœºè§†å›¾ï¼Œä¸”è®¾å¤‡ç±»å‹åŒ¹é…ï¼‰
                const showPhoneData = showPhoneFields && device.device_type === 'æ‰‹æœº';

                return `
                <tr>
                    <td>${index + 1}</td>
                    <td class="type-field" style="display: ${isAllView ? '' : 'none'};">${getDeviceIcon(device.device_type)} ${device.device_type}</td>
                    <td>${device.model || '-'}</td>
                    <td>
                        <strong>${device.device_name}</strong>
                        ${device.is_overdue ? '<span style="color: #ff4d4f; font-size: 12px;">(é€¾æœŸ)</span>' : ''}
                    </td>
                    <td>
                        ${device.jira_address ? `<a href="http://jira.carbit.lo/browse/${device.jira_address}" target="_blank" style="color: #1890ff; text-decoration: none;">${device.jira_address}</a>` : '-'}
                    </td>
                    <!-- è½¦æœº/ä»ªè¡¨ç‰¹æœ‰å­—æ®µ (ç¬¬6-12åˆ—) -->
                    <td class="car-field" style="display: ${showCarFields ? '' : 'none'};">${showCarData ? (device.project_attribute || '-') : '-'}</td>
                    <td class="car-field" style="display: ${showCarFields ? '' : 'none'};">${showCarData ? (device.connection_method || '-') : '-'}</td>
                    <td class="car-field" style="display: ${showCarFields ? '' : 'none'};">${showCarData ? (device.os_version || '-') : '-'}</td>
                    <td class="car-field" style="display: ${showCarFields ? '' : 'none'};">${showCarData ? (device.os_platform || '-') : '-'}</td>
                    <td class="car-field" style="display: ${showCarFields ? '' : 'none'};">${showCarData ? (device.product_name || '-') : '-'}</td>
                    <td class="car-field" style="display: ${showCarFields ? '' : 'none'};">${showCarData ? (device.screen_orientation || '-') : '-'}</td>
                    <td class="car-field" style="display: ${showCarFields ? '' : 'none'};">${showCarData ? (device.screen_resolution || '-') : '-'}</td>
                    <!-- æ‰‹æœºç‰¹æœ‰å­—æ®µ (ç¬¬13-14åˆ—) -->
                    <td class="phone-field" style="display: ${showPhoneFields ? '' : 'none'};">${showPhoneData ? (device.system_version || '-') : '-'}</td>
                    <td class="phone-field" style="display: ${showPhoneFields ? '' : 'none'}; font-size: 12px; font-family: monospace;">${showPhoneData ? (device.imei || '-') : '-'}</td>
                    <td><span class="status-tag status-${device.status}">${device.status}</span></td>
                    <td>${device.borrower || '-'}</td>
                    <td class="location-cell">${getDeviceLocation(device)}</td>
                    <td style="color: ${device.is_overdue ? '#ff4d4f' : '#666'}">${device.expected_return || '-'}</td>
                    <td>
                        <div class="table-actions">
                            <a href="/admin/pc/device/${device.id}" class="btn btn-sm btn-secondary">ç¼–è¾‘</a>
                            ${getActionButtons(device)}
                            <button class="btn btn-sm btn-danger" onclick="deleteDevice('${device.id}')">åˆ é™¤</button>
                        </div>
                    </td>
                </tr>
            `}).join('');
        }

        // è·å–æ“ä½œæŒ‰é’®
        function getActionButtons(device) {
            // å°å­˜ã€æµé€šã€æ— æŸœå·çŠ¶æ€è®¾å¤‡ä¸æ”¯æŒå€Ÿç”¨æ“ä½œ
            if (device.status === 'å°å­˜' || device.status === 'æµé€š' || device.status === 'æ— æŸœå·') {
                return '';
            } else if (device.status === 'åœ¨åº“' || device.status === 'ä¿ç®¡ä¸­') {
                // åœ¨åº“å’Œä¿ç®¡ä¸­çŠ¶æ€éƒ½å¯ä»¥å€Ÿå‡º
                return `<button class="btn btn-sm btn-primary" onclick="showBorrowModal('${device.id}')">å€Ÿå‡º</button>`;
            } else if (device.status === 'å€Ÿå‡º') {
                return `
                    <button class="btn btn-sm btn-success" onclick="showReturnModal('${device.id}')">å½’è¿˜</button>
                    <button class="btn btn-sm btn-warning" onclick="showTransferModal('${device.id}')">è½¬å€Ÿ</button>
                `;
            }
            return '';
        }

        // å½“å‰é€‰ä¸­çš„è®¾å¤‡ç±»å‹
        let currentTypeFilter = '';

        // åˆ‡æ¢ç±»å‹æ ‡ç­¾
        function switchTypeTab(tabElement) {
            // ç§»é™¤æ‰€æœ‰æ ‡ç­¾çš„activeçŠ¶æ€
            document.querySelectorAll('.type-tab').forEach(tab => tab.classList.remove('active'));
            // æ·»åŠ å½“å‰æ ‡ç­¾çš„activeçŠ¶æ€
            tabElement.classList.add('active');
            // æ›´æ–°å½“å‰ç±»å‹ç­›é€‰
            currentTypeFilter = tabElement.dataset.type;
            // æ›´æ–°è¡¨å¤´æ˜¾ç¤º
            updateLocationHeader();
            // æ›´æ–°æœç´¢æ¡†æ ‡ç­¾å’Œplaceholder
            updateSearchPlaceholder();
            // æ›´æ–°çŠ¶æ€ç­›é€‰é€‰é¡¹
            updateStatusOptions();
            // æ›´æ–°æŸœå·å‰ç¼€é€‰é¡¹
            updateCabinetPrefixOptions();
            // åº”ç”¨ç­›é€‰
            filterDevices();
        }

        // æ›´æ–°çŠ¶æ€ç­›é€‰é€‰é¡¹ - æ ¹æ®å½“å‰ç±»å‹æ˜¾ç¤ºå­˜åœ¨çš„çŠ¶æ€
        function updateStatusOptions() {
            const statusSelect = document.getElementById('filterStatus');
            const currentStatus = statusSelect.value;

            // è·å–å½“å‰ç±»å‹ä¸‹çš„æ‰€æœ‰çŠ¶æ€
            let relevantDevices = devices;
            if (currentTypeFilter) {
                relevantDevices = devices.filter(d => d.device_type === currentTypeFilter);
            }

            // ç»Ÿè®¡å„çŠ¶æ€æ•°é‡
            const statusCounts = {};
            relevantDevices.forEach(d => {
                statusCounts[d.status] = (statusCounts[d.status] || 0) + 1;
            });

            // æ‰€æœ‰å¯èƒ½çš„çŠ¶æ€åˆ—è¡¨
            const allStatuses = ['åœ¨åº“', 'ä¿ç®¡ä¸­', 'å€Ÿå‡º', 'å·²å¯„å‡º', 'ç»´ä¿®ä¸­', 'å·²æŸå', 'æŠ¥åºŸ', 'æµé€š', 'å°å­˜', 'æ— æŸœå·', 'ä¸¢å¤±'];

            // é‡æ–°æ„å»ºä¸‹æ‹‰æ¡†é€‰é¡¹
            let optionsHtml = '<option value="">å…¨éƒ¨</option>';
            allStatuses.forEach(status => {
                if (statusCounts[status]) {
                    optionsHtml += `<option value="${status}">${status} (${statusCounts[status]})</option>`;
                }
            });

            statusSelect.innerHTML = optionsHtml;

            // å¦‚æœä¹‹å‰é€‰ä¸­çš„çŠ¶æ€ä»ç„¶å­˜åœ¨ï¼Œä¿æŒé€‰ä¸­
            if (currentStatus && statusCounts[currentStatus]) {
                statusSelect.value = currentStatus;
            }
        }

        // æ›´æ–°ç±»å‹æ ‡ç­¾è®¡æ•°
        function updateTypeCounts() {
            const counts = {
                '': devices.length,
                'è½¦æœº': devices.filter(d => d.device_type === 'è½¦æœº').length,
                'æ‰‹æœº': devices.filter(d => d.device_type === 'æ‰‹æœº').length,
                'ä»ªè¡¨': devices.filter(d => d.device_type === 'ä»ªè¡¨').length,
                'æ‰‹æœºå¡': devices.filter(d => d.device_type === 'æ‰‹æœºå¡').length,
                'å…¶å®ƒè®¾å¤‡': devices.filter(d => d.device_type === 'å…¶å®ƒè®¾å¤‡').length
            };

            document.getElementById('count-all').textContent = counts[''];
            document.getElementById('count-car').textContent = counts['è½¦æœº'];
            document.getElementById('count-phone').textContent = counts['æ‰‹æœº'];
            document.getElementById('count-dashboard').textContent = counts['ä»ªè¡¨'];
            document.getElementById('count-sim').textContent = counts['æ‰‹æœºå¡'];
            document.getElementById('count-other').textContent = counts['å…¶å®ƒè®¾å¤‡'];
        }

        // ç­›é€‰åŠŸèƒ½
        document.getElementById('searchInput')?.addEventListener('input', filterDevices);
        document.getElementById('filterStatus')?.addEventListener('change', filterDevices);
        document.getElementById('filterCabinet')?.addEventListener('input', filterDevices);
        document.getElementById('filterCabinetPrefix')?.addEventListener('change', filterDevices);



        function filterDevices() {
            const keyword = document.getElementById('searchInput')?.value?.toLowerCase() || '';
            const status = document.getElementById('filterStatus')?.value || '';
            const cabinet = document.getElementById('filterCabinet')?.value?.toLowerCase() || '';
            const cabinetPrefix = document.getElementById('filterCabinetPrefix')?.value || '';

            let filtered = devices;

            // å…¨å±€å…³é”®è¯æœç´¢ï¼ˆæ”¯æŒæ‰€æœ‰å­—æ®µï¼‰
            if (keyword) {
                filtered = filtered.filter(d => {
                    const searchFields = [
                        d.device_name,
                        d.model,
                        d.borrower,
                        d.cabinet,
                        d.jira_address,
                        d.imei,
                        d.system_version,
                        d.os_version,
                        d.os_platform,
                        d.project_attribute,
                        d.product_name,
                        d.connection_method,
                        d.screen_orientation,
                        d.screen_resolution,
                        d.hardware_version,
                        d.software_version,
                        d.remark,
                        d.reason,
                        d.location,
                        d.phone,
                        d.carrier,
                        d.sn
                    ];
                    return searchFields.some(field => field && field.toLowerCase().includes(keyword));
                });
            }

            // åŸºç¡€ç­›é€‰
            if (currentTypeFilter) filtered = filtered.filter(d => d.device_type === currentTypeFilter);
            if (status) filtered = filtered.filter(d => d.status === status);
            if (cabinet) filtered = filtered.filter(d => d.cabinet && d.cabinet.toLowerCase().includes(cabinet));

            // æŸœå·å‰ç¼€ç­›é€‰ï¼ˆåŒ¹é…xx-xxæˆ–xx - xxæ ¼å¼ï¼Œæ”¯æŒç©ºæ ¼ï¼Œæ”¯æŒå­—æ¯æˆ–æ•°å­—å¼€å¤´ï¼‰
            if (cabinetPrefix) {
                filtered = filtered.filter(d => {
                    if (!d.cabinet) return false;
                    // åŒ¹é…ä»¥ "å‰ç¼€-" æˆ– "å‰ç¼€ -" å¼€å¤´çš„æŸœå·ï¼ˆæ”¯æŒå­—æ¯å’Œæ•°å­—ï¼‰
                    const pattern = new RegExp(`^${cabinetPrefix}\\s*-[A-Za-z0-9\\s-]*$`);
                    return pattern.test(d.cabinet);
                });
            }

            filteredDevices = filtered;
            currentPage = 1; // ç­›é€‰åé‡ç½®åˆ°ç¬¬ä¸€é¡µ
            renderCurrentPage();
        }

        // æ¸²æŸ“å½“å‰é¡µæ•°æ®
        function renderCurrentPage() {
            const start = (currentPage - 1) * pageSize;
            const end = start + pageSize;
            const pageData = filteredDevices.slice(start, end);
            renderDevices(pageData);
            renderPagination();
        }

        // æ¸²æŸ“åˆ†é¡µæ§ä»¶
        function renderPagination() {
            const pagination = document.getElementById('pagination');
            const totalPages = Math.ceil(filteredDevices.length / pageSize);

            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }

            let html = `<div style="display: flex; align-items: center; gap: 8px;">`;

            // ä¸Šä¸€é¡µ
            html += `<button class="pagination-btn" onclick="goToPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : ''}>ä¸Šä¸€é¡µ</button>`;

            // é¡µç 
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                    html += `<button class="pagination-btn ${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">${i}</button>`;
                } else if (i === currentPage - 3 || i === currentPage + 3) {
                    html += `<span style="color: #999;">...</span>`;
                }
            }

            // ä¸‹ä¸€é¡µ
            html += `<button class="pagination-btn" onclick="goToPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : ''}>ä¸‹ä¸€é¡µ</button>`;

            // é¡µç ä¿¡æ¯
            html += `<span style="margin-left: 16px; color: #666; font-size: 14px;">å…± ${filteredDevices.length} æ¡ï¼Œ${totalPages} é¡µ</span>`;

            html += `</div>`;
            pagination.innerHTML = html;
        }

        // è·³è½¬åˆ°æŒ‡å®šé¡µ
        function goToPage(page) {
            const totalPages = Math.ceil(filteredDevices.length / pageSize);
            if (page < 1 || page > totalPages) return;
            currentPage = page;
            renderCurrentPage();
            // æ»šåŠ¨åˆ°è¡¨æ ¼é¡¶éƒ¨
            document.querySelector('.data-table').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function resetFilters() {
            // é‡ç½®åŸºç¡€ç­›é€‰
            document.getElementById('searchInput').value = '';
            document.getElementById('filterStatus').value = '';
            document.getElementById('filterCabinet').value = '';
            document.getElementById('filterCabinetPrefix').value = '';



            // é‡ç½®ç±»å‹æ ‡ç­¾åˆ°"å…¨éƒ¨"
            document.querySelectorAll('.type-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelector('.type-tab[data-type=""]').classList.add('active');
            currentTypeFilter = '';

            // æ›´æ–°è¡¨å¤´æ˜¾ç¤º
            updateLocationHeader();
            // é‡ç½®çŠ¶æ€ç­›é€‰å¹¶æ›´æ–°é€‰é¡¹
            updateStatusOptions();
            // æ›´æ–°æŸœå·å‰ç¼€é€‰é¡¹
            updateCabinetPrefixOptions();

            // é‡ç½®åˆ†é¡µ
            filteredDevices = devices;
            currentPage = 1;
            renderCurrentPage();
        }

        // æ˜¾ç¤ºå€Ÿå‡ºå¼¹çª—
        function showBorrowModal(deviceId) {
            currentDeviceId = deviceId;
            document.getElementById('borrowModal').classList.add('show');
        }

        // ç¡®è®¤å€Ÿå‡º
        async function confirmBorrow() {
            const borrower = document.getElementById('borrowUser').value;
            const days = document.getElementById('borrowDays').value;
            const remarks = document.getElementById('borrowRemarks').value;

            if (!borrower) {
                showToast('è¯·é€‰æ‹©å€Ÿç”¨äºº', 'warning');
                return;
            }

            try {
                const response = await fetch(`/api/devices/${currentDeviceId}/borrow`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ borrower, days: parseInt(days), remarks })
                });

                const result = await response.json();
                if (result.success) {
                    showToast('å€Ÿå‡ºæˆåŠŸ', 'success');
                    closeModal('borrowModal');
                    loadDevices();
                } else {
                    showToast(result.message || 'å€Ÿå‡ºå¤±è´¥', 'error');
                }
            } catch (error) {
                showToast('ç½‘ç»œé”™è¯¯', 'error');
            }
        }

        // æ˜¾ç¤ºå½’è¿˜å¼¹çª—
        function showReturnModal(deviceId) {
            currentDeviceId = deviceId;
            document.getElementById('returnModal').classList.add('show');
        }

        // ç¡®è®¤å½’è¿˜
        async function confirmReturn() {
            try {
                const response = await fetch(`/api/devices/${currentDeviceId}/return`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const result = await response.json();
                if (result.success) {
                    showToast('å½’è¿˜æˆåŠŸ', 'success');
                    closeModal('returnModal');
                    loadDevices();
                } else {
                    showToast(result.message || 'å½’è¿˜å¤±è´¥', 'error');
                }
            } catch (error) {
                showToast('ç½‘ç»œé”™è¯¯', 'error');
            }
        }

        // æ˜¾ç¤ºè½¬å€Ÿå¼¹çª—
        function showTransferModal(deviceId) {
            currentDeviceId = deviceId;
            document.getElementById('transferModal').classList.add('show');
        }

        // ç¡®è®¤è½¬å€Ÿ
        async function confirmTransfer() {
            const borrower = document.getElementById('transferUser').value;
            const remarks = document.getElementById('transferRemarks').value;

            if (!borrower) {
                showToast('è¯·é€‰æ‹©æ–°å€Ÿç”¨äºº', 'warning');
                return;
            }

            try {
                const response = await fetch(`/api/devices/${currentDeviceId}/transfer`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ borrower, remarks })
                });

                const result = await response.json();
                if (result.success) {
                    showToast('è½¬å€ŸæˆåŠŸ', 'success');
                    closeModal('transferModal');
                    loadDevices();
                } else {
                    showToast(result.message || 'è½¬å€Ÿå¤±è´¥', 'error');
                }
            } catch (error) {
                showToast('ç½‘ç»œé”™è¯¯', 'error');
            }
        }

        // åˆ é™¤è®¾å¤‡
        async function deleteDevice(deviceId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¯¥è®¾å¤‡å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) return;

            try {
                const response = await fetch(`/api/devices/${deviceId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();
                if (result.success) {
                    showToast('åˆ é™¤æˆåŠŸ', 'success');
                    loadDevices();
                } else {
                    showToast(result.message || 'åˆ é™¤å¤±è´¥', 'error');
                }
            } catch (error) {
                showToast('ç½‘ç»œé”™è¯¯', 'error');
            }
        }

        // å…³é—­å¼¹çª—
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        // æ˜¾ç¤ºToast
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadDevices();
            initColumnResize();
        });

        // åˆ—å®½è°ƒæ•´åŠŸèƒ½
        function initColumnResize() {
            const table = document.getElementById('deviceTable');
            if (!table) return;
            
            const ths = table.querySelectorAll('thead th');
            let resizing = false;
            let currentTh = null;
            let startX = 0;
            let startWidth = 0;

            ths.forEach((th, index) => {
                // è·³è¿‡æœ€åä¸€åˆ—ï¼ˆæ“ä½œåˆ—ï¼‰
                if (index === ths.length - 1) return;
                
                const resizer = th.querySelector('.resizer');
                if (!resizer) return;

                resizer.addEventListener('mousedown', function(e) {
                    resizing = true;
                    currentTh = th;
                    startX = e.pageX;
                    startWidth = th.offsetWidth;
                    th.classList.add('resizing');
                    document.body.style.cursor = 'col-resize';
                    document.body.style.userSelect = 'none';
                    e.preventDefault();
                });
            });

            document.addEventListener('mousemove', function(e) {
                if (!resizing || !currentTh) return;
                
                const diff = e.pageX - startX;
                const newWidth = Math.max(50, startWidth + diff); // æœ€å°å®½åº¦50px
                currentTh.style.width = newWidth + 'px';
            });

            document.addEventListener('mouseup', function() {
                if (resizing && currentTh) {
                    currentTh.classList.remove('resizing');
                    resizing = false;
                    currentTh = null;
                    document.body.style.cursor = '';
                    document.body.style.userSelect = '';
                }
            });
        }

        // æ˜¾ç¤ºæ‰¹é‡å¯¼å…¥å¼¹çª—
        function showImportModal() {
            const modal = document.createElement('div');
            modal.id = 'importModal';
            modal.className = 'modal';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="modal-dialog" style="max-width: 500px;">
                    <div class="modal-header" style="padding: 20px 24px; border-bottom: 1px solid #e8e8e8;">
                        <h3>ğŸ“¥ æ‰¹é‡å¯¼å…¥è®¾å¤‡</h3>
                        <button class="modal-close" onclick="closeImportModal()">&times;</button>
                    </div>
                    <div class="modal-body" style="padding: 24px;">
                        <div class="form-group" style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 500;">é€‰æ‹©è®¾å¤‡ç±»å‹</label>
                            <select id="importDeviceType" class="form-control" style="width: 100%; padding: 8px; border: 1px solid #d9d9d9; border-radius: 4px;">
                                <option value="">è¯·é€‰æ‹©è®¾å¤‡ç±»å‹</option>
                                <option value="car">ğŸš— è½¦æœº</option>
                                <option value="instrument">ğŸ“Š ä»ªè¡¨</option>
                                <option value="phone">ğŸ“± æ‰‹æœº</option>
                                <option value="sim">ğŸ“² æ‰‹æœºå¡</option>
                                <option value="other">ğŸ”§ å…¶å®ƒè®¾å¤‡</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 500;">ä¸‹è½½æ¨¡æ¿</label>
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <a href="/admin/template/car" class="btn btn-sm btn-secondary template-link" data-type="car">è½¦æœºæ¨¡æ¿</a>
                                <a href="/admin/template/instrument" class="btn btn-sm btn-secondary template-link" data-type="instrument">ä»ªè¡¨æ¨¡æ¿</a>
                                <a href="/admin/template/phone" class="btn btn-sm btn-secondary template-link" data-type="phone">æ‰‹æœºæ¨¡æ¿</a>
                                <a href="/admin/template/sim" class="btn btn-sm btn-secondary template-link" data-type="sim">æ‰‹æœºå¡æ¨¡æ¿</a>
                                <a href="/admin/template/other" class="btn btn-sm btn-secondary template-link" data-type="other">å…¶å®ƒè®¾å¤‡æ¨¡æ¿</a>
                            </div>
                            <p style="margin-top: 8px; font-size: 12px; color: #666;">è¯·å…ˆä¸‹è½½å¯¹åº”ç±»å‹çš„æ¨¡æ¿ï¼Œå¡«å…¥æ•°æ®åå†ä¸Šä¼ </p>
                        </div>
                        <div class="form-group">
                            <label style="display: block; margin-bottom: 8px; font-weight: 500;">ä¸Šä¼ Excelæ–‡ä»¶</label>
                            <input type="file" id="importFile" accept=".xlsx,.xls" style="display: none;">
                            <button type="button" class="btn btn-secondary" onclick="document.getElementById('importFile').click()" style="width: 100%; padding: 20px; border: 2px dashed #d9d9d9; background: #fafafa;">
                                <span style="font-size: 24px;">ğŸ“</span>
                                <p style="margin: 8px 0 0; color: #666;">ç‚¹å‡»é€‰æ‹©Excelæ–‡ä»¶</p>
                                <p id="selectedFileName" style="margin: 4px 0 0; font-size: 12px; color: #1890ff;"></p>
                            </button>
                        </div>
                    </div>
                    <div class="modal-footer" style="padding: 16px 24px; border-top: 1px solid #e8e8e8; background: #fafafa;">
                        <button type="button" class="btn btn-secondary" onclick="closeImportModal()">å–æ¶ˆ</button>
                        <button type="button" class="btn btn-primary" onclick="importDevices()">å¼€å§‹å¯¼å…¥</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            // æ–‡ä»¶é€‰æ‹©äº‹ä»¶
            document.getElementById('importFile').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    document.getElementById('selectedFileName').textContent = 'å·²é€‰æ‹©: ' + file.name;
                }
            });

            // è®¾å¤‡ç±»å‹æ”¹å˜æ—¶é«˜äº®å¯¹åº”æ¨¡æ¿æŒ‰é’®
            document.getElementById('importDeviceType').addEventListener('change', function() {
                const type = this.value;
                document.querySelectorAll('.template-link').forEach(link => {
                    if (link.dataset.type === type) {
                        link.style.background = '#1890ff';
                        link.style.color = '#fff';
                        link.style.borderColor = '#1890ff';
                    } else {
                        link.style.background = '';
                        link.style.color = '';
                        link.style.borderColor = '';
                    }
                });
            });
        }

        // å…³é—­å¯¼å…¥å¼¹çª—
        function closeImportModal() {
            const modal = document.getElementById('importModal');
            if (modal) {
                modal.remove();
            }
        }

        // å¯¼å…¥è®¾å¤‡
        async function importDevices() {
            const deviceType = document.getElementById('importDeviceType').value;
            const fileInput = document.getElementById('importFile');
            const file = fileInput.files[0];

            if (!deviceType) {
                showToast('è¯·é€‰æ‹©è®¾å¤‡ç±»å‹', 'error');
                return;
            }
            if (!file) {
                showToast('è¯·é€‰æ‹©Excelæ–‡ä»¶', 'error');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);
            formData.append('device_type', deviceType);

            try {
                const response = await fetch('/admin/api/import-devices', {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();

                if (result.success) {
                    showToast(`å¯¼å…¥æˆåŠŸï¼å…±å¯¼å…¥ ${result.imported_count} ä¸ªè®¾å¤‡`, 'success');
                    closeImportModal();
                    loadDevices(); // åˆ·æ–°åˆ—è¡¨
                } else {
                    showToast(result.message || 'å¯¼å…¥å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('å¯¼å…¥å¤±è´¥:', error);
                showToast('å¯¼å…¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼', 'error');
            }
        }
    </script>
</body>
</html>
