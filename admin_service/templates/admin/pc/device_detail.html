<!-- 
  电脑端后台管理 - 新增/编辑设备页面
-->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ '编辑设备' if device else '新增设备' }} - 车载测试设备管理系统</title>
    <link rel="stylesheet" href="/static/admin/admin_pc.css">
</head>
<body class="pc-admin-body">
    <div class="pc-admin-wrapper">
        <!-- 侧边栏 -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <span class="logo">🔧</span>
                <span class="logo-text">后台管理</span>
            </div>
            <nav class="sidebar-nav">
                <a href="/admin/pc/dashboard" class="nav-item">
                    <span class="nav-icon">📊</span>
                    <span>仪表盘</span>
                </a>
                <a href="/admin/pc/devices" class="nav-item active">
                    <span class="nav-icon">📱</span>
                    <span>设备管理</span>
                </a>
                <a href="/admin/pc/users" class="nav-item">
                    <span class="nav-icon">👥</span>
                    <span>用户管理</span>
                </a>
                <a href="/admin/pc/records" class="nav-item">
                    <span class="nav-icon">📋</span>
                    <span>记录查询</span>
                </a>
                <a href="/admin/pc/logs" class="nav-item">
                    <span class="nav-icon">📜</span>
                    <span>操作日志</span>
                </a>
                <a href="/admin/pc/overdue" class="nav-item">
                    <span class="nav-icon">⚠️</span>
                    <span>过期未还</span>
                    {% if overdue_count > 0 %}
                    <span class="nav-badge">{{ overdue_count }}</span>
                    {% endif %}
                </a>
                <a href="/admin/pc/announcements" class="nav-item">
                    <span class="nav-icon">📢</span>
                    <span>公告管理</span>
                </a>
            </nav>
            <div class="sidebar-footer">
                <span>👤 {{ admin_name }}</span>
                <a href="/admin/logout" class="logout-btn">退出</a>
            </div>
        </aside>

        <!-- 主内容区 -->
        <main class="main-content">
            <header class="content-header">
                <h1>{{ '编辑设备' if device else '新增设备' }}</h1>
                <div class="header-actions">
                    <a href="javascript:history.back()" class="btn btn-secondary">← 返回列表</a>
                </div>
            </header>

            <!-- 表单 -->
            <div class="form-container">
                <form id="deviceForm">
                    <!-- 基本信息 -->
                    <div class="form-section">
                        <h3 class="form-section-title">基本信息</h3>
                        <div class="form-row">
                            <div class="form-field">
                                <label>设备类型 <span class="required">*</span></label>
                                <select id="deviceType" required>
                                    <option value="车机" {{ 'selected' if device and device.device_type.value == '车机' else 'selected' }}>🚗 车机</option>
                                    <option value="仪表" {{ 'selected' if device and device.device_type.value == '仪表' else '' }}>📊 仪表</option>
                                    <option value="手机" {{ 'selected' if device and device.device_type.value == '手机' else '' }}>📱 手机</option>
                                    <option value="手机卡" {{ 'selected' if device and device.device_type.value == '手机卡' else '' }}>📲 手机卡</option>
                                    <option value="其它设备" {{ 'selected' if device and device.device_type.value == '其它设备' else '' }}>🔧 其它设备</option>
                                </select>
                            </div>
                            <div class="form-field">
                                <label>设备名称 <span class="required">*</span></label>
                                <input type="text" id="deviceName" value="{{ device.name if device else '' }}" placeholder="请输入设备名称（唯一）" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-field">
                                <label>型号</label>
                                <input type="text" id="deviceModel" value="{{ device.model if device else '' }}" placeholder="如：iPhone 14 Pro Max">
                            </div>
                            <div class="form-field">
                                <label>JIRA地址</label>
                                <input type="text" id="deviceJiraAddress" value="{{ device.jira_address if device else '' }}" placeholder="如：NAV-2890">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-field">
                                <label>设备状态</label>
                                <select id="deviceStatus">
                                    <option value="在库" {{ 'selected' if device and device.status.value == '在库' else 'selected' }}>在库</option>
                                    <option value="借出" {{ 'selected' if device and device.status.value == '借出' else '' }}>借出</option>
                                    <option value="保管中" {{ 'selected' if device and device.status.value == '保管中' else '' }}>保管中</option>
                                    <option value="已寄出" {{ 'selected' if device and device.status.value == '已寄出' else '' }}>已寄出</option>
                                    <option value="维修中" {{ 'selected' if device and device.status.value == '维修中' else '' }}>维修中</option>
                                    <option value="已损坏" {{ 'selected' if device and device.status.value == '已损坏' else '' }}>已损坏</option>
                                    <option value="丢失" {{ 'selected' if device and device.status.value == '丢失' else '' }}>丢失</option>
                                    <option value="报废" {{ 'selected' if device and device.status.value == '报废' else '' }}>报废</option>
                                    <option value="流通" {{ 'selected' if device and device.status.value == '流通' else '' }}>流通</option>
                                    <option value="封存" {{ 'selected' if device and device.status.value == '封存' else '' }}>封存</option>
                                    <option value="无柜号" {{ 'selected' if device and device.status.value == '无柜号' else '' }}>无柜号</option>
                                </select>
                            </div>
                            <div class="form-field">
                                <label>备注</label>
                                <input type="text" id="deviceRemark" value="{{ device.remark if device else '' }}" placeholder="设备备注信息">
                            </div>
                        </div>
                    </div>

                    <!-- 存放信息 -->
                    <div class="form-section">
                        <h3 class="form-section-title">存放信息</h3>
                        <div class="form-row">
                            <div class="form-field">
                                <label>柜号/保管人 <span class="required">*</span></label>
                                <input type="text" id="deviceCabinet" value="{{ device.cabinet_number if device else '' }}" placeholder="如：A01 或 张三" required>
                            </div>
                            <div class="form-field">
                                <label>当前借用人</label>
                                <input type="text" id="deviceBorrower" value="{{ device.borrower if device else '' }}" placeholder="设备借出时自动填充">
                            </div>
                        </div>
                    </div>

                    <!-- 动态字段（手机特有） -->
                    <div class="form-section" id="phoneFields" style="display: none;">
                        <h3 class="form-section-title">手机特有信息</h3>
                        <div class="form-row">
                            <div class="form-field">
                                <label>系统版本</label>
                                <input type="text" id="phoneSystemVersion" value="{{ device.system_version if device else '' }}" placeholder="如：Android 14 / iOS 17">
                            </div>
                            <div class="form-field">
                                <label>IMEI</label>
                                <input type="text" id="phoneIMEI" value="{{ device.imei if device else '' }}" placeholder="IMEI号">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-field">
                                <label>SN码</label>
                                <input type="text" id="phoneSN" value="{{ device.sn if device else '' }}" placeholder="设备序列号">
                            </div>
                            <div class="form-field">
                                <label>运营商</label>
                                <select id="phoneCarrier">
                                    <option value="" {{ 'selected' if device and not device.carrier else '' }}>无</option>
                                    <option value="移动" {{ 'selected' if device and device.carrier == '移动' else '' }}>移动</option>
                                    <option value="联通" {{ 'selected' if device and device.carrier == '联通' else '' }}>联通</option>
                                    <option value="电信" {{ 'selected' if device and device.carrier == '电信' else '' }}>电信</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- 动态字段（车机/仪表特有） -->
                    <div class="form-section" id="carFields" style="display: none;">
                        <h3 class="form-section-title">车机/仪表特有信息</h3>
                        <div class="form-row">
                            <div class="form-field">
                                <label>软件版本</label>
                                <input type="text" id="carVersion" value="{{ device.software_version if device else '' }}" placeholder="软件版本号">
                            </div>
                            <div class="form-field">
                                <label>芯片型号</label>
                                <input type="text" id="carHardware" value="{{ device.hardware_version if device else '' }}" placeholder="芯片型号">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-field">
                                <label>项目属性</label>
                                <input type="text" id="carProjectAttr" value="{{ device.project_attribute if device else '' }}" placeholder="项目属性">
                            </div>
                            <div class="form-field">
                                <label>连接方式</label>
                                <input type="text" id="carConnMethod" value="{{ device.connection_method if device else '' }}" placeholder="连接方式">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-field">
                                <label>系统版本</label>
                                <input type="text" id="carOsVersion" value="{{ device.os_version if device else '' }}" placeholder="系统版本">
                            </div>
                            <div class="form-field">
                                <label>系统平台</label>
                                <input type="text" id="carOsPlatform" value="{{ device.os_platform if device else '' }}" placeholder="系统平台">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-field">
                                <label>产品名称</label>
                                <input type="text" id="carProductName" value="{{ device.product_name if device else '' }}" placeholder="产品名称">
                            </div>
                            <div class="form-field">
                                <label>屏幕方向</label>
                                <input type="text" id="carScreenOrientation" value="{{ device.screen_orientation if device else '' }}" placeholder="屏幕方向（如：横屏/竖屏）">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-field">
                                <label>车机分辨率</label>
                                <input type="text" id="carScreenResolution" value="{{ device.screen_resolution if device else '' }}" placeholder="分辨率（如：1920x1080）">
                            </div>
                        </div>
                    </div>

                    <!-- 备注 -->
                    <div class="form-section">
                        <h3 class="form-section-title">备注信息</h3>
                        <div class="form-field">
                            <label>设备备注</label>
                            <textarea id="deviceRemarks" placeholder="可选：添加设备备注信息...">{{ device.remark if device else '' }}</textarea>
                        </div>
                    </div>

                    <!-- 操作按钮 -->
                    <!-- 操作按钮 -->
                    <div class="form-actions">
                        <a href="javascript:history.back()" class="btn btn-secondary">取消</a>
                        <button type="submit" class="btn btn-primary">💾 保存设备</button>
                    </div>
                </form>
            </div>
        </main>
    </div>

    <!-- Toast提示 -->
    <div id="toast" class="toast"></div>

    <script>
        // 初始化：根据设备类型显示对应字段
        function initDeviceFields() {
            const deviceType = document.getElementById('deviceType').value;
            const phoneFields = document.getElementById('phoneFields');
            const carFields = document.getElementById('carFields');

            if (deviceType === '手机') {
                phoneFields.style.display = 'block';
                carFields.style.display = 'none';
            } else if (deviceType === '车机' || deviceType === '仪表') {
                // 车机和仪表显示相同的特有字段
                phoneFields.style.display = 'none';
                carFields.style.display = 'block';
            } else {
                // 手机卡、其它设备不显示特有字段
                phoneFields.style.display = 'none';
                carFields.style.display = 'none';
            }
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', initDeviceFields);

        // 设备类型切换
        document.getElementById('deviceType').addEventListener('change', initDeviceFields);

        // 表单提交
        document.getElementById('deviceForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const deviceData = {
                device_type: document.getElementById('deviceType').value,
                device_name: document.getElementById('deviceName').value.trim(),
                model: document.getElementById('deviceModel').value.trim(),
                status: document.getElementById('deviceStatus').value,
                cabinet: document.getElementById('deviceCabinet').value.trim(),
                borrower: document.getElementById('deviceBorrower').value.trim(),
                jira_address: document.getElementById('deviceJiraAddress').value.trim(),
                remarks: document.getElementById('deviceRemark').value.trim()
            };

            // 手机特有字段
            if (deviceData.device_type === '手机') {
                deviceData.sn = document.getElementById('phoneSN').value.trim();
                deviceData.imei = document.getElementById('phoneIMEI').value.trim();
                deviceData.system_version = document.getElementById('phoneSystemVersion').value.trim();
                deviceData.carrier = document.getElementById('phoneCarrier').value;
            }

            // 车机/仪表特有字段
            if (deviceData.device_type === '车机' || deviceData.device_type === '仪表') {
                deviceData.software_version = document.getElementById('carVersion').value.trim();
                deviceData.hardware_version = document.getElementById('carHardware').value.trim();
                deviceData.project_attribute = document.getElementById('carProjectAttr').value.trim();
                deviceData.connection_method = document.getElementById('carConnMethod').value.trim();
                deviceData.os_version = document.getElementById('carOsVersion').value.trim();
                deviceData.os_platform = document.getElementById('carOsPlatform').value.trim();
                deviceData.product_name = document.getElementById('carProductName').value.trim();
                deviceData.screen_orientation = document.getElementById('carScreenOrientation').value.trim();
                deviceData.screen_resolution = document.getElementById('carScreenResolution').value.trim();
            }

            // 手机卡、其它设备不发送特有字段

            const isEdit = '{{ device.id if device else "" }}' !== '';
            const url = isEdit ? `/api/devices/{{ device.id if device else "" }}` : '/api/devices';
            const method = isEdit ? 'PUT' : 'POST';

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(deviceData)
                });

                const result = await response.json();

                if (result.success) {
                    showToast(isEdit ? '设备更新成功' : '设备录入成功', 'success');
                    setTimeout(() => {
                        // 返回上一页保持筛选状态，如果没有上一页则跳转到设备列表
                        if (document.referrer && document.referrer.includes('/admin/pc/devices')) {
                            window.location.href = document.referrer;
                        } else {
                            window.location.href = '/admin/pc/devices';
                        }
                    }, 1000);
                } else {
                    showToast(result.message || '操作失败', 'error');
                }
            } catch (error) {
                showToast('网络错误，请重试', 'error');
            }
        });

        // 显示Toast
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
    </script>
</body>
</html>
