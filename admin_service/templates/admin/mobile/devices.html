<!-- 
  æ‰‹æœºç«¯åå°ç®¡ç† - è®¾å¤‡æŸ¥è¯¢é¡µé¢
  æ ¸å¿ƒåŠŸèƒ½ï¼šæœç´¢ã€åº•éƒ¨å¼¹çª—è¯¦æƒ…ã€é•¿æŒ‰å¿«æ·æ“ä½œã€ç‚¹å‡»å±•å¼€
-->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è®¾å¤‡æŸ¥è¯¢ - æ‰‹æœºåå°</title>
    <link rel="stylesheet" href="/static/admin/admin_mobile.css">
</head>
<body>
    <div class="mobile-admin-container">
        <!-- é¡¶éƒ¨æ ‡é¢˜æ  -->
        <header class="mobile-header">
            <a href="/admin/mobile/dashboard" class="back-btn">â†</a>
            <h1>è®¾å¤‡æŸ¥è¯¢</h1>
            <a href="/admin/mobile/settings" class="settings-btn">âš™ï¸</a>
        </header>

        <!-- æœç´¢æ  -->
        <div class="search-section">
            <div class="search-box">
                <span class="search-icon">ğŸ”</span>
                <input type="text" id="searchInput" placeholder="æœç´¢è®¾å¤‡å / å€Ÿç”¨äºº / æŸœå·" autocomplete="off">
                <button class="clear-btn" id="clearSearch" style="display:none;">âœ•</button>
            </div>
            <!-- ç­›é€‰æ ‡ç­¾ -->
            <div class="filter-tags">
                <select id="filterStatus" class="filter-select">
                    <option value="">å…¨éƒ¨çŠ¶æ€</option>
                    <option value="åœ¨åº“">åœ¨åº“</option>
                    <option value="å€Ÿå‡º">å€Ÿå‡º</option>
                    <option value="å·²å¯„å‡º">å·²å¯„å‡º</option>
                    <option value="ç»´ä¿®ä¸­">ç»´ä¿®ä¸­</option>
                    <option value="å·²æŸå">å·²æŸå</option>
                    <option value="æŠ¥åºŸ">æŠ¥åºŸ</option>
                    <option value="æµé€š">æµé€š</option>
                    <option value="å°å­˜">å°å­˜</option>
                    <option value="æ— æŸœå·">æ— æŸœå·</option>
                </select>
                <select id="filterType" class="filter-select">
                    <option value="">å…¨éƒ¨ç±»å‹</option>
                    <option value="æ‰‹æœº">ğŸ“± æ‰‹æœº</option>
                    <option value="è½¦æœº">ğŸš— è½¦æœº</option>
                </select>
            </div>
        </div>

        <!-- è®¾å¤‡åˆ—è¡¨ -->
        <div class="device-list-section" id="deviceList">
            <!-- è®¾å¤‡åˆ—è¡¨å°†é€šè¿‡JSåŠ¨æ€åŠ è½½ -->
            <div class="loading-state">
                <span class="loading-icon">â³</span>
                <p>åŠ è½½ä¸­...</p>
            </div>
        </div>
    </div>

    <!-- åº•éƒ¨å¯¼èˆª -->
    <nav class="bottom-nav">
        <a href="/admin/mobile/dashboard" class="nav-item">
            <span class="nav-icon">ğŸ </span>
            <span class="nav-text">é¦–é¡µ</span>
        </a>
        <a href="/admin/mobile/devices" class="nav-item active">
            <span class="nav-icon">ğŸ“±</span>
            <span class="nav-text">æŸ¥è¯¢</span>
        </a>
        <a href="/admin/mobile/device/add" class="nav-item">
            <span class="nav-icon">â•</span>
            <span class="nav-text">å½•å…¥</span>
        </a>
    </nav>

    <!-- åº•éƒ¨å¼¹çª— - è®¾å¤‡è¯¦æƒ… -->
    <div id="deviceModal" class="bottom-modal">
        <div class="modal-overlay" onclick="closeModal()"></div>
        <div class="modal-content">
            <!-- æ‹–åŠ¨æŒ‡ç¤ºæ¡ -->
            <div class="modal-drag-bar" onclick="closeModal()">
                <div class="drag-line"></div>
                <span class="drag-text">â¬‡ï¸ ä¸‹æ»‘æ”¶èµ·</span>
            </div>
            
            <!-- è®¾å¤‡åŸºæœ¬ä¿¡æ¯ -->
            <div class="modal-header">
                <div class="device-icon" id="modalDeviceIcon">ğŸ“±</div>
                <div class="device-title">
                    <h3 id="modalDeviceName">è®¾å¤‡åç§°</h3>
                    <span class="device-status" id="modalDeviceStatus">åœ¨åº“</span>
                </div>
            </div>

            <!-- è®¾å¤‡ä¿¡æ¯ -->
            <div class="modal-body">
                <div class="info-grid">
                    <div class="info-item">
                        <span class="info-label">ç±»å‹</span>
                        <span class="info-value" id="modalDeviceType">æ‰‹æœº</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">å‹å·</span>
                        <span class="info-value" id="modalDeviceModel">-</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">æŸœå·</span>
                        <span class="info-value" id="modalDeviceCabinet">A01</span>
                    </div>
                    <div class="info-item" id="modalBorrowerItem">
                        <span class="info-label">å€Ÿç”¨äºº</span>
                        <span class="info-value" id="modalDeviceBorrower">-</span>
                    </div>
                    <div class="info-item" id="modalBorrowTimeItem">
                        <span class="info-label">å€Ÿå‡ºæ—¶é—´</span>
                        <span class="info-value" id="modalDeviceBorrowTime">-</span>
                    </div>
                    <div class="info-item" id="modalExpectReturnItem">
                        <span class="info-label">é¢„è®¡å½’è¿˜</span>
                        <span class="info-value" id="modalDeviceExpectReturn">-</span>
                    </div>
                </div>

                <!-- å¿«é€Ÿæ“ä½œæŒ‰é’® -->
                <div class="quick-actions-section">
                    <h4>å¿«é€Ÿæ“ä½œ</h4>
                    <div class="action-buttons" id="modalQuickActions">
                        <!-- åŠ¨æ€ç”Ÿæˆæ“ä½œæŒ‰é’® -->
                    </div>
                </div>

                <!-- å¤‡æ³¨ -->
                <div class="device-remarks" id="modalRemarksSection">
                    <h4>è®¾å¤‡å¤‡æ³¨</h4>
                    <p id="modalDeviceRemarks">æš‚æ— å¤‡æ³¨</p>
                </div>

                <!-- æœ€è¿‘å€Ÿè¿˜è®°å½• -->
                <div class="recent-records-section">
                    <h4>æœ€è¿‘5æ¡è®°å½•</h4>
                    <div class="recent-records-list" id="modalRecentRecords">
                        <!-- åŠ¨æ€åŠ è½½ -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- å¿«æ·ç¼–è¾‘å¼¹çª— -->
    <div id="editModal" class="edit-modal">
        <div class="modal-overlay" onclick="closeEditModal()"></div>
        <div class="edit-modal-content">
            <div class="edit-modal-header">
                <h3 id="editModalTitle">ç¼–è¾‘</h3>
                <button class="close-btn" onclick="closeEditModal()">âœ•</button>
            </div>
            <div class="edit-modal-body" id="editModalBody">
                <!-- åŠ¨æ€ç”Ÿæˆç¼–è¾‘å†…å®¹ -->
            </div>
            <div class="edit-modal-footer">
                <button class="btn-cancel" onclick="closeEditModal()">å–æ¶ˆ</button>
                <button class="btn-confirm" onclick="confirmEdit()">ç¡®è®¤</button>
            </div>
        </div>
    </div>

    <!-- Toastæç¤º -->
    <div id="toast" class="toast"></div>

    <!-- é•¿æŒ‰èœå• -->
    <div id="longPressMenu" class="long-press-menu">
        <div class="menu-overlay" onclick="closeLongPressMenu()"></div>
        <div class="menu-content">
            <div class="menu-header">
                <span id="menuDeviceName">è®¾å¤‡åç§°</span>
            </div>
            <div class="menu-items" id="menuItems">
                <!-- åŠ¨æ€ç”Ÿæˆèœå•é¡¹ -->
            </div>
        </div>
    </div>

    <!-- å¿«æ·ç¼–è¾‘å¼¹çª— -->
    <div id="editModal" class="edit-modal">
        <div class="modal-overlay" onclick="closeEditModal()"></div>
        <div class="edit-modal-content">
            <div class="edit-modal-header">
                <h3 id="editModalTitle">ç¼–è¾‘</h3>
                <button class="close-btn" onclick="closeEditModal()">âœ•</button>
            </div>
            <div class="edit-modal-body" id="editModalBody">
                <!-- åŠ¨æ€ç”Ÿæˆç¼–è¾‘å†…å®¹ -->
            </div>
            <div class="edit-modal-footer">
                <button class="btn-cancel" onclick="closeEditModal()">å–æ¶ˆ</button>
                <button class="btn-confirm" onclick="confirmEdit()">ç¡®è®¤</button>
            </div>
        </div>
    </div>

    <script src="/static/admin/admin_mobile.js"></script>
    <script>
        // é¡µé¢åˆå§‹åŒ–
        let devices = [];
        let currentDevice = null;
        let currentEditType = '';
        let longPressTimer = null;
        
        document.addEventListener('DOMContentLoaded', function() {
            loadDevices();
            initSearch();
            initFilters();
        });

        // åŠ è½½è®¾å¤‡åˆ—è¡¨
        async function loadDevices() {
            try {
                const response = await fetch('/api/devices');
                devices = await response.json();
                renderDeviceList(devices);
            } catch (error) {
                showToast('åŠ è½½è®¾å¤‡åˆ—è¡¨å¤±è´¥');
            }
        }

        // æ¸²æŸ“è®¾å¤‡åˆ—è¡¨
        function renderDeviceList(deviceList) {
            const container = document.getElementById('deviceList');
            
            if (deviceList.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <span class="empty-icon">ğŸ“±</span>
                        <p>æš‚æ— è®¾å¤‡</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = deviceList.map(device => `
                <div class="device-item ${device.status === 'å€Ÿå‡º' ? 'borrowed' : ''}" 
                     data-id="${device.id}"
                     onclick="handleDeviceClick('${device.id}', event)"
                     ontouchstart="handleTouchStart('${device.id}', event)" 
                     ontouchend="handleTouchEnd(event)"
                     onmousedown="handleMouseDown('${device.id}', event)"
                     onmouseup="handleMouseUp(event)"
                     onmouseleave="handleMouseUp(event)">
                    <div class="device-main">
                        <div class="device-icon">${device.device_type === 'æ‰‹æœº' ? 'ğŸ“±' : 'ğŸš—'}</div>
                        <div class="device-info">
                            <h4>${device.device_name}</h4>
                            <p class="device-meta">
                                <span class="device-status-badge status-${getStatusClass(device.status)}">${device.status}</span>
                                ${device.borrower ? `<span class="borrower">ğŸ‘¤ ${device.borrower}</span>` : `<span class="cabinet">ğŸ“¦ ${device.cabinet || 'æ— æŸœå·'}</span>`}
                            </p>
                        </div>
                        ${device.is_overdue ? '<span class="overdue-badge">é€¾æœŸ</span>' : ''}
                    </div>
                    <div class="device-expand ${device.expanded ? 'expanded' : ''}" id="expand-${device.id}">
                        <div class="expand-actions">
                            ${getActionButtons(device)}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // è·å–çŠ¶æ€æ ·å¼ç±»
        function getStatusClass(status) {
            const statusMap = {
                'åœ¨åº“': 'available',
                'å€Ÿå‡º': 'borrowed',
                'å·²å¯„å‡º': 'sent',
                'ç»´ä¿®ä¸­': 'repairing',
                'å·²æŸå': 'damaged',
                'æŠ¥åºŸ': 'scrapped'
            };
            return statusMap[status] || 'available';
        }

        // è·å–æ“ä½œæŒ‰é’®
        function getActionButtons(device) {
            let buttons = '';
            
            if (device.status === 'åœ¨åº“') {
                buttons += `<button class="action-btn btn-borrow" onclick="showBorrowModal('${device.id}', event)">å½•å…¥ç™»è®°</button>`;
            } else if (device.status === 'å€Ÿå‡º') {
                buttons += `<button class="action-btn btn-return" onclick="showReturnModal('${device.id}', event)">å¼ºåˆ¶å½’è¿˜</button>`;
                buttons += `<button class="action-btn btn-transfer" onclick="showTransferModal('${device.id}', event)">è½¬å€Ÿ</button>`;
            }
            
            buttons += `<button class="action-btn btn-edit" onclick="showEditModal('${device.id}', event)">ç¼–è¾‘è®¾å¤‡</button>`;
            buttons += `<button class="action-btn btn-cabinet" onclick="showEditFieldModal('${device.id}', 'cabinet', event)">æ›´æ”¹æŸœå·</button>`;
            buttons += `<button class="action-btn btn-status" onclick="showEditFieldModal('${device.id}', 'status', event)">è®¾ç½®çŠ¶æ€</button>`;
            
            return buttons;
        }

        // ç‚¹å‡»è®¾å¤‡ - åˆ‡æ¢å±•å¼€/æ˜¾ç¤ºå¼¹çª—
        function handleDeviceClick(deviceId, event) {
            if (longPressTimer) {
                clearTimeout(longPressTimer);
                longPressTimer = null;
            }
            
            // å¦‚æœç‚¹å‡»çš„æ˜¯æŒ‰é’®ï¼Œä¸å¤„ç†
            if (event.target.tagName === 'BUTTON') {
                return;
            }
            
            // å…ˆæ£€æŸ¥æ˜¯å¦æœ‰å±•å¼€çš„é¡¹
            const expandedItem = document.querySelector('.device-expand.expanded');
            const currentExpand = document.getElementById(`expand-${deviceId}`);
            
            if (expandedItem && expandedItem !== currentExpand) {
                // å…³é—­å…¶ä»–å±•å¼€çš„é¡¹
                expandedItem.classList.remove('expanded');
            }
            
            // åˆ‡æ¢å½“å‰é¡¹çš„å±•å¼€çŠ¶æ€
            if (currentExpand) {
                if (currentExpand.classList.contains('expanded')) {
                    // å·²ç»å±•å¼€ï¼Œç‚¹å‡»æ˜¾ç¤ºå¼¹çª—
                    openDeviceModal(deviceId);
                } else {
                    // æœªå±•å¼€ï¼Œç‚¹å‡»å±•å¼€
                    currentExpand.classList.add('expanded');
                }
            }
        }

        // è§¦æ‘¸å¼€å§‹ - é•¿æŒ‰æ£€æµ‹
        function handleTouchStart(deviceId, event) {
            longPressTimer = setTimeout(() => {
                showLongPressMenu(deviceId);
            }, 600);
        }

        // è§¦æ‘¸ç»“æŸ
        function handleTouchEnd(event) {
            if (longPressTimer) {
                clearTimeout(longPressTimer);
                longPressTimer = null;
            }
        }

        // é¼ æ ‡æŒ‰ä¸‹
        function handleMouseDown(deviceId, event) {
            longPressTimer = setTimeout(() => {
                showLongPressMenu(deviceId);
            }, 600);
        }

        // é¼ æ ‡æŠ¬èµ·
        function handleMouseUp(event) {
            if (longPressTimer) {
                clearTimeout(longPressTimer);
                longPressTimer = null;
            }
        }

        // æ˜¾ç¤ºé•¿æŒ‰èœå•
        function showLongPressMenu(deviceId) {
            const device = devices.find(d => d.id === deviceId);
            if (!device) return;
            
            currentDevice = device;
            
            document.getElementById('menuDeviceName').textContent = device.device_name;
            const menuItems = document.getElementById('menuItems');
            
            let itemsHtml = '';
            
            if (device.status === 'åœ¨åº“') {
                itemsHtml += `<div class="menu-item" onclick="showBorrowModal('${device.id}');closeLongPressMenu();"><span class="menu-icon">ğŸ“¤</span>å½•å…¥ç™»è®°</div>`;
            } else if (device.status === 'å€Ÿå‡º') {
                itemsHtml += `<div class="menu-item" onclick="showReturnModal('${device.id}');closeLongPressMenu();"><span class="menu-icon">ğŸ“¥</span>å¼ºåˆ¶å½’è¿˜</div>`;
                itemsHtml += `<div class="menu-item" onclick="showTransferModal('${device.id}');closeLongPressMenu();"><span class="menu-icon">ğŸ”„</span>è½¬å€Ÿè®¾å¤‡</div>`;
                itemsHtml += `<div class="menu-item" onclick="showEditFieldModal('${device.id}', 'borrower');closeLongPressMenu();"><span class="menu-icon">ğŸ‘¤</span>æ›´æ”¹å€Ÿç”¨äºº</div>`;
            }
            
            itemsHtml += `<div class="menu-item" onclick="showEditFieldModal('${device.id}', 'cabinet');closeLongPressMenu();"><span class="menu-icon">ğŸ“¦</span>æ›´æ”¹æŸœå·</div>`;
            itemsHtml += `<div class="menu-item" onclick="showEditFieldModal('${device.id}', 'keeper');closeLongPressMenu();"><span class="menu-icon">ğŸ”‘</span>æ›´æ”¹ä¿ç®¡äºº</div>`;
            itemsHtml += `<div class="menu-item" onclick="showEditFieldModal('${device.id}', 'status');closeLongPressMenu();"><span class="menu-icon">ğŸ“Š</span>è®¾ç½®çŠ¶æ€</div>`;
            itemsHtml += `<div class="menu-item" onclick="openDeviceModal('${device.id}');closeLongPressMenu();"><span class="menu-icon">ğŸ“‹</span>æŸ¥çœ‹è¯¦æƒ…</div>`;
            
            menuItems.innerHTML = itemsHtml;
            
            document.getElementById('longPressMenu').classList.add('show');
        }

        // å…³é—­é•¿æŒ‰èœå•
        function closeLongPressMenu() {
            document.getElementById('longPressMenu').classList.remove('show');
        }

        // æ‰“å¼€è®¾å¤‡è¯¦æƒ…å¼¹çª—
        function openDeviceModal(deviceId) {
            const device = devices.find(d => d.id === deviceId);
            if (!device) return;
            
            currentDevice = device;
            
            // å¡«å……åŸºæœ¬ä¿¡æ¯
            document.getElementById('modalDeviceIcon').textContent = device.device_type === 'æ‰‹æœº' ? 'ğŸ“±' : 'ğŸš—';
            document.getElementById('modalDeviceName').textContent = device.device_name;
            document.getElementById('modalDeviceStatus').textContent = device.status;
            document.getElementById('modalDeviceStatus').className = `device-status status-${getStatusClass(device.status)}`;
            document.getElementById('modalDeviceType').textContent = device.device_type;
            document.getElementById('modalDeviceModel').textContent = device.model || '-';
            document.getElementById('modalDeviceCabinet').textContent = device.cabinet || '-';
            document.getElementById('modalDeviceBorrower').textContent = device.borrower || '-';
            document.getElementById('modalDeviceBorrowTime').textContent = device.borrow_time || '-';
            document.getElementById('modalDeviceExpectReturn').textContent = device.expect_return_time || '-';
            
            // æ ¹æ®çŠ¶æ€æ˜¾ç¤º/éšè—å€Ÿç”¨äººä¿¡æ¯
            const borrowerItems = ['modalBorrowerItem', 'modalBorrowTimeItem', 'modalExpectReturnItem'];
            borrowerItems.forEach(id => {
                document.getElementById(id).style.display = device.borrower ? 'flex' : 'none';
            });
            
            // ç”Ÿæˆå¿«é€Ÿæ“ä½œæŒ‰é’®
            generateQuickActions(device);
            
            // å¤‡æ³¨
            if (device.remarks) {
                document.getElementById('modalRemarksSection').style.display = 'block';
                document.getElementById('modalDeviceRemarks').textContent = device.remarks;
            } else {
                document.getElementById('modalRemarksSection').style.display = 'none';
            }
            
            // åŠ è½½æœ€è¿‘è®°å½•
            loadRecentRecords(deviceId);
            
            document.getElementById('deviceModal').classList.add('show');
        }

        // å…³é—­å¼¹çª—
        function closeModal() {
            document.getElementById('deviceModal').classList.remove('show');
        }

        // ç”Ÿæˆå¿«é€Ÿæ“ä½œæŒ‰é’®
        function generateQuickActions(device) {
            const container = document.getElementById('modalQuickActions');
            let buttons = '';
            
            if (device.status === 'åœ¨åº“') {
                buttons += `<button class="quick-btn btn-borrow" onclick="showBorrowModal('${device.id}')">ğŸ“¤ å½•å…¥ç™»è®°</button>`;
            } else if (device.status === 'å€Ÿå‡º') {
                buttons += `<button class="quick-btn btn-return" onclick="showReturnModal('${device.id}')">ğŸ“¥ å¼ºåˆ¶å½’è¿˜</button>`;
                buttons += `<button class="quick-btn btn-transfer" onclick="showTransferModal('${device.id}')">ğŸ”„ è½¬å€Ÿ</button>`;
            }
            
            buttons += `<button class="quick-btn btn-edit" onclick="showEditModal('${device.id}')">âœï¸ ç¼–è¾‘</button>`;
            buttons += `<button class="quick-btn btn-cabinet" onclick="showEditFieldModal('${device.id}', 'cabinet')">ğŸ“¦ æ”¹æŸœå·</button>`;
            buttons += `<button class="quick-btn btn-status" onclick="showEditFieldModal('${device.id}', 'status')">ğŸ“Š æ”¹çŠ¶æ€</button>`;
            
            container.innerHTML = buttons;
        }

        // åŠ è½½æœ€è¿‘5æ¡è®°å½•
        async function loadRecentRecords(deviceId) {
            try {
                const response = await fetch(`/api/devices/${deviceId}/records?limit=5`);
                const records = await response.json();
                
                const container = document.getElementById('modalRecentRecords');
                if (records.length === 0) {
                    container.innerHTML = '<p class="empty-records">æš‚æ— è®°å½•</p>';
                    return;
                }
                
                container.innerHTML = records.map(r => `
                    <div class="recent-record-item">
                        <span class="record-type">${r.action_type}</span>
                        <span class="record-user">${r.user_name}</span>
                        <span class="record-time">${r.time}</span>
                    </div>
                `).join('');
            } catch (error) {
                document.getElementById('modalRecentRecords').innerHTML = '<p class="empty-records">åŠ è½½å¤±è´¥</p>';
            }
        }

        // åˆå§‹åŒ–æœç´¢
        function initSearch() {
            const searchInput = document.getElementById('searchInput');
            const clearBtn = document.getElementById('clearSearch');
            
            searchInput.addEventListener('input', function() {
                const keyword = this.value.toLowerCase();
                clearBtn.style.display = keyword ? 'block' : 'none';
                
                const filtered = devices.filter(d => 
                    (d.device_name && d.device_name.toLowerCase().includes(keyword)) ||
                    (d.borrower && d.borrower.toLowerCase().includes(keyword)) ||
                    (d.cabinet && d.cabinet.toLowerCase().includes(keyword))
                );
                renderDeviceList(filtered);
            });
            
            clearBtn.addEventListener('click', function() {
                searchInput.value = '';
                this.style.display = 'none';
                renderDeviceList(devices);
            });
        }

        // åˆå§‹åŒ–ç­›é€‰
        function initFilters() {
            const statusFilter = document.getElementById('filterStatus');
            const typeFilter = document.getElementById('filterType');
            
            const applyFilters = () => {
                const status = statusFilter.value;
                const type = typeFilter.value;
                
                let filtered = devices;
                
                if (status) {
                    filtered = filtered.filter(d => d.status === status);
                }
                if (type) {
                    filtered = filtered.filter(d => d.device_type === type);
                }
                
                renderDeviceList(filtered);
            };
            
            statusFilter.addEventListener('change', applyFilters);
            typeFilter.addEventListener('change', applyFilters);
        }

        // æ˜¾ç¤ºToastæç¤º
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 2000);
        }
    </script>
</body>
</html>
