{% extends "pc/base_pc.html" %}

{% block title %}{{ device.name }} - è®¾å¤‡è¯¦æƒ…{% endblock %}

{% set active_nav = 'devices' %}

{% block content %}
<!-- é¡µé¢å¤´éƒ¨ -->
<div class="detail-header">
    <div class="detail-icon">
        {% if device_type == 'è½¦æœº' %}ğŸš—
        {% elif device_type == 'æ‰‹æœº' %}ğŸ“±
        {% elif device_type == 'ä»ªè¡¨' %}ğŸ“Š
        {% elif device_type == 'æ‰‹æœºå¡' %}ğŸ“²
        {% else %}ğŸ”§{% endif %}
    </div>
    <div class="detail-title">
        <h2>{{ device.name }}</h2>
        <div class="detail-meta">
            {% if is_circulating %}
            <span class="status-tag status-circulating">æµé€šè®¾å¤‡</span>
            {% elif is_sealed %}
            <span class="status-tag status-sealed">å°å­˜è®¾å¤‡</span>
            {% else %}
            <span class="status-tag status-no-cabinet">æ— æŸœå·è®¾å¤‡</span>
            {% endif %}
            <span>{{ device_type }}</span>
        </div>
    </div>
</div>

<!-- è®¾å¤‡è¯¦æƒ… -->
<div class="detail-grid">
    <div class="detail-main">
        <div class="card">
            <div class="card-header">
                <span class="card-title">ğŸ“‹ è®¾å¤‡ä¿¡æ¯</span>
            </div>
            <div class="card-body">
                <div class="info-row">
                    <span class="info-label">è®¾å¤‡ç±»å‹</span>
                    <span class="info-value">{{ device_type }}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">å‹å·</span>
                    <span class="info-value">{{ device.model or '-' }}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">{% if device_type == 'è½¦æœº' or device_type == 'ä»ªè¡¨' %}æŸœå·{% else %}ä¿ç®¡äºº{% endif %}</span>
                    <span class="info-value" style="color: {% if is_circulating %}#52c41a{% elif is_sealed %}#eb2f96{% else %}#999{% endif %}; font-weight: 500;">
                        {% if is_circulating %}æµé€š{% elif is_sealed %}{{ device.cabinet_number or '-' }}{% else %}æ— {% endif %}
                    </span>
                </div>
                <div class="info-row">
                    <span class="info-label">å¤‡æ³¨</span>
                    <span class="info-value">{{ device.remark or '-' }}</span>
                </div>
            </div>
        </div>

        <!-- çŠ¶æ€æç¤º -->
        <div class="card">
            <div class="card-header">
                <span class="card-title">â„¹ï¸ çŠ¶æ€è¯´æ˜</span>
            </div>
            <div class="card-body">
                <div style="background: {% if is_circulating %}#f6ffed{% elif is_sealed %}#fff0f6{% else %}#f5f5f5{% endif %}; padding: 20px; border-radius: 8px; text-align: center;">
                    <p style="font-size: 16px; font-weight: 500; color: {% if is_circulating %}#52c41a{% elif is_sealed %}#eb2f96{% else %}#666{% endif %}; margin-bottom: 8px;">
                        {% if is_circulating %}ğŸ”„ æ­¤è®¾å¤‡ä¸ºæµé€šè®¾å¤‡{% elif is_sealed %}ğŸ”’ æ­¤è®¾å¤‡ä¸ºå°å­˜è®¾å¤‡{% else %}âš ï¸ æ­¤è®¾å¤‡æš‚æ— æŸœå·ä¿¡æ¯{% endif %}
                    </p>
                    <p style="color: #8c8c8c; font-size: 14px;">æš‚ä¸æ”¯æŒå€Ÿç”¨æ“ä½œ</p>
                </div>
            </div>
        </div>

        <!-- ç”¨æˆ·å¤‡æ³¨ -->
        <div class="card">
            <div class="card-header">
                <span class="card-title">ğŸ“ ç”¨æˆ·å¤‡æ³¨</span>
                <button class="btn btn-primary btn-sm" onclick="openAddRemarkModal()">+ æ·»åŠ å¤‡æ³¨</button>
            </div>
            <div class="card-body">
                {% if remarks %}
                <div class="remarks-list">
                    {% for remark in remarks %}
                    <div class="remark-item">
                        <div class="remark-content">{{ remark.content }}</div>
                        <div class="remark-meta">
                            <span class="remark-author">{{ remark.creator }}</span>
                            <span>{{ remark.create_time }}</span>
                            {% if remark.is_creator %}
                            <div class="remark-actions">
                                <a href="javascript:void(0)" onclick="openEditRemarkModal('{{ remark.id }}', '{{ remark.content|replace("'", "\\'") }}')">ç¼–è¾‘</a>
                                <a href="javascript:void(0)" class="delete" onclick="deleteRemark('{{ remark.id }}')">åˆ é™¤</a>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="empty-state" style="padding: 40px;">
                    <p class="empty-title">æš‚æ— å¤‡æ³¨</p>
                    <button class="btn btn-primary" onclick="openAddRemarkModal()">æ·»åŠ ç¬¬ä¸€æ¡å¤‡æ³¨</button>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- æŸ¥çœ‹è®°å½• -->
        <div class="card">
            <div class="card-header">
                <span class="card-title">ğŸ‘ï¸ æŸ¥çœ‹è®°å½•</span>
            </div>
            <div class="card-body">
                {% if view_records %}
                <div class="timeline">
                    {% for vr in view_records %}
                    <div class="timeline-item">
                        <div class="timeline-dot"></div>
                        <div class="timeline-content">
                            <div class="timeline-header">
                                <span class="timeline-device">{{ vr.viewer }}</span>
                                <span class="timeline-time">{{ vr.view_time }}</span>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="empty-state" style="padding: 40px;">
                    <p class="empty-title">æš‚æ— æŸ¥çœ‹è®°å½•</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- å¼¹çª—ï¼šæ·»åŠ å¤‡æ³¨ -->
<div class="modal-overlay" id="addRemarkModal">
    <div class="modal">
        <div class="modal-header">
            <span class="modal-title">ğŸ“ æ·»åŠ å¤‡æ³¨</span>
            <button class="modal-close" onclick="closeModal('addRemarkModal')">Ã—</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label">å¤‡æ³¨å†…å®¹</label>
                <textarea id="remarkContent" class="form-textarea" rows="4" placeholder="è¯·è¾“å…¥å¤‡æ³¨å†…å®¹..."></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-default" onclick="closeModal('addRemarkModal')">å–æ¶ˆ</button>
            <button class="btn btn-primary" onclick="submitAddRemark()">ç¡®è®¤æ·»åŠ </button>
        </div>
    </div>
</div>

<!-- å¼¹çª—ï¼šç¼–è¾‘å¤‡æ³¨ -->
<div class="modal-overlay" id="editRemarkModal">
    <div class="modal">
        <div class="modal-header">
            <span class="modal-title">âœï¸ ç¼–è¾‘å¤‡æ³¨</span>
            <button class="modal-close" onclick="closeModal('editRemarkModal')">Ã—</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label">å¤‡æ³¨å†…å®¹</label>
                <textarea id="editRemarkContent" class="form-textarea" rows="4"></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-default" onclick="closeModal('editRemarkModal')">å–æ¶ˆ</button>
            <button class="btn btn-primary" onclick="submitEditRemark()">ç¡®è®¤ä¿®æ”¹</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const deviceId = '{{ device.id }}';
let currentRemarkId = '';

function openModal(id) { document.getElementById(id).classList.add('active'); }
function closeModal(id) { document.getElementById(id).classList.remove('active'); }

function openAddRemarkModal() { openModal('addRemarkModal'); }

function openEditRemarkModal(id, content) {
    currentRemarkId = id;
    document.getElementById('editRemarkContent').value = content;
    openModal('editRemarkModal');
}

function submitAddRemark() {
    const content = document.getElementById('remarkContent').value.trim();
    if (!content) { showToast('å¤‡æ³¨å†…å®¹ä¸èƒ½ä¸ºç©º'); return; }
    fetch('/api/remark/add', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({device_id: deviceId, content: content})
    }).then(r => r.json()).then(data => {
        if (data.success) { showToast('å¤‡æ³¨å·²æ·»åŠ '); closeModal('addRemarkModal'); location.reload(); }
        else { showToast(data.message || 'æ·»åŠ å¤±è´¥'); }
    }).catch(() => showToast('æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•'));
}

function submitEditRemark() {
    const content = document.getElementById('editRemarkContent').value.trim();
    if (!content) { showToast('å¤‡æ³¨å†…å®¹ä¸èƒ½ä¸ºç©º'); return; }
    fetch('/api/remark/edit', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({remark_id: currentRemarkId, content: content})
    }).then(r => r.json()).then(data => {
        if (data.success) { showToast('å¤‡æ³¨å·²æ›´æ–°'); closeModal('editRemarkModal'); location.reload(); }
        else { showToast(data.message || 'æ›´æ–°å¤±è´¥'); }
    }).catch(() => showToast('æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•'));
}

function deleteRemark(id) {
    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡å¤‡æ³¨å—ï¼Ÿ')) return;
    fetch('/api/remark/delete', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({remark_id: id})
    }).then(r => r.json()).then(data => {
        if (data.success) { showToast('åˆ é™¤æˆåŠŸ'); location.reload(); }
        else { showToast(data.message || 'åˆ é™¤å¤±è´¥'); }
    }).catch(() => showToast('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•'));
}
</script>
{% endblock %}
