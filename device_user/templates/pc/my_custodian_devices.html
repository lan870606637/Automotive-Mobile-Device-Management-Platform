{% extends "pc/base_pc.html" %}

{% block title %}æˆ‘çš„ä¿ç®¡è®¾å¤‡ - è®¾å¤‡ç®¡ç†ç³»ç»Ÿ{% endblock %}

{% set active_nav = 'my_custodian' %}

{% block content %}
<h1 class="page-title">ğŸ›¡ï¸ æˆ‘çš„ä¿ç®¡è®¾å¤‡</h1>

<!-- ç»Ÿè®¡å¡ç‰‡ -->
<div class="stats-grid" style="grid-template-columns: repeat(2, 1fr);">
    <div class="stat-card">
        <div class="stat-header">
            <span class="stat-icon blue">ğŸ“±</span>
            <span class="stat-label">ä¿ç®¡è®¾å¤‡æ€»æ•°</span>
        </div>
        <div class="stat-value">{{ total_count }}</div>
    </div>
    <div class="stat-card">
        <div class="stat-header">
            <span class="stat-icon orange">ğŸ“¤</span>
            <span class="stat-label">å½“å‰å€Ÿå‡º</span>
        </div>
        <div class="stat-value">{{ devices|selectattr('status', 'equalto', 'å€Ÿå‡º')|list|length }}</div>
    </div>
</div>

<!-- è®¾å¤‡åˆ—è¡¨ -->
<div class="card">
    <div class="card-header">
        <span class="card-title">ğŸ“‹ ä¿ç®¡è®¾å¤‡æ˜ç»†</span>
    </div>
    <div class="card-body">
        {% if devices %}
        <table class="data-table">
            <thead>
                <tr>
                    <th>è®¾å¤‡åç§°</th>
                    <th>ç±»å‹</th>
                    <th>å½“å‰å€Ÿç”¨äºº</th>
                    <th>å€Ÿç”¨æ—¶é—´</th>
                    <th>é¢„è®¡å½’è¿˜</th>
                    <th>æ—¶é—´çŠ¶æ€</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody>
                {% for device in devices %}
                <tr>
                    <td>
                        <span style="font-size: 16px; margin-right: 4px;">{% if device.type == 'è½¦æœº' %}ğŸš—{% else %}ğŸ“±{% endif %}</span>
                        <span style="font-weight: 500;">{{ device.name }}</span>
                    </td>
                    <td>{{ device.type }}</td>
                    <td>
                        {% if device.status in ['ä¸¢å¤±', 'å·²æŸå'] %}
                        <span style="color: #8c8c8c;">-</span>
                        {% elif device.borrower == 'æœªå€Ÿç”¨' %}
                        <span style="color: #8c8c8c;">æœªå€Ÿç”¨</span>
                        {% elif device.borrower == user.borrower_name %}
                        <span style="color: #8c8c8c;">-</span>
                        {% else %}
                        {{ device.borrower }}
                        {% endif %}
                    </td>
                    <td style="font-size: 13px; color: #595959;">
                        {% if device.status in ['ä¸¢å¤±', 'å·²æŸå'] %}-
                        {% else %}{{ device.borrow_time or '-' }}
                        {% endif %}
                    </td>
                    <td style="font-size: 13px; color: #595959;">
                        {% if device.status in ['ä¸¢å¤±', 'å·²æŸå'] %}-
                        {% else %}{{ device.expected_return_date or '-' }}
                        {% endif %}
                    </td>
                    <td>
                        {% if device.status == 'å€Ÿå‡º' %}
                            {% if device.is_overdue %}
                            <span class="status-tag status-lost">{{ device.time_remaining }}</span>
                            {% else %}
                            <span class="status-tag status-available">{{ device.time_remaining }}</span>
                            {% endif %}
                        {% elif device.status == 'ä¸¢å¤±' %}
                        <span class="status-tag status-lost">ä¸¢å¤±</span>
                        {% elif device.status == 'å·²æŸå' %}
                        <span class="status-tag status-damaged">å·²æŸå</span>
                        {% elif device.type == 'æ‰‹æœº' %}
                        <span class="status-tag status-available">ä¿ç®¡ä¸­</span>
                        {% else %}
                        <span class="status-tag status-available">åœ¨åº“</span>
                        {% endif %}
                    </td>
                    <td>
                        <div style="display: flex; gap: 6px;">
                            {% if device.status == 'å€Ÿå‡º' %}
                            <button class="btn btn-error btn-sm" onclick="forceReturn('{{ device.id }}', '{{ device.name }}')">å¼ºåˆ¶å½’è¿˜</button>
                            {% endif %}
                            {% if device.status in ['å€Ÿå‡º', 'åœ¨åº“', 'ä¿ç®¡ä¸­'] %}
                            <button class="btn btn-warning btn-sm" onclick="transferDevice('{{ device.id }}', '{{ device.name }}', {{ device.borrower | tojson }})">è½¬å€Ÿ</button>
                            {% endif %}
                            <a href="{{ url_for('pc_device_detail', device_id=device.id) }}" class="btn btn-primary btn-sm">è¯¦æƒ…</a>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="empty-state">
            <div class="empty-icon">ğŸ“­</div>
            <p class="empty-title">æš‚æ— ä¿ç®¡è®¾å¤‡</p>
            <p style="color: #8c8c8c; font-size: 14px;">æ‚¨å½“å‰æ²¡æœ‰ä¿ç®¡ä»»ä½•è®¾å¤‡</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- å¼ºåˆ¶å½’è¿˜ç¡®è®¤å¼¹çª— -->
<div id="returnModal" class="modal-overlay">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title">å¼ºåˆ¶å½’è¿˜ç¡®è®¤</h3>
            <button class="modal-close" onclick="closeReturnModal()">&times;</button>
        </div>
        <div class="modal-body">
            <p>ç¡®å®šè¦å¼ºåˆ¶æ”¶å›è®¾å¤‡ <strong id="returnDeviceName"></strong> å—ï¼Ÿ</p>
            <p style="color: #999; font-size: 13px; margin-top: 8px;">æ­¤æ“ä½œå°†ç›´æ¥ä»å½“å‰å€Ÿç”¨äººå¤„æ”¶å›è®¾å¤‡ã€‚</p>
        </div>
        <div class="modal-footer">
            <button class="btn btn-default" onclick="closeReturnModal()">å–æ¶ˆ</button>
            <button class="btn btn-error" onclick="confirmReturn()">ç¡®è®¤æ”¶å›</button>
        </div>
    </div>
</div>

<!-- è½¬å€Ÿå¼¹çª— -->
<div id="transferModal" class="modal-overlay">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title">è½¬å€Ÿè®¾å¤‡</h3>
            <button class="modal-close" onclick="closeTransferModal()">&times;</button>
        </div>
        <div class="modal-body">
            <p style="margin-bottom: 16px;">è®¾å¤‡ï¼š<strong id="transferDeviceName"></strong></p>
            <div class="form-group">
                <label class="form-label" for="transferTo">é€‰æ‹©è½¬å€Ÿäºº</label>
                <select id="transferTo" class="form-select">
                    <option value="">è¯·é€‰æ‹©</option>
                </select>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-default" onclick="closeTransferModal()">å–æ¶ˆ</button>
            <button class="btn btn-primary" onclick="confirmTransfer()">ç¡®è®¤è½¬å€Ÿ</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentDeviceId = '';

// å¼ºåˆ¶å½’è¿˜
function forceReturn(deviceId, deviceName) {
    currentDeviceId = deviceId;
    document.getElementById('returnDeviceName').textContent = deviceName;
    document.getElementById('returnModal').classList.add('active');
}

function closeReturnModal() {
    document.getElementById('returnModal').classList.remove('active');
}

function confirmReturn() {
    fetch('/api/return-by-custodian', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ device_id: currentDeviceId })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            showToast('æ”¶å›æˆåŠŸ');
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast(data.message || 'æ”¶å›å¤±è´¥');
        }
    })
    .catch(err => {
        showToast('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•');
    });
    closeReturnModal();
}

// è½¬å€Ÿ
function transferDevice(deviceId, deviceName, currentBorrower) {
    currentDeviceId = deviceId;
    document.getElementById('transferDeviceName').textContent = deviceName;
    alert('è°ƒè¯•: currentBorrower = [' + currentBorrower + ']');

    // åŠ è½½ç”¨æˆ·åˆ—è¡¨ï¼ˆæ’é™¤å½“å‰å€Ÿç”¨äººï¼Œæ’é™¤"æœªå€Ÿç”¨"çŠ¶æ€ï¼‰
    fetch('/api/users')
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            const select = document.getElementById('transferTo');
            select.innerHTML = '<option value="">è¯·é€‰æ‹©</option>';
            data.users.forEach(u => {
                // æ’é™¤å½“å‰å€Ÿç”¨äººï¼ˆå½“ä¸æ˜¯"æœªå€Ÿç”¨"æ—¶ï¼‰
                if (currentBorrower && currentBorrower !== 'æœªå€Ÿç”¨' && u.name === currentBorrower) {
                    return; // è·³è¿‡å½“å‰å€Ÿç”¨äºº
                }
                select.innerHTML += `<option value="${u.name}">${u.name}</option>`;
            });
        }
    })
    .catch(err => {
        alert('è¯·æ±‚å¤±è´¥: ' + err.message);
    });

    document.getElementById('transferModal').classList.add('active');
}

function closeTransferModal() {
    document.getElementById('transferModal').classList.remove('active');
}

function confirmTransfer() {
    const transferTo = document.getElementById('transferTo').value;
    if (!transferTo) {
        showToast('è¯·é€‰æ‹©è½¬å€Ÿäºº');
        return;
    }
    
    fetch('/api/transfer', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            device_id: currentDeviceId,
            transfer_to: transferTo
        })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            showToast('è½¬å€ŸæˆåŠŸ');
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast(data.message || 'è½¬å€Ÿå¤±è´¥');
        }
    })
    .catch(err => {
        showToast('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•');
    });
    closeTransferModal();
}

// Toastæç¤º
function showToast(message) {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.classList.add('show');
    setTimeout(() => toast.classList.remove('show'), 2000);
}

// ç‚¹å‡»é®ç½©å…³é—­å¼¹çª—
document.getElementById('returnModal').addEventListener('click', function(e) {
    if (e.target === this) closeReturnModal();
});
document.getElementById('transferModal').addEventListener('click', function(e) {
    if (e.target === this) closeTransferModal();
});
</script>
{% endblock %}
