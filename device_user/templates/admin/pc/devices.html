<!-- 
  ç”µè„‘ç«¯åå°ç®¡ç† - è®¾å¤‡ç®¡ç†é¡µé¢
  åŠŸèƒ½ï¼šåˆ—è¡¨å±•ç¤ºã€ç­›é€‰ã€æ–°å¢ã€ç¼–è¾‘ã€åˆ é™¤ã€å€Ÿè¿˜æ“ä½œ
-->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è®¾å¤‡ç®¡ç† - è½¦è½½æµ‹è¯•è®¾å¤‡ç®¡ç†ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="/static/admin/admin_pc.css">
</head>
<body class="pc-admin-body">
    <div class="pc-admin-wrapper">
        <!-- ä¾§è¾¹æ  -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <span class="logo">ğŸ”§</span>
                <span class="logo-text">åå°ç®¡ç†</span>
            </div>
            <nav class="sidebar-nav">
                <a href="/admin/pc/dashboard" class="nav-item">
                    <span class="nav-icon">ğŸ“Š</span>
                    <span>ä»ªè¡¨ç›˜</span>
                </a>
                <a href="/admin/pc/devices" class="nav-item active">
                    <span class="nav-icon">ğŸ“±</span>
                    <span>è®¾å¤‡ç®¡ç†</span>
                </a>
                <a href="/admin/pc/users" class="nav-item">
                    <span class="nav-icon">ğŸ‘¥</span>
                    <span>ç”¨æˆ·ç®¡ç†</span>
                </a>
                <a href="/admin/pc/records" class="nav-item">
                    <span class="nav-icon">ğŸ“‹</span>
                    <span>è®°å½•æŸ¥è¯¢</span>
                </a>
                <a href="/admin/pc/logs" class="nav-item">
                    <span class="nav-icon">ğŸ“œ</span>
                    <span>æ“ä½œæ—¥å¿—</span>
                </a>
                <a href="/admin/pc/overdue" class="nav-item">
                    <span class="nav-icon">âš ï¸</span>
                    <span>è¿‡æœŸæœªè¿˜</span>
                    {% if overdue_count > 0 %}
                    <span class="nav-badge">{{ overdue_count }}</span>
                    {% endif %}
                </a>
            </nav>
            <div class="sidebar-footer">
                <span>ğŸ‘¤ {{ admin_name }}</span>
                <a href="/admin/logout" class="logout-btn">é€€å‡º</a>
            </div>
        </aside>

        <!-- ä¸»å†…å®¹åŒº -->
        <main class="main-content">
            <header class="content-header">
                <h1>è®¾å¤‡ç®¡ç†</h1>
                <div class="header-actions">
                    <a href="/admin/pc/device/add" class="btn btn-primary">â• æ–°å¢è®¾å¤‡</a>
                </div>
            </header>

            <!-- ç­›é€‰æ  -->
            <div class="filter-bar">
                <div class="filter-group">
                    <input type="text" id="searchInput" class="search-input" placeholder="æœç´¢è®¾å¤‡å / å€Ÿç”¨äºº / æŸœå·">
                </div>
                <div class="filter-group">
                    <label>ç±»å‹</label>
                    <select id="filterType">
                        <option value="">å…¨éƒ¨</option>
                        <option value="æ‰‹æœº">æ‰‹æœº</option>
                        <option value="è½¦æœº">è½¦æœº</option>
                        <option value="ä»ªè¡¨">ä»ªè¡¨</option>
                        <option value="æ‰‹æœºå¡">æ‰‹æœºå¡</option>
                        <option value="å…¶å®ƒè®¾å¤‡">å…¶å®ƒè®¾å¤‡</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>çŠ¶æ€</label>
                    <select id="filterStatus">
                        <option value="">å…¨éƒ¨</option>
                        <option value="åœ¨åº“">åœ¨åº“</option>
                        <option value="ä¿ç®¡ä¸­">ä¿ç®¡ä¸­</option>
                        <option value="å€Ÿå‡º">å€Ÿå‡º</option>
                        <option value="å·²å¯„å‡º">å·²å¯„å‡º</option>
                        <option value="ç»´ä¿®ä¸­">ç»´ä¿®ä¸­</option>
                        <option value="å·²æŸå">å·²æŸå</option>
                        <option value="æŠ¥åºŸ">æŠ¥åºŸ</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>æŸœå·</label>
                    <select id="filterCabinet">
                        <option value="">å…¨éƒ¨</option>
                        {% for cabinet in cabinets %}
                        <option value="{{ cabinet }}">{{ cabinet }}</option>
                        {% endfor %}
                    </select>
                </div>
                <button class="btn btn-secondary" onclick="resetFilters()">é‡ç½®</button>
            </div>

            <!-- è®¾å¤‡åˆ—è¡¨ -->
            <div class="data-table">
                <table>
                    <thead>
                        <tr>
                            <th>è®¾å¤‡åç§°</th>
                            <th>ç±»å‹</th>
                            <th>å‹å·</th>
                            <th>çŠ¶æ€</th>
                            <th>å€Ÿç”¨äºº</th>
                            <th>æŸœå·</th>
                            <th>é¢„è®¡å½’è¿˜</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="deviceTableBody">
                        {% for device in devices %}
                        <tr>
                            <td>
                                <strong>{{ device.name }}</strong>
                                {% if device.is_overdue %}
                                <span style="color: #ff4d4f; font-size: 12px;">(é€¾æœŸ)</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if device.device_type.value == 'æ‰‹æœº' %}ğŸ“±{% elif device.device_type.value == 'è½¦æœº' %}ğŸš—{% elif device.device_type.value == 'ä»ªè¡¨' %}ğŸ“Š{% elif device.device_type.value == 'æ‰‹æœºå¡' %}ğŸ“²{% elif device.device_type.value == 'å…¶å®ƒè®¾å¤‡' %}ğŸ”§{% else %}ğŸ“¦{% endif %}
                                {{ device.device_type.value }}
                            </td>
                            <td>{{ device.model or '-' }}</td>
                            <td><span class="status-tag status-{{ device.status }}">{{ device.status }}</span></td>
                            <td>{{ device.borrower or '-' }}</td>
                            <td>{{ device.cabinet or '-' }}</td>
                            <td style="color: {{ '#ff4d4f' if device.is_overdue else '#666' }}">{{ device.expect_return_time or '-' }}</td>
                            <td>
                                <div class="table-actions">
                                    <a href="/admin/pc/device/{{ device.id }}" class="btn btn-sm btn-secondary">ç¼–è¾‘</a>
                                    {% if device.status == 'åœ¨åº“' %}
                                    <button class="btn btn-sm btn-primary" onclick="showBorrowModal('{{ device.id }}')">å€Ÿå‡º</button>
                                    {% elif device.status == 'å€Ÿå‡º' %}
                                    <button class="btn btn-sm btn-success" onclick="showReturnModal('{{ device.id }}')">å½’è¿˜</button>
                                    <button class="btn btn-sm btn-warning" onclick="showTransferModal('{{ device.id }}')">è½¬å€Ÿ</button>
                                    {% endif %}
                                    <button class="btn btn-sm btn-danger" onclick="deleteDevice('{{ device.id }}')">åˆ é™¤</button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- åˆ†é¡µ -->
            <div class="pagination" id="pagination">
                <!-- åŠ¨æ€ç”Ÿæˆåˆ†é¡µ -->
            </div>
        </main>
    </div>

    <!-- å€Ÿå‡ºè®¾å¤‡å¼¹çª— -->
    <div id="borrowModal" class="modal">
        <div class="modal-dialog">
            <div class="modal-header">
                <h3>ğŸ“¤ å½•å…¥ç™»è®°ï¼ˆå€Ÿå‡ºè®¾å¤‡ï¼‰</h3>
                <button class="modal-close" onclick="closeModal('borrowModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-field">
                    <label>é€‰æ‹©å€Ÿç”¨äºº <span class="required">*</span></label>
                    <select id="borrowUser">
                        <option value="">è¯·é€‰æ‹©å€Ÿç”¨äºº</option>
                        {% for user in users %}
                        <option value="{{ user.name }}">{{ user.name }} {{ '(' + user.weixin_name + ')' if user.weixin_name else '' }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-row">
                    <div class="form-field">
                        <label>å€Ÿå‡ºå¤©æ•° <span class="required">*</span></label>
                        <input type="number" id="borrowDays" value="1" min="1" max="365">
                    </div>
                    <div class="form-field">
                        <label>æŸœå·/ä¿ç®¡äºº</label>
                        <input type="text" id="borrowCabinet" value="æµé€š">
                    </div>
                </div>
                <div class="form-field">
                    <label>å€Ÿå‡ºå¤‡æ³¨</label>
                    <textarea id="borrowRemarks" placeholder="å¯é€‰ï¼šå¡«å†™å€Ÿå‡ºå¤‡æ³¨..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('borrowModal')">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="confirmBorrow()">ç¡®è®¤å€Ÿå‡º</button>
            </div>
        </div>
    </div>

    <!-- å½’è¿˜è®¾å¤‡å¼¹çª— -->
    <div id="returnModal" class="modal">
        <div class="modal-dialog" style="max-width: 400px;">
            <div class="modal-header">
                <h3>ğŸ“¥ å¼ºåˆ¶å½’è¿˜è®¾å¤‡</h3>
                <button class="modal-close" onclick="closeModal('returnModal')">&times;</button>
            </div>
            <div class="modal-body">
                <p>ç¡®è®¤å¼ºåˆ¶å½’è¿˜è¯¥è®¾å¤‡å—ï¼Ÿ</p>
                <p style="color: #666; font-size: 14px; margin-top: 12px;">è®¾å¤‡å°†å›åˆ°åœ¨åº“çŠ¶æ€ï¼Œå¹¶è®°å½•æ“ä½œæ—¥å¿—ã€‚</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('returnModal')">å–æ¶ˆ</button>
                <button class="btn btn-success" onclick="confirmReturn()">ç¡®è®¤å½’è¿˜</button>
            </div>
        </div>
    </div>

    <!-- è½¬å€Ÿè®¾å¤‡å¼¹çª— -->
    <div id="transferModal" class="modal">
        <div class="modal-dialog">
            <div class="modal-header">
                <h3>ğŸ”„ è½¬å€Ÿè®¾å¤‡</h3>
                <button class="modal-close" onclick="closeModal('transferModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-field">
                    <label>æ–°å€Ÿç”¨äºº <span class="required">*</span></label>
                    <select id="transferUser">
                        <option value="">è¯·é€‰æ‹©å€Ÿç”¨äºº</option>
                        {% for user in users %}
                        <option value="{{ user.name }}">{{ user.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-field">
                    <label>è½¬å€Ÿå¤‡æ³¨</label>
                    <textarea id="transferRemarks" placeholder="å¯é€‰ï¼šå¡«å†™è½¬å€Ÿå¤‡æ³¨..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('transferModal')">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="confirmTransfer()">ç¡®è®¤è½¬å€Ÿ</button>
            </div>
        </div>
    </div>

    <!-- Toastæç¤º -->
    <div id="toast" class="toast"></div>

    <script>
        let currentDeviceId = null;
        let devices = [];

        // è·å–è®¾å¤‡å›¾æ ‡
        function getDeviceIcon(deviceType) {
            const iconMap = {
                'æ‰‹æœº': 'ğŸ“±',
                'è½¦æœº': 'ğŸš—',
                'ä»ªè¡¨': 'ğŸ“Š',
                'æ‰‹æœºå¡': 'ğŸ“²',
                'å…¶å®ƒè®¾å¤‡': 'ğŸ”§'
            };
            return iconMap[deviceType] || 'ğŸ“¦';
        }

        // åŠ è½½è®¾å¤‡åˆ—è¡¨
        async function loadDevices() {
            try {
                const response = await fetch('/api/devices');
                devices = await response.json();
                renderDevices(devices);
            } catch (error) {
                showToast('åŠ è½½è®¾å¤‡åˆ—è¡¨å¤±è´¥', 'error');
            }
        }

        // æ¸²æŸ“è®¾å¤‡åˆ—è¡¨
        function renderDevices(deviceList) {
            const tbody = document.getElementById('deviceTableBody');
            
            if (deviceList.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="empty-cell">æš‚æ— è®¾å¤‡</td></tr>';
                return;
            }

            tbody.innerHTML = deviceList.map(device => `
                <tr>
                    <td>
                        <strong>${device.device_name}</strong>
                        ${device.is_overdue ? '<span style="color: #ff4d4f; font-size: 12px;">(é€¾æœŸ)</span>' : ''}
                    </td>
                    <td>${getDeviceIcon(device.device_type)} ${device.device_type}</td>
                    <td>${device.model || '-'}</td>
                    <td><span class="status-tag status-${device.status}">${device.status}</span></td>
                    <td>${device.borrower || '-'}</td>
                    <td>${device.cabinet || '-'}</td>
                    <td style="color: ${device.is_overdue ? '#ff4d4f' : '#666'}">${device.expect_return_time || '-'}</td>
                    <td>
                        <div class="table-actions">
                            <a href="/admin/pc/device/${device.id}" class="btn btn-sm btn-secondary">ç¼–è¾‘</a>
                            ${getActionButtons(device)}
                            <button class="btn btn-sm btn-danger" onclick="deleteDevice('${device.id}')">åˆ é™¤</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // è·å–æ“ä½œæŒ‰é’®
        function getActionButtons(device) {
            if (device.status === 'åœ¨åº“') {
                return `<button class="btn btn-sm btn-primary" onclick="showBorrowModal('${device.id}')">å€Ÿå‡º</button>`;
            } else if (device.status === 'å€Ÿå‡º') {
                return `
                    <button class="btn btn-sm btn-success" onclick="showReturnModal('${device.id}')">å½’è¿˜</button>
                    <button class="btn btn-sm btn-warning" onclick="showTransferModal('${device.id}')">è½¬å€Ÿ</button>
                `;
            }
            return '';
        }

        // ç­›é€‰åŠŸèƒ½
        document.getElementById('searchInput')?.addEventListener('input', filterDevices);
        document.getElementById('filterType')?.addEventListener('change', filterDevices);
        document.getElementById('filterStatus')?.addEventListener('change', filterDevices);
        document.getElementById('filterCabinet')?.addEventListener('change', filterDevices);

        function filterDevices() {
            const keyword = document.getElementById('searchInput')?.value?.toLowerCase() || '';
            const type = document.getElementById('filterType')?.value || '';
            const status = document.getElementById('filterStatus')?.value || '';
            const cabinet = document.getElementById('filterCabinet')?.value || '';

            let filtered = devices;

            if (keyword) {
                filtered = filtered.filter(d => 
                    (d.device_name && d.device_name.toLowerCase().includes(keyword)) ||
                    (d.borrower && d.borrower.toLowerCase().includes(keyword)) ||
                    (d.cabinet && d.cabinet.toLowerCase().includes(keyword))
                );
            }
            if (type) filtered = filtered.filter(d => d.device_type === type);
            if (status) filtered = filtered.filter(d => d.status === status);
            if (cabinet) filtered = filtered.filter(d => d.cabinet === cabinet);

            renderDevices(filtered);
        }

        function resetFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('filterType').value = '';
            document.getElementById('filterStatus').value = '';
            document.getElementById('filterCabinet').value = '';
            renderDevices(devices);
        }

        // æ˜¾ç¤ºå€Ÿå‡ºå¼¹çª—
        function showBorrowModal(deviceId) {
            currentDeviceId = deviceId;
            document.getElementById('borrowModal').classList.add('show');
        }

        // ç¡®è®¤å€Ÿå‡º
        async function confirmBorrow() {
            const user = document.getElementById('borrowUser').value;
            const days = document.getElementById('borrowDays').value;
            const cabinet = document.getElementById('borrowCabinet').value;
            const remarks = document.getElementById('borrowRemarks').value;

            if (!user) {
                showToast('è¯·é€‰æ‹©å€Ÿç”¨äºº', 'warning');
                return;
            }

            try {
                const response = await fetch(`/api/devices/${currentDeviceId}/borrow`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user, days: parseInt(days), cabinet, remarks })
                });

                const result = await response.json();
                if (result.success) {
                    showToast('å€Ÿå‡ºæˆåŠŸ', 'success');
                    closeModal('borrowModal');
                    loadDevices();
                } else {
                    showToast(result.message || 'å€Ÿå‡ºå¤±è´¥', 'error');
                }
            } catch (error) {
                showToast('ç½‘ç»œé”™è¯¯', 'error');
            }
        }

        // æ˜¾ç¤ºå½’è¿˜å¼¹çª—
        function showReturnModal(deviceId) {
            currentDeviceId = deviceId;
            document.getElementById('returnModal').classList.add('show');
        }

        // ç¡®è®¤å½’è¿˜
        async function confirmReturn() {
            try {
                const response = await fetch(`/api/devices/${currentDeviceId}/return`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const result = await response.json();
                if (result.success) {
                    showToast('å½’è¿˜æˆåŠŸ', 'success');
                    closeModal('returnModal');
                    loadDevices();
                } else {
                    showToast(result.message || 'å½’è¿˜å¤±è´¥', 'error');
                }
            } catch (error) {
                showToast('ç½‘ç»œé”™è¯¯', 'error');
            }
        }

        // æ˜¾ç¤ºè½¬å€Ÿå¼¹çª—
        function showTransferModal(deviceId) {
            currentDeviceId = deviceId;
            document.getElementById('transferModal').classList.add('show');
        }

        // ç¡®è®¤è½¬å€Ÿ
        async function confirmTransfer() {
            const user = document.getElementById('transferUser').value;
            const remarks = document.getElementById('transferRemarks').value;

            if (!user) {
                showToast('è¯·é€‰æ‹©æ–°å€Ÿç”¨äºº', 'warning');
                return;
            }

            try {
                const response = await fetch(`/api/devices/${currentDeviceId}/transfer`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user, remarks })
                });

                const result = await response.json();
                if (result.success) {
                    showToast('è½¬å€ŸæˆåŠŸ', 'success');
                    closeModal('transferModal');
                    loadDevices();
                } else {
                    showToast(result.message || 'è½¬å€Ÿå¤±è´¥', 'error');
                }
            } catch (error) {
                showToast('ç½‘ç»œé”™è¯¯', 'error');
            }
        }

        // åˆ é™¤è®¾å¤‡
        async function deleteDevice(deviceId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¯¥è®¾å¤‡å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) return;

            try {
                const response = await fetch(`/api/devices/${deviceId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();
                if (result.success) {
                    showToast('åˆ é™¤æˆåŠŸ', 'success');
                    loadDevices();
                } else {
                    showToast(result.message || 'åˆ é™¤å¤±è´¥', 'error');
                }
            } catch (error) {
                showToast('ç½‘ç»œé”™è¯¯', 'error');
            }
        }

        // å…³é—­å¼¹çª—
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        // æ˜¾ç¤ºToast
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', loadDevices);
    </script>
</body>
</html>
