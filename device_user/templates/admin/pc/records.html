<!-- 
  ç”µè„‘ç«¯åå°ç®¡ç† - è®°å½•æŸ¥è¯¢é¡µé¢
-->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è®°å½•æŸ¥è¯¢ - è½¦è½½æµ‹è¯•è®¾å¤‡ç®¡ç†ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="/static/admin/admin_pc.css">
</head>
<body class="pc-admin-body">
    <div class="pc-admin-wrapper">
        <!-- ä¾§è¾¹æ  -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <span class="logo">ğŸ”§</span>
                <span class="logo-text">åå°ç®¡ç†</span>
            </div>
            <nav class="sidebar-nav">
                <a href="/admin/pc/dashboard" class="nav-item">
                    <span class="nav-icon">ğŸ“Š</span>
                    <span>ä»ªè¡¨ç›˜</span>
                </a>
                <a href="/admin/pc/devices" class="nav-item">
                    <span class="nav-icon">ğŸ“±</span>
                    <span>è®¾å¤‡ç®¡ç†</span>
                </a>
                <a href="/admin/pc/users" class="nav-item">
                    <span class="nav-icon">ğŸ‘¥</span>
                    <span>ç”¨æˆ·ç®¡ç†</span>
                </a>
                <a href="/admin/pc/records" class="nav-item active">
                    <span class="nav-icon">ğŸ“‹</span>
                    <span>è®°å½•æŸ¥è¯¢</span>
                </a>
                <a href="/admin/pc/logs" class="nav-item">
                    <span class="nav-icon">ğŸ“œ</span>
                    <span>æ“ä½œæ—¥å¿—</span>
                </a>
                <a href="/admin/pc/overdue" class="nav-item">
                    <span class="nav-icon">âš ï¸</span>
                    <span>è¿‡æœŸæœªè¿˜</span>
                </a>
            </nav>
            <div class="sidebar-footer">
                <span>ğŸ‘¤ {{ admin_name }}</span>
                <a href="/admin/logout" class="logout-btn">é€€å‡º</a>
            </div>
        </aside>

        <!-- ä¸»å†…å®¹åŒº -->
        <main class="main-content">
            <header class="content-header">
                <h1>è®°å½•æŸ¥è¯¢</h1>
                <div class="header-actions">
                    <button class="btn btn-success" onclick="exportRecords()">ğŸ“¥ å¯¼å‡ºExcel</button>
                </div>
            </header>

            <!-- ç­›é€‰æ  -->
            <div class="filter-bar">
                <div class="filter-group">
                    <input type="text" id="searchDevice" class="search-input" placeholder="æœç´¢è®¾å¤‡å">
                </div>
                <div class="filter-group">
                    <input type="text" id="searchUser" placeholder="æœç´¢å€Ÿç”¨äºº">
                </div>
                <div class="filter-group">
                    <label>ç±»å‹</label>
                    <select id="filterType">
                        <option value="">å…¨éƒ¨</option>
                        <option value="æ‰‹æœº">æ‰‹æœº</option>
                        <option value="è½¦æœº">è½¦æœº</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>æ“ä½œ</label>
                    <select id="filterAction">
                        <option value="">å…¨éƒ¨</option>
                        <option value="å€Ÿå‡º">å€Ÿå‡º</option>
                        <option value="å½’è¿˜">å½’è¿˜</option>
                        <option value="å½•å…¥ç™»è®°">å½•å…¥ç™»è®°</option>
                        <option value="å¼ºåˆ¶å½’è¿˜">å¼ºåˆ¶å½’è¿˜</option>
                        <option value="è½¬å€Ÿ">è½¬å€Ÿ</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>å¼€å§‹æ—¥æœŸ</label>
                    <input type="date" id="startDate">
                </div>
                <div class="filter-group">
                    <label>ç»“æŸæ—¥æœŸ</label>
                    <input type="date" id="endDate">
                </div>
                <button class="btn btn-secondary" onclick="resetFilters()">é‡ç½®</button>
            </div>

            <!-- è®°å½•åˆ—è¡¨ -->
            <div class="data-table">
                <table>
                    <thead>
                        <tr>
                            <th>æ“ä½œç±»å‹</th>
                            <th>è®¾å¤‡åç§°</th>
                            <th>è®¾å¤‡ç±»å‹</th>
                            <th>å€Ÿç”¨äºº</th>
                            <th>æ“ä½œæ—¶é—´</th>
                            <th>å¤‡æ³¨</th>
                        </tr>
                    </thead>
                    <tbody id="recordsTableBody">
                        {% for record in records %}
                        <tr>
                            <td><span class="action-badge action-{{ record.action_type }}">{{ record.action_type }}</span></td>
                            <td>{{ record.device_name }}</td>
                            <td>{{ record.device_type }}</td>
                            <td>{{ record.user_name }}</td>
                            <td>{{ record.time }}</td>
                            <td>{{ record.remarks or '-' }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- åˆ†é¡µ -->
            <div class="pagination" id="pagination">
                <!-- åŠ¨æ€ç”Ÿæˆåˆ†é¡µ -->
            </div>
        </main>
    </div>

    <!-- Toastæç¤º -->
    <div id="toast" class="toast"></div>

    <script>
        let records = [];
        let currentPage = 1;
        let totalPages = 1;

        // åŠ è½½è®°å½•
        async function loadRecords(page = 1) {
            try {
                const params = new URLSearchParams();
                params.append('page', page);
                params.append('limit', 20);

                const response = await fetch(`/api/records?${params}`);
                const data = await response.json();
                
                records = data.records || [];
                currentPage = data.page || 1;
                totalPages = data.total_pages || 1;
                
                renderRecords(records);
                renderPagination();
            } catch (error) {
                showToast('åŠ è½½è®°å½•å¤±è´¥', 'error');
            }
        }

        // æ¸²æŸ“è®°å½•
        function renderRecords(recordList) {
            const tbody = document.getElementById('recordsTableBody');
            
            if (recordList.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="empty-cell">æš‚æ— è®°å½•</td></tr>';
                return;
            }

            tbody.innerHTML = recordList.map(record => `
                <tr>
                    <td><span class="action-badge action-${record.action_type}">${record.action_type}</span></td>
                    <td>${record.device_name}</td>
                    <td>${record.device_type}</td>
                    <td>${record.user_name}</td>
                    <td>${record.time}</td>
                    <td>${record.remarks || '-'}</td>
                </tr>
            `).join('');
        }

        // æ¸²æŸ“åˆ†é¡µ
        function renderPagination() {
            const pagination = document.getElementById('pagination');
            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }

            let html = '';
            
            // ä¸Šä¸€é¡µ
            html += `<button class="pagination-btn" onclick="loadRecords(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>ä¸Šä¸€é¡µ</button>`;
            
            // é¡µç 
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                    html += `<button class="pagination-btn ${i === currentPage ? 'active' : ''}" onclick="loadRecords(${i})">${i}</button>`;
                } else if (i === currentPage - 3 || i === currentPage + 3) {
                    html += `<span>...</span>`;
                }
            }
            
            // ä¸‹ä¸€é¡µ
            html += `<button class="pagination-btn" onclick="loadRecords(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>ä¸‹ä¸€é¡µ</button>`;
            
            pagination.innerHTML = html;
        }

        // ç­›é€‰åŠŸèƒ½
        document.getElementById('searchDevice')?.addEventListener('input', filterRecords);
        document.getElementById('searchUser')?.addEventListener('input', filterRecords);
        document.getElementById('filterType')?.addEventListener('change', filterRecords);
        document.getElementById('filterAction')?.addEventListener('change', filterRecords);
        document.getElementById('startDate')?.addEventListener('change', filterRecords);
        document.getElementById('endDate')?.addEventListener('change', filterRecords);

        function filterRecords() {
            const deviceKeyword = document.getElementById('searchDevice')?.value?.toLowerCase() || '';
            const userKeyword = document.getElementById('searchUser')?.value?.toLowerCase() || '';
            const type = document.getElementById('filterType')?.value || '';
            const action = document.getElementById('filterAction')?.value || '';
            const startDate = document.getElementById('startDate')?.value || '';
            const endDate = document.getElementById('endDate')?.value || '';

            let filtered = records;

            if (deviceKeyword) {
                filtered = filtered.filter(r => r.device_name && r.device_name.toLowerCase().includes(deviceKeyword));
            }
            if (userKeyword) {
                filtered = filtered.filter(r => r.user_name && r.user_name.toLowerCase().includes(userKeyword));
            }
            if (type) {
                filtered = filtered.filter(r => r.device_type === type);
            }
            if (action) {
                filtered = filtered.filter(r => r.action_type === action);
            }
            if (startDate) {
                filtered = filtered.filter(r => r.time && r.time >= startDate);
            }
            if (endDate) {
                filtered = filtered.filter(r => r.time && r.time <= endDate + ' 23:59:59');
            }

            renderRecords(filtered);
        }

        function resetFilters() {
            document.getElementById('searchDevice').value = '';
            document.getElementById('searchUser').value = '';
            document.getElementById('filterType').value = '';
            document.getElementById('filterAction').value = '';
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            renderRecords(records);
        }

        // å¯¼å‡ºè®°å½•
        async function exportRecords() {
            try {
                const response = await fetch('/api/records/export', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        device_name: document.getElementById('searchDevice')?.value,
                        user_name: document.getElementById('searchUser')?.value,
                        device_type: document.getElementById('filterType')?.value,
                        action_type: document.getElementById('filterAction')?.value,
                        start_date: document.getElementById('startDate')?.value,
                        end_date: document.getElementById('endDate')?.value
                    })
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `å€Ÿè¿˜è®°å½•_${new Date().toISOString().split('T')[0]}.xlsx`;
                    a.click();
                    showToast('å¯¼å‡ºæˆåŠŸ', 'success');
                } else {
                    showToast('å¯¼å‡ºå¤±è´¥', 'error');
                }
            } catch (error) {
                showToast('ç½‘ç»œé”™è¯¯', 'error');
            }
        }

        // æ˜¾ç¤ºToast
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => loadRecords(1));
    </script>
</body>
</html>
