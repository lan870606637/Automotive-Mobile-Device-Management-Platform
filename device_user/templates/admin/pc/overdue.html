<!-- 
  ç”µè„‘ç«¯åå°ç®¡ç† - è¿‡æœŸæœªè¿˜é¡µé¢
-->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¿‡æœŸæœªè¿˜ - è½¦è½½æµ‹è¯•è®¾å¤‡ç®¡ç†ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="/static/admin/admin_pc.css">
</head>
<body class="pc-admin-body">
    <div class="pc-admin-wrapper">
        <!-- ä¾§è¾¹æ  -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <span class="logo">ğŸ”§</span>
                <span class="logo-text">åå°ç®¡ç†</span>
            </div>
            <nav class="sidebar-nav">
                <a href="/admin/pc/dashboard" class="nav-item">
                    <span class="nav-icon">ğŸ“Š</span>
                    <span>ä»ªè¡¨ç›˜</span>
                </a>
                <a href="/admin/pc/devices" class="nav-item">
                    <span class="nav-icon">ğŸ“±</span>
                    <span>è®¾å¤‡ç®¡ç†</span>
                </a>
                <a href="/admin/pc/users" class="nav-item">
                    <span class="nav-icon">ğŸ‘¥</span>
                    <span>ç”¨æˆ·ç®¡ç†</span>
                </a>
                <a href="/admin/pc/records" class="nav-item">
                    <span class="nav-icon">ğŸ“‹</span>
                    <span>è®°å½•æŸ¥è¯¢</span>
                </a>
                <a href="/admin/pc/logs" class="nav-item">
                    <span class="nav-icon">ğŸ“œ</span>
                    <span>æ“ä½œæ—¥å¿—</span>
                </a>
                <a href="/admin/pc/overdue" class="nav-item active">
                    <span class="nav-icon">âš ï¸</span>
                    <span>è¿‡æœŸæœªè¿˜</span>
                </a>
            </nav>
            <div class="sidebar-footer">
                <span>ğŸ‘¤ {{ admin_name }}</span>
                <a href="/admin/logout" class="logout-btn">é€€å‡º</a>
            </div>
        </aside>

        <!-- ä¸»å†…å®¹åŒº -->
        <main class="main-content">
            <header class="content-header">
                <h1>âš ï¸ è¿‡æœŸæœªè¿˜è®¾å¤‡</h1>
                <div class="header-actions">
                    <button class="btn btn-primary" onclick="sendReminders()">ğŸ“¢ å‘é€æé†’</button>
                    <button class="btn btn-success" onclick="exportOverdue()">ğŸ“¥ å¯¼å‡ºåˆ—è¡¨</button>
                </div>
            </header>

            <!-- ç»Ÿè®¡ä¿¡æ¯ -->
            <div class="stats-row" style="margin-bottom: 20px;">
                <div class="stat-card-large overdue">
                    <div class="stat-icon-bg">âš ï¸</div>
                    <div class="stat-info">
                        <span class="stat-value">{{ overdue_count }}</span>
                        <span class="stat-label">é€¾æœŸè®¾å¤‡æ€»æ•°</span>
                    </div>
                </div>
                <div class="stat-card-large borrowed">
                    <div class="stat-icon-bg">ğŸ“±</div>
                    <div class="stat-info">
                        <span class="stat-value">{{ phone_overdue }}</span>
                        <span class="stat-label">æ‰‹æœºé€¾æœŸ</span>
                    </div>
                </div>
                <div class="stat-card-large borrowed">
                    <div class="stat-icon-bg">ğŸš—</div>
                    <div class="stat-info">
                        <span class="stat-value">{{ car_overdue }}</span>
                        <span class="stat-label">è½¦æœºé€¾æœŸ</span>
                    </div>
                </div>
            </div>

            <!-- é€¾æœŸåˆ—è¡¨ -->
            <div class="content-card">
                <div class="card-header">
                    <h3>é€¾æœŸè®¾å¤‡åˆ—è¡¨ï¼ˆæŒ‰é€¾æœŸå¤©æ•°æ’åºï¼‰</h3>
                    <button class="btn btn-secondary" onclick="refreshOverdue()">ğŸ”„ åˆ·æ–°</button>
                </div>
                <div class="data-table">
                    <table>
                        <thead>
                            <tr>
                                <th>è®¾å¤‡åç§°</th>
                                <th>ç±»å‹</th>
                                <th>å€Ÿç”¨äºº</th>
                                <th>å€Ÿå‡ºæ—¶é—´</th>
                                <th>é¢„è®¡å½’è¿˜</th>
                                <th>é€¾æœŸå¤©æ•°</th>
                                <th>è”ç³»æ–¹å¼</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="overdueTableBody">
                            {% for device in overdue_devices %}
                            <tr style="background: {{ '#fff1f0' if device.overdue_days > 7 else '' }}">
                                <td>
                                    <strong>{{ device.device_name }}</strong>
                                    {% if device.overdue_days > 14 %}
                                    <span style="color: #ff4d4f; font-size: 12px;">(ä¸¥é‡é€¾æœŸ)</span>
                                    {% endif %}
                                </td>
                                <td>{{ 'ğŸ“±' if device.device_type == 'æ‰‹æœº' else 'ğŸš—' }} {{ device.device_type }}</td>
                                <td>{{ device.borrower }}</td>
                                <td>{{ device.borrow_time }}</td>
                                <td style="color: #ff4d4f; font-weight: 500;">{{ device.expect_return_time }}</td>
                                <td>
                                    <span style="color: {{ '#ff4d4f' if device.overdue_days > 7 else '#faad14' }}; font-weight: 600;">
                                        {% if device.overdue_hours < 24 %}{{ device.overdue_hours }} å°æ—¶{% else %}{{ device.overdue_days }} å¤©{% endif %}
                                    </span>
                                </td>
                                <td>{{ device.phone or '-' }}</td>
                                <td>
                                    <div class="table-actions">
                                        <button class="btn btn-sm btn-success" onclick="returnDevice('{{ device.id }}')">å½’è¿˜</button>
                                        <button class="btn btn-sm btn-primary" onclick="remindUser('{{ device.id }}')">æé†’</button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% if not overdue_devices %}
                <div class="empty-state" style="padding: 60px;">
                    <span style="font-size: 64px;">âœ…</span>
                    <p style="margin-top: 16px; font-size: 18px; color: #52c41a;">å¤ªæ£’äº†ï¼æ²¡æœ‰é€¾æœŸè®¾å¤‡</p>
                </div>
                {% endif %}
            </div>
        </main>
    </div>

    <!-- Toastæç¤º -->
    <div id="toast" class="toast"></div>

    <script>
        // åŠ è½½é€¾æœŸè®¾å¤‡
        async function loadOverdue() {
            try {
                const response = await fetch('/api/devices/overdue');
                const data = await response.json();
                renderOverdue(data.devices || []);
            } catch (error) {
                showToast('åŠ è½½æ•°æ®å¤±è´¥', 'error');
            }
        }

        // æ¸²æŸ“é€¾æœŸè®¾å¤‡
        function renderOverdue(devices) {
            const tbody = document.getElementById('overdueTableBody');
            
            if (devices.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="empty-cell">æš‚æ— é€¾æœŸè®¾å¤‡</td></tr>';
                return;
            }

            tbody.innerHTML = devices.map(device => `
                <tr style="background: ${device.overdue_days > 7 ? '#fff1f0' : ''}">
                    <td>
                        <strong>${device.device_name}</strong>
                        ${device.overdue_days > 14 ? '<span style="color: #ff4d4f; font-size: 12px;">(ä¸¥é‡é€¾æœŸ)</span>' : ''}
                    </td>
                    <td>${device.device_type === 'æ‰‹æœº' ? 'ğŸ“±' : 'ğŸš—'} ${device.device_type}</td>
                    <td>${device.borrower}</td>
                    <td>${device.borrow_time}</td>
                    <td style="color: #ff4d4f; font-weight: 500;">${device.expect_return_time}</td>
                    <td>
                        <span style="color: ${device.overdue_days > 7 ? '#ff4d4f' : '#faad14'}; font-weight: 600;">
                            ${device.overdue_hours < 24 ? device.overdue_hours + ' å°æ—¶' : device.overdue_days + ' å¤©'}
                        </span>
                    </td>
                    <td>${device.phone || '-'}</td>
                    <td>
                        <div class="table-actions">
                            <button class="btn btn-sm btn-success" onclick="returnDevice('${device.id}')">å½’è¿˜</button>
                            <button class="btn btn-sm btn-primary" onclick="remindUser('${device.id}')">æé†’</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // å½’è¿˜è®¾å¤‡
        async function returnDevice(deviceId) {
            if (!confirm('ç¡®è®¤å½’è¿˜è¯¥è®¾å¤‡å—ï¼Ÿ')) return;
            
            try {
                const response = await fetch(`/api/devices/${deviceId}/return`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const result = await response.json();
                if (result.success) {
                    showToast('å½’è¿˜æˆåŠŸ', 'success');
                    loadOverdue();
                } else {
                    showToast(result.message || 'å½’è¿˜å¤±è´¥', 'error');
                }
            } catch (error) {
                showToast('ç½‘ç»œé”™è¯¯', 'error');
            }
        }

        // æé†’ç”¨æˆ·
        async function remindUser(deviceId) {
            try {
                const response = await fetch(`/api/devices/${deviceId}/remind`, {
                    method: 'POST'
                });

                const result = await response.json();
                if (result.success) {
                    showToast('æé†’å·²å‘é€', 'success');
                } else {
                    showToast(result.message || 'å‘é€å¤±è´¥', 'error');
                }
            } catch (error) {
                showToast('ç½‘ç»œé”™è¯¯', 'error');
            }
        }

        // æ‰¹é‡å‘é€æé†’
        async function sendReminders() {
            if (!confirm('ç¡®å®šè¦ç»™æ‰€æœ‰é€¾æœŸç”¨æˆ·å‘é€æé†’å—ï¼Ÿ')) return;
            
            try {
                const response = await fetch('/api/overdue/remind_all', {
                    method: 'POST'
                });

                const result = await response.json();
                if (result.success) {
                    showToast(`å·²å‘é€ ${result.count} æ¡æé†’`, 'success');
                } else {
                    showToast(result.message || 'å‘é€å¤±è´¥', 'error');
                }
            } catch (error) {
                showToast('ç½‘ç»œé”™è¯¯', 'error');
            }
        }

        // å¯¼å‡ºé€¾æœŸåˆ—è¡¨
        async function exportOverdue() {
            try {
                const response = await fetch('/api/overdue/export');
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `é€¾æœŸè®¾å¤‡_${new Date().toISOString().split('T')[0]}.xlsx`;
                    a.click();
                    showToast('å¯¼å‡ºæˆåŠŸ', 'success');
                } else {
                    showToast('å¯¼å‡ºå¤±è´¥', 'error');
                }
            } catch (error) {
                showToast('ç½‘ç»œé”™è¯¯', 'error');
            }
        }

        // åˆ·æ–°æ•°æ®
        function refreshOverdue() {
            loadOverdue();
            showToast('å·²åˆ·æ–°', 'success');
        }

        // æ˜¾ç¤ºToast
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', loadOverdue);
        
        // æ¯30ç§’è‡ªåŠ¨åˆ·æ–°
        setInterval(loadOverdue, 30000);
    </script>
</body>
</html>
